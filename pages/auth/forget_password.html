<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿˜è¨˜å¯†ç¢¼ - Vieshow Ticketing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script src="../../js/chatbot.js"></script>
</head>
<body class="bg-gray-50 font-sans min-h-screen flex flex-col items-center justify-center p-4">
    
    <div class="w-full max-w-sm">
        
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-vieshow-red">Vieshow</h1>
            <p class="text-gray-600 mt-1">å¨ç§€å½±åŸè¨‚ç¥¨ç³»çµ±</p>
        </div>

        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-4 border-vieshow-red">
            <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">
                ğŸ”’ é‡è¨­å¯†ç¢¼
            </h2>
            <div id="messageContainer" class="hidden p-3 mb-4 rounded-lg font-medium text-sm text-center" role="alert"></div>
            
            <div id="step1_verification">
                <p class="text-center text-gray-500 mb-6 text-sm">è«‹è¼¸å…¥æ‚¨çš„å¸³è™Ÿèˆ‡èº«åˆ†è­‰è™Ÿé€²è¡Œé©—è­‰ã€‚</p>
                <form id="verificationForm" class="space-y-4">
                    <div>
                        <label for="memberEmail" class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶ (å¸³è™Ÿ):</label>
                        <input type="email" id="memberEmail" name="memberEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-vieshow-red focus:border-vieshow-red transition duration-150" placeholder="æ‚¨çš„è¨»å†Šé›»å­éƒµä»¶">
                    </div>
                    <div>
                        <label for="memberId" class="block text-sm font-medium text-gray-700 mb-1">èº«åˆ†è­‰å­—è™Ÿ:</label>
                        <input type="text" id="memberId" name="memberId" required maxlength="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-vieshow-red focus:border-vieshow-red transition duration-150" placeholder="è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ (10ç¢¼)">
                    </div>
                    <button type="submit" id="step1Button" class="w-full bg-vieshow-red text-white py-3 rounded-lg font-bold text-base hover:bg-red-700 transition duration-200 shadow-md flex items-center justify-center">
                        é©—è­‰å¸³è™Ÿ
                    </button>
                </form>
            </div>

            <div id="step2_reset" class="hidden">
                <p class="text-center text-gray-500 mb-6 text-sm">è«‹è¼¸å…¥ä¸¦ç¢ºèªæ–°çš„å¯†ç¢¼ã€‚</p>
                <form id="resetPasswordForm" class="space-y-4">
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç¢¼ (è‹±æ•¸çµ„åˆï¼Œè‡³å°‘8ç¢¼):</label>
                        <input type="password" id="newPassword" name="newPassword" required minlength="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-vieshow-red focus:border-vieshow-red transition duration-150" placeholder="è«‹è¼¸å…¥ 8 ä½ä»¥ä¸Šæ–°å¯†ç¢¼">
                        <span class="text-vieshow-red text-xs mt-1 block" id="newPwdFormatError"></span>
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">ç¢ºèªæ–°å¯†ç¢¼:</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-vieshow-red focus:border-vieshow-red transition duration-150" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                        <span class="text-vieshow-red text-xs mt-1 block" id="newPwdMatchError"></span>
                    </div>
                    <button type="submit" id="step2Button" class="w-full bg-vieshow-red text-white py-3 rounded-lg font-bold text-base hover:bg-red-700 transition duration-200 shadow-md flex items-center justify-center">
                        ç¢ºèªæ›´æ”¹å¯†ç¢¼
                    </button>
                </form>
            </div>
            
            <p class="mt-6 text-center text-sm">
                <a href="#" id="backToLoginLink" class="text-blue-600 hover:text-blue-800 hover:underline transition duration-150">
                    &larr; è¿”å›
                </a>
            </p>
        </div>
    </div>

    <script>
        // 1. è¨­å®šå¾Œç«¯ API ç¶²å€
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';

        // æš«å­˜é©—è­‰é€šéçš„ä½¿ç”¨è€…è³‡æ–™ï¼Œä¾›ç¬¬äºŒæ­¥ä½¿ç”¨
        let verifiedUser = { email: '', idCard: '' };

        // --- åµæ¸¬å›è·³ç¶²å€é‚è¼¯ ---
        let targetLoginUrl = 'login.html'; 
        const urlParams = new URLSearchParams(window.location.search);
        const redirectUrl = urlParams.get('redirect'); 

        if (redirectUrl) {
            try {
                targetLoginUrl = decodeURIComponent(redirectUrl);
            } catch (e) {
                console.error("è§£ç¢¼å¤±æ•—", e);
            }
        }
        
        function showFormMessage(text, type) {
            const container = document.getElementById('messageContainer');
            container.textContent = text;
            container.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            
            if (type === 'success') container.classList.add('bg-green-100', 'text-green-800');
            else if (type === 'error') container.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'info') container.classList.add('bg-blue-100', 'text-blue-800');

            setTimeout(() => { container.classList.add('hidden'); }, 5000);
        }

        function checkPasswordFormat(password) {
            if (password.length < 8) return 'å¯†ç¢¼é•·åº¦å¿…é ˆè‡³å°‘ 8 å€‹å­—å…ƒã€‚';
            if (!/[a-zA-Z]/.test(password)) return 'å¯†ç¢¼å¿…é ˆåŒ…å«è‹±æ–‡å­—æ¯ã€‚';
            if (!/[0-9]/.test(password)) return 'å¯†ç¢¼å¿…é ˆåŒ…å«æ•¸å­—ã€‚';
            return null; 
        }

        const step1 = document.getElementById('step1_verification');
        const step2 = document.getElementById('step2_reset');
        const verificationForm = document.getElementById('verificationForm');
        const resetForm = document.getElementById('resetPasswordForm');
        const step1Button = document.getElementById('step1Button');
        const step2Button = document.getElementById('step2Button');
        const newPwdFormatError = document.getElementById('newPwdFormatError');
        const newPwdMatchError = document.getElementById('newPwdMatchError');
        
        function clearResetErrors() {
            newPwdFormatError.textContent = '';
            newPwdMatchError.textContent = '';
        }
        
        // --- æ­¥é©Ÿä¸€ï¼šå¸³è™Ÿé©—è­‰è™•ç† (å‘¼å« API) ---
        verificationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('memberEmail').value;
            const id = document.getElementById('memberId').value;
            
            if (id.length !== 10) {
                showFormMessage('âŒ èº«åˆ†è­‰å­—è™Ÿé•·åº¦å¿…é ˆæ˜¯ 10 ç¢¼ã€‚', 'error');
                return;
            }

            step1Button.disabled = true;
            step1Button.textContent = 'é©—è­‰ä¸­...';
            step1Button.classList.add('opacity-75', 'cursor-not-allowed');
            showFormMessage('æ­£åœ¨é©—è­‰æ‚¨çš„å¸³è™Ÿè³‡è¨Š...', 'info');
            
            try {
                // å‘¼å«å¾Œç«¯é©—è­‰ API
                const response = await fetch(`${API_BASE_URL}/auth/verify-account`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, idCard: id })
                });
                
                const result = await response.json();

                if (response.ok) {
                    showFormMessage('âœ… å¸³è™Ÿé©—è­‰æˆåŠŸï¼è«‹è¨­å®šæ‚¨çš„æ–°å¯†ç¢¼ã€‚', 'success');
                    
                    // æš«å­˜è³‡æ–™ï¼Œä¾›ç¬¬äºŒæ­¥ä½¿ç”¨
                    verifiedUser = { email: email, idCard: id };

                    // åˆ‡æ›ç•«é¢
                    setTimeout(() => {
                        step1.classList.add('hidden');
                        step2.classList.remove('hidden');
                        // æ¸…é™¤è¨Šæ¯ä»¥ä¾¿ç¬¬äºŒæ­¥é¡¯ç¤ºæ–°è¨Šæ¯
                        document.getElementById('messageContainer').classList.add('hidden');
                    }, 1000);
                } else {
                    showFormMessage(`âŒ ${result.message}`, 'error');
                }
            } catch (error) {
                console.error(error);
                showFormMessage('âŒ é€£ç·šä¼ºæœå™¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚', 'error');
            } finally {
                step1Button.disabled = false;
                step1Button.textContent = 'é©—è­‰å¸³è™Ÿ';
                step1Button.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        });

        // --- æ­¥é©ŸäºŒï¼šé‡è¨­å¯†ç¢¼è™•ç† (å‘¼å« API) ---
        resetForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            clearResetErrors(); 

            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            // 1. å¯†ç¢¼æ ¼å¼æª¢æŸ¥
            const formatError = checkPasswordFormat(newPass);
            if (formatError) {
                newPwdFormatError.textContent = 'âŒ ' + formatError;
                showFormMessage('âŒ æ–°å¯†ç¢¼ä¸ç¬¦åˆæ ¼å¼è¦æ±‚ã€‚', 'error');
                return;
            }

            // 2. å¯†ç¢¼ç¢ºèªæª¢æŸ¥
            if (newPass !== confirmPass) {
                newPwdMatchError.textContent = 'âŒ å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ã€‚';
                showFormMessage('âŒ å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ã€‚', 'error');
                return;
            }

            step2Button.disabled = true;
            step2Button.textContent = 'æ­£åœ¨æ›´æ”¹...';
            step2Button.classList.add('opacity-75', 'cursor-not-allowed');
            showFormMessage('æ­£åœ¨æ›´æ–°å¯†ç¢¼ï¼Œè«‹ç¨å€™...', 'info');

            try {
                // å‘¼å«å¾Œç«¯é‡è¨­ API
                const response = await fetch(`${API_BASE_URL}/auth/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: verifiedUser.email,
                        idCard: verifiedUser.idCard,
                        newPassword: newPass
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showFormMessage(`ğŸ‰ å¯†ç¢¼æ›´æ–°æˆåŠŸï¼è«‹ä½¿ç”¨æ–°å¯†ç¢¼ç™»å…¥ã€‚`, 'success');
                    resetForm.reset();
                    step2Button.textContent = 'å·²æˆåŠŸæ›´æ”¹';
                    
                    // å»¶é²è·³è½‰åˆ°ç™»å…¥é 
                    setTimeout(() => {
                        window.location.href = targetLoginUrl;
                    }, 2000);
                } else {
                    showFormMessage(`âŒ ${result.message}`, 'error');
                    step2Button.disabled = false;
                    step2Button.textContent = 'ç¢ºèªæ›´æ”¹å¯†ç¢¼';
                    step2Button.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error(error);
                showFormMessage('âŒ é€£ç·šä¼ºæœå™¨å¤±æ•—ã€‚', 'error');
                step2Button.disabled = false;
                step2Button.textContent = 'ç¢ºèªæ›´æ”¹å¯†ç¢¼';
                step2Button.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        });

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            const backLink = document.getElementById('backToLoginLink');
            if (backLink) {
                backLink.href = targetLoginUrl;
            }
        });
    </script>
    
</body>
</html>


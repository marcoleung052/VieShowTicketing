<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員登入 - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Tailwind 配置，確保顏色和字體與專案一致
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        /* 新增通知動畫 */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes fadeOutUp {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fadeOutUp 0.5s ease-in forwards; }

        /* 驗證碼文字樣式，模擬圖片效果 */
        .captcha-text {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* bg-gray-100 */
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 5px;
            padding: 5px 10px;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem;
            cursor: pointer;
            width: 120px; /* 模擬圖片寬度 */
            height: 40px; /* 模擬圖片高度 */
            color: #1f2937; /* text-gray-800 */
            user-select: none; /* 防止選中文字 */
            text-decoration: line-through; /* 模擬干擾線 */
            font-family: monospace;
            transform: rotate(-1deg); /* 輕微旋轉，更像 CAPTCHA */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow 影城</a>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-8 flex-grow">
        <div id="loginCard" class="max-w-lg mx-auto bg-white p-8 sm:p-10 rounded-xl shadow-2xl border-t-8 border-vieshow-red">
            
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
                會員登入
            </h2>

            <form id="loginForm" action="#" method="POST" class="space-y-5">

                <div>
                    <label for="loginAccount" class="block text-sm font-medium text-gray-700 mb-1">帳號/電子郵件:</label>
                    <input type="text" id="loginAccount" name="loginAccount" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-vieshow-red focus:border-vieshow-red transition duration-150"
                           placeholder="請輸入帳號或電子郵件">
                </div>

                <div>
                    <label for="loginPwd" class="block text-sm font-medium text-gray-700 mb-1">密碼:</label>
                    <input type="password" id="loginPwd" name="loginPwd" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-vieshow-red focus:border-vieshow-red transition duration-150"
                           placeholder="請輸入密碼">
                </div>

                <div class="text-right">
                    <a href="forget_password.html" class="text-sm text-blue-600 hover:text-vieshow-red transition duration-150 font-medium">忘記密碼?</a>
                </div>

                <div>
                    <label for="captchaCode" class="block text-sm font-medium text-gray-700 mb-1">驗證碼:</label>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="captchaCode" name="captchaCode" required maxlength="4"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-vieshow-red focus:border-vieshow-red transition duration-150 max-w-[150px]">
                        
                        <div id="captchaImage" class="captcha-text" title="點擊刷新驗證碼"></div>
                        
                        <button type="button" id="refreshCaptcha" title="重新整理驗證碼"
                                class="h-10 w-10 bg-vieshow-red text-white text-xl font-bold rounded-full flex items-center justify-center hover:bg-red-700 transition duration-300 shadow-md transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.564c.261-.595.399-1.295.399-2.265v-.1c0-1.076.326-2.074.885-2.887a1 1 0 011.666.273A8.98 8.98 0 0011 4.545V3a1 1 0 112 0v1.545a8.98 8.98 0 00-11 5.67V17a1 1 0 11-2 0V9.873c0-2.203 1.05-4.14 2.686-5.385A7.002 7.002 0 014 2.101V3a1 1 0 01-1-1zm6 16a7 7 0 100-14 7 7 0 000 14z" clip-rule="evenodd" />
                            </svg>
                        </button> 
                    </div>
                </div>

                <button type="submit" id="loginButton" class="w-full bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg mt-6 transform hover:-translate-y-0.5">
                    登入
                </button>

                <p class="text-center text-gray-600 mt-4">還沒有帳號？ 
                    <a href="register.html" class="text-vieshow-red font-semibold hover:text-red-700 transition duration-150">立即註冊</a>
                </p>
            </form>
        </div>
        
        <!-- <div id="loggedInMessage" class="max-w-lg mx-auto bg-green-50 p-10 sm:p-12 rounded-xl shadow-2xl border-t-8 border-green-500 hidden text-center">
            <svg class="mx-auto h-16 w-16 text-green-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-3xl font-extrabold text-green-700 mb-2">您已登入！</h2>
            <p class="text-lg text-gray-700 mb-6">您目前已是會員，無法重複登入。</p>
            <button id="goToMemberCenter" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md">
                前往會員中心 &rarr;
            </button>
        </div> -->
    </div>

    <script>
        const API_BASE_URL = 'https://your-fastapi-backend.com/api/v1'; 
        let currentCaptcha = ''; // 用於儲存當前模擬的驗證碼，用於前端比對
        
        // *** [新增/修正] 為了跳轉邏輯新增的常數 ***
        // 預設跳轉頁面 (當沒有指定 redirect 時)
        const DEFAULT_REDIRECT_URL = '../../index.html';
        // 會員中心路徑 (用於已登入訊息的按鈕和預設跳轉)
        const MEMBER_HOME_URL = '../member/member_home.html';
        // **********************************************

        // --- 1. 檢查是否已登入 (新增邏輯) ---
        // function checkLoginStatus() {
        //     // 檢查 localStorage 中是否有模擬的登入 token
        //     const token = localStorage.getItem('auth_token');
        //     const loginCard = document.getElementById('loginCard');
        //     const loggedInMessage = document.getElementById('loggedInMessage');

        //     if (token) {
        //         // 如果已登入，隱藏登入表單，顯示已登入訊息
        //         loginCard.classList.add('hidden');
        //         loggedInMessage.classList.remove('hidden');
        //     } else {
        //         // 如果未登入，顯示登入表單
        //         loginCard.classList.remove('hidden');
        //         loggedInMessage.classList.add('hidden');
        //     }
        // }

        // --- 2. 顯示模擬通知 (動畫效果) ---
        function showNotification(message, isError = false) {
            // ... (保持不變)
            const notification = document.createElement('div');
            notification.innerHTML = message; // 使用 innerHTML 允許簡單的標籤，例如粗體
            const bgColor = isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            
            notification.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg shadow-xl z-50 transition duration-300 transform ${bgColor} animate-fade-in-down`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.replace('animate-fade-in-down', 'animate-fade-out-up');
                setTimeout(() => notification.remove(), 500); // 讓淡出動畫完成
            }, 3000);
        }

        // --- 3. 驗證碼相關邏輯 (修正顯示問題並加入模擬比對) ---
        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let captcha = '';
            for (let i = 0; i < 4; i++) {
                captcha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return captcha;
        }

        function refreshCaptcha() {
            currentCaptcha = generateCaptcha();
            const captchaDiv = document.getElementById('captchaImage');
            captchaDiv.textContent = currentCaptcha;
            // 清空驗證碼輸入框
            document.getElementById('captchaCode').value = '';
            console.log('當前模擬驗證碼:', currentCaptcha);
        }
        
        // *** [新增] 處理登入成功後的頁面跳轉邏輯 ***
        function handleLoginSuccessRedirect() {
            // 1. 取得 URL 中的 redirect 參數
            const params = new URLSearchParams(window.location.search);
            const redirectUrl = params.get('redirect');
            
            // 2. 決定目標網址
            let targetUrl = DEFAULT_REDIRECT_URL; // 預設跳轉到會員中心

            if (redirectUrl) {
                // 如果有 redirect 參數，則使用該網址 (需要解碼)
                targetUrl = decodeURIComponent(redirectUrl);
                console.log("偵測到回調網址:", targetUrl);
            } else {
                console.log("未偵測到回調網址，使用預設目標:", targetUrl);
            }

            // 3. 執行跳轉
            showNotification('✅ 登入成功！即將跳轉...', false);
            
            setTimeout(() => {
                // 跳轉到目標網址
                window.location.href = targetUrl;
            }, 1500); // 延遲 1.5 秒
        }
        // **********************************************
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api'; // 請替換
        // --- 處理表單提交 (核心登入邏輯) ---
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            const form = event.target;
            const loginButton = document.getElementById('loginButton');
            const account = form.loginAccount.value;
            const password = form.loginPwd.value;
            const captchaInput = form.captchaCode.value.toUpperCase(); // 驗證碼輸入通常不區分大小寫

            // 1. 檢查前端驗證碼是否正確
            if (captchaInput !== currentCaptcha) {
                showNotification('❌ **驗證碼錯誤！** 請重新輸入。', true);
                refreshCaptcha(); // 驗證碼錯誤，強制刷新
                return;
            }

            // 禁用按鈕
            loginButton.disabled = true;
            loginButton.textContent = '登入中...';
            loginButton.classList.add('opacity-75', 'cursor-not-allowed');

            showNotification('正在驗證帳號資訊...', false);
            
            // 2. 模擬後端 API 請求
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account, password })
                });
        
                const result = await response.json();
        
                if (response.ok) {
                    // 登入成功：儲存 Token 與使用者資料
                    localStorage.setItem('auth_token', result.token);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    
                    showNotification('✅ 登入成功！即將跳轉...', false);
                    
                    // 檢查是否有 redirect 參數 (保持您原有的跳轉邏輯)
                    const params = new URLSearchParams(window.location.search);
                    const redirectUrl = params.get('redirect') ? decodeURIComponent(params.get('redirect')) : '../../index.html';
                    
                    setTimeout(() => { window.location.href = redirectUrl; }, 1500);
                } else {
                    // 登入失敗
                    showNotification(`❌ ${result.message}`, true);
                    refreshCaptcha();
                    loginButton.disabled = false;
                    loginButton.textContent = '登入';
                }
            } catch (error) {
                console.error('API Error:', error);
                showNotification('❌ 連線伺服器失敗，請稍後再試', true);
                loginButton.disabled = false;
                loginButton.textContent = '登入';
            }
        });

        // --- 初始化事件綁定 (已修正) ---
        window.onload = function() {
            //checkLoginStatus(); // 載入時檢查登入狀態
            refreshCaptcha(); // 初始化驗證碼
            
            // 綁定重新整理驗證碼事件到 Div (模擬圖片點擊)
            document.getElementById('captchaImage').addEventListener('click', refreshCaptcha);
            
            // 【修正處】：綁定重新整理驗證碼事件到 Button (圖標按鈕點擊)
            document.getElementById('refreshCaptcha').addEventListener('click', refreshCaptcha); 
            
            // 綁定已登入時的按鈕 (使用 MEMBER_HOME_URL)
            // document.getElementById('goToMemberCenter').addEventListener('click', () => {
            //     window.location.href = MEMBER_HOME_URL;
            // });
        };
    </script>
    
    <footer class="bg-gray-800 text-white p-4 mt-auto text-center text-sm">
        <p class="text-gray-400">&copy; 2025 Vieshow Ticketing System.</p>
    </footer>

</body>

</html>

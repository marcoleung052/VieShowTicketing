<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員登入 - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes fadeOutUp {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fadeOutUp 0.5s ease-in forwards; }

        .captcha-text {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; 
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 5px;
            padding: 5px 10px;
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem;
            cursor: pointer;
            width: 120px; 
            height: 40px; 
            color: #1f2937; 
            user-select: none; 
            text-decoration: line-through; 
            font-family: monospace;
            transform: rotate(-1deg); 
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow 影城</a>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-8 flex-grow">
        <div id="loginCard" class="max-w-lg mx-auto bg-white p-8 sm:p-10 rounded-xl shadow-2xl border-t-8 border-vieshow-red">
            
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
                會員登入
            </h2>

            <form id="loginForm" class="space-y-5">

                <div>
                    <label for="loginAccount" class="block text-sm font-medium text-gray-700 mb-1">帳號/電子郵件:</label>
                    <input type="text" id="loginAccount" name="loginAccount" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-vieshow-red focus:border-vieshow-red transition duration-150"
                           placeholder="請輸入帳號或電子郵件">
                </div>

                <div>
                    <label for="loginPwd" class="block text-sm font-medium text-gray-700 mb-1">密碼:</label>
                    <input type="password" id="loginPwd" name="loginPwd" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-vieshow-red focus:border-vieshow-red transition duration-150"
                           placeholder="請輸入密碼">
                </div>

                <div class="text-right">
                    <a href="forget_password.html" class="text-sm text-blue-600 hover:text-vieshow-red transition duration-150 font-medium">忘記密碼?</a>
                </div>

                <div>
                    <label for="captchaCode" class="block text-sm font-medium text-gray-700 mb-1">驗證碼:</label>
                    <div class="flex items-center space-x-3">
                        <input type="text" id="captchaCode" name="captchaCode" required maxlength="4"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-vieshow-red focus:border-vieshow-red transition duration-150 max-w-[150px]">
                        
                        <div id="captchaImage" class="captcha-text" title="點擊刷新驗證碼"></div>
                        
                        <button type="button" id="refreshCaptcha" title="重新整理驗證碼"
                                class="h-10 w-10 bg-vieshow-red text-white text-xl font-bold rounded-full flex items-center justify-center hover:bg-red-700 transition duration-300 shadow-md transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.564c.261-.595.399-1.295.399-2.265v-.1c0-1.076.326-2.074.885-2.887a1 1 0 011.666.273A8.98 8.98 0 0011 4.545V3a1 1 0 112 0v1.545a8.98 8.98 0 00-11 5.67V17a1 1 0 11-2 0V9.873c0-2.203 1.05-4.14 2.686-5.385A7.002 7.002 0 014 2.101V3a1 1 0 01-1-1zm6 16a7 7 0 100-14 7 7 0 000 14z" clip-rule="evenodd" />
                            </svg>
                        </button> 
                    </div>
                </div>

                <button type="submit" id="loginButton" class="w-full bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg mt-6 transform hover:-translate-y-0.5">
                    登入
                </button>

                <p class="text-center text-gray-600 mt-4">還沒有帳號？ 
                    <a href="register.html" class="text-vieshow-red font-semibold hover:text-red-700 transition duration-150">立即註冊</a>
                </p>
            </form>
        </div>
    </div>

    <script>
        // 設定後端 API 網址 (請確認您的網址)
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        
        let currentCaptcha = ''; 
        const DEFAULT_REDIRECT_URL = '../../index.html';
        
        // --- 顯示通知 ---
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.innerHTML = message;
            const bgColor = isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            notification.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg shadow-xl z-50 transition duration-300 transform ${bgColor} animate-fade-in-down`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.replace('animate-fade-in-down', 'animate-fade-out-up');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // --- 驗證碼邏輯 ---
        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let captcha = '';
            for (let i = 0; i < 4; i++) {
                captcha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return captcha;
        }

        function refreshCaptcha() {
            currentCaptcha = generateCaptcha();
            const captchaDiv = document.getElementById('captchaImage');
            captchaDiv.textContent = currentCaptcha;
            document.getElementById('captchaCode').value = '';
        }
        
        // --- 登入成功跳轉 ---
        function handleLoginSuccessRedirect() {
            const params = new URLSearchParams(window.location.search);
            const redirectUrl = params.get('redirect');
            let targetUrl = DEFAULT_REDIRECT_URL;

            if (redirectUrl) {
                try {
                    targetUrl = decodeURIComponent(redirectUrl);
                } catch (e) {
                    console.error('Redirect URL decode failed', e);
                }
            }

            showNotification('✅ 登入成功！即將跳轉...', false);
            
            setTimeout(() => {
                window.location.href = targetUrl;
            }, 1500);
        }

        // --- 處理登入 (呼叫後端 API) ---
        document.getElementById('loginForm').addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            const form = event.target;
            const loginButton = document.getElementById('loginButton');
            const account = form.loginAccount.value;
            const password = form.loginPwd.value;
            const captchaInput = form.captchaCode.value.toUpperCase();

            // 1. 檢查前端驗證碼
            if (captchaInput !== currentCaptcha) {
                showNotification('❌ **驗證碼錯誤！** 請重新輸入。', true);
                refreshCaptcha(); 
                return;
            }

            // 禁用按鈕
            loginButton.disabled = true;
            loginButton.textContent = '登入中...';
            loginButton.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                // 2. 呼叫後端登入 API
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account: account,
                        password: password
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // 登入成功
                    localStorage.setItem('auth_token', result.token);
                    // 【關鍵修正】儲存完整的 user 物件 (包含 id)
                    localStorage.setItem('user', JSON.stringify(result.user));
                    
                    handleLoginSuccessRedirect();
                } else {
                    // 登入失敗
                    showNotification(`❌ ${result.message}`, true);
                    refreshCaptcha();
                    loginButton.disabled = false;
                    loginButton.textContent = '登入';
                    loginButton.classList.remove('opacity-75', 'cursor-not-allowed');
                }

            } catch (error) {
                console.error(error);
                showNotification('❌ 連線伺服器失敗，請稍後再試', true);
                loginButton.disabled = false;
                loginButton.textContent = '登入';
                loginButton.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        });

        // --- 初始化 ---
        window.onload = function() {
            refreshCaptcha(); 
            document.getElementById('captchaImage').addEventListener('click', refreshCaptcha);
            document.getElementById('refreshCaptcha').addEventListener('click', refreshCaptcha); 
        };
    </script>
    
    <footer class="bg-gray-800 text-white p-4 mt-auto text-center text-sm">
        <p class="text-gray-400">&copy; 2025 Vieshow Ticketing System.</p>
    </footer>

</body>
</html>

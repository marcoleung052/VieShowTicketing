<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡è¨»å†Š - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Tailwind é…ç½®ï¼Œç¢ºä¿é¡è‰²å’Œå­—é«”èˆ‡å°ˆæ¡ˆä¸€è‡´
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'success-green': '#10b981', // Emerald 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    boxShadow: {
                        'vieshow': '0 10px 15px -3px rgba(229, 9, 20, 0.1), 0 4px 6px -2px rgba(229, 9, 20, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        /* æ–°å¢é€šçŸ¥å‹•ç•« */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -40px); }
            to { opacity: 1; transform: translate(-50%, 20px); }
        }
        @keyframes fadeOutUp {
            from { opacity: 1; transform: translate(-50%, 20px); }
            to { opacity: 0; transform: translate(-50%, -40px); }
        }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fadeOutUp 0.5s ease-in forwards; }

        /* ç¢ºä¿ body æœ€å°é«˜åº¦ä»¥ä½¿ç”¨ flex-grow */
        .min-h-screen {
            min-height: 100vh;
        }
        /* è¨»å†Šæ­¥é©Ÿå¡ç‰‡ */
        .register-card {
            display: none; /* é è¨­éš±è—æ‰€æœ‰æ­¥é©Ÿå¡ç‰‡ */
            max-width: 44rem; /* ç‚ºäº†å®¹ç´æˆåŠŸç¢ºèªé é¢è¼ƒå¯¬çš„å…§å®¹ */
        }
        .register-card:first-child {
            display: block; /* é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹æ­¥é©Ÿ */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
        </nav>
    </header>

    <div id="notification" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-xl text-white opacity-0 pointer-events-none transition-all duration-300" role="alert">
        </div>

    <main class="container mx-auto px-4 py-8 flex-grow flex items-center justify-center">
        
        <div id="registerCard" class="register-card w-full max-w-xl bg-white p-6 sm:p-10 rounded-2xl shadow-2xl border-t-8 border-vieshow-red transform transition-transform duration-300">
            
            <h2 class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-4 border-vieshow-red/50">
                æœƒå“¡è¨»å†Š
            </h2>

            <form id="registerForm" class="space-y-6">
                
                <div>
                    <label for="memberCardID" class="block text-sm font-medium text-gray-700 mb-1">èº«åˆ†è­‰å­—è™Ÿ:</label>
                    <div class="flex space-x-3">
                        <input type="text" id="memberCardID" name="memberCardID" required maxlength="10"
                            class="flex-grow p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm uppercase"
                            placeholder="è«‹è¼¸å…¥èº«åˆ†è­‰å­—è™Ÿ (10 ç¢¼)">
                        
                        <button type="button" id="checkIdButton"
                            class="shrink-0 px-4 py-2 text-sm font-medium rounded-xl bg-gray-200 text-gray-700 hover:bg-vieshow-gold hover:text-white transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            æª¢æŸ¥
                        </button>
                    </div>
                    <span class="error text-vieshow-red text-xs mt-1 block" id="idError"></span>
                </div>

                <div><label for="memberName" class="block text-sm font-medium text-gray-700 mb-1">å§“å:</label><input type="text" id="memberName" name="memberName" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å"></div>
                <div><label for="memberBirth" class="block text-sm font-medium text-gray-700 mb-1">ç”Ÿæ—¥:</label><input type="date" id="memberBirth" name="memberBirth" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm"></div>

                <div>
                    <label for="memberPhone" class="block text-sm font-medium text-gray-700 mb-1">è¡Œå‹•é›»è©±:</label>
                    <input type="tel" id="memberPhone" name="memberPhone" required pattern="09\d{8}" maxlength="10"
                        class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm"
                        placeholder="ä¾‹å¦‚: 0912345678">
                    <input type="tel" id="memberPhoneConfirm" name="memberPhoneConfirm" required maxlength="10"
                        class="w-full p-3 mt-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm"
                        placeholder="å†æ¬¡è¼¸å…¥è¡Œå‹•é›»è©±">
                    <span class="error text-vieshow-red text-xs mt-1 block" id="phoneMatchError"></span>
                </div>

                <div>
                    <label for="memberEmail" class="block text-sm font-medium text-gray-700 mb-1">é›»å­éƒµä»¶ (Email):</label>
                    <input type="email" id="memberEmail" name="memberEmail" required
                        class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm"
                        placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶">
                    <input type="email" id="memberEmailConfirm" name="memberEmailConfirm" required
                        class="w-full p-3 mt-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm"
                        placeholder="å†æ¬¡è¼¸å…¥é›»å­éƒµä»¶">
                    <span class="error text-vieshow-red text-xs mt-1 block" id="emailMatchError"></span>
                    <span class="error text-vieshow-red text-xs mt-1 block" id="emailError"></span>
                </div>

                <div>
                    <label for="memberPwd" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼ (è‹±æ•¸çµ„åˆï¼Œè‡³å°‘8ç¢¼):</label>
                    <input type="password" id="memberPwd" name="memberPwd" required minlength="8"
                        class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm"
                        placeholder="è¨­å®šæ‚¨çš„å¯†ç¢¼">
                    <span class="error text-vieshow-red text-xs mt-1 block" id="pwdFormatError"></span>
                </div>

                <div>
                    <label for="memberPwdConfirm" class="block text-sm font-medium text-gray-700 mb-1">ç¢ºèªå¯†ç¢¼:</label>
                    <input type="password" id="memberPwdConfirm" name="memberPwdConfirm" required
                        class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:border-vieshow-red transition duration-200 shadow-sm"
                        placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼">
                    <span class="error text-vieshow-red text-xs mt-1 block" id="pwdMatchError"></span>
                </div>
                
                <button type="submit" id="registerButton"
                    class="w-full bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg hover:shadow-xl hover:shadow-vieshow-red/40 transform hover:-translate-y-0.5 mt-8">
                    ä¸‹ä¸€æ­¥ï¼šç™¼é€å•Ÿç”¨ä¿¡ä»¶
                </button>

                <p class="text-center text-sm text-gray-600 mt-4">
                    å·²æ˜¯æœƒå“¡ï¼Ÿ <a href="login.html" class="text-vieshow-red font-semibold hover:text-vieshow-gold transition duration-300 hover:underline">ç«‹å³ç™»å…¥</a>
                </p>
            </form>
        </div>

        <div id="activationCard" class="register-card w-full max-w-lg bg-white p-6 sm:p-10 rounded-2xl shadow-2xl border-t-8 border-vieshow-gold hidden">
            <h2 class="text-3xl font-extrabold text-gray-900 mb-8 text-center border-b pb-4 border-vieshow-gold/50">
                å¸³è™Ÿå•Ÿç”¨
            </h2>
            <div class="space-y-4 text-center">
                <p class="text-lg text-gray-700">æˆ‘å€‘å·²å°‡ä¸€çµ„ **4 ä½æ•¸å­—ç¢ºèªç¢¼**å¯„é€è‡³æ‚¨çš„é›»å­éƒµä»¶ä¿¡ç®±ï¼š</p>
                <p id="sentEmailDisplay" class="text-vieshow-red font-bold text-xl"></p>
                <p class="text-sm text-gray-500">ï¼ˆåœ¨æ¨¡æ“¬æ¨¡å¼ä¸‹ï¼Œç¢ºèªç¢¼å°‡é¡¯ç¤ºæ–¼ Console ä¸­ã€‚ï¼‰</p>
                
                <form id="activationForm" class="space-y-4">
                    <label for="activationCode" class="block text-sm font-medium text-gray-700 pt-4">è¼¸å…¥ç¢ºèªç¢¼:</label>
                    <input type="text" id="activationCode" name="activationCode" required maxlength="4"
                        class="w-full max-w-xs mx-auto text-center p-3 border-2 border-vieshow-gold rounded-xl text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-vieshow-gold transition duration-200 shadow-md">
                    <span class="error text-vieshow-red text-xs mt-1 block" id="activationError"></span>
                    
                    <div class="flex flex-col space-y-3 pt-6">
                        <button type="submit"
                            class="bg-success-green hover:bg-green-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg transform hover:-translate-y-0.5">
                            ç¢ºèªä¸¦å•Ÿç”¨å¸³è™Ÿ
                        </button>
                        <button type="button" id="resendCode" class="text-sm text-gray-500 hover:text-vieshow-red transition duration-300">
                            é‡æ–°ç™¼é€ç¢ºèªç¢¼
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="successCard" class="register-card w-full max-w-xl bg-white p-6 sm:p-10 rounded-2xl shadow-2xl border-t-8 border-success-green hidden">
            <h2 class="text-3xl font-extrabold text-success-green mb-6 text-center">
                ğŸ‰ è¨»å†ŠæˆåŠŸï¼è³‡æ–™ç¢ºèª
            </h2>
            <p class="text-center text-gray-700 mb-8">æ­å–œæ‚¨æˆç‚º Vieshow æœƒå“¡ã€‚ä»¥ä¸‹æ˜¯æ‚¨çš„è¨»å†Šè³‡æ–™ï¼š</p>

            <div id="confirmationDetails" class="space-y-4 bg-gray-50 p-6 rounded-lg border">
                </div>

            <button id="goToLogin"
                class="w-full bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-lg mt-8 transform hover:-translate-y-0.5">
                å‰å¾€ç™»å…¥é é¢
            </button>
        </div>

    </main>

    <footer class="bg-gray-800 text-white p-4 mt-auto text-center text-sm">
        <p class="text-gray-400">&copy; 2025 Vieshow Ticketing System.</p>
    </footer>

    <script>
        // è¨­å®šæœªä¾† FastAPI å¾Œç«¯ API çš„åŸºç¤ URL
        const API_BASE_URL = 'https://your-fastapi-backend.com/api/v1'; 
        let currentActivationCode = ''; // æ¨¡æ“¬å„²å­˜çš„å•Ÿç”¨ç¢ºèªç¢¼ (éœ€æ±‚ 4)
        let memberData = {}; // æš«å­˜è¨»å†ŠæˆåŠŸçš„ç”¨æˆ¶è³‡æ–™ (éœ€æ±‚ 4, 5)
        let isIdChecked = false; // æ–°å¢ï¼šè¿½è¹¤èº«ä»½è­‰æ˜¯å¦å·²é€šéæª¢æŸ¥
        
        // æ¨¡æ“¬çš„è³‡æ–™åº«ç‹€æ…‹ (æ¨¡æ“¬æª¢æŸ¥èº«åˆ†è­‰æˆ–Emailæ˜¯å¦å·²å­˜åœ¨)
        const MOCK_DB = {
            idCards: ['A123456789'], // å·²è¨»å†Šçš„èº«ä»½è­‰ç¯„ä¾‹
            emails: ['registered@example.com'] // å·²è¨»å†Šçš„Emailç¯„ä¾‹
        };

        // --- è¼”åŠ©å‡½æ•¸ (ä¿æŒä¸è®Š) ---
        let notificationTimeout;
        function showNotification(message, type = 'error', duration = 3000) {
            const notification = document.getElementById('notification');
            clearTimeout(notificationTimeout);

            notification.className = 'fixed top-0 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-xl text-white pointer-events-none';
            if (type === 'success') {
                notification.classList.add('bg-green-600');
            } else if (type === 'warning') {
                notification.classList.add('bg-vieshow-gold');
            } else { // default to error
                notification.classList.add('bg-vieshow-red');
            }

            notification.innerHTML = `<strong>${type === 'success' ? 'âœ”' : (type === 'warning' ? 'âš ï¸' : 'âŒ')}</strong> ${message}`;
            
            notification.classList.remove('opacity-0', 'animate-fade-out-up');
            notification.classList.add('animate-fade-in-down');

            notificationTimeout = setTimeout(() => {
                notification.classList.remove('animate-fade-in-down');
                notification.classList.add('animate-fade-out-up');
            }, duration);
        }

        /**
         * é©—è­‰å°ç£èº«åˆ†è­‰å­—è™Ÿæ ¼å¼åŠæª¢æŸ¥ç¢¼ (éœ€æ±‚ 1)
         * @param {string} id - èº«åˆ†è­‰å­—è™Ÿ
         * @returns {boolean}
         */
        function isValidTwId(id) {
            const regex = /^[A-Z][12]\d{8}$/;
            if (!regex.test(id)) return false;

            const map = 'ABCDEFGHJKLMNPQRSTUVXYWZIO';
            const char = id.charAt(0);
            const index = map.indexOf(char) + 10;
            
            const n1 = Math.floor(index / 10);
            const n2 = index % 10;
            let sum = n1 * 1 + n2 * 9;

            for (let i = 1; i <= 8; i++) {
                sum += parseInt(id.charAt(i)) * (9 - i);
            }
            sum += parseInt(id.charAt(9)) * 1;
            
            return sum % 10 === 0;
        }

        /**
         * æª¢æŸ¥å¯†ç¢¼æ ¼å¼ (éœ€æ±‚ 3)
         * @param {string} password - å¯†ç¢¼
         * @returns {string | null} - éŒ¯èª¤è¨Šæ¯æˆ– null
         */
        function checkPasswordFormat(password) {
            if (password.length < 8) {
                return 'å¯†ç¢¼å¿…é ˆè‡³å°‘ 8 å€‹å­—å…ƒã€‚';
            }
            if (!/[a-zA-Z]/.test(password)) {
                return 'å¯†ç¢¼å¿…é ˆåŒ…å«è‹±æ–‡å­—æ¯ã€‚';
            }
            if (!/[0-9]/.test(password)) {
                return 'å¯†ç¢¼å¿…é ˆåŒ…å«æ•¸å­—ã€‚';
            }
            return null; // æ ¼å¼æ­£ç¢º
        }

        /**
         * éš¨æ©Ÿç”Ÿæˆ 4 ä½æ•¸å­—ç¢ºèªç¢¼ (éœ€æ±‚ 4)
         * @returns {string}
         */
        function generateActivationCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        /**
         * é¡¯ç¤ºæŒ‡å®šæ­¥é©Ÿå¡ç‰‡
         * @param {string} cardId - è¦é¡¯ç¤ºçš„å¡ç‰‡ ID ('registerCard', 'activationCard', 'successCard')
         */
        function showCard(cardId) {
            document.querySelectorAll('.register-card').forEach(card => {
                card.style.display = 'none';
            });
            document.getElementById(cardId).style.display = 'block';
            window.scrollTo(0, 0); // è·³è½‰æ™‚æ²å‹•åˆ°é ‚éƒ¨
        }

        // --- æ–°å¢ï¼šèº«åˆ†è­‰è™Ÿç¢¼ç¨ç«‹æª¢æŸ¥é‚è¼¯ ---
        function checkIdCard() {
            const idInput = document.getElementById('memberCardID');
            const idError = document.getElementById('idError');
            const idCard = idInput.value.trim().toUpperCase();
            const checkButton = document.getElementById('checkIdButton');

            idError.textContent = '';
            isIdChecked = false; // é‡è¨­æª¢æŸ¥ç‹€æ…‹
            checkButton.disabled = true; // æª¢æŸ¥æœŸé–“ç¦ç”¨æŒ‰éˆ•
            checkButton.textContent = 'æª¢æŸ¥ä¸­...';

            // æ¨¡æ“¬å¾Œç«¯å»¶é²æª¢æŸ¥
            setTimeout(() => {
                checkButton.disabled = false;
                checkButton.textContent = 'æª¢æŸ¥';

                if (idCard.length !== 10) {
                    idError.textContent = 'èº«åˆ†è­‰è™Ÿå¿…é ˆç‚º 10 ç¢¼ã€‚';
                    showNotification('èº«åˆ†è­‰è™Ÿç¢¼é•·åº¦éŒ¯èª¤ã€‚', 'error');
                    return;
                }

                // 1. æ ¼å¼æª¢æŸ¥ (éœ€æ±‚ 1)
                if (!isValidTwId(idCard)) {
                    idError.textContent = 'æ­¤è­‰è™Ÿé©—è­‰å¤±æ•—! è«‹ç¬¦åˆè¦æ±‚çš„æ ¼å¼!';
                    showNotification('èº«åˆ†è­‰æ ¼å¼é©—è­‰å¤±æ•—ã€‚', 'error');
                    return;
                }
                
                // 2. å­˜åœ¨æª¢æŸ¥ (æ¨¡æ“¬è³‡æ–™åº«æŸ¥è©¢) (éœ€æ±‚ 1)
                if (MOCK_DB.idCards.includes(idCard)) {
                    idError.textContent = 'æ­¤è­‰è™Ÿå·²ç‚ºæœƒå“¡! è«‹ç›´æ¥ç™»å…¥ã€‚';
                    showNotification('æ­¤èº«åˆ†è­‰è™Ÿå·²è¨»å†Šã€‚', 'error');
                    return;
                }

                // é©—è­‰æˆåŠŸ
                idError.textContent = 'âœ… èº«åˆ†è­‰è™Ÿæ ¼å¼æ­£ç¢ºä¸”æœªè¨»å†Šã€‚';
                idError.classList.remove('text-vieshow-red');
                idError.classList.add('text-success-green');
                isIdChecked = true;
                showNotification('èº«åˆ†è­‰è™Ÿé©—è­‰é€šéï¼', 'success');

                // è®“èº«åˆ†è­‰è™Ÿç¢¼ä¸èƒ½å†ä¿®æ”¹
                idInput.readOnly = true; 
            }, 1000); // æ¨¡æ“¬ 1 ç§’ API æª¢æŸ¥å»¶é²
        }


        // --- è™•ç†è¡¨å–®æäº¤ (æ­¥é©Ÿä¸€: è¨»å†Š) ---
        document.getElementById('registerForm').addEventListener('submit', function(event) {
            event.preventDefault(); 

            // æ¸…é™¤æ‰€æœ‰éŒ¯èª¤è¨Šæ¯ (é™¤äº†èº«åˆ†è­‰çš„æˆåŠŸè¨Šæ¯ï¼Œå¦‚æœæœ‰)
            document.querySelectorAll('.error:not(#idError)').forEach(el => el.textContent = '');
            
            // å¦‚æœç”¨æˆ¶æ²’æœ‰å…ˆæŒ‰æª¢æŸ¥æŒ‰éˆ•ï¼Œå‰‡å¼·åˆ¶åŸ·è¡Œä¸€æ¬¡æª¢æŸ¥
            if (!isIdChecked) {
                document.getElementById('idError').classList.remove('text-success-green');
                document.getElementById('idError').classList.add('text-vieshow-red');
                document.getElementById('idError').textContent = 'è«‹å…ˆé»æ“Šã€Œæª¢æŸ¥ã€æŒ‰éˆ•é©—è­‰èº«åˆ†è­‰è™Ÿã€‚';
                showNotification('è«‹å…ˆé©—è­‰èº«åˆ†è­‰è™Ÿç¢¼ã€‚', 'error');
                return;
            }

            const form = event.target;
            const data = {
                idCard: form.memberCardID.value.trim().toUpperCase(),
                name: form.memberName.value.trim(),
                birthDate: form.memberBirth.value,
                phone: form.memberPhone.value.trim(),
                phoneConfirm: form.memberPhoneConfirm.value.trim(),
                email: form.memberEmail.value.trim(),
                emailConfirm: form.memberEmailConfirm.value.trim(),
                password: form.memberPwd.value,
                passwordConfirm: form.memberPwdConfirm.value 
            };
            
            // --- å‰ç«¯é©—è­‰ (åªæª¢æŸ¥æœªè¢«ç¨ç«‹æª¢æŸ¥çš„æ¬„ä½) ---
            let hasError = false;
            
            // 1. é›»è©±é‡è¤‡ç¢ºèª (éœ€æ±‚ 2)
            if (data.phone !== data.phoneConfirm) {
                document.getElementById('phoneMatchError').textContent = 'è¡Œå‹•é›»è©±è¼¸å…¥ä¸ç›¸ç¬¦ã€‚';
                hasError = true;
            }

            // 2. Email é‡è¤‡ç¢ºèª (éœ€æ±‚ 2)
            if (data.email !== data.emailConfirm) {
                document.getElementById('emailMatchError').textContent = 'é›»å­éƒµä»¶è¼¸å…¥ä¸ç›¸ç¬¦ã€‚';
                hasError = true;
            } else if (MOCK_DB.emails.includes(data.email)) {
                document.getElementById('emailError').textContent = 'æ­¤ Email å·²è¢«è¨»å†Š!';
                hasError = true;
            }
            
            // 3. å¯†ç¢¼æ ¼å¼æª¢æŸ¥ (éœ€æ±‚ 3)
            const pwdErrorMsg = checkPasswordFormat(data.password);
            if (pwdErrorMsg) {
                document.getElementById('pwdFormatError').textContent = 'å¯†ç¢¼æ ¼å¼éŒ¯èª¤ï¼š' + pwdErrorMsg;
                hasError = true;
            }

            // 4. å¯†ç¢¼é‡è¤‡ç¢ºèª (éœ€æ±‚ 2)
            if (data.password !== data.passwordConfirm) {
                document.getElementById('pwdMatchError').textContent = 'å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç›¸ç¬¦ã€‚';
                hasError = true;
            }
            
            if (hasError) {
                showNotification('è«‹ä¿®æ­£è¡¨å–®ä¸­çš„éŒ¯èª¤å¾Œå†æäº¤ã€‚', 'error');
                return;
            }

            // --- æ¨¡æ“¬å¾Œç«¯è¨»å†Šæµç¨‹ (éœ€æ±‚ 4) ---
            const registerButton = document.getElementById('registerButton');
            registerButton.disabled = true;
            registerButton.textContent = 'è¨»å†Šä¸­ï¼Œè«‹ç¨å€™...';
            showNotification('è³‡æ–™é©—è­‰æˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆå•Ÿç”¨ç¢¼ä¸¦ç™¼é€éƒµä»¶...', 'warning', 4000);

            // æ¨¡æ“¬å¾Œç«¯å°‡è³‡æ–™å¯«å…¥è³‡æ–™åº«ä¸¦ç”Ÿæˆå•Ÿç”¨ç¢¼
            setTimeout(() => {
                memberData = {
                    idCard: data.idCard,
                    name: data.name,
                    birthDate: data.birthDate,
                    phone: data.phone,
                    email: data.email
                    // ä¸å„²å­˜å¯†ç¢¼
                };
                
                // ç”Ÿæˆç¢ºèªç¢¼
                currentActivationCode = generateActivationCode(); 
                
                // æ¨¡æ“¬å°‡ç¢ºèªç¢¼åŠ å…¥è³‡æ–™åº«
                console.log('--- MOCK DB --- è¨»å†Šè³‡æ–™å·²å„²å­˜ã€‚');
                console.warn(`ã€æ¨¡æ“¬éƒµä»¶ç™¼é€ã€‘å¸³è™Ÿå•Ÿç”¨ç¢ºèªç¢¼ï¼š${currentActivationCode}`); // åœ¨ Console é¡¯ç¤ºç¢ºèªç¢¼
                
                document.getElementById('sentEmailDisplay').textContent = data.email;
                
                // é€²å…¥æ­¥é©ŸäºŒ
                showCard('activationCard');

                showNotification('âœ… å•Ÿç”¨ä¿¡å·²ç™¼é€ï¼è«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®± (åŠ Console)ã€‚', 'success');
                
                // æ¢å¾©è¨»å†ŠæŒ‰éˆ•ç‹€æ…‹ (å¦‚æœéœ€è¦è¿”å›æ­¥é©Ÿä¸€çš„è©±)
                registerButton.disabled = false;
                registerButton.textContent = 'ä¸‹ä¸€æ­¥ï¼šç™¼é€å•Ÿç”¨ä¿¡ä»¶';

            }, 2500); // æ¨¡æ“¬ API å»¶é²
        });

        // --- è™•ç†è¡¨å–®æäº¤ (æ­¥é©ŸäºŒ: å•Ÿç”¨) ---
        document.getElementById('activationForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const inputCode = document.getElementById('activationCode').value.trim();
            document.getElementById('activationError').textContent = '';

            if (inputCode === currentActivationCode) {
                // å•Ÿç”¨æˆåŠŸ (éœ€æ±‚ 4)
                showNotification('ğŸ‰ å•Ÿç”¨æˆåŠŸï¼å¸³è™Ÿå·²æ­£å¼é–‹é€šã€‚', 'success', 4000);
                
                // æ¨¡æ“¬å°‡æœƒå“¡åŠ å…¥æ­£å¼ DB
                MOCK_DB.idCards.push(memberData.idCard);
                MOCK_DB.emails.push(memberData.email);

                // é€²å…¥æ­¥é©Ÿä¸‰ (ç¢ºèªé é¢)
                displayConfirmation();
                showCard('successCard');

            } else {
                // å•Ÿç”¨å¤±æ•—
                document.getElementById('activationError').textContent = 'âŒ ç¢ºèªç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚';
                showNotification('âŒ å•Ÿç”¨å¤±æ•—ï¼šç¢ºèªç¢¼éŒ¯èª¤ã€‚', 'error');
                document.getElementById('activationCode').value = '';
            }
        });

        // --- é‡æ–°ç™¼é€ç¢ºèªç¢¼ (æ­¥é©ŸäºŒ) ---
        document.getElementById('resendCode').addEventListener('click', function() {
            // é‡æ–°ç”Ÿæˆæ–°çš„ç¢ºèªç¢¼
            currentActivationCode = generateActivationCode();
            console.warn(`ã€é‡æ–°ç™¼é€æ¨¡æ“¬éƒµä»¶ã€‘æ–°çš„å¸³è™Ÿå•Ÿç”¨ç¢ºèªç¢¼ï¼š${currentActivationCode}`);
            showNotification('æ–°çš„ç¢ºèªç¢¼å·²é‡æ–°ç™¼é€è‡³ä¿¡ç®±ã€‚', 'warning');
        });

        // --- é¡¯ç¤ºè¨»å†ŠæˆåŠŸè³‡æ–™ (æ­¥é©Ÿä¸‰: ç¢ºèª) (éœ€æ±‚ 5) ---
        function displayConfirmation() {
            const container = document.getElementById('confirmationDetails');
            container.innerHTML = `
                <div class="flex justify-between border-b pb-2"><span class="font-medium text-gray-600">èº«åˆ†è­‰å­—è™Ÿ:</span> <span class="font-bold text-gray-800">${memberData.idCard}</span></div>
                <div class="flex justify-between border-b pb-2"><span class="font-medium text-gray-600">å§“å:</span> <span class="font-bold text-gray-800">${memberData.name}</span></div>
                <div class="flex justify-between border-b pb-2"><span class="font-medium text-gray-600">ç”Ÿæ—¥:</span> <span class="font-bold text-gray-800">${memberData.birthDate}</span></div>
                <div class="flex justify-between border-b pb-2"><span class="font-medium text-gray-600">è¡Œå‹•é›»è©±:</span> <span class="font-bold text-gray-800">${memberData.phone}</span></div>
                <div class="flex justify-between"><span class="font-medium text-gray-600">é›»å­éƒµä»¶:</span> <span class="font-bold text-gray-800">${memberData.email}</span></div>
            `;
        }
        
        // --- è·³è½‰åˆ°ç™»å…¥é é¢ (æ­¥é©Ÿä¸‰) ---
        document.getElementById('goToLogin').addEventListener('click', () => {
             // æ¸…é™¤æš«å­˜è³‡æ–™ï¼Œæ¨¡æ“¬è¨»å†Šæµç¨‹çµæŸ
            memberData = {}; 
            currentActivationCode = '';
            window.location.href = 'login.html'; 
        });

        // --- åˆå§‹åŒ–äº‹ä»¶ç¶å®š ---
        document.addEventListener('DOMContentLoaded', () => {
            // ç¶å®šæ–°çš„èº«åˆ†è­‰æª¢æŸ¥æŒ‰éˆ•äº‹ä»¶
            document.getElementById('checkIdButton').addEventListener('click', checkIdCard);

            // è®“èº«åˆ†è­‰è¼¸å…¥æ¡†çš„å€¼æ”¹è®Šæ™‚ï¼Œé‡ç½®æª¢æŸ¥ç‹€æ…‹
            document.getElementById('memberCardID').addEventListener('input', () => {
                const idInput = document.getElementById('memberCardID');
                const idError = document.getElementById('idError');
                
                idInput.readOnly = false; // é‡æ–°å•Ÿç”¨ç·¨è¼¯
                isIdChecked = false; // é‡ç½®æª¢æŸ¥ç‹€æ…‹
                idError.textContent = ''; // æ¸…é™¤è¨Šæ¯
                idError.classList.remove('text-success-green');
                idError.classList.add('text-vieshow-red');
            });
        });
    </script>
</body>
</html>
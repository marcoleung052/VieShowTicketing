<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡ä¸­å¿ƒ - Vieshow Ticketing</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        /* å¡ç‰‡åŸºç¤æ¨£å¼ */
        .menu-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px; /* å›ºå®šé«˜åº¦ï¼Œè®“å¡ç‰‡çœ‹èµ·ä¾†æ•´é½Š */
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 700;
            font-size: 1.125rem; /* text-lg */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .menu-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
        }

        /* ç™½åº•æ¨£å¼ (ä¸€èˆ¬æŒ‰éˆ•) */
        .card-white {
            background-color: white;
            color: #374151; /* text-gray-700 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .card-white:hover {
            border-color: #d1d5db;
            background-color: #f9fafb;
        }

        /* ç´…åº•æ¨£å¼ (å¼·èª¿æŒ‰éˆ•) */
        .card-red {
            background-color: #e50914; /* vieshow-red */
            color: white;
            border: 1px solid #e50914;
        }
        .card-red:hover {
            background-color: #b91c1c; /* darker red */
        }

        /* icon å¤§å° */
        .card-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes fadeOutUp { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -20px); } }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fadeOutUp 0.5s ease-in forwards; }

        .barcode-container {
            min-height: 8rem; 
            display: flex;
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            border: 1px solid #ccc; 
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4 flex items-center">
                <span class="text-sm font-medium">æ­¡è¿ï¼Œ<span id="memberName">è¼‰å…¥ä¸­...</span></span>
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-10 flex-grow max-w-6xl">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-vieshow-gold sticky top-4">
                    <h1 class="text-2xl font-extrabold text-gray-800 mb-6 flex items-center border-b pb-4">
                        <span class="mr-2">ğŸ‘¤</span> æœƒå“¡ä¸­å¿ƒ
                    </h1>

                    <div class="space-y-4 text-gray-700">
                        <div>
                            <p class="text-xs text-gray-500 uppercase">å§“å Name</p>
                            <p id="profile_name" class="font-bold text-lg">Loading...</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase">é›»å­éƒµä»¶ Email</p>
                            <p id="profile_email" class="font-medium break-all">Loading...</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase">é›»è©± Phone</p>
                            <p id="profile_phone" class="font-medium">Loading...</p>
                        </div>
                        
                        <div class="bg-red-50 p-4 rounded-lg border border-red-100 mt-4">
                            <p class="text-xs text-red-600 font-bold uppercase">ç›®å‰é»æ•¸ Points</p>
                            <div class="flex justify-between items-end">
                                <p class="text-3xl font-extrabold text-vieshow-red" id="profile_points">0</p>
                                <span class="text-sm text-gray-500 mb-1">é»</span>
                            </div>
                        </div>

                        <div class="pt-4 mt-2 border-t">
                            <p class="text-xs text-gray-500 uppercase mb-2 text-center">æœƒå“¡æ¢ç¢¼ Member Code</p>
                            <div id="barcodeContainer" class="barcode-container">
                                <svg id="member-barcode" class="w-full h-auto"></svg>
                            </div>
                            <p id="profile_member_id" class="text-center font-mono text-sm mt-1 text-gray-400 tracking-wider"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    
                    <a href="../../index.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ </span>
                        <span>é¦–é </span>
                    </a>

                    <a href="../booking/booking_flow_1.html" class="menu-card card-red">
                        <span class="card-icon">ğŸ«</span>
                        <span>ç«‹å³è¨‚ç¥¨</span>
                    </a>

                    <a href="../booking/booking_history.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ§¾</span>
                        <span>è¨‚ç¥¨ç´€éŒ„</span>
                    </a>

                    <a href="../points/point_history.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ“œ</span>
                        <span>é»æ•¸ç´€éŒ„</span>
                    </a>

                    <a href="../points/point_exchange.html" class="menu-card card-white">
                        <span class="card-icon">ğŸª™</span>
                        <span>é»æ•¸å…Œæ›</span>
                    </a>

                    <a href="./topup.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ’³</span>
                        <span>é»æ•¸å„²å€¼</span>
                    </a>

                    <a href="./member_profile.html" class="menu-card card-white">
                        <span class="card-icon">âš™ï¸</span>
                        <span>æœƒå“¡è³‡æ–™ä¿®æ”¹</span>
                    </a>

                    <button id="signOutButton" class="menu-card card-red w-full">
                        <span class="card-icon">â¡ï¸</span>
                        <span>ç™»å‡º</span>
                    </button>

                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const INDEX_PAGE_URL = '../../index.html';

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.innerHTML = message;
            const bgColor = isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            notification.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg shadow-xl z-50 transition duration-300 transform ${bgColor} animate-fade-in-down`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.replace('animate-fade-in-down', 'animate-fade-out-up');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function checkLoginStatus() {
            const token = localStorage.getItem('auth_token');
            const userStr = localStorage.getItem('user');
            if (!token || !userStr) {
                forceLogout("æ‚¨å°šæœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥");
                return null;
            }
            try {
                const user = JSON.parse(userStr);
                if (!user.id) {
                    forceLogout("ç™»å…¥è³‡æ–™éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ä»¥æ›´æ–°ç³»çµ±");
                    return null;
                }
                return user;
            } catch (e) {
                forceLogout("æœƒå“¡è³‡æ–™ç•°å¸¸ï¼Œè«‹é‡æ–°ç™»å…¥");
                return null;
            }
        }

        function forceLogout(msg) {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('memberDataCache');
            alert(msg, () => { window.location.href = LOGIN_PAGE_URL; });
        }
        
        async function fetchAndRenderMemberData(userId) {
            // å„ªå…ˆæª¢æŸ¥ Session Storage å¿«å–
            const cachedDataStr = sessionStorage.getItem('memberDataCache');
            if (cachedDataStr) {
                try {
                    const cachedData = JSON.parse(cachedDataStr);
                    if (cachedData.memberId === userId || cachedData.cardId === userId) {
                        console.log("âš¡ ä½¿ç”¨å¿«å–æœƒå“¡è³‡æ–™");
                        renderPage(cachedData);
                        return;
                    }
                } catch(e) {}
            }

            try {
                const response = await fetch(`${API_BASE_URL}/member/profile?id=${userId}`);
                if (!response.ok) {
                    if (response.status === 404) throw new Error('æ‰¾ä¸åˆ°æ­¤æœƒå“¡');
                    throw new Error('ä¼ºæœå™¨éŒ¯èª¤');
                }
                
                const memberData = await response.json();
                
                // æ›´æ–°å¿«å–
                sessionStorage.setItem('memberDataCache', JSON.stringify(memberData));

                renderPage(memberData);

            } catch (error) {
                console.error("API Error:", error);
                showNotification('ç„¡æ³•è¼‰å…¥æœƒå“¡è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦', true);
            }
        }

        function renderPage(memberData) {
            document.getElementById('memberName').textContent = memberData.name;
            // document.getElementById('memberGreetingName').textContent = memberData.name; // ç§»é™¤ï¼Œç‰ˆé¢èª¿æ•´
            document.getElementById('profile_name').textContent = memberData.name;
            document.getElementById('profile_email').textContent = memberData.email;
            document.getElementById('profile_phone').textContent = memberData.phone;
            // document.getElementById('profile_dob').textContent = memberData.dob; // ç‰ˆé¢ç²¾ç°¡ï¼Œå¯ä¸é¡¯ç¤ºç”Ÿæ—¥
            document.getElementById('profile_points').textContent = memberData.points.toLocaleString();
            document.getElementById('profile_member_id').textContent = memberData.memberId;
            
            const barcodeValue = memberData.memberId || '0000000000';
            
            JsBarcode("#member-barcode", barcodeValue, {
                format: "CODE128", 
                lineColor: "#000",
                width: 2,
                height: 50,
                displayValue: true, 
                fontSize: 14,
                fontOptions: "bold",
                margin: 0
            });
        }

        document.getElementById('signOutButton').addEventListener('click', function(e) {
            e.preventDefault(); 
            this.disabled = true; this.innerHTML = '<span class="mr-2">...</span> ç™»å‡ºä¸­';
            localStorage.removeItem('auth_token'); 
            localStorage.removeItem('user'); 
            sessionStorage.removeItem('memberDataCache'); 
            showNotification('âœ… ç™»å‡ºæˆåŠŸï¼å³å°‡å°å‘é¦–é ...', false);
            setTimeout(() => { window.location.href = INDEX_PAGE_URL; }, 2000);
        });
        
        function alert(message, callback) { 
            const d = document.createElement('div');
            d.innerHTML = `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl"><p class="mb-4 font-bold text-gray-800">${message}</p><button class="bg-vieshow-red text-white px-4 py-2 rounded" onclick="this.closest('.fixed').remove(); if(${callback}) ${callback}()">ç¢ºå®š</button></div></div>`;
            document.body.appendChild(d.firstChild);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const user = checkLoginStatus();
            if (user) {
                await fetchAndRenderMemberData(user.id);
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡ä¸­å¿ƒ - Vieshow Ticketing</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        /* å¡ç‰‡åŸºç¤æ¨£å¼ */
        .menu-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1.125rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            text-decoration: none; /* ç¢ºä¿é€£çµç„¡åº•ç·š */
        }
        .menu-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.15);
        }

        /* ç™½åº•æŒ‰éˆ• */
        .card-white {
            background-color: white;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        .card-white:hover {
            border-color: #d1d5db;
            background-color: #f9fafb;
        }

        /* ç´…åº•æŒ‰éˆ• */
        .card-red {
            background-color: #e50914;
            color: white;
            border: 1px solid #e50914;
        }
        .card-red:hover {
            background-color: #b91c1c;
        }

        .card-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        
        /* æ¢ç¢¼å®¹å™¨ */
        .barcode-container {
            min-height: 8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        /* é€šçŸ¥å‹•ç•« */
        @keyframes fadeInDown { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes fadeOutUp { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -20px); } }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fadeOutUp 0.5s ease-in forwards; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4 flex items-center">
                <span class="text-sm font-medium">æ­¡è¿ï¼Œ<span id="memberName">è¼‰å…¥ä¸­...</span></span>
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-10 flex-grow max-w-7xl">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-vieshow-gold sticky top-4">
                    <h1 class="text-2xl font-extrabold text-gray-800 mb-6 flex items-center border-b pb-4">
                        <span class="mr-2">ğŸ‘¤</span> æœƒå“¡ä¸­å¿ƒ
                    </h1>

                    <div class="space-y-4 text-gray-700">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">å§“å Name</p>
                            <p id="profile_name" class="font-bold text-lg">Loading...</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">é›»å­éƒµä»¶ Email</p>
                            <p id="profile_email" class="font-medium break-all">Loading...</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">é›»è©± Phone</p>
                            <p id="profile_phone" class="font-medium">Loading...</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">ç”Ÿæ—¥ Birthday</p>
                            <p id="profile_dob" class="font-medium">Loading...</p>
                        </div>
                        
                        <div class="bg-red-50 p-4 rounded-lg border border-red-100 mt-4">
                            <p class="text-xs text-red-600 font-bold uppercase">ç›®å‰é»æ•¸ Points</p>
                            <div class="flex justify-between items-end">
                                <p class="text-3xl font-extrabold text-vieshow-red" id="profile_points">0</p>
                                <span class="text-sm text-gray-500 mb-1">é»</span>
                            </div>
                        </div>

                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">æœƒå“¡ç·¨è™Ÿ Member ID</p>
                            <p id="profile_member_id" class="font-mono text-lg font-bold tracking-wider text-gray-800">Loading...</p>
                        </div>

                        <div class="pt-4 mt-2 border-t">
                            <p class="text-xs text-gray-500 uppercase mb-2 text-center font-bold">æœƒå“¡æ¢ç¢¼ Member Code</p>
                            <div id="barcodeContainer" class="barcode-container">
                                <svg id="member-barcode" class="w-full h-auto"></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-l-4 border-vieshow-red pl-3">
                    å¿«é€ŸåŠŸèƒ½å°è¦½
                </h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    
                    <a href="../../index.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ </span>
                        <span>é¦–é </span>
                    </a>

                    <a href="javascript:void(0)" onclick="goToBookingReset()" class="menu-card card-red">
                        <span class="card-icon">ğŸ«</span>
                        <span>ç«‹å³è¨‚ç¥¨</span>
                    </a>

                    <a href="../booking/booking_history.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ§¾</span>
                        <span>è¨‚ç¥¨ç´€éŒ„</span>
                    </a>

                    <a href="../points/point_history.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ“œ</span>
                        <span>é»æ•¸ç´€éŒ„</span>
                    </a>

                    <a href="../points/point_exchange.html" class="menu-card card-white">
                        <span class="card-icon">ğŸª™</span>
                        <span>é»æ•¸å…Œæ›</span>
                    </a>

                    <a href="./topup.html" class="menu-card card-white">
                        <span class="card-icon">ğŸ’³</span>
                        <span>é»æ•¸å„²å€¼</span>
                    </a>

                    <a href="./member_profile.html" class="menu-card card-white">
                        <span class="card-icon">âš™ï¸</span>
                        <span>æœƒå“¡è³‡æ–™ä¿®æ”¹</span>
                    </a>

                    <button id="signOutButton" class="menu-card card-red w-full">
                        <span class="card-icon">â¡ï¸</span>
                        <span>ç™»å‡º</span>
                    </button>

                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const INDEX_PAGE_URL = '../../index.html';

        // --- é€šçŸ¥ç³»çµ± ---
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.innerHTML = message;
            const bgColor = isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            notification.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg shadow-xl z-50 transition duration-300 transform ${bgColor} animate-fade-in-down`;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.replace('animate-fade-in-down', 'animate-fade-out-up');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // --- ç™»å…¥æª¢æŸ¥ (ä¿®æ­£ç‰ˆï¼šæœªç™»å…¥æ™‚è·³ Alert) ---
        function checkLoginStatus() {
            const token = localStorage.getItem('auth_token');
            const userStr = localStorage.getItem('user');

            if (!token || !userStr) {
                // ã€é—œéµä¿®æ­£ã€‘ä½¿ç”¨ Alert æç¤ºä¸¦è·³è½‰
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æœƒå“¡ä¸­å¿ƒ', () => {
                    window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`;
                });
                return null;
            }

            try {
                const user = JSON.parse(userStr);
                if (!user.id) {
                    forceLogout("ç™»å…¥è³‡æ–™éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ä»¥æ›´æ–°ç³»çµ±");
                    return null;
                }
                return user;
            } catch (e) {
                forceLogout("æœƒå“¡è³‡æ–™ç•°å¸¸ï¼Œè«‹é‡æ–°ç™»å…¥");
                return null;
            }
        }

        function forceLogout(msg) {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('memberDataCache');
            alert(msg, () => { window.location.href = LOGIN_PAGE_URL; });
        }
        
        // --- è³‡æ–™è¼‰å…¥ ---
        async function fetchAndRenderMemberData(userId) {
            // å„ªå…ˆæª¢æŸ¥ Session Storage å¿«å–
            const cachedDataStr = sessionStorage.getItem('memberDataCache');
            if (cachedDataStr) {
                try {
                    const cachedData = JSON.parse(cachedDataStr);
                    if (cachedData.memberId === userId || cachedData.cardId === userId) {
                        console.log("âš¡ ä½¿ç”¨å¿«å–æœƒå“¡è³‡æ–™");
                        renderPage(cachedData);
                        return;
                    }
                } catch(e) {}
            }

            try {
                const response = await fetch(`${API_BASE_URL}/member/profile?id=${userId}`);
                if (!response.ok) {
                    if (response.status === 404) throw new Error('æ‰¾ä¸åˆ°æ­¤æœƒå“¡');
                    throw new Error('ä¼ºæœå™¨éŒ¯èª¤');
                }
                
                const memberData = await response.json();
                
                // æ›´æ–°å¿«å–
                sessionStorage.setItem('memberDataCache', JSON.stringify(memberData));

                renderPage(memberData);

            } catch (error) {
                console.error("API Error:", error);
                showNotification('ç„¡æ³•è¼‰å…¥æœƒå“¡è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦', true);
            }
        }

        function renderPage(memberData) {
            document.getElementById('memberName').textContent = memberData.name;
            document.getElementById('profile_name').textContent = memberData.name;
            document.getElementById('profile_email').textContent = memberData.email;
            document.getElementById('profile_phone').textContent = memberData.phone;
            document.getElementById('profile_dob').textContent = memberData.dob;
            document.getElementById('profile_points').textContent = memberData.points.toLocaleString();
            document.getElementById('profile_member_id').textContent = memberData.memberId;
            
            const barcodeValue = memberData.memberId || '0000000000';
            
            JsBarcode("#member-barcode", barcodeValue, {
                format: "CODE128", 
                lineColor: "#000",
                width: 2,
                height: 50,
                displayValue: true, 
                fontSize: 14,
                fontOptions: "bold",
                margin: 0
            });
        }

        // --- ç™»å‡ºæŒ‰éˆ• ---
        document.getElementById('signOutButton').addEventListener('click', function(e) {
            e.preventDefault(); 
            this.disabled = true; 
            // é¿å…åœ–æ¨™æ¶ˆå¤±ï¼Œä¿ç•™çµæ§‹
            this.innerHTML = `<span class="card-icon animate-spin">â³</span><span>ç™»å‡ºä¸­...</span>`;
            
            localStorage.removeItem('auth_token'); 
            localStorage.removeItem('user'); 
            sessionStorage.removeItem('memberDataCache'); 
            
            // ä½¿ç”¨ alert ä¸¦åœ¨ callback ä¸­è·³è½‰
            alert('âœ… ç™»å‡ºæˆåŠŸï¼å³å°‡å°å‘é¦–é ...', () => {
                window.location.href = INDEX_PAGE_URL;
            });
        });
        function goToBookingReset() {
            // 1. æ¸…é™¤é é¸é›»å½± (é—œéµ)
            sessionStorage.removeItem('preSelectedMovie');
            
            // 2. æ¸…é™¤ä¹‹å‰çš„è¨‚å–®æš«å­˜ (å¯é¸ï¼Œè¦–éœ€æ±‚è€Œå®šï¼Œä½†æ¸…é™¤æ¯”è¼ƒä¹¾æ·¨)
            localStorage.removeItem('currentBooking');
            sessionStorage.removeItem('returnFromStep2Data');

            // 3. è·³è½‰
            window.location.href = '../booking/booking_flow_1.html';
        }
        // --- ä¿®æ­£å¾Œçš„è‡ªå®šç¾© Alert å‡½å¼ ---
        function alert(message, callback) { 
            // 1. å»ºç«‹å¤–å±¤å®¹å™¨
            const d = document.createElement('div');
            
            // 2. è¨­å®š HTML å…§å®¹ (ç§»é™¤ onclick ä¸­çš„ JS é‚è¼¯)
            d.innerHTML = `
                <div id="custom-alert-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl min-w-[300px]">
                        <p class="mb-6 font-bold text-gray-800 text-lg">${message}</p>
                        <div class="flex justify-end">
                            <button id="custom-alert-btn" class="bg-vieshow-red text-white px-6 py-2 rounded hover:bg-red-700 transition duration-200">
                                ç¢ºå®š
                            </button>
                        </div>
                    </div>
                </div>`;
            
            // 3. å°‡ç”Ÿæˆçš„å…ƒç´ åŠ å…¥ DOM
            const modalElement = d.firstElementChild;
            document.body.appendChild(modalElement);

            // 4. ä½¿ç”¨ addEventListener ç¶å®šäº‹ä»¶ (è§£æ±º callback ç„¡æ³•åŸ·è¡Œçš„å•é¡Œ)
            const confirmBtn = modalElement.querySelector('#custom-alert-btn');
            confirmBtn.addEventListener('click', function() {
                modalElement.remove(); // ç§»é™¤è¦–çª—
                if (callback && typeof callback === 'function') {
                    callback(); // åŸ·è¡Œè·³è½‰
                }
            });
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', async () => {
            const user = checkLoginStatus();
            if (user) {
                await fetchAndRenderMemberData(user.id);
            }
        });
        
    </script>
</body>
</html>


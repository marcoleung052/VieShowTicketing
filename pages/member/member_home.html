<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡ä¸­å¿ƒ - Vieshow Ticketing</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">

    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        .btn-action {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            height: 100%; 
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid transparent;
        }
        .btn-action span.icon {
            font-size: 1.5rem; 
            margin-bottom: 0.5rem;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-logout-action {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .btn-logout-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* é€šçŸ¥å‹•ç•« */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        @keyframes fadeOutUp {
            from { opacity: 1; transform: translate(-50%, 0); }
            to { opacity: 0; transform: translate(-50%, -20px); }
        }
        .animate-fade-in-down { animation: fadeInDown 0.5s ease-out forwards; }
        .animate-fade-out-up { animation: fadeOutUp 0.5s ease-in forwards; }

        .barcode-container {
            height: 10rem; 
            display: flex;
            align-items: center; 
            justify-content: center;
            border: 1px solid #ccc; 
            border-radius: 0.5rem;
            padding: 10px;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .barcode-display {
            font-family: 'Libre Barcode 128', monospace;
            font-size: 80px; 
            text-align: center;
            line-height: 1;
            display: block;
            margin: 0 auto;
            max-width: 100%;
            overflow-x: hidden;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'btn-primary': '#4f46e5',
                        'btn-hover': '#4338ca',
                        'btn-danger': '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4 flex items-center">
                <span class="text-sm font-medium">æ­¡è¿ï¼Œ<span id="memberName">è¼‰å…¥ä¸­...</span></span>
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-10 flex-grow max-w-6xl">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-vieshow-gold member-details-container">
                <h1 class="text-3xl font-extrabold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">ğŸ‘¤</span> æœƒå“¡ä¸­å¿ƒé¦–é  
                    <span class="text-base font-normal ml-3 text-gray-500">(Hi, <span id="memberGreetingName"></span>)</span>
                </h1>

                <div class="space-y-3 text-lg text-gray-700">
                    <h2 class="text-xl font-bold border-b pb-1 mb-2 text-vieshow-red">æœƒå“¡è³‡æ–™:</h2>
                    
                    <p>
                        <span class="font-semibold text-gray-600 w-20 inline-block">å§“å:</span> 
                        <span id="profile_name" class="font-bold"></span>
                    </p>
                    <p>
                        <span class="font-semibold text-gray-600 w-20 inline-block">Email:</span> 
                        <span id="profile_email"></span>
                    </p>
                    <p>
                        <span class="font-semibold text-gray-600 w-20 inline-block">é›»è©±:</span> 
                        <span id="profile_phone"></span>
                    </p>
                    <p>
                        <span class="font-semibold text-gray-600 w-20 inline-block">ç”Ÿæ—¥:</span> 
                        <span id="profile_dob"></span>
                    </p>
                    <p>
                        <span class="font-semibold text-gray-600 w-20 inline-block">å›é¥‹é»æ•¸:</span> 
                        <span id="profile_points" class="text-vieshow-gold font-bold text-xl"></span>
                        <span class="ml-1 text-sm text-gray-500">é»</span>
                    </p>
                    <p>
                        <span class="font-semibold text-gray-600 w-20 inline-block">æœƒå“¡ç·¨è™Ÿ:</span> 
                        <span id="profile_member_id" class="font-mono tracking-widest"></span>
                    </p>
                    
                    <div class="pt-4">
                        <h3 class="font-semibold mb-1 text-gray-600">æœƒå“¡æ¢ç¢¼:</h3>
                        <div id="barcodeContainer" class="barcode-container">
                            <span id="barcodeValue" class="barcode-display"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-bold text-gray-700 mb-4 border-l-4 border-vieshow-red pl-3">å¿«é€ŸåŠŸèƒ½å°è¦½</h2>

                <div class="member-actions grid grid-cols-2 gap-4">

                    <a href="../../index.html" class="btn-action bg-white text-gray-700 border-gray-300 hover:bg-gray-100">
                        <span class="icon" role="img" aria-label="Home">ğŸ </span> é¦–é 
                    </a>

                    <a href="../booking/booking_flow_1.html" class="btn-action bg-vieshow-red text-white hover:bg-red-700">
                        <span class="icon" role="img" aria-label="Ticket">ğŸ«</span> ç«‹å³è¨‚ç¥¨
                    </a>

                    <a href="../booking/booking_history.html" class="btn-action bg-white text-gray-700 border-gray-300 hover:bg-gray-100">
                        <span class="icon" role="img" aria-label="History">ğŸ§¾</span> è¨‚ç¥¨ç´€éŒ„
                    </a>

                    <a href="../points/point_exchange.html" class="btn-action bg-white text-gray-700 border-gray-300 hover:bg-gray-100">
                        <span class="icon" role="img" aria-label="Coin">ğŸª™</span> é»æ•¸å…Œæ›
                    </a>

                    <a href="./topup.html" class="btn-action bg-white text-gray-700 border-gray-300 hover:bg-gray-100">
                        <span class="icon" role="img" aria-label="Card">ğŸ’³</span> é»æ•¸å„²å€¼
                    </a>

                    <a href="./member_profile.html" class="btn-action bg-white text-gray-700 border-gray-300 hover:bg-gray-100">
                        <span class="icon" role="img" aria-label="Settings">âš™ï¸</span> æœƒå“¡è³‡æ–™ä¿®æ”¹
                    </a>
                </div>
                
                <button id="signOutButton" class="btn-logout-action bg-btn-danger text-white hover:bg-red-600 mt-6 w-full"> 
                    <span class="mr-2 text-xl">â¡ï¸</span> ç™»å‡º
                </button>
            </div>

        </div>

    </div>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        // 1. è¨­å®šå¾Œç«¯ API ç¶²å€
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';

        const LOGIN_PAGE_URL = '../auth/login.html';
        const INDEX_PAGE_URL = '../../index.html';

        /**
         * çµ±ä¸€çš„é€šçŸ¥é¡¯ç¤ºå‡½æ•¸
         */
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.innerHTML = message;
            const bgColor = isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
            
            notification.className = `fixed top-0 left-1/2 -translate-x-1/2 mt-4 px-6 py-3 rounded-lg shadow-xl z-50 transition duration-300 transform ${bgColor} animate-fade-in-down`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.replace('animate-fade-in-down', 'animate-fade-out-up');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        /**
         * æª¢æŸ¥ç™»å…¥ç‹€æ…‹ (åŒ…å«è‡ªå‹•ä¿®æ­£ææ¯€è³‡æ–™)
         */
        function checkLoginStatus() {
            const token = localStorage.getItem('auth_token');
            const userStr = localStorage.getItem('user');
            
            // 1. åŸºæœ¬æª¢æŸ¥ï¼šæ²’æœ‰ Token æˆ– User è³‡æ–™
            if (!token || !userStr) {
                forceLogout("æ‚¨å°šæœªç™»å…¥ï¼Œè«‹é‡æ–°ç™»å…¥");
                return null;
            }

            try {
                const user = JSON.parse(userStr);
                // 2. å®Œæ•´æ€§æª¢æŸ¥ï¼šå¦‚æœæœ‰ User ä½†æ²’æœ‰ ID (é€™æ˜¯å°è‡´ 404 undefined çš„åŸå› )
                if (!user.id) {
                    console.warn("åµæ¸¬åˆ°èˆŠç‰ˆç™»å…¥è³‡æ–™ï¼Œå¼·åˆ¶ç™»å‡ºä»¥æ›´æ–°ã€‚");
                    forceLogout("ç™»å…¥è³‡æ–™éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ä»¥æ›´æ–°ç³»çµ±");
                    return null;
                }
                return user;
            } catch (e) {
                forceLogout("æœƒå“¡è³‡æ–™ç•°å¸¸ï¼Œè«‹é‡æ–°ç™»å…¥");
                return null;
            }
        }

        function forceLogout(msg) {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            alert(msg, () => {
                window.location.href = LOGIN_PAGE_URL;
            });
        }
        
        /**
         * ç²å–æœƒå“¡å®Œæ•´è³‡æ–™ä¸¦æ¸²æŸ“
         */
        async function fetchAndRenderMemberData(userId) {
            try {
                // å‘¼å«å¾Œç«¯ API
                const response = await fetch(`${API_BASE_URL}/member/profile?id=${userId}`);
                
                if (!response.ok) {
                    if (response.status === 404) throw new Error('æ‰¾ä¸åˆ°æ­¤æœƒå“¡');
                    throw new Error('ä¼ºæœå™¨éŒ¯èª¤');
                }
                
                const memberData = await response.json();
                
                // æ¸²æŸ“è³‡æ–™
                document.getElementById('memberName').textContent = memberData.name;
                document.getElementById('memberGreetingName').textContent = memberData.name;

                document.getElementById('profile_name').textContent = memberData.name;
                document.getElementById('profile_email').textContent = memberData.email;
                document.getElementById('profile_phone').textContent = memberData.phone;
                document.getElementById('profile_dob').textContent = memberData.dob;
                document.getElementById('profile_points').textContent = memberData.points;
                document.getElementById('profile_member_id').textContent = memberData.memberId;
                
                // æ¢ç¢¼ä½¿ç”¨ cardID æˆ– memberID
                document.getElementById('barcodeValue').textContent = memberData.cardId || memberData.memberId;

            } catch (error) {
                console.error("API Error:", error);
                showNotification('ç„¡æ³•è¼‰å…¥æœƒå“¡è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦', true);
            }
        }

        // --- ç™»å‡ºè™•ç† ---
        document.getElementById('signOutButton').addEventListener('click', function(e) {
            e.preventDefault(); 

            this.disabled = true; 
            this.textContent = 'ç™»å‡ºä¸­...';

            // æ¸…é™¤ç™»å…¥ç‹€æ…‹
            localStorage.removeItem('auth_token'); 
            localStorage.removeItem('user'); 

            showNotification('âœ… ç™»å‡ºæˆåŠŸï¼å³å°‡å°å‘é¦–é ...', false);

            // å°å‘é¦–é 
            setTimeout(() => {
                window.location.href = INDEX_PAGE_URL; 
            }, 2000);
        });
        
        // è‡ªå®šç¾© Alert
        function alert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') {
                    callback(); 
                }
            };

            window.customAlertConfirm = handleConfirm;

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" 
                                    class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alert = alert;

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œæª¢æŸ¥èˆ‡è³‡æ–™æ¸²æŸ“
        document.addEventListener('DOMContentLoaded', async () => {
            const user = checkLoginStatus();
            if (user) {
                await fetchAndRenderMemberData(user.id);
                console.log("æœƒå“¡ä¸­å¿ƒé é¢åˆå§‹åŒ–å®Œæˆã€‚");
            }
        });
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>è¨‚ç¥¨æ­¥é©Ÿ 1: é¸æ“‡ç¥¨å‹™é¡å‹èˆ‡å ´æ¬¡ - Vieshow Ticketing</title>Â 

Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â Â 
Â  Â  <script>
Â  Â  Â  Â  tailwind.config = {
Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'vieshow-red': '#e50914',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'vieshow-gold': '#f7a83d',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'vieshow-dark': '#1a1a1a',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'gray-500': '#6b7280',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // è‡ªå®šç¾© Alert (å¿…é ˆæ”¾åœ¨æœ€å‰é¢ç¢ºä¿å¯ç”¨)
Â  Â  Â  Â  function customAlert(message, callback) {Â 
Â  Â  Â  Â  Â  Â  const existingModal = document.getElementById('custom-alert-modal');
Â  Â  Â  Â  Â  Â  if (existingModal) existingModal.remove();

Â  Â  Â  Â  Â  Â  const handleConfirm = () => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('custom-alert-modal').remove();
Â  Â  Â  Â  Â  Â  Â  Â  if (callback && typeof callback === 'function') { callback(); }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  window.customAlertConfirm = handleConfirm;

Â  Â  Â  Â  Â  Â  const modalHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700 mb-5">${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  document.body.insertAdjacentHTML('beforeend', modalHtml);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.alert = customAlert;
Â  Â  </script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  /* (CSS æ¨£å¼ä¿æŒä¸è®Š) */
Â  Â  Â  Â  body { background-color: #f7f7f7; font-family: 'Noto Sans TC', 'Inter', sans-serif; color: #333; }
Â  Â  Â  Â  .main-content { padding: 2rem 0; min-height: 80vh; }
Â  Â  Â  Â  .container { max-width: 1000px; margin: 0 auto; padding: 0 1rem; }
Â  Â  Â  Â  .booking-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 2rem; }
Â  Â  Â  Â  .title-section { border-bottom: 1px solid #e5e5e5; padding-bottom: 1.5rem; margin-bottom: 2rem; }
Â  Â  Â  Â  .main-title { font-size: 1.875rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.5rem; }
Â  Â  Â  Â  .step-title { font-size: 1.25rem; font-weight: 600; color: #e50914; }
Â  Â  Â  Â  .step-description { color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem; }
Â  Â  Â  Â  .step-indicator { display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; }
Â  Â  Â  Â  .step-circle { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; color: white; background-color: #9ca3af; transition: all 0.3s; }
Â  Â  Â  Â  .step-active { background-color: #e50914; box-shadow: 0 0 0 5px rgba(229, 9, 20, 0.3); }
Â  Â  Â  Â  .step-completed { background-color: #10b981; }
Â  Â  Â  Â  .step-line { width: 3rem; height: 3px; background-color: #9ca3af; margin: 0 0.5rem; transition: background-color 0.3s; }
Â  Â  Â  Â  .step-line.step-active { background-color: #e50914; }
Â  Â  Â  Â  .form-section > div { padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }
Â  Â  Â  Â  .section-label { display: block; font-size: 1.125rem; font-weight: 600; color: #333; margin-top: 1.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; }
Â  Â  Â  Â  .select-styled { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s; }
Â  Â  Â  Â  .select-styled:focus { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); outline: none; }
Â  Â  Â  Â  .select-help { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }
Â  Â  Â  Â  .ticket-type-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
Â  Â  Â  Â  .ticket-type-card { border: 2px solid #e5e5e5; border-radius: 0.75rem; padding: 1.5rem; cursor: pointer; transition: all 0.2s; position: relative; }
Â  Â  Â  Â  .ticket-type-card:hover { border-color: #f7a83d; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
Â  Â  Â  Â  .ticket-type-card.selected { border-color: #e50914; box-shadow: 0 0 0 4px rgba(229, 9, 20, 0.1); background-color: #fff5f5; }
Â  Â  Â  Â  .ticket-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
Â  Â  Â  Â  .ticket-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
Â  Â  Â  Â  .ticket-description { color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem; }
Â  Â  Â  Â  .feature-item { display: flex; align-items: center; font-size: 0.9rem; margin-bottom: 0.5rem; }
Â  Â  Â  Â  .feature-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
Â  Â  Â  Â  .dot-blue { background-color: #3b82f6; }
Â  Â  Â  Â  .dot-green { background-color: #10b981; }
Â  Â  Â  Â  .group-ticket-info { margin-top: 1rem; padding: 1rem; background-color: #f0fdf4; border: 1px dashed #4ade80; border-radius: 0.5rem; }
Â  Â  Â  Â  .group-ticket-title { font-weight: 600; color: #16a34a; margin-bottom: 0.5rem; }
Â  Â  Â  Â  .group-ticket-list { list-style: none; padding-left: 0; font-size: 0.9rem; color: #16a34a; }
Â  Â  Â  Â  .movie-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
Â  Â  Â  Â  .movie-card { border: 1px solid #e5e5e5; border-radius: 0.75rem; overflow: hidden; transition: all 0.2s; background-color: #fafafa; position: relative; }
Â  Â  Â  Â  .movie-card:hover { box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); transform: translateY(-2px); }
Â  Â  Â  Â  .movie-card.selected { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); }
Â  Â  Â  Â  .movie-content { padding: 1rem; }
Â  Â  Â  Â  .movie-layout { display: flex; gap: 1rem; }
Â  Â  Â  Â  .movie-poster-container { flex-shrink: 0; width: 100px; height: 150px; }
Â  Â  Â  Â  .movie-poster { width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; }
Â  Â  Â  Â  .movie-details { flex-grow: 1; }
Â  Â  Â  Â  .movie-title { font-size: 1.125rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.25rem; }
Â  Â  Â  Â  .movie-tags { margin-bottom: 0.5rem; }
Â  Â  Â  Â  .movie-tag { display: inline-block; padding: 0.1rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; }
Â  Â  Â  Â  .tag-red { background-color: #fee2e2; color: #ef4444; }
Â  Â  Â  Â  .tag-gray { background-color: #e5e7eb; color: #4b5563; }
Â  Â  Â  Â  .movie-description { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}
Â  Â  Â  Â  .showtime-section { padding: 1rem 0; background-color: #f9fafb; border-radius: 0.75rem; }
Â  Â  Â  Â  .date-section { padding: 0 1rem 1rem 1rem; }
Â  Â  Â  Â  .date-header { font-size: 1.125rem; font-weight: 700; color: #1a1a1a; background-color: #f3f4f6; padding: 0.5rem 1rem; margin: 1rem -1rem 1rem -1rem; border-bottom: 1px solid #e5e7eb; }
Â  Â  Â  Â  .showtime-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
Â  Â  Â  Â  .showtime-card { border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.2s; background-color: white; position: relative; }
Â  Â  Â  Â  .showtime-card:hover { border-color: #f7a83d; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
Â  Â  Â  Â  .showtime-card.selected { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); background-color: #fff5f5; }
Â  Â  Â  Â  .showtime-time { font-size: 1.5rem; font-weight: 700; color: #e50914; margin-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
Â  Â  Â  Â  .showtime-details { font-size: 0.875rem; color: #4b5563; }
Â  Â  Â  Â  .showtime-row { display: flex; justify-content: space-between; margin-bottom: 0.25rem; }
Â  Â  Â  Â  .button-container { padding-top: 2rem; text-align: center; }
Â  Â  Â  Â  .next-step-button { background-color: #e50914; color: white; padding: 0.8rem 2rem; font-size: 1.125rem; font-weight: 700; border-radius: 0.5rem; transition: background-color 0.2s; }
Â  Â  Â  Â  .next-step-button:hover:not(:disabled) { background-color: #c50711; }
Â  Â  Â  Â  .next-step-button:disabled { background-color: #fda4af; cursor: not-allowed; }
Â  Â  Â  Â  .loading-message { text-align: center; margin-top: 1.5rem; font-size: 0.95rem; color: #6b7280; }
Â  Â  Â  Â  footer { text-align: center; padding: 1.5rem; background-color: #1a1a1a; color: #9ca3af; font-size: 0.875rem; margin-top: 2rem; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* è¼‰å…¥æ›´å¤šæŒ‰éˆ•æ¨£å¼ */
Â  Â  Â  Â  .load-more-btn {
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 200px;
Â  Â  Â  Â  Â  Â  margin: 1.5rem auto 0;
Â  Â  Â  Â  Â  Â  padding: 0.75rem;
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  color: #6b7280;
Â  Â  Â  Â  Â  Â  border: 1px solid #d1d5db;
Â  Â  Â  Â  Â  Â  border-radius: 0.5rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .load-more-btn:hover {
Â  Â  Â  Â  Â  Â  color: #e50914;
Â  Â  Â  Â  Â  Â  border-color: #e50914;
Â  Â  Â  Â  Â  Â  background-color: #fff1f2;
Â  Â  Â  Â  }
Â  Â  Â  Â  
        /* åœ˜é«”ç¥¨æç¤ºæ¨£å¼ */
        .showtime-card.disabled-group {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #ff9900;
            background-color: #fffbeb;
        }
Â  Â  </style>
</head>
<body>
Â  Â Â 
Â  Â  <header class="bg-gray-800 text-white shadow-md">
Â  Â  Â  Â  <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
Â  Â  Â  Â  Â  Â  <div id="headerNavRight" class="space-x-4"></div>
Â  Â  Â  Â  </nav>
Â  Â  </header>

Â  Â  <div class="main-content">
Â  Â  Â  Â  <div class="container">
Â  Â  Â  Â  Â  Â  <div class="step-indicator">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-circle step-active">1</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-line step-pending"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-circle step-pending">2</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-line step-pending"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-circle step-pending">3</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-line step-pending"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-circle step-pending">4</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-line step-pending"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="step-circle step-pending">5</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="bookingCard" class="booking-card">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="title-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="main-title">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="step-title">é¸æ“‡ç¥¨å‹™é¡å‹èˆ‡å ´æ¬¡</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="step-description">è«‹å…ˆé¸æ“‡ç¥¨å‹™é¡å‹ï¼Œç„¶å¾Œä¾åºé¸æ“‡å½±åŸã€é›»å½±å’Œå ´æ¬¡ã€‚</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <form id="bookingFlow1Form" action="#" method="POST" class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="ticketTypeSection">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ«</span> é¸æ“‡ç¥¨å‹™é¡å‹</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-type-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-type-card general" data-type="general">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-type-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-icon">ğŸ‘¤</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="ticket-title">ä¸€èˆ¬è³¼ç¥¨</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="ticket-description">å€‹äººæˆ–å°åœ˜é«”è§€å½±é¸æ“‡</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-features">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="feature-item"><span class="feature-dot dot-blue"></span><span>é©åˆ **1-9 äºº**è§€å½±</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="feature-item"><span class="feature-dot dot-blue"></span><span>å¤šç¨®ç¥¨ç¨®é¸æ“‡</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-type-card group" data-type="group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-type-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-icon">ğŸ‘¥</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="ticket-title">åœ˜é«”ç¥¨</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="ticket-description">10äººä»¥ä¸Šåœ˜é«”å„ªæƒ </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ticket-features">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="feature-item"><span class="feature-dot dot-green"></span><span>é©åˆ **10-20 äºº**åœ˜é«”</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="feature-item"><span class="feature-dot dot-green"></span><span>å°ˆå±¬åœ˜é«”å„ªæƒ åƒ¹</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="groupTicketInfo" class="group-ticket-info hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="group-ticket-title">ğŸ‰ åœ˜é«”ç¥¨å°ˆå±¬å„ªæƒ </h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="group-ticket-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>â€¢ **10äººä»¥ä¸Š**äº«åœ˜é«”å„ªæƒ åƒ¹ (é™ **20 äºº**ä»¥ä¸‹)</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li>â€¢ éœ€æ–¼è§€å½±å‰3å¤©é è¨‚</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="cinemaSelectionSection" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="cinema_location" class="section-label"><span style="margin-right: 0.5rem;">ğŸ“</span> é¸æ“‡å½±åŸåœ°é»</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="cinema_location" name="cinema_location" required class="select-styled">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="select-help">é¸æ“‡æ‚¨æƒ³è§€å½±çš„å½±åŸåœ°é» (**å¿…å¡«**)</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="movieSelectionSection" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ¬</span> é¸æ“‡é›»å½±</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="movieSelection" class="movie-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="grid-column: 1 / -1; text-align: center; padding: 2rem 0; color: var(--gray-500);">è«‹å…ˆé¸æ“‡å½±åŸåœ°é»ä»¥é¡¯ç¤ºé›»å½±æ¸…å–®</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="showtimeSelectionSection" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ•’</span> é¸æ“‡å ´æ¬¡</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="showtimeSelection" class="showtime-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="text-align: center; padding: 2rem 0; color: var(--gray-500);">è«‹å…ˆé¸æ“‡é›»å½±ä»¥é¡¯ç¤ºå ´æ¬¡è³‡è¨Š</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loadMoreContainer"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loadingStatus" class="loading-message"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="button-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="nextStepButton" class="next-step-button" disabled>ä¸‹ä¸€æ­¥: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <footer><p>&copy; 2025 Vieshow Ticketing System</p></footer>

Â  Â  <script>
Â  Â  const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
Â  Â  const INDEX_PAGE_URL = '../../index.html';
Â  Â  const LOGIN_PAGE_URL = '../auth/login.html';
Â  Â  const MEMBER_HOME_URL = '../member/member_home.html';

Â  Â  // --- å…¨åŸŸè®Šæ•¸ ---
Â  Â  let currentSelections = { ticketType: null, cinema: null, movie: null, showtime: null };
Â  Â Â 
Â  Â  // ç”¨æ–¼å ´æ¬¡é¡¯ç¤ºçš„è®Šæ•¸
Â  Â  let allGroupedShowtimes = {};Â 
Â  Â  let allSortedDates = [];Â  Â  Â Â 
Â  Â  let currentDateIndex = 0;Â  Â  Â Â 
Â  Â  const DAYS_PER_LOAD = 2;Â  Â  Â Â 

Â  Â  // DOM å…ƒç´ 
Â  Â  const cinemaSelect = document.getElementById('cinema_location');
Â  Â  const movieSelection = document.getElementById('movieSelection');
Â  Â  const showtimeSelection = document.getElementById('showtimeSelection');
Â  Â  const loadMoreContainer = document.getElementById('loadMoreContainer');
Â  Â  const nextButton = document.getElementById('nextStepButton');
Â  Â  const loadingStatus = document.getElementById('loadingStatus');
Â  Â  const form = document.getElementById('bookingFlow1Form');
Â  Â  const cinemaSelectionSection = document.getElementById('cinemaSelectionSection');
Â  Â  const movieSelectionSection = document.getElementById('movieSelectionSection');
Â  Â  const showtimeSelectionSection = document.getElementById('showtimeSelectionSection');

Â  Â  // --- ç™»å…¥èˆ‡ UI ---
Â  Â  function renderUI() {
Â  Â  Â  Â  const token = localStorage.getItem('auth_token');
Â  Â  Â  Â  const navRight = document.getElementById('headerNavRight');
Â  Â  Â  Â  if (token) {
Â  Â  Â  Â  Â  Â  navRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
Â  Â  Â  Â  Â  Â  document.getElementById('signOutLink').addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault(); localStorage.removeItem('auth_token'); localStorage.removeItem('preSelectedMovie'); alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  navRight.innerHTML = `<a href="${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function checkLoginStatus() {
Â  Â  Â  Â  if (!localStorage.getItem('auth_token')) {
Â  Â  Â  Â  Â  Â  alert('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨', () => { window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`; });
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  Â  renderUI(); return true;
Â  Â  }

Â  Â  // --- æ ¸å¿ƒé‚è¼¯ ---

Â  Â  // 1. è¼‰å…¥å½±åŸ
Â  Â  async function loadCinemas() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  loadingStatus.textContent = 'è¼‰å…¥å½±åŸåˆ—è¡¨...';
Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_BASE_URL}/info/cinemas`);
Â  Â  Â  Â  Â  Â  const cinemas = await res.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  cinemaSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>';
Â  Â  Â  Â  Â  Â  cinemas.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  Â  Â  Â  Â  opt.value = c.id; opt.textContent = c.name;
Â  Â  Â  Â  Â  Â  Â  Â  cinemaSelect.appendChild(opt);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  loadingStatus.textContent = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ã€æ–°é‚è¼¯ã€‘æª¢æŸ¥æ˜¯å¦æ˜¯å¾ Step 2 è¿”å›ï¼Œè‡ªå‹•é é¸
Â  Â  Â  Â  Â  Â  const returnDataStr = sessionStorage.getItem('returnFromStep2Data');
Â  Â  Â  Â  Â  Â  if (returnDataStr) {
Â  Â  Â  Â  Â  Â  Â  Â  const returnData = JSON.parse(returnDataStr);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // é é¸ Cinema
Â  Â  Â  Â  Â  Â  Â  Â  if (returnData.cinemaId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cinemaSelect.value = returnData.cinemaId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ‰‹å‹•è§¸ç™¼ change event
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cinemaSelect.dispatchEvent(new Event('change'));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // é é¸ Ticket Type
Â  Â  Â  Â  Â  Â  Â  Â  if (returnData.ticketType) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector(`.ticket-type-card[data-type="${returnData.ticketType}"]`)?.click();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // æ¸…é™¤å¿«å–ï¼Œé¿å…ä¸‹æ¬¡è¼‰å…¥æ™‚ä»ä½¿ç”¨èˆŠè³‡æ–™
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('returnFromStep2Data');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  console.error(e); loadingStatus.textContent = 'è¼‰å…¥å½±åŸå¤±æ•—';Â 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 2. è¼‰å…¥é›»å½± (å·²å„ªåŒ–ï¼šå„ªå…ˆè®€å– sessionStorage)
Â  Â  async function loadMovies(cinemaId) {
Â  Â  Â  Â  movieSelection.innerHTML = '';
Â  Â  Â  Â  resetSelection(2);

Â  Â  Â  Â  const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (preSelectedMovieStr) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const preMovie = JSON.parse(preSelectedMovieStr);
Â  Â  Â  Â  Â  Â  Â  Â  console.log("âš¡ æª¢æ¸¬åˆ°é é¸é›»å½±ï¼Œè·³é API æŸ¥è©¢:", preMovie.name);

Â  Â  Â  Â  Â  Â  Â  Â  // ç›´æ¥æ¸²æŸ“é€™ä¸€å¼µå¡ç‰‡
Â  Â  Â  Â  Â  Â  Â  Â  renderSingleMovieCard(preMovie);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  movieSelectionSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  updateStepIndicator(2);

Â  Â  Â  Â  Â  Â  Â  Â  // è‡ªå‹•é¸å–ä¸¦è¼‰å…¥å ´æ¬¡
Â  Â  Â  Â  Â  Â  Â  Â  selectMovie(preMovie);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const card = document.querySelector('.movie-card');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  }, 100);

Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("è§£æé é¸é›»å½±å¤±æ•—ï¼Œå›é€€åˆ°ä¸€èˆ¬æ¨¡å¼", e);
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('preSelectedMovie');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- ä»¥ä¸‹ç‚ºä¸€èˆ¬æ¨¡å¼ ---
Â  Â  Â  Â  movieSelection.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#6b7280;">è¼‰å…¥é›»å½±æ¸…å–®...</div>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_BASE_URL}/movie/showtimes?location=${cinemaId}`);
Â  Â  Â  Â  Â  Â  const showtimes = await res.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const uniqueMovies = {};
Â  Â  Â  Â  Â  Â  showtimes.forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!uniqueMovies[s.movieId]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uniqueMovies[s.movieId] = { id: s.movieId, name: s.movieName };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  movieSelection.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (Object.keys(uniqueMovies).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  movieSelection.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#6b7280;">æ­¤å½±åŸæš«ç„¡é›»å½±å ´æ¬¡</div>';Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Object.values(uniqueMovies).forEach(async (m) => {
Â  Â  Â  Â  Â  Â  Â  Â  let details = { posterUrl: '', grade: '', duration: '', info: '' };
Â  Â  Â  Â  Â  Â  Â  Â  const cacheKey = `movie_cache_${m.id}`;
Â  Â  Â  Â  Â  Â  Â  Â  const cachedDetail = sessionStorage.getItem(cacheKey);

Â  Â  Â  Â  Â  Â  Â  Â  if (cachedDetail) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details = JSON.parse(cachedDetail);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const detailRes = await fetch(`${API_BASE_URL}/movie/${m.id}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (detailRes.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details = await detailRes.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem(cacheKey, JSON.stringify(details));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e){}
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  renderSingleMovieCard({ ...m, ...details });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  movieSelectionSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  updateStepIndicator(2);

Â  Â  Â  Â  } catch (e) { console.error(e); movieSelection.innerHTML = 'è¼‰å…¥å¤±æ•—'; }
Â  Â  }

Â  Â  // è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“å–®å¼µé›»å½±å¡ç‰‡
Â  Â  function renderSingleMovieCard(movie) {
Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  card.className = 'movie-card cursor-pointer';
Â  Â  Â  Â  card.dataset.movieId = movie.id;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let poster = movie.posterUrl || 'https://placehold.co/300x450?text=No+Poster';
Â  Â  Â  Â  if (poster && !poster.startsWith('http') && !poster.startsWith('data:')) {
Â  Â  Â  Â  Â  Â  poster = '../../' + poster;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="movie-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="movie-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="movie-poster-container"><img src="${poster}" class="movie-poster"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="movie-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="movie-title">${movie.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="movie-tags">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="movie-tag tag-red">${movie.grade || 'æ™®éç´š'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="movie-tag tag-gray">${movie.duration || ''}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="movie-description">${movie.info || ''}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  card.onclick = () => selectMovie(movie);
Â  Â  Â  Â  movieSelection.appendChild(card);
Â  Â  }

Â  Â  // 3. è¼‰å…¥å ´æ¬¡ (åˆ†é è¼‰å…¥é‚è¼¯)
Â  Â  async function loadShowtimes(cinemaId, movieId) {
Â  Â  Â  Â  showtimeSelection.innerHTML = '<div style="text-align:center; padding:2rem; color:#6b7280;">æ­£åœ¨æŸ¥è©¢å ´æ¬¡...</div>';
Â  Â  Â  Â  loadMoreContainer.innerHTML = '';Â 
Â  Â  Â  Â  resetSelection(3);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const isGroupTicket = currentSelections.ticketType === 'group';
Â  Â  Â  Â  const GROUP_MIN_SEATS = 10; // åœ˜é«”ç¥¨æœ€ä½è¦æ±‚åº§ä½æ•¸
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // é€™è£¡æˆ‘å€‘éœ€è¦å‘¼å«ä¸€å€‹èƒ½çµ¦å‡ºå‰©é¤˜åº§ä½çš„ API
Â  Â  Â  Â  Â  Â  // å‡è¨­å¾Œç«¯ /movie/showtimes å·²ç¶“åŒ…å« estimatedAvailableSeats æ¬„ä½
Â  Â  Â  Â  Â  Â  const res = await fetch(`${API_BASE_URL}/movie/showtimes?location=${cinemaId}&movie=${movieId}`);
Â  Â  Â  Â  Â  Â  const rawShowtimes = await res.json();

Â  Â  Â  Â  Â  Â  // ç‚ºäº†æ¼”ç¤ºå‰©é¤˜åº§ä½åŠŸèƒ½ï¼Œæˆ‘å€‘å¿…é ˆæ¨¡æ“¬æˆ–å¾ API å–å¾—åº§ä½æ•¸
Â  Â  Â  Â  Â  Â  const showtimes = await Promise.all(rawShowtimes.map(async (s) => {
Â  Â  Â  Â  Â  Â  Â  Â  // â— å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™å€‹æ•¸æ“šæ‡‰è©²ç”±å¾Œç«¯æä¾›ï¼Œè€Œä¸æ˜¯åœ¨é€™è£¡å‘¼å« /booking/seats
Â  Â  Â  Â  Â  Â  Â  Â  // é€™è£¡ç‚ºäº†æ¼”ç¤ºåŠŸèƒ½ï¼Œæˆ‘å€‘å¾ /booking/seats ç²å–å¯¦éš›å‰©é¤˜åº§ä½æ•¸
Â  Â  Â  Â  Â  Â  Â  Â  let availableSeats = 999;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const seatsRes = await fetch(`${API_BASE_URL}/booking/seats?showingId=${s.id}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const seatData = await seatsRes.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  availableSeats = seatData.filter(seat => seat.status === 1).length;
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`ç„¡æ³•ç²å–åº§ä½æ•¸ for ${s.id}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  availableSeats = 50; // é è¨­å€¼
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return { ...s, availableSeats };
Â  Â  Â  Â  Â  Â  }));


Â  Â  Â  Â  Â  Â  showtimeSelection.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (showtimes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  showtimeSelection.innerHTML = `<div style="text-align:center; padding:2rem; color:#6b7280;">æ­¤å½±åŸç›®å‰æ²’æœ‰ã€Š${currentSelections.movie?.name || 'æ­¤é›»å½±'}ã€‹çš„å ´æ¬¡</div>`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  allGroupedShowtimes = {};
Â  Â  Â  Â  Â  Â  showtimes.forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!allGroupedShowtimes[s.date]) allGroupedShowtimes[s.date] = [];
Â  Â  Â  Â  Â  Â  Â  Â  allGroupedShowtimes[s.date].push(s);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  allSortedDates = Object.keys(allGroupedShowtimes).sort();
Â  Â  Â  Â  Â  Â  currentDateIndex = 0;

Â  Â  Â  Â  Â  Â  renderShowtimesBatch(isGroupTicket, GROUP_MIN_SEATS);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showtimeSelectionSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  updateStepIndicator(3);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (e) { console.error(e); showtimeSelection.innerHTML = 'è¼‰å…¥å¤±æ•—'; }
Â  Â  }

Â  Â  function renderShowtimesBatch(isGroupTicket, GROUP_MIN_SEATS) {
Â  Â  Â  Â  const nextIndex = Math.min(currentDateIndex + DAYS_PER_LOAD, allSortedDates.length);
Â  Â  Â  Â  const datesToRender = allSortedDates.slice(currentDateIndex, nextIndex);
Â  Â  Â  Â Â 
Â  Â  Â  Â  datesToRender.forEach(date => {
Â  Â  Â  Â  Â  Â  const section = document.createElement('div'); section.className = 'date-section';
Â  Â  Â  Â  Â  Â  section.style.opacity = '0'; section.style.transition = 'opacity 0.5s ease-in';
Â  Â  Â  Â  Â  Â  section.innerHTML = `<h4 class="date-header">${date}</h4>`;
Â  Â  Â  Â  Â  Â  const grid = document.createElement('div'); grid.className = 'showtime-grid';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  allGroupedShowtimes[date].forEach(s => {
Â  Â  Â  Â  Â  Â  Â  Â  const available = s.availableSeats;
Â  Â  Â  Â  Â  Â  Â  Â  const isTooFew = isGroupTicket && available < GROUP_MIN_SEATS;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div'); 
Â  Â  Â  Â  Â  Â  Â  Â  card.className = `showtime-card ${isTooFew ? 'disabled-group' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  card.dataset.id = s.id;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let seatsStatusHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (isTooFew) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seatsStatusHTML = `<div class="showtime-row text-xs text-vieshow-red font-bold">å‰©é¤˜åº§ä½ä¸è¶³ (éœ€ ${GROUP_MIN_SEATS} å¼µ)</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (available <= 10) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seatsStatusHTML = `<div class="showtime-row text-xs text-red-500 font-bold">âš ï¸ åƒ…å‰© ${available} å¼µ</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seatsStatusHTML = `<div class="showtime-row text-xs text-green-500 font-bold">å‰©é¤˜åº§ä½å……è¶³ (${available} å¼µ)</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="showtime-time">${s.time}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="showtime-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="showtime-row"><span>å½±å»³:</span><span class="font-medium">${s.theater}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="showtime-row"><span>ç‰ˆæœ¬:</span><span class="font-medium">${s.format}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${seatsStatusHTML}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!isTooFew) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.onclick = () => selectShowtime(s);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
                    // å¦‚æœä¸è¶³ï¼Œé»æ“Šå‰‡æç¤º
                    card.onclick = () => alert(`é¸æ“‡åœ˜é«”ç¥¨æ™‚ï¼Œæ­¤å ´æ¬¡å‰©é¤˜åº§ä½ (${available} å¼µ) ä¸è¶³ ${GROUP_MIN_SEATS} å¼µã€‚`);
                }

Â  Â  Â  Â  Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  section.appendChild(grid);
Â  Â  Â  Â  Â  Â  showtimeSelection.appendChild(section);
Â  Â  Â  Â  Â  Â  setTimeout(() => { section.style.opacity = '1'; }, 50);
Â  Â  Â  Â  }

Â  Â  function renderLoadMoreButton() {
Â  Â  Â  Â  // (ç•¥ï¼Œä¿æŒä¸è®Š)
Â  Â  Â  Â  loadMoreContainer.innerHTML = '';Â 
Â  Â  Â  Â  if (currentDateIndex < allSortedDates.length) {
Â  Â  Â  Â  Â  Â  const remaining = allSortedDates.length - currentDateIndex;
Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  btn.className = 'load-more-btn';
Â  Â  Â  Â  Â  Â  btn.textContent = `çœ‹æ›´å¤šæ™‚é–“ (${remaining} å¤©) â–¼`;
Â  Â  Â  Â  Â  Â  btn.type = 'button';Â 
Â  Â  Â  Â  Â  Â  btn.onclick = () => renderShowtimesBatch(currentSelections.ticketType === 'group', 10); // å‚³å…¥ç‹€æ…‹
Â  Â  Â  Â  Â  Â  loadMoreContainer.appendChild(btn);
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // --- äº’å‹•èˆ‡é¸æ“‡ ---
Â  Â  function setupTicketTypeSelection() {
Â  Â  Â  Â  document.querySelectorAll('.ticket-type-card').forEach(card => {
Â  Â  Â  Â  Â  Â  card.onclick = function() {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  Â  Â  this.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  currentSelections.ticketType = this.dataset.type;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('groupTicketInfo').classList.toggle('hidden', currentSelections.ticketType !== 'group');
Â  Â  Â  Â  Â  Â  Â  Â  nextButton.textContent = currentSelections.ticketType === 'group' ? 'ä¸‹ä¸€æ­¥: å¡«å¯«åœ˜é«”è³‡è¨Š' : 'ä¸‹ä¸€æ­¥: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  resetSelection(1);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('cinemaSelectionSection').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  loadCinemas();
Â  Â  Â  Â  Â  Â  Â  Â  updateStepIndicator(1);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function resetSelection(step) {
Â  Â  Â  Â  // (ç•¥ï¼Œä¿æŒä¸è®Š)
Â  Â  Â  Â  if (step <= 1) { currentSelections.cinema = null; cinemaSelect.selectedIndex = 0; movieSelectionSection.classList.add('hidden'); }
Â  Â  Â  Â  if (step <= 2) { currentSelections.movie = null; showtimeSelectionSection.classList.add('hidden'); }
Â  Â  Â  Â  if (step <= 3) { currentSelections.showtime = null; nextButton.disabled = true; }
Â  Â  }

Â  Â  function selectMovie(movie) {
Â  Â  Â  Â  // (ç•¥ï¼Œä¿æŒä¸è®Š)
Â  Â  Â  Â  document.querySelectorAll('.movie-card').forEach(c => c.classList.remove('selected'));
Â  Â  Â  Â  document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`)?.classList.add('selected');
Â  Â  Â  Â  currentSelections.movie = movie;
Â  Â  Â  Â  loadShowtimes(currentSelections.cinema.id, movie.id);
Â  Â  }

Â  Â  function selectShowtime(showtime) {
Â  Â  Â  Â  // (ç•¥ï¼Œä¿æŒä¸è®Š)
Â  Â  Â  Â  document.querySelectorAll('.showtime-card').forEach(c => c.classList.remove('selected'));
Â  Â  Â  Â  const card = document.querySelector(`.showtime-card[data-id="${showtime.id}"]`);
Â  Â  Â  Â  if(card) card.classList.add('selected');
Â  Â  Â  Â Â 
Â  Â  Â  Â  currentSelections.showtime = showtime;
Â  Â  Â  Â  nextButton.disabled = false;
Â  Â  }

Â  Â  function updateStepIndicator(step) {
Â  Â  Â  Â  // (ç•¥ï¼Œä¿æŒä¸è®Š)
Â  Â  Â  Â  document.querySelectorAll('.step-circle').forEach((c, i) => {
Â  Â  Â  Â  Â  Â  c.className = `step-circle ${i < step ? 'step-completed' : (i === step ? 'step-active' : 'step-pending')}`;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  cinemaSelect.addEventListener('change', function() {
Â  Â  Â  Â  // (ç•¥ï¼Œä¿æŒä¸è®Š)
Â  Â  Â  Â  if (this.value) {
Â  Â  Â  Â  Â  Â  currentSelections.cinema = { id: this.value, name: this.options[this.selectedIndex].text };
Â  Â  Â  Â  Â  Â  loadMovies(this.value);
Â  Â  Â  Â  }
Â  Â  });

Â  Â  form.addEventListener('submit', (e) => {
Â  Â  Â  Â  // (ç•¥ï¼Œä¿æŒä¸è®Š)
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  if (!currentSelections.ticketType || !currentSelections.cinema || !currentSelections.movie || !currentSelections.showtime) {
Â  Â  Â  Â  Â  Â  alert('è«‹å®Œæˆæ‰€æœ‰é¸æ“‡'); return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ã€å„ªåŒ–é»ã€‘å°‡ç•¶å‰é¸æ“‡çš„å½±åŸå’Œç¥¨å‹™é¡å‹å­˜å…¥ sessionStorage
Â  Â  Â  Â  sessionStorage.setItem('returnFromStep2Data', JSON.stringify({
Â  Â  Â  Â  Â  Â  ticketType: currentSelections.ticketType,
Â  Â  Â  Â  Â  Â  cinemaId: currentSelections.cinema.id
Â  Â  Â  Â  }));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ã€ä¿®æ­£é‡é»ã€‘ç¢ºä¿è³‡æ–™æ¬„ä½åç¨±çµ±ä¸€
Â  Â  Â  Â  localStorage.setItem('currentBooking', JSON.stringify({
Â  Â  Â  Â  Â  Â  ticketType: currentSelections.ticketType,
Â  Â  Â  Â  Â  Â  cinema: currentSelections.cinema,
Â  Â  Â  Â  Â  Â  movie: {
Â  Â  Â  Â  Â  Â  Â  Â  id: currentSelections.movie.id,
Â  Â  Â  Â  Â  Â  Â  Â  title: currentSelections.movie.name, // ç¢ºä¿æœ‰ title
Â  Â  Â  Â  Â  Â  Â  Â  ...currentSelections.movieÂ 
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  showtime: {
Â  Â  Â  Â  Â  Â  Â  Â  id: currentSelections.showtime.id,
Â  Â  Â  Â  Â  Â  Â  Â  date: currentSelections.showtime.date,
Â  Â  Â  Â  Â  Â  Â  Â  time: currentSelections.showtime.time,
Â  Â  Â  Â  Â  Â  Â  Â  theater: currentSelections.showtime.theater,
Â  Â  Â  Â  Â  Â  Â  Â  type: currentSelections.showtime.format, // ç¢ºä¿æœ‰ type
Â  Â  Â  Â  Â  Â  Â  Â  ...currentSelections.showtime
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // é€å‡ºå¾Œæ¸…é™¤é é¸é›»å½±ï¼Œé¿å…ä¸‹æ¬¡å¹²æ“¾
Â  Â  Â  Â  sessionStorage.removeItem('preSelectedMovie');
Â  Â  Â  Â  window.location.href = currentSelections.ticketType === 'group' ? 'booking_flow_group.html' : 'booking_flow_2.html';
Â  Â  });

Â  Â  window.onload = () => {
Â  Â  Â  Â  if (checkLoginStatus()) {
Â  Â  Â  Â  Â  Â  setupTicketTypeSelection();
Â  Â  Â  Â  Â  Â  localStorage.removeItem('currentBooking'); // æ¸…é™¤èˆŠè¨‚å–®
Â  Â  Â  Â  Â  Â  // æ³¨æ„ï¼šé€™è£¡ä¸è¦æ¸…é™¤ preSelectedMovieï¼Œå› ç‚ºæˆ‘å€‘æ­£è¦ç”¨å®ƒ
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // Custom Alert (ä¿æŒèˆ‡æ‚¨ä¸€è‡´)
Â  Â  function customAlert(message, callback) {Â 
Â  Â  Â  Â  const existingModal = document.getElementById('custom-alert-modal');
Â  Â  Â  Â  if (existingModal) existingModal.remove();
Â  Â  Â  Â  const handleConfirm = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('custom-alert-modal').remove();
Â  Â  Â  Â  Â  Â  if (callback && typeof callback === 'function') { callback(); }
Â  Â  Â  Â  };
Â  Â  Â  Â  window.customAlertConfirm = handleConfirm;
Â  Â  Â  Â  const modalHtml = `
Â  Â  Â  Â  Â  Â  <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-700 mb-5">${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  document.body.insertAdjacentHTML('beforeend', modalHtml);
Â  Â  }
Â  Â  window.alert = customAlert;
</script>
</body>
</html>

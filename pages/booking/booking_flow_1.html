<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 1: é¸æ“‡ç¥¨å‹™é¡å‹èˆ‡å ´æ¬¡ - Vieshow Ticketing</title> 

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-dark': '#1a1a1a',
                        'gray-500': '#6b7280',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        };

        // è‡ªå®šç¾© Alert (å¿…é ˆæ”¾åœ¨æœ€å‰é¢ç¢ºä¿å¯ç”¨)
        function customAlert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') { callback(); }
            };
            window.customAlertConfirm = handleConfirm;

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alert = customAlert;
    </script>
    
    <style>
        /* (CSS æ¨£å¼ä¿æŒä¸è®Š) */
        body { background-color: #f7f7f7; font-family: 'Noto Sans TC', 'Inter', sans-serif; color: #333; }
        .main-content { padding: 2rem 0; min-height: 80vh; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 1rem; }
        .booking-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 2rem; }
        .title-section { border-bottom: 1px solid #e5e5e5; padding-bottom: 1.5rem; margin-bottom: 2rem; }
        .main-title { font-size: 1.875rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.5rem; }
        .step-title { font-size: 1.25rem; font-weight: 600; color: #e50914; }
        .step-description { color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem; }
        .step-indicator { display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; }
        .step-circle { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; color: white; background-color: #9ca3af; transition: all 0.3s; }
        .step-active { background-color: #e50914; box-shadow: 0 0 0 5px rgba(229, 9, 20, 0.3); }
        .step-completed { background-color: #10b981; }
        .step-line { width: 3rem; height: 3px; background-color: #9ca3af; margin: 0 0.5rem; transition: background-color 0.3s; }
        .step-line.step-active { background-color: #e50914; }
        .form-section > div { padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }
        .section-label { display: block; font-size: 1.125rem; font-weight: 600; color: #333; margin-top: 1.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; }
        .select-styled { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s; }
        .select-styled:focus { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); outline: none; }
        .select-help { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }
        .ticket-type-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .ticket-type-card { border: 2px solid #e5e5e5; border-radius: 0.75rem; padding: 1.5rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .ticket-type-card:hover { border-color: #f7a83d; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .ticket-type-card.selected { border-color: #e50914; box-shadow: 0 0 0 4px rgba(229, 9, 20, 0.1); background-color: #fff5f5; }
        .ticket-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .ticket-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
        .ticket-description { color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem; }
        .feature-item { display: flex; align-items: center; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .feature-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .dot-blue { background-color: #3b82f6; }
        .dot-green { background-color: #10b981; }
        .group-ticket-info { margin-top: 1rem; padding: 1rem; background-color: #f0fdf4; border: 1px dashed #4ade80; border-radius: 0.5rem; }
        .group-ticket-title { font-weight: 600; color: #16a34a; margin-bottom: 0.5rem; }
        .group-ticket-list { list-style: none; padding-left: 0; font-size: 0.9rem; color: #16a34a; }
        .movie-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .movie-card { border: 1px solid #e5e5e5; border-radius: 0.75rem; overflow: hidden; transition: all 0.2s; background-color: #fafafa; position: relative; }
        .movie-card:hover { box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); transform: translateY(-2px); }
        .movie-card.selected { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); }
        .movie-content { padding: 1rem; }
        .movie-layout { display: flex; gap: 1rem; }
        .movie-poster-container { flex-shrink: 0; width: 100px; height: 150px; }
        .movie-poster { width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; }
        .movie-details { flex-grow: 1; }
        .movie-title { font-size: 1.125rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.25rem; }
        .movie-tags { margin-bottom: 0.5rem; }
        .movie-tag { display: inline-block; padding: 0.1rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; }
        .tag-red { background-color: #fee2e2; color: #ef4444; }
        .tag-gray { background-color: #e5e7eb; color: #4b5563; }
        .movie-description { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}
        .showtime-section { padding: 1rem 0; background-color: #f9fafb; border-radius: 0.75rem; }
        .date-section { padding: 0 1rem 1rem 1rem; }
        .date-header { font-size: 1.125rem; font-weight: 700; color: #1a1a1a; background-color: #f3f4f6; padding: 0.5rem 1rem; margin: 1rem -1rem 1rem -1rem; border-bottom: 1px solid #e5e7eb; }
        .showtime-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .showtime-card { border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.2s; background-color: white; position: relative; }
        .showtime-card:hover { border-color: #f7a83d; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .showtime-card.selected { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); background-color: #fff5f5; }
        .showtime-time { font-size: 1.5rem; font-weight: 700; color: #e50914; margin-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }
        .showtime-details { font-size: 0.875rem; color: #4b5563; }
        .showtime-row { display: flex; justify-content: space-between; margin-bottom: 0.25rem; }
        .button-container { padding-top: 2rem; text-align: center; }
        .next-step-button { background-color: #e50914; color: white; padding: 0.8rem 2rem; font-size: 1.125rem; font-weight: 700; border-radius: 0.5rem; transition: background-color 0.2s; }
        .next-step-button:hover:not(:disabled) { background-color: #c50711; }
        .next-step-button:disabled { background-color: #fda4af; cursor: not-allowed; }
        .loading-message { text-align: center; margin-top: 1.5rem; font-size: 0.95rem; color: #6b7280; }
        footer { text-align: center; padding: 1.5rem; background-color: #1a1a1a; color: #9ca3af; font-size: 0.875rem; margin-top: 2rem; }
        
        /* è¼‰å…¥æ›´å¤šæŒ‰éˆ•æ¨£å¼ */
        .load-more-btn {
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 1.5rem auto 0;
            padding: 0.75rem;
            background-color: white;
            color: #6b7280;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
        }
        .load-more-btn:hover {
            color: #e50914;
            border-color: #e50914;
            background-color: #fff1f2;
        }
    </style>
</head>
<body>
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4"></div>
        </nav>
    </header>

    <div class="main-content">
        <div class="container">
            <div class="step-indicator">
                <div class="step-circle step-active">1</div>
                <div class="step-line step-pending"></div>
                <div class="step-circle step-pending">2</div>
                <div class="step-line step-pending"></div>
                <div class="step-circle step-pending">3</div>
                <div class="step-line step-pending"></div>
                <div class="step-circle step-pending">4</div>
                <div class="step-line step-pending"></div>
                <div class="step-circle step-pending">5</div>
            </div>
            
            <div id="bookingCard" class="booking-card">
                
                <div class="title-section">
                    <h1 class="main-title">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>
                    <p class="step-title">é¸æ“‡ç¥¨å‹™é¡å‹èˆ‡å ´æ¬¡</p>
                    <p class="step-description">è«‹å…ˆé¸æ“‡ç¥¨å‹™é¡å‹ï¼Œç„¶å¾Œä¾åºé¸æ“‡å½±åŸã€é›»å½±å’Œå ´æ¬¡ã€‚</p>
                </div>

                <form id="bookingFlow1Form" action="#" method="POST" class="form-section">
                    
                    <div id="ticketTypeSection">
                        <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ«</span> é¸æ“‡ç¥¨å‹™é¡å‹</label>
                        <div class="ticket-type-grid">
                            <div class="ticket-type-card general" data-type="general">
                                <div class="ticket-type-content">
                                    <div class="ticket-icon">ğŸ‘¤</div>
                                    <h3 class="ticket-title">ä¸€èˆ¬è³¼ç¥¨</h3>
                                    <p class="ticket-description">å€‹äººæˆ–å°åœ˜é«”è§€å½±é¸æ“‡</p>
                                    <div class="ticket-features">
                                        <div class="feature-item"><span class="feature-dot dot-blue"></span><span>é©åˆ **1-9 äºº**è§€å½±</span></div>
                                        <div class="feature-item"><span class="feature-dot dot-blue"></span><span>å¤šç¨®ç¥¨ç¨®é¸æ“‡</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="ticket-type-card group" data-type="group">
                                <div class="ticket-type-content">
                                    <div class="ticket-icon">ğŸ‘¥</div>
                                    <h3 class="ticket-title">åœ˜é«”ç¥¨</h3>
                                    <p class="ticket-description">10äººä»¥ä¸Šåœ˜é«”å„ªæƒ </p>
                                    <div class="ticket-features">
                                        <div class="feature-item"><span class="feature-dot dot-green"></span><span>é©åˆ **10-20 äºº**åœ˜é«”</span></div>
                                        <div class="feature-item"><span class="feature-dot dot-green"></span><span>å°ˆå±¬åœ˜é«”å„ªæƒ åƒ¹</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="groupTicketInfo" class="group-ticket-info hidden">
                            <h4 class="group-ticket-title">ğŸ‰ åœ˜é«”ç¥¨å°ˆå±¬å„ªæƒ </h4>
                            <ul class="group-ticket-list">
                                <li>â€¢ **10äººä»¥ä¸Š**äº«åœ˜é«”å„ªæƒ åƒ¹ (é™ **20 äºº**ä»¥ä¸‹)</li>
                                <li>â€¢ éœ€æ–¼è§€å½±å‰3å¤©é è¨‚</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="cinemaSelectionSection" class="hidden">
                        <label for="cinema_location" class="section-label"><span style="margin-right: 0.5rem;">ğŸ“</span> é¸æ“‡å½±åŸåœ°é»</label>
                        <select id="cinema_location" name="cinema_location" required class="select-styled">
                            <option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>
                        </select>
                        <p class="select-help">é¸æ“‡æ‚¨æƒ³è§€å½±çš„å½±åŸåœ°é» (**å¿…å¡«**)</p>
                    </div>
                    
                    <div id="movieSelectionSection" class="hidden">
                        <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ¬</span> é¸æ“‡é›»å½±</label>
                        <div id="movieSelection" class="movie-grid">
                            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem 0; color: var(--gray-500);">è«‹å…ˆé¸æ“‡å½±åŸåœ°é»ä»¥é¡¯ç¤ºé›»å½±æ¸…å–®</div>
                        </div>
                    </div>
                    
                    <div id="showtimeSelectionSection" class="hidden">
                        <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ•’</span> é¸æ“‡å ´æ¬¡</label>
                        <div id="showtimeSelection" class="showtime-section">
                            <div style="text-align: center; padding: 2rem 0; color: var(--gray-500);">è«‹å…ˆé¸æ“‡é›»å½±ä»¥é¡¯ç¤ºå ´æ¬¡è³‡è¨Š</div>
                        </div>
                        <div id="loadMoreContainer"></div>
                    </div>
                    
                    <div id="loadingStatus" class="loading-message"></div>

                    <div class="button-container">
                        <button type="submit" id="nextStepButton" class="next-step-button" disabled>ä¸‹ä¸€æ­¥: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer><p>&copy; 2025 Vieshow Ticketing System</p></footer>

    <script>
    const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
    const INDEX_PAGE_URL = '../../index.html';
    const LOGIN_PAGE_URL = '../auth/login.html';
    const MEMBER_HOME_URL = '../member/member_home.html';

    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentSelections = { ticketType: null, cinema: null, movie: null, showtime: null };
    
    // ç”¨æ–¼å ´æ¬¡é¡¯ç¤ºçš„è®Šæ•¸
    let allGroupedShowtimes = {}; 
    let allSortedDates = [];      
    let currentDateIndex = 0;      
    const DAYS_PER_LOAD = 2;      

    // DOM å…ƒç´ 
    const cinemaSelect = document.getElementById('cinema_location');
    const movieSelection = document.getElementById('movieSelection');
    const showtimeSelection = document.getElementById('showtimeSelection');
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const nextButton = document.getElementById('nextStepButton');
    const loadingStatus = document.getElementById('loadingStatus');
    const form = document.getElementById('bookingFlow1Form');
    const cinemaSelectionSection = document.getElementById('cinemaSelectionSection');
    const movieSelectionSection = document.getElementById('movieSelectionSection');
    const showtimeSelectionSection = document.getElementById('showtimeSelectionSection');

    // --- ç™»å…¥èˆ‡ UI ---
    function renderUI() {
        const token = localStorage.getItem('auth_token');
        const navRight = document.getElementById('headerNavRight');
        if (token) {
            navRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
            document.getElementById('signOutLink').addEventListener('click', (e) => {
                e.preventDefault(); localStorage.removeItem('auth_token'); localStorage.removeItem('preSelectedMovie'); alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
            });
        } else {
            navRight.innerHTML = `<a href="${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
        }
    }

    function checkLoginStatus() {
        if (!localStorage.getItem('auth_token')) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨', () => { window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`; });
            return false;
        }
        renderUI(); return true;
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---

    // 1. è¼‰å…¥å½±åŸ
    async function loadCinemas() {
        try {
            loadingStatus.textContent = 'è¼‰å…¥å½±åŸåˆ—è¡¨...';
            const res = await fetch(`${API_BASE_URL}/info/cinemas`);
            const cinemas = await res.json();
            
            cinemaSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>';
            cinemas.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.name;
                cinemaSelect.appendChild(opt);
            });
            loadingStatus.textContent = '';
            
            // ã€æ–°é‚è¼¯ã€‘æª¢æŸ¥æ˜¯å¦æ˜¯å¾ Step 2 è¿”å›ï¼Œè‡ªå‹•é é¸
            const returnDataStr = sessionStorage.getItem('returnFromStep2Data');
            if (returnDataStr) {
                const returnData = JSON.parse(returnDataStr);
                
                // é é¸ Cinema
                if (returnData.cinemaId) {
                    cinemaSelect.value = returnData.cinemaId;
                    // æ‰‹å‹•è§¸ç™¼ change event
                    cinemaSelect.dispatchEvent(new Event('change'));
                }
                
                // é é¸ Ticket Type
                if (returnData.ticketType) {
                    document.querySelector(`.ticket-type-card[data-type="${returnData.ticketType}"]`).click();
                }
                
                // æ¸…é™¤å¿«å–ï¼Œé¿å…ä¸‹æ¬¡è¼‰å…¥æ™‚ä»ä½¿ç”¨èˆŠè³‡æ–™
                sessionStorage.removeItem('returnFromStep2Data');
            }

        } catch (e) { 
            console.error(e); loadingStatus.textContent = 'è¼‰å…¥å½±åŸå¤±æ•—'; 
        }
    }

    // 2. è¼‰å…¥é›»å½± (å·²å„ªåŒ–ï¼šå„ªå…ˆè®€å– sessionStorage)
    async function loadMovies(cinemaId) {
        movieSelection.innerHTML = '';
        resetSelection(2);

        const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
        
        if (preSelectedMovieStr) {
            try {
                const preMovie = JSON.parse(preSelectedMovieStr);
                console.log("âš¡ æª¢æ¸¬åˆ°é é¸é›»å½±ï¼Œè·³é API æŸ¥è©¢:", preMovie.name);

                // ç›´æ¥æ¸²æŸ“é€™ä¸€å¼µå¡ç‰‡
                renderSingleMovieCard(preMovie);
                
                movieSelectionSection.classList.remove('hidden');
                updateStepIndicator(2);

                // è‡ªå‹•é¸å–ä¸¦è¼‰å…¥å ´æ¬¡
                selectMovie(preMovie);
                
                setTimeout(() => {
                    const card = document.querySelector('.movie-card');
                    if(card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);

                return;
            } catch (e) {
                console.error("è§£æé é¸é›»å½±å¤±æ•—ï¼Œå›é€€åˆ°ä¸€èˆ¬æ¨¡å¼", e);
                sessionStorage.removeItem('preSelectedMovie');
            }
        }

        // --- ä»¥ä¸‹ç‚ºä¸€èˆ¬æ¨¡å¼ ---
        movieSelection.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#6b7280;">è¼‰å…¥é›»å½±æ¸…å–®...</div>';
        
        try {
            const res = await fetch(`${API_BASE_URL}/movie/showtimes?location=${cinemaId}`);
            const showtimes = await res.json();
            
            const uniqueMovies = {};
            showtimes.forEach(s => {
                if (!uniqueMovies[s.movieId]) {
                    uniqueMovies[s.movieId] = { id: s.movieId, name: s.movieName };
                }
            });
            
            movieSelection.innerHTML = '';
            if (Object.keys(uniqueMovies).length === 0) {
                movieSelection.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#6b7280;">æ­¤å½±åŸæš«ç„¡é›»å½±å ´æ¬¡</div>'; 
                return;
            }

            Object.values(uniqueMovies).forEach(async (m) => {
                let details = { posterUrl: '', grade: '', duration: '', info: '' };
                const cacheKey = `movie_cache_${m.id}`;
                const cachedDetail = sessionStorage.getItem(cacheKey);

                if (cachedDetail) {
                    details = JSON.parse(cachedDetail);
                } else {
                    try {
                        const detailRes = await fetch(`${API_BASE_URL}/movie/${m.id}`);
                        if (detailRes.ok) {
                            details = await detailRes.json();
                            sessionStorage.setItem(cacheKey, JSON.stringify(details));
                        }
                    } catch(e){}
                }
                
                renderSingleMovieCard({ ...m, ...details });
            });
            
            movieSelectionSection.classList.remove('hidden');
            updateStepIndicator(2);

        } catch (e) { console.error(e); movieSelection.innerHTML = 'è¼‰å…¥å¤±æ•—'; }
    }

    // è¼”åŠ©å‡½å¼ï¼šæ¸²æŸ“å–®å¼µé›»å½±å¡ç‰‡
    function renderSingleMovieCard(movie) {
        const card = document.createElement('div');
        card.className = 'movie-card cursor-pointer';
        card.dataset.movieId = movie.id;
        
        let poster = movie.posterUrl || 'https://placehold.co/300x450?text=No+Poster';
        if (poster && !poster.startsWith('http') && !poster.startsWith('data:')) {
            poster = '../../' + poster; 
        }
        
        card.innerHTML = `
            <div class="movie-content">
                <div class="movie-layout">
                    <div class="movie-poster-container"><img src="${poster}" class="movie-poster"></div>
                    <div class="movie-details">
                        <h3 class="movie-title">${movie.name}</h3>
                        <div class="movie-tags">
                            <span class="movie-tag tag-red">${movie.grade || 'æ™®éç´š'}</span>
                            <span class="movie-tag tag-gray">${movie.duration || ''}</span>
                        </div>
                        <p class="movie-description">${movie.info || ''}</p>
                    </div>
                </div>
            </div>`;
        card.onclick = () => selectMovie(movie);
        movieSelection.appendChild(card);
    }

    // 3. è¼‰å…¥å ´æ¬¡ (åˆ†é è¼‰å…¥é‚è¼¯)
    async function loadShowtimes(cinemaId, movieId) {
        showtimeSelection.innerHTML = '<div style="text-align:center; padding:2rem; color:#6b7280;">æ­£åœ¨æŸ¥è©¢å ´æ¬¡...</div>';
        loadMoreContainer.innerHTML = ''; 
        resetSelection(3);
        
        try {
            const res = await fetch(`${API_BASE_URL}/movie/showtimes?location=${cinemaId}&movie=${movieId}`);
            const showtimes = await res.json();
            
            showtimeSelection.innerHTML = '';
            if (showtimes.length === 0) {
                showtimeSelection.innerHTML = `
                    <div style="text-align:center; padding:2rem; color:#6b7280;">
                        <p class="text-lg font-bold mb-2">æ­¤å½±åŸç›®å‰æ²’æœ‰ã€Š${currentSelections.movie?.name || 'æ­¤é›»å½±'}ã€‹çš„å ´æ¬¡</p>
                        <p class="text-sm">è«‹å˜—è©¦é¸æ“‡å…¶ä»–å½±åŸï¼Œæˆ–å›åˆ°é¦–é é¸æ“‡å…¶ä»–é›»å½±ã€‚</p>
                    </div>`; 
                return;
            }

            allGroupedShowtimes = {};
            showtimes.forEach(s => {
                if (!allGroupedShowtimes[s.date]) allGroupedShowtimes[s.date] = [];
                allGroupedShowtimes[s.date].push(s);
            });

            allSortedDates = Object.keys(allGroupedShowtimes).sort();
            currentDateIndex = 0;

            renderShowtimesBatch();
            
            showtimeSelectionSection.classList.remove('hidden');
            updateStepIndicator(3);
            
        } catch (e) { console.error(e); showtimeSelection.innerHTML = 'è¼‰å…¥å¤±æ•—'; }
    }

    function renderShowtimesBatch() {
        const nextIndex = Math.min(currentDateIndex + DAYS_PER_LOAD, allSortedDates.length);
        const datesToRender = allSortedDates.slice(currentDateIndex, nextIndex);
        
        datesToRender.forEach(date => {
            const section = document.createElement('div'); section.className = 'date-section';
            section.style.opacity = '0'; section.style.transition = 'opacity 0.5s ease-in';
            section.innerHTML = `<h4 class="date-header">${date}</h4>`;
            const grid = document.createElement('div'); grid.className = 'showtime-grid';
            
            allGroupedShowtimes[date].forEach(s => {
                const card = document.createElement('div'); card.className = 'showtime-card';
                card.dataset.id = s.id;
                card.innerHTML = `
                    <div class="showtime-time">${s.time}</div>
                    <div class="showtime-details">
                        <div class="showtime-row"><span>å½±å»³:</span><span class="font-medium">${s.theater}</span></div>
                        <div class="showtime-row"><span>ç‰ˆæœ¬:</span><span class="font-medium">${s.format}</span></div>
                    </div>`;
                card.onclick = () => selectShowtime(s);
                grid.appendChild(card);
            });
            section.appendChild(grid);
            showtimeSelection.appendChild(section);
            setTimeout(() => { section.style.opacity = '1'; }, 50);
        });

        currentDateIndex = nextIndex;
        renderLoadMoreButton();
    }

    function renderLoadMoreButton() {
        loadMoreContainer.innerHTML = ''; 
        if (currentDateIndex < allSortedDates.length) {
            const remaining = allSortedDates.length - currentDateIndex;
            const btn = document.createElement('button');
            btn.className = 'load-more-btn';
            btn.textContent = `çœ‹æ›´å¤šæ™‚é–“ (${remaining} å¤©) â–¼`;
            btn.type = 'button'; 
            btn.onclick = renderShowtimesBatch; 
            loadMoreContainer.appendChild(btn);
        }
    }

    // --- äº’å‹•èˆ‡é¸æ“‡ ---
    function setupTicketTypeSelection() {
        document.querySelectorAll('.ticket-type-card').forEach(card => {
            card.onclick = function() {
                document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                currentSelections.ticketType = this.dataset.type;
                
                document.getElementById('groupTicketInfo').classList.toggle('hidden', currentSelections.ticketType !== 'group');
                nextButton.textContent = currentSelections.ticketType === 'group' ? 'ä¸‹ä¸€æ­¥: å¡«å¯«åœ˜é«”è³‡è¨Š' : 'ä¸‹ä¸€æ­¥: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»';
                
                resetSelection(1);
                document.getElementById('cinemaSelectionSection').classList.remove('hidden');
                loadCinemas();
                updateStepIndicator(1);
            };
        });
    }

    function resetSelection(step) {
        if (step <= 1) { currentSelections.cinema = null; cinemaSelect.selectedIndex = 0; movieSelectionSection.classList.add('hidden'); }
        if (step <= 2) { currentSelections.movie = null; showtimeSelectionSection.classList.add('hidden'); }
        if (step <= 3) { currentSelections.showtime = null; nextButton.disabled = true; }
    }

    function selectMovie(movie) {
        document.querySelectorAll('.movie-card').forEach(c => c.classList.remove('selected'));
        document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`)?.classList.add('selected');
        currentSelections.movie = movie;
        loadShowtimes(currentSelections.cinema.id, movie.id);
    }

    function selectShowtime(showtime) {
        document.querySelectorAll('.showtime-card').forEach(c => c.classList.remove('selected'));
        const card = document.querySelector(`.showtime-card[data-id="${showtime.id}"]`);
        if(card) card.classList.add('selected');
        
        currentSelections.showtime = showtime;
        nextButton.disabled = false;
    }

    function updateStepIndicator(step) {
        document.querySelectorAll('.step-circle').forEach((c, i) => {
            c.className = `step-circle ${i < step ? 'step-completed' : (i === step ? 'step-active' : 'step-pending')}`;
        });
    }

    cinemaSelect.addEventListener('change', function() {
        if (this.value) {
            currentSelections.cinema = { id: this.value, name: this.options[this.selectedIndex].text };
            loadMovies(this.value);
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!currentSelections.ticketType || !currentSelections.cinema || !currentSelections.movie || !currentSelections.showtime) {
            alert('è«‹å®Œæˆæ‰€æœ‰é¸æ“‡'); return;
        }
        
        // ã€å„ªåŒ–é»ã€‘å°‡ç•¶å‰é¸æ“‡çš„å½±åŸå’Œç¥¨å‹™é¡å‹å­˜å…¥ sessionStorage
        sessionStorage.setItem('returnFromStep2Data', JSON.stringify({
            ticketType: currentSelections.ticketType,
            cinemaId: currentSelections.cinema.id
        }));
        
        // ã€ä¿®æ­£é‡é»ã€‘ç¢ºä¿è³‡æ–™æ¬„ä½åç¨±çµ±ä¸€
        localStorage.setItem('currentBooking', JSON.stringify({
            ticketType: currentSelections.ticketType,
            cinema: currentSelections.cinema,
            movie: {
                id: currentSelections.movie.id,
                title: currentSelections.movie.name, // ç¢ºä¿æœ‰ title
                ...currentSelections.movie 
            },
            showtime: {
                id: currentSelections.showtime.id,
                date: currentSelections.showtime.date,
                time: currentSelections.showtime.time,
                theater: currentSelections.showtime.theater,
                type: currentSelections.showtime.format, // ç¢ºä¿æœ‰ type
                ...currentSelections.showtime
            }
        }));
        
        // é€å‡ºå¾Œæ¸…é™¤é é¸é›»å½±ï¼Œé¿å…ä¸‹æ¬¡å¹²æ“¾
        sessionStorage.removeItem('preSelectedMovie');
        window.location.href = currentSelections.ticketType === 'group' ? 'booking_flow_group.html' : 'booking_flow_2.html';
    });

    window.onload = () => {
        if (checkLoginStatus()) {
            setupTicketTypeSelection();
            localStorage.removeItem('currentBooking'); // æ¸…é™¤èˆŠè¨‚å–®
            // æ³¨æ„ï¼šé€™è£¡ä¸è¦æ¸…é™¤ preSelectedMovieï¼Œå› ç‚ºæˆ‘å€‘æ­£è¦ç”¨å®ƒ
        }
    };

    // Custom Alert (ä¿æŒèˆ‡æ‚¨ä¸€è‡´)
    function customAlert(message, callback) { 
        const existingModal = document.getElementById('custom-alert-modal');
        if (existingModal) existingModal.remove();
        const handleConfirm = () => {
            document.getElementById('custom-alert-modal').remove();
            if (callback && typeof callback === 'function') { callback(); }
        };
        window.customAlertConfirm = handleConfirm;
        const modalHtml = `
            <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                    <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
                    </div>
                    <p class="text-gray-700 mb-5">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.alert = customAlert;
</script>
</body>
</html>

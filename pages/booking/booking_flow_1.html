<!DOCTYPE html>

<html lang="zh-TW">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>訂票步驟 1: 選擇票務類型與場次 - Vieshow Ticketing</title> 



    <script src="https://cdn.tailwindcss.com"></script>

    

    <script>
    const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
    const INDEX_PAGE_URL = '../../index.html';
    const LOGIN_PAGE_URL = '../auth/login.html';
    const MEMBER_HOME_URL = '../member/member_home.html';

    // --- 全域變數 ---
    let currentSelections = { ticketType: null, cinema: null, movie: null, showtime: null };
    
    // 資料暫存
    let cinemaRawShowtimes = [];     // 該影城所有場次 (raw data)
    let allMoviesData = [];          // 所有電影資料 (Lazy Load)
    let isAllMoviesLoaded = false;   // 標記是否已載入所有電影
    
    let currentMovieShowtimesGrouped = {}; // 當前選中電影的場次 (按日期分組)
    let allSortedDates = [];         // 日期排序列表
    let currentDateIndex = 0;        // 目前顯示到第幾個日期
    
    const DAYS_PER_LOAD = 1;

    // DOM 元素
    const cinemaSelect = document.getElementById('cinema_location');
    const movieSelection = document.getElementById('movieSelection');
    const showtimeSelection = document.getElementById('showtimeSelection');
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const nextButton = document.getElementById('nextStepButton');
    const loadingStatus = document.getElementById('loadingStatus');
    const form = document.getElementById('bookingFlow1Form');
    const cinemaSelectionSection = document.getElementById('cinemaSelectionSection');
    const movieSelectionSection = document.getElementById('movieSelectionSection');
    const showtimeSelectionSection = document.getElementById('showtimeSelectionSection');

    // --- 登入與 UI ---
    function renderUI() {
        const token = localStorage.getItem('auth_token');
        const navRight = document.getElementById('headerNavRight');
        if (token) {
            navRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">登出</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">會員中心</a>`;
            document.getElementById('signOutLink').addEventListener('click', (e) => {
                e.preventDefault(); localStorage.removeItem('auth_token'); localStorage.removeItem('preSelectedMovie'); alert('已登出', () => window.location.href = INDEX_PAGE_URL);
            });
        } else {
            navRight.innerHTML = `<a href="${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}" class="hover:text-vieshow-gold transition duration-300">登入</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">會員中心</a>`;
        }
    }

    function checkLoginStatus() {
        if (!localStorage.getItem('auth_token')) {
            alert('請先登入才能進行訂票', () => { window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`; });
            return false;
        }
        renderUI(); return true;
    }

    // --- 核心邏輯 ---

    // 1. 初始化
    async function initPage() {
        if (!checkLoginStatus()) return;
        
        loadingStatus.textContent = '初始化中...';
        try {
            // 優先檢查是否有預選電影
            const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
            
            // 1. 載入影城 (這是必須的)
            await loadCinemas();

            if (preSelectedMovieStr) {
                // 【優化路徑 A】如果有預選電影，只處理該電影
                console.log("⚡ 偵測到預選電影，跳過全量載入");
                const preMovie = JSON.parse(preSelectedMovieStr);
                
                // 直接渲染這一部電影並選中
                renderSingleMovieCard(preMovie); 
                selectMovie(preMovie); // 預選狀態
                
                // 標記為尚未載入所有電影 (如果使用者換影城才載入)
                isAllMoviesLoaded = false;
                
                // 嘗試從返回資料恢復影城選擇 (如果有)
                const returnDataStr = sessionStorage.getItem('returnFromStep2Data');
                if (returnDataStr) {
                     const returnData = JSON.parse(returnDataStr);
                     if (returnData.cinemaId) {
                         cinemaSelect.value = returnData.cinemaId;
                         // 手動觸發 change，這會觸發 loadShowtimes 並可能覆蓋上面的單一顯示
                         // 為了保持流暢，我們在 change handler 裡處理
                         cinemaSelect.dispatchEvent(new Event('change'));
                     }
                     sessionStorage.removeItem('returnFromStep2Data');
                }

            } else {
                // 【一般路徑 B】無預選，載入所有電影
                await prefetchAllMovies();
                
                // 檢查返回資料
                const returnDataStr = sessionStorage.getItem('returnFromStep2Data');
                if (returnDataStr) {
                    const returnData = JSON.parse(returnDataStr);
                    if (returnData.ticketType) document.querySelector(`.ticket-type-card[data-type="${returnData.ticketType}"]`)?.click();
                    if (returnData.cinemaId) {
                        cinemaSelect.value = returnData.cinemaId;
                        cinemaSelect.dispatchEvent(new Event('change'));
                    }
                    sessionStorage.removeItem('returnFromStep2Data');
                }
            }

            loadingStatus.textContent = '';
            setupTicketTypeSelection();
            
        } catch (e) {
            console.error(e);
            loadingStatus.textContent = '系統初始化失敗';
        }
    }

    async function loadCinemas() {
        const res = await fetch(`${API_BASE_URL}/info/cinemas`);
        const cinemas = await res.json();
        cinemaSelect.innerHTML = '<option value="" disabled selected>請選擇影城地點</option>';
        cinemas.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id; opt.textContent = c.name;
            cinemaSelect.appendChild(opt);
        });
    }

    // 載入所有電影 (Lazy Load)
    async function prefetchAllMovies() {
        if (isAllMoviesLoaded) return; // 避免重複載入

        const res = await fetch(`${API_BASE_URL}/movie/now-playing`);
        let movies = await res.json();
        
        // 並行載入詳細資訊
        const detailedMovies = await Promise.all(movies.map(async (m) => {
            try {
                const cacheKey = `movie_cache_${m.id}`;
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) return { ...m, ...JSON.parse(cached) };

                const detailRes = await fetch(`${API_BASE_URL}/movie/${m.id}`);
                const detail = await detailRes.json();
                sessionStorage.setItem(cacheKey, JSON.stringify(detail));
                return { ...m, ...detail };
            } catch { return m; }
        }));
        
        allMoviesData = detailedMovies;
        isAllMoviesLoaded = true;
        renderAllMovies(allMoviesData);
    }

    function renderAllMovies(movies) {
        movieSelection.innerHTML = '';
        if (movies.length === 0) {
            movieSelection.innerHTML = '<div style="grid-column:1/-1; text-align:center;">暫無電影</div>';
            return;
        }
        movies.forEach(m => renderSingleMovieCard(m));
    }

    function renderSingleMovieCard(movie) {
        // 避免重複渲染
        if (document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`)) return;

        const card = document.createElement('div');
        card.className = 'movie-card cursor-pointer hidden-movie'; // 預設隱藏
        card.dataset.movieId = movie.id;
        
        let poster = movie.posterUrl || 'https://placehold.co/300x450?text=No+Poster';
        if (poster && !poster.startsWith('http') && !poster.startsWith('data:')) poster = '../../' + poster; 
        
        card.innerHTML = `
            <div class="movie-poster-container"><img src="${poster}" class="movie-poster"></div>
            <div class="movie-content">
                <h3 class="movie-title">${movie.name}</h3>
                <div class="movie-tags">
                    <span class="movie-tag tag-red">${movie.grade || '普遍級'}</span>
                    <span class="movie-tag tag-genre">${movie.genre || '劇情'}</span>
                    <span class="movie-tag tag-duration">${movie.duration || '未知片長'}</span>
                </div>
                <p class="movie-description">${movie.info || '暫無簡介'}</p>
            </div>`;
        card.onclick = () => selectMovie(movie);
        movieSelection.appendChild(card);
    }

    // 2. 選擇影城後
    cinemaSelect.addEventListener('change', async function() {
        const cinemaId = this.value;
        if (!cinemaId) return;

        currentSelections.cinema = { id: cinemaId, name: this.options[this.selectedIndex].text };
        resetSelection(2);
        
        loadingStatus.textContent = '載入影城場次中...';
        try {
            const res = await fetch(`${API_BASE_URL}/movie/showtimes?location=${cinemaId}`);
            cinemaRawShowtimes = await res.json(); 
            
            const availableMovieIds = new Set(cinemaRawShowtimes.map(s => s.movieId));
            
            // 【關鍵】如果還沒載入所有電影 (是預選進入的)，現在使用者換影城了，必須載入全部
            if (!isAllMoviesLoaded) {
                 // 這裡我們不強制載入全部，而是看預選電影是否在該影城有場次
                 const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
                 if (preSelectedMovieStr) {
                     const preMovie = JSON.parse(preSelectedMovieStr);
                     
                     // 如果該影城有這部片 -> 繼續只顯示這部片 (保持專注)
                     if (availableMovieIds.has(preMovie.id)) {
                         updateMoviesVisibility(new Set([preMovie.id])); 
                         selectMovie(preMovie);
                     } else {
                         // 如果該影城沒這部片 -> 必須載入所有電影讓使用者重選
                         await prefetchAllMovies();
                         updateMoviesVisibility(availableMovieIds);
                         sessionStorage.removeItem('preSelectedMovie'); // 清除無效預選
                         alert('此影城沒有您預選的電影，請重新選擇。');
                     }
                 } else {
                     await prefetchAllMovies();
                     updateMoviesVisibility(availableMovieIds);
                 }
            } else {
                updateMoviesVisibility(availableMovieIds);
            }
            
            movieSelectionSection.classList.remove('hidden');
            loadingStatus.textContent = '';
            
            // 處理預選電影的自動選定 (如果資料已在)
            const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
            if (preSelectedMovieStr) {
                const preMovie = JSON.parse(preSelectedMovieStr);
                if (availableMovieIds.has(preMovie.id)) {
                    // 確保該卡片是選中狀態
                    selectMovie(preMovie);
                    setTimeout(() => {
                        const card = document.querySelector(`.movie-card[data-movie-id="${preMovie.id}"]`);
                        if(card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }

        } catch (e) { console.error(e); }
    });

    function updateMoviesVisibility(availableIds) {
        const cards = document.querySelectorAll('.movie-card');
        let visibleCount = 0;
        cards.forEach(card => {
            const mId = parseInt(card.dataset.movieId);
            if (availableIds.has(mId)) {
                card.classList.remove('hidden-movie');
                visibleCount++;
            } else {
                card.classList.add('hidden-movie');
            }
        });
        
        if (visibleCount === 0) {
             if(!document.getElementById('no-movie-msg'))
                movieSelection.innerHTML += '<div id="no-movie-msg" style="grid-column:1/-1; text-align:center; padding:2rem;">此影城目前無上映電影</div>';
        } else {
            const msg = document.getElementById('no-movie-msg');
            if(msg) msg.remove();
        }
    }

    // 3. 選擇電影後
    function selectMovie(movie) {
        document.querySelectorAll('.movie-card').forEach(c => c.classList.remove('selected'));
        // 確保卡片存在 (如果是預選載入，可能還沒渲染，這裡補救一下)
        let card = document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`);
        if (!card) { renderSingleMovieCard(movie); card = document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`); }
        
        if(card) {
            card.classList.add('selected');
            card.classList.remove('hidden-movie'); // 確保預選的電影是顯示的
        }

        currentSelections.movie = movie;
        resetSelection(3);
        
        // 如果是剛進來還沒選影城，就只停在選中電影，不載入場次
        if (!currentSelections.cinema) return;

        const myShowtimes = cinemaRawShowtimes.filter(s => s.movieId === movie.id);
        
        if (myShowtimes.length === 0) {
            showtimeSelection.innerHTML = '<div style="text-align:center; padding:2rem;">查無場次</div>';
            showtimeSelectionSection.classList.remove('hidden');
            return;
        }

        currentMovieShowtimesGrouped = {};
        myShowtimes.forEach(s => {
            if (!currentMovieShowtimesGrouped[s.date]) currentMovieShowtimesGrouped[s.date] = [];
            currentMovieShowtimesGrouped[s.date].push(s);
        });
        
        allSortedDates = Object.keys(currentMovieShowtimesGrouped).sort();
        currentDateIndex = 0;
        
        showtimeSelection.innerHTML = ''; 
        renderNextDay();
        
        showtimeSelectionSection.classList.remove('hidden');
        updateStepIndicator(3);
        
        // 注意：這裡不清除 preSelectedMovie，因為如果使用者切換影城，我們還需要它來自動選中
        // 只有在 submit 或離開時才清除
    }

    // 4. 渲染日期場次
    async function renderNextDay() {
        if (currentDateIndex >= allSortedDates.length) return;

        const date = allSortedDates[currentDateIndex];
        const rawShowtimes = currentMovieShowtimesGrouped[date];
        
        const section = document.createElement('div'); 
        section.className = 'date-section';
        section.innerHTML = `<h4 class="date-header">${date} <span class="text-sm font-normal text-gray-500 ml-2 animate-pulse">(查詢座位中...)</span></h4>`;
        const grid = document.createElement('div'); 
        grid.className = 'showtime-grid';
        section.appendChild(grid);
        
        showtimeSelection.appendChild(section);

        const isGroupTicket = currentSelections.ticketType === 'group';
        const GROUP_MIN_SEATS = 10;

        try {
            const showtimesWithSeats = await Promise.all(rawShowtimes.map(async (s) => {
                let availableSeats = 0;
                try {
                    const seatsRes = await fetch(`${API_BASE_URL}/booking/seats?showingId=${s.id}`);
                    const seats = await seatsRes.json();
                    availableSeats = seats.filter(seat => seat.status === 1).length;
                } catch { availableSeats = 0; }
                return { ...s, availableSeats };
            }));

            showtimesWithSeats.forEach(s => {
                const available = s.availableSeats;
                const isTooFew = isGroupTicket && available < GROUP_MIN_SEATS;
                const isFull = available <= 0;

                const card = document.createElement('div');
                card.className = `showtime-card ${isFull || isTooFew ? 'disabled-group' : ''}`;
                card.dataset.id = s.id;

                let seatsStatusHTML = '';
                if (isTooFew) seatsStatusHTML = `<div class="showtime-row text-xs text-vieshow-red font-bold">剩餘座位不足 (需 ${GROUP_MIN_SEATS} 張)</div>`;
                else if (isFull) seatsStatusHTML = `<div class="showtime-row text-xs text-gray-500 font-bold">已售完</div>`;
                else if (available <= 10) seatsStatusHTML = `<div class="showtime-row text-xs text-red-500 font-bold">⚠️ 僅剩 ${available} 張</div>`;
                else seatsStatusHTML = `<div class="showtime-row text-xs text-green-500 font-bold">剩餘 ${available} 席</div>`;

                card.innerHTML = `
                    <div class="showtime-time">${s.time}</div>
                    <div class="showtime-details">
                        <div class="showtime-row"><span>影廳:</span><span class="font-medium">${s.theater}</span></div>
                        <div class="showtime-row"><span>版本:</span><span class="font-medium">${s.format}</span></div>
                        ${seatsStatusHTML}
                    </div>`;

                if (!isFull && !isTooFew) {
                    card.onclick = () => selectShowtime(s);
                } else if (isTooFew) {
                     card.onclick = () => alert(`選擇團體票時，此場次剩餘座位 (${available} 張) 不足 ${GROUP_MIN_SEATS} 張。`);
                }
                grid.appendChild(card);
            });

            const loadingSpan = section.querySelector('.date-header span');
            if(loadingSpan) loadingSpan.remove();

        } catch (e) {
            console.error(e);
            section.querySelector('.date-header span').textContent = "(座位載入失敗)";
        }

        currentDateIndex++;
        renderLoadMoreButton();
    }

    function renderLoadMoreButton() {
        loadMoreContainer.innerHTML = ''; 
        if (currentDateIndex < allSortedDates.length) {
            const nextDate = allSortedDates[currentDateIndex];
            const btn = document.createElement('button');
            btn.className = 'load-more-btn';
            btn.textContent = `顯示下一天 (${nextDate}) ▼`;
            btn.type = 'button'; 
            btn.onclick = () => {
                btn.textContent = "載入中...";
                btn.disabled = true;
                renderNextDay(); 
            };
            loadMoreContainer.appendChild(btn);
        }
    }

    // --- 輔助函式 ---
    function selectShowtime(showtime) {
        document.querySelectorAll('.showtime-card').forEach(c => c.classList.remove('selected'));
        const card = document.querySelector(`.showtime-card[data-id="${showtime.id}"]`);
        if(card) card.classList.add('selected');
        currentSelections.showtime = showtime;
        nextButton.disabled = false;
    }

    function updateStepIndicator(step) {
        document.querySelectorAll('.step-circle').forEach((c, i) => {
            c.className = `step-circle ${i < step ? 'step-completed' : (i === step ? 'step-active' : 'step-pending')}`;
        });
    }

    function setupTicketTypeSelection() {
        document.querySelectorAll('.ticket-type-card').forEach(card => {
            card.onclick = function() {
                document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                currentSelections.ticketType = this.dataset.type;
                document.getElementById('groupTicketInfo').classList.toggle('hidden', currentSelections.ticketType !== 'group');
                nextButton.textContent = currentSelections.ticketType === 'group' ? '下一步: 填寫團體資訊' : '下一步: 選擇票種與餐點';
                resetSelection(1);
                document.getElementById('cinemaSelectionSection').classList.remove('hidden');
                updateStepIndicator(1);
            };
        });
    }

    function resetSelection(step) {
        if (step <= 1) { currentSelections.cinema = null; cinemaSelect.selectedIndex = 0; movieSelectionSection.classList.add('hidden'); }
        if (step <= 2) { 
            // 只有在真的要切換電影時才隱藏，如果是切換影城但保留電影則不隱藏
            // 這裡簡單處理：切換影城時會重置電影選擇
            currentSelections.movie = null; 
            showtimeSelectionSection.classList.add('hidden'); 
            showtimeSelection.innerHTML = ''; 
            loadMoreContainer.innerHTML = ''; 
        }
        if (step <= 3) { currentSelections.showtime = null; nextButton.disabled = true; }
    }

    form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentSelections.ticketType || !currentSelections.cinema || !currentSelections.movie || !currentSelections.showtime) {
                alert('請完成所有選擇'); return;
            }
            sessionStorage.setItem('returnFromStep2Data', JSON.stringify({
                ticketType: currentSelections.ticketType,
                cinemaId: currentSelections.cinema.id
            }));
            const availableSeats = currentSelections.showtime.availableSeats || 0;
            if (currentSelections.ticketType === 'general' && availableSeats < 1) {
                return alert('該場次已無座位，請重新選擇場次');
            }
            localStorage.setItem('currentBooking', JSON.stringify({
                ticketType: currentSelections.ticketType,
                cinema: currentSelections.cinema,
                movie: {
                    id: currentSelections.movie.id,
                    title: currentSelections.movie.name, 
                    ...currentSelections.movie 
                },
                showtime: {
                    id: currentSelections.showtime.id,
                    date: currentSelections.showtime.date,
                    time: currentSelections.showtime.time,
                    theater: currentSelections.showtime.theater,
                    type: currentSelections.showtime.format,
                    availableSeats: availableSeats, 
                    ...currentSelections.showtime
                }
            }));
            
            // 真正提交後才清除預選
            sessionStorage.removeItem('preSelectedMovie');
            window.location.href = currentSelections.ticketType === 'group' ? 'booking_flow_group.html' : 'booking_flow_2.html';
    });

    document.addEventListener('DOMContentLoaded', initPage);

    // Alert
    function customAlert(message, callback) { 
        const existingModal = document.getElementById('custom-alert-modal');
        if (existingModal) existingModal.remove();
        const handleConfirm = () => {
            document.getElementById('custom-alert-modal').remove();
            if (callback && typeof callback === 'function') { callback(); }
        };
        window.customAlertConfirm = handleConfirm;
        const modalHtml = `
            <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                    <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>系統提示
                    </div>
                    <p class="text-gray-700 mb-5">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">確認</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.alert = customAlert;
    </script>

</body>

</html>



<!DOCTYPE html>

<html lang="zh-TW">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>è¨‚ç¥¨æ­¥é©Ÿ 1: é¸æ“‡ç¥¨å‹™é¡å‹èˆ‡å ´æ¬¡ - Vieshow Ticketing</title> 



    <script src="https://cdn.tailwindcss.com"></script>

    

    <script>

        tailwind.config = {

            theme: {

                extend: {

                    colors: {

                        'vieshow-red': '#e50914',

                        'vieshow-gold': '#f7a83d',

                        'vieshow-dark': '#1a1a1a',

                        'gray-500': '#6b7280',

                    },

                    fontFamily: {

                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],

                    },

                }

            }

        };



        // è‡ªå®šç¾© Alert (å¿…é ˆæ”¾åœ¨æœ€å‰é¢ç¢ºä¿å¯ç”¨)

        function customAlert(message, callback) { 

            const existingModal = document.getElementById('custom-alert-modal');

            if (existingModal) existingModal.remove();



            const handleConfirm = () => {

                document.getElementById('custom-alert-modal').remove();

                if (callback && typeof callback === 'function') { callback(); }

            };

            window.customAlertConfirm = handleConfirm;



            const modalHtml = `

                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">

                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">

                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">

                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º

                        </div>

                        <p class="text-gray-700 mb-5">${message}</p>

                        <div class="flex justify-end">

                            <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>

                        </div>

                    </div>

                </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

        }

        window.alert = customAlert;

    </script>

    

    <style>

        /* (CSS æ¨£å¼ä¿æŒä¸è®Š) */

        body { background-color: #f7f7f7; font-family: 'Noto Sans TC', 'Inter', sans-serif; color: #333; }

        .main-content { padding: 2rem 0; min-height: 80vh; }

        .container { max-width: 1000px; margin: 0 auto; padding: 0 1rem; }

        .booking-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); padding: 2rem; }

        .title-section { border-bottom: 1px solid #e5e5e5; padding-bottom: 1.5rem; margin-bottom: 2rem; }

        .main-title { font-size: 1.875rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.5rem; }

        .step-title { font-size: 1.25rem; font-weight: 600; color: #e50914; }

        .step-description { color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem; }

        .step-indicator { display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; }

        .step-circle { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; color: white; background-color: #9ca3af; transition: all 0.3s; }

        .step-active { background-color: #e50914; box-shadow: 0 0 0 5px rgba(229, 9, 20, 0.3); }

        .step-completed { background-color: #10b981; }

        .step-line { width: 3rem; height: 3px; background-color: #9ca3af; margin: 0 0.5rem; transition: background-color 0.3s; }

        .step-line.step-active { background-color: #e50914; }

        .form-section > div { padding: 1rem 0; border-bottom: 1px solid #f3f4f6; }

        .section-label { display: block; font-size: 1.125rem; font-weight: 600; color: #333; margin-top: 1.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; }

        .select-styled { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; background-color: #f9fafb; font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s; }

        .select-styled:focus { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); outline: none; }

        .select-help { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }

        .ticket-type-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }

        .ticket-type-card { border: 2px solid #e5e5e5; border-radius: 0.75rem; padding: 1.5rem; cursor: pointer; transition: all 0.2s; position: relative; }

        .ticket-type-card:hover { border-color: #f7a83d; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }

        .ticket-type-card.selected { border-color: #e50914; box-shadow: 0 0 0 4px rgba(229, 9, 20, 0.1); background-color: #fff5f5; }

        .ticket-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }

        .ticket-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }

        .ticket-description { color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem; }

        .feature-item { display: flex; align-items: center; font-size: 0.9rem; margin-bottom: 0.5rem; }

        .feature-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }

        .dot-blue { background-color: #3b82f6; }

        .dot-green { background-color: #10b981; }

        .group-ticket-info { margin-top: 1rem; padding: 1rem; background-color: #f0fdf4; border: 1px dashed #4ade80; border-radius: 0.5rem; }

        .group-ticket-title { font-weight: 600; color: #16a34a; margin-bottom: 0.5rem; }

        .group-ticket-list { list-style: none; padding-left: 0; font-size: 0.9rem; color: #16a34a; }

        .movie-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }

        .movie-card { border: 1px solid #e5e5e5; border-radius: 0.75rem; overflow: hidden; transition: all 0.2s; background-color: #fafafa; position: relative; }

        .movie-card:hover { box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); transform: translateY(-2px); }

        .movie-card.selected { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); }

        .movie-content { padding: 1rem; }

        .movie-layout { display: flex; gap: 1rem; }

        .movie-poster-container { flex-shrink: 0; width: 100px; height: 150px; }

        .movie-poster { width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; }

        .movie-details { flex-grow: 1; }

        .movie-title { font-size: 1.125rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.25rem; }

        .movie-tags { margin-bottom: 0.5rem; }

        .movie-tag { display: inline-block; padding: 0.1rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; }

        .tag-red { background-color: #fee2e2; color: #ef4444; }

        .tag-gray { background-color: #e5e7eb; color: #4b5563; }

        .movie-description { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;}

        .showtime-section { padding: 1rem 0; background-color: #f9fafb; border-radius: 0.75rem; }

        .date-section { padding: 0 1rem 1rem 1rem; }

        .date-header { font-size: 1.125rem; font-weight: 700; color: #1a1a1a; background-color: #f3f4f6; padding: 0.5rem 1rem; margin: 1rem -1rem 1rem -1rem; border-bottom: 1px solid #e5e7eb; }

        .showtime-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        .showtime-card { border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.2s; background-color: white; position: relative; }

        .showtime-card:hover { border-color: #f7a83d; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }

        .showtime-card.selected { border-color: #e50914; box-shadow: 0 0 0 3px rgba(229, 9, 20, 0.2); background-color: #fff5f5; }

        .showtime-time { font-size: 1.5rem; font-weight: 700; color: #e50914; margin-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; }

        .showtime-details { font-size: 0.875rem; color: #4b5563; }

        .showtime-row { display: flex; justify-content: space-between; margin-bottom: 0.25rem; }

        .button-container { padding-top: 2rem; text-align: center; }

        .next-step-button { background-color: #e50914; color: white; padding: 0.8rem 2rem; font-size: 1.125rem; font-weight: 700; border-radius: 0.5rem; transition: background-color 0.2s; }

        .next-step-button:hover:not(:disabled) { background-color: #c50711; }

        .next-step-button:disabled { background-color: #fda4af; cursor: not-allowed; }

        .loading-message { text-align: center; margin-top: 1.5rem; font-size: 0.95rem; color: #6b7280; }

        footer { text-align: center; padding: 1.5rem; background-color: #1a1a1a; color: #9ca3af; font-size: 0.875rem; margin-top: 2rem; }

        

        /* è¼‰å…¥æ›´å¤šæŒ‰éˆ•æ¨£å¼ */

        .load-more-btn {

            display: block;

            width: 100%;

            max-width: 200px;

            margin: 1.5rem auto 0;

            padding: 0.75rem;

            background-color: white;

            color: #6b7280;

            border: 1px solid #d1d5db;

            border-radius: 0.5rem;

            font-weight: 600;

            text-align: center;

            transition: all 0.2s;

        }

        .load-more-btn:hover {

            color: #e50914;

            border-color: #e50914;

            background-color: #fff1f2;

        }

    </style>

</head>

<body>

    

    <header class="bg-gray-800 text-white shadow-md">

        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">

            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>

            <div id="headerNavRight" class="space-x-4"></div>

        </nav>

    </header>



    <div class="main-content">

        <div class="container">

            <div class="step-indicator">

                <div class="step-circle step-active">1</div>

                <div class="step-line step-pending"></div>

                <div class="step-circle step-pending">2</div>

                <div class="step-line step-pending"></div>

                <div class="step-circle step-pending">3</div>

                <div class="step-line step-pending"></div>

                <div class="step-circle step-pending">4</div>

                <div class="step-line step-pending"></div>

                <div class="step-circle step-pending">5</div>

            </div>

            

            <div id="bookingCard" class="booking-card">

                

                <div class="title-section">

                    <h1 class="main-title">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>

                    <p class="step-title">é¸æ“‡ç¥¨å‹™é¡å‹èˆ‡å ´æ¬¡</p>

                    <p class="step-description">è«‹å…ˆé¸æ“‡ç¥¨å‹™é¡å‹ï¼Œç„¶å¾Œä¾åºé¸æ“‡å½±åŸã€é›»å½±å’Œå ´æ¬¡ã€‚</p>

                </div>



                <form id="bookingFlow1Form" action="#" method="POST" class="form-section">

                    

                    <div id="ticketTypeSection">

                        <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ«</span> é¸æ“‡ç¥¨å‹™é¡å‹</label>

                        <div class="ticket-type-grid">

                            <div class="ticket-type-card general" data-type="general">

                                <div class="ticket-type-content">

                                    <div class="ticket-icon">ğŸ‘¤</div>

                                    <h3 class="ticket-title">ä¸€èˆ¬è³¼ç¥¨</h3>

                                    <p class="ticket-description">å€‹äººæˆ–å°åœ˜é«”è§€å½±é¸æ“‡</p>

                                    <div class="ticket-features">

                                        <div class="feature-item"><span class="feature-dot dot-blue"></span><span>é©åˆ **1-9 äºº**è§€å½±</span></div>

                                        <div class="feature-item"><span class="feature-dot dot-blue"></span><span>å¤šç¨®ç¥¨ç¨®é¸æ“‡</span></div>

                                    </div>

                                </div>

                            </div>

                            <div class="ticket-type-card group" data-type="group">

                                <div class="ticket-type-content">

                                    <div class="ticket-icon">ğŸ‘¥</div>

                                    <h3 class="ticket-title">åœ˜é«”ç¥¨</h3>

                                    <p class="ticket-description">10äººä»¥ä¸Šåœ˜é«”å„ªæƒ </p>

                                    <div class="ticket-features">

                                        <div class="feature-item"><span class="feature-dot dot-green"></span><span>é©åˆ **10-20 äºº**åœ˜é«”</span></div>

                                        <div class="feature-item"><span class="feature-dot dot-green"></span><span>å°ˆå±¬åœ˜é«”å„ªæƒ åƒ¹</span></div>

                                    </div>

                                </div>

                            </div>

                        </div>

                        <div id="groupTicketInfo" class="group-ticket-info hidden">

                            <h4 class="group-ticket-title">ğŸ‰ åœ˜é«”ç¥¨å°ˆå±¬å„ªæƒ </h4>

                            <ul class="group-ticket-list">

                                <li>â€¢ **10äººä»¥ä¸Š**äº«åœ˜é«”å„ªæƒ åƒ¹ (é™ **20 äºº**ä»¥ä¸‹)</li>

                                <li>â€¢ éœ€æ–¼è§€å½±å‰3å¤©é è¨‚</li>

                            </ul>

                        </div>

                    </div>

                    

                    <div id="cinemaSelectionSection" class="hidden">

                        <label for="cinema_location" class="section-label"><span style="margin-right: 0.5rem;">ğŸ“</span> é¸æ“‡å½±åŸåœ°é»</label>

                        <select id="cinema_location" name="cinema_location" required class="select-styled">

                            <option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>

                        </select>

                        <p class="select-help">é¸æ“‡æ‚¨æƒ³è§€å½±çš„å½±åŸåœ°é» (**å¿…å¡«**)</p>

                    </div>

                    

                    <div id="movieSelectionSection" class="hidden">

                        <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ¬</span> é¸æ“‡é›»å½±</label>

                        <div id="movieSelection" class="movie-grid">

                            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem 0; color: var(--gray-500);">è«‹å…ˆé¸æ“‡å½±åŸåœ°é»ä»¥é¡¯ç¤ºé›»å½±æ¸…å–®</div>

                        </div>

                    </div>

                    

                    <div id="showtimeSelectionSection" class="hidden">

                        <label class="section-label"><span style="margin-right: 0.5rem;">ğŸ•’</span> é¸æ“‡å ´æ¬¡</label>

                        <div id="showtimeSelection" class="showtime-section">

                            <div style="text-align: center; padding: 2rem 0; color: var(--gray-500);">è«‹å…ˆé¸æ“‡é›»å½±ä»¥é¡¯ç¤ºå ´æ¬¡è³‡è¨Š</div>

                        </div>

                        <div id="loadMoreContainer"></div>

                    </div>

                    

                    <div id="loadingStatus" class="loading-message"></div>



                    <div class="button-container">

                        <button type="submit" id="nextStepButton" class="next-step-button" disabled>ä¸‹ä¸€æ­¥: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»</button>

                    </div>

                </form>

            </div>

        </div>

    </div>



    <footer><p>&copy; 2025 Vieshow Ticketing System</p></footer>



    <script>
    const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
    const INDEX_PAGE_URL = '../../index.html';
    const LOGIN_PAGE_URL = '../auth/login.html';
    const MEMBER_HOME_URL = '../member/member_home.html';

    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentSelections = { ticketType: null, cinema: null, movie: null, showtime: null };
    
    // è³‡æ–™æš«å­˜
    let cinemaRawShowtimes = [];     // è©²å½±åŸæ‰€æœ‰å ´æ¬¡ (raw data)
    let allMoviesData = [];          // æ‰€æœ‰é›»å½±è³‡æ–™ (Lazy Load)
    let isAllMoviesLoaded = false;   // æ¨™è¨˜æ˜¯å¦å·²è¼‰å…¥æ‰€æœ‰é›»å½±
    
    let currentMovieShowtimesGrouped = {}; // ç•¶å‰é¸ä¸­é›»å½±çš„å ´æ¬¡ (æŒ‰æ—¥æœŸåˆ†çµ„)
    let allSortedDates = [];         // æ—¥æœŸæ’åºåˆ—è¡¨
    let currentDateIndex = 0;        // ç›®å‰é¡¯ç¤ºåˆ°ç¬¬å¹¾å€‹æ—¥æœŸ
    
    const DAYS_PER_LOAD = 1;

    // DOM å…ƒç´ 
    const cinemaSelect = document.getElementById('cinema_location');
    const movieSelection = document.getElementById('movieSelection');
    const showtimeSelection = document.getElementById('showtimeSelection');
    const loadMoreContainer = document.getElementById('loadMoreContainer');
    const nextButton = document.getElementById('nextStepButton');
    const loadingStatus = document.getElementById('loadingStatus');
    const form = document.getElementById('bookingFlow1Form');
    const cinemaSelectionSection = document.getElementById('cinemaSelectionSection');
    const movieSelectionSection = document.getElementById('movieSelectionSection');
    const showtimeSelectionSection = document.getElementById('showtimeSelectionSection');

    // --- ç™»å…¥èˆ‡ UI ---
    function renderUI() {
        const token = localStorage.getItem('auth_token');
        const navRight = document.getElementById('headerNavRight');
        if (token) {
            navRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
            document.getElementById('signOutLink').addEventListener('click', (e) => {
                e.preventDefault(); localStorage.removeItem('auth_token'); localStorage.removeItem('preSelectedMovie'); alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
            });
        } else {
            navRight.innerHTML = `<a href="${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
        }
    }

    function checkLoginStatus() {
        if (!localStorage.getItem('auth_token')) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨', () => { window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`; });
            return false;
        }
        renderUI(); return true;
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---

    // 1. åˆå§‹åŒ–
    async function initPage() {
        if (!checkLoginStatus()) return;
        
        loadingStatus.textContent = 'åˆå§‹åŒ–ä¸­...';
        try {
            // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰é é¸é›»å½±
            const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
            
            // 1. è¼‰å…¥å½±åŸ (é€™æ˜¯å¿…é ˆçš„)
            await loadCinemas();

            if (preSelectedMovieStr) {
                // ã€å„ªåŒ–è·¯å¾‘ Aã€‘å¦‚æœæœ‰é é¸é›»å½±ï¼Œåªè™•ç†è©²é›»å½±
                console.log("âš¡ åµæ¸¬åˆ°é é¸é›»å½±ï¼Œè·³éå…¨é‡è¼‰å…¥");
                const preMovie = JSON.parse(preSelectedMovieStr);
                
                // ç›´æ¥æ¸²æŸ“é€™ä¸€éƒ¨é›»å½±ä¸¦é¸ä¸­
                renderSingleMovieCard(preMovie); 
                selectMovie(preMovie); // é é¸ç‹€æ…‹
                
                // æ¨™è¨˜ç‚ºå°šæœªè¼‰å…¥æ‰€æœ‰é›»å½± (å¦‚æœä½¿ç”¨è€…æ›å½±åŸæ‰è¼‰å…¥)
                isAllMoviesLoaded = false;
                
                // å˜—è©¦å¾è¿”å›è³‡æ–™æ¢å¾©å½±åŸé¸æ“‡ (å¦‚æœæœ‰)
                const returnDataStr = sessionStorage.getItem('returnFromStep2Data');
                if (returnDataStr) {
                     const returnData = JSON.parse(returnDataStr);
                     if (returnData.cinemaId) {
                         cinemaSelect.value = returnData.cinemaId;
                         // æ‰‹å‹•è§¸ç™¼ changeï¼Œé€™æœƒè§¸ç™¼ loadShowtimes ä¸¦å¯èƒ½è¦†è“‹ä¸Šé¢çš„å–®ä¸€é¡¯ç¤º
                         // ç‚ºäº†ä¿æŒæµæš¢ï¼Œæˆ‘å€‘åœ¨ change handler è£¡è™•ç†
                         cinemaSelect.dispatchEvent(new Event('change'));
                     }
                     sessionStorage.removeItem('returnFromStep2Data');
                }

            } else {
                // ã€ä¸€èˆ¬è·¯å¾‘ Bã€‘ç„¡é é¸ï¼Œè¼‰å…¥æ‰€æœ‰é›»å½±
                await prefetchAllMovies();
                
                // æª¢æŸ¥è¿”å›è³‡æ–™
                const returnDataStr = sessionStorage.getItem('returnFromStep2Data');
                if (returnDataStr) {
                    const returnData = JSON.parse(returnDataStr);
                    if (returnData.ticketType) document.querySelector(`.ticket-type-card[data-type="${returnData.ticketType}"]`)?.click();
                    if (returnData.cinemaId) {
                        cinemaSelect.value = returnData.cinemaId;
                        cinemaSelect.dispatchEvent(new Event('change'));
                    }
                    sessionStorage.removeItem('returnFromStep2Data');
                }
            }

            loadingStatus.textContent = '';
            setupTicketTypeSelection();
            
        } catch (e) {
            console.error(e);
            loadingStatus.textContent = 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—';
        }
    }

    async function loadCinemas() {
        const res = await fetch(`${API_BASE_URL}/info/cinemas`);
        const cinemas = await res.json();
        cinemaSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å½±åŸåœ°é»</option>';
        cinemas.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id; opt.textContent = c.name;
            cinemaSelect.appendChild(opt);
        });
    }

    // è¼‰å…¥æ‰€æœ‰é›»å½± (Lazy Load)
    async function prefetchAllMovies() {
        if (isAllMoviesLoaded) return; // é¿å…é‡è¤‡è¼‰å…¥

        const res = await fetch(`${API_BASE_URL}/movie/now-playing`);
        let movies = await res.json();
        
        // ä¸¦è¡Œè¼‰å…¥è©³ç´°è³‡è¨Š
        const detailedMovies = await Promise.all(movies.map(async (m) => {
            try {
                const cacheKey = `movie_cache_${m.id}`;
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) return { ...m, ...JSON.parse(cached) };

                const detailRes = await fetch(`${API_BASE_URL}/movie/${m.id}`);
                const detail = await detailRes.json();
                sessionStorage.setItem(cacheKey, JSON.stringify(detail));
                return { ...m, ...detail };
            } catch { return m; }
        }));
        
        allMoviesData = detailedMovies;
        isAllMoviesLoaded = true;
        renderAllMovies(allMoviesData);
    }

    function renderAllMovies(movies) {
        movieSelection.innerHTML = '';
        if (movies.length === 0) {
            movieSelection.innerHTML = '<div style="grid-column:1/-1; text-align:center;">æš«ç„¡é›»å½±</div>';
            return;
        }
        movies.forEach(m => renderSingleMovieCard(m));
    }

    function renderSingleMovieCard(movie) {
        // é¿å…é‡è¤‡æ¸²æŸ“
        if (document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`)) return;

        const card = document.createElement('div');
        card.className = 'movie-card cursor-pointer hidden-movie'; // é è¨­éš±è—
        card.dataset.movieId = movie.id;
        
        let poster = movie.posterUrl || 'https://placehold.co/300x450?text=No+Poster';
        if (poster && !poster.startsWith('http') && !poster.startsWith('data:')) poster = '../../' + poster; 
        
        card.innerHTML = `
            <div class="movie-poster-container"><img src="${poster}" class="movie-poster"></div>
            <div class="movie-content">
                <h3 class="movie-title">${movie.name}</h3>
                <div class="movie-tags">
                    <span class="movie-tag tag-red">${movie.grade || 'æ™®éç´š'}</span>
                    <span class="movie-tag tag-genre">${movie.genre || 'åŠ‡æƒ…'}</span>
                    <span class="movie-tag tag-duration">${movie.duration || 'æœªçŸ¥ç‰‡é•·'}</span>
                </div>
                <p class="movie-description">${movie.info || 'æš«ç„¡ç°¡ä»‹'}</p>
            </div>`;
        card.onclick = () => selectMovie(movie);
        movieSelection.appendChild(card);
    }

    // 2. é¸æ“‡å½±åŸå¾Œ
    cinemaSelect.addEventListener('change', async function() {
        const cinemaId = this.value;
        if (!cinemaId) return;

        currentSelections.cinema = { id: cinemaId, name: this.options[this.selectedIndex].text };
        resetSelection(2);
        
        loadingStatus.textContent = 'è¼‰å…¥å½±åŸå ´æ¬¡ä¸­...';
        try {
            const res = await fetch(`${API_BASE_URL}/movie/showtimes?location=${cinemaId}`);
            cinemaRawShowtimes = await res.json(); 
            
            const availableMovieIds = new Set(cinemaRawShowtimes.map(s => s.movieId));
            
            // ã€é—œéµã€‘å¦‚æœé‚„æ²’è¼‰å…¥æ‰€æœ‰é›»å½± (æ˜¯é é¸é€²å…¥çš„)ï¼Œç¾åœ¨ä½¿ç”¨è€…æ›å½±åŸäº†ï¼Œå¿…é ˆè¼‰å…¥å…¨éƒ¨
            if (!isAllMoviesLoaded) {
                 // é€™è£¡æˆ‘å€‘ä¸å¼·åˆ¶è¼‰å…¥å…¨éƒ¨ï¼Œè€Œæ˜¯çœ‹é é¸é›»å½±æ˜¯å¦åœ¨è©²å½±åŸæœ‰å ´æ¬¡
                 const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
                 if (preSelectedMovieStr) {
                     const preMovie = JSON.parse(preSelectedMovieStr);
                     
                     // å¦‚æœè©²å½±åŸæœ‰é€™éƒ¨ç‰‡ -> ç¹¼çºŒåªé¡¯ç¤ºé€™éƒ¨ç‰‡ (ä¿æŒå°ˆæ³¨)
                     if (availableMovieIds.has(preMovie.id)) {
                         updateMoviesVisibility(new Set([preMovie.id])); 
                         selectMovie(preMovie);
                     } else {
                         // å¦‚æœè©²å½±åŸæ²’é€™éƒ¨ç‰‡ -> å¿…é ˆè¼‰å…¥æ‰€æœ‰é›»å½±è®“ä½¿ç”¨è€…é‡é¸
                         await prefetchAllMovies();
                         updateMoviesVisibility(availableMovieIds);
                         sessionStorage.removeItem('preSelectedMovie'); // æ¸…é™¤ç„¡æ•ˆé é¸
                         alert('æ­¤å½±åŸæ²’æœ‰æ‚¨é é¸çš„é›»å½±ï¼Œè«‹é‡æ–°é¸æ“‡ã€‚');
                     }
                 } else {
                     await prefetchAllMovies();
                     updateMoviesVisibility(availableMovieIds);
                 }
            } else {
                updateMoviesVisibility(availableMovieIds);
            }
            
            movieSelectionSection.classList.remove('hidden');
            loadingStatus.textContent = '';
            
            // è™•ç†é é¸é›»å½±çš„è‡ªå‹•é¸å®š (å¦‚æœè³‡æ–™å·²åœ¨)
            const preSelectedMovieStr = sessionStorage.getItem('preSelectedMovie');
            if (preSelectedMovieStr) {
                const preMovie = JSON.parse(preSelectedMovieStr);
                if (availableMovieIds.has(preMovie.id)) {
                    // ç¢ºä¿è©²å¡ç‰‡æ˜¯é¸ä¸­ç‹€æ…‹
                    selectMovie(preMovie);
                    setTimeout(() => {
                        const card = document.querySelector(`.movie-card[data-movie-id="${preMovie.id}"]`);
                        if(card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                }
            }

        } catch (e) { console.error(e); }
    });

    function updateMoviesVisibility(availableIds) {
        const cards = document.querySelectorAll('.movie-card');
        let visibleCount = 0;
        cards.forEach(card => {
            const mId = parseInt(card.dataset.movieId);
            if (availableIds.has(mId)) {
                card.classList.remove('hidden-movie');
                visibleCount++;
            } else {
                card.classList.add('hidden-movie');
            }
        });
        
        if (visibleCount === 0) {
             if(!document.getElementById('no-movie-msg'))
                movieSelection.innerHTML += '<div id="no-movie-msg" style="grid-column:1/-1; text-align:center; padding:2rem;">æ­¤å½±åŸç›®å‰ç„¡ä¸Šæ˜ é›»å½±</div>';
        } else {
            const msg = document.getElementById('no-movie-msg');
            if(msg) msg.remove();
        }
    }

    // 3. é¸æ“‡é›»å½±å¾Œ
    function selectMovie(movie) {
        document.querySelectorAll('.movie-card').forEach(c => c.classList.remove('selected'));
        // ç¢ºä¿å¡ç‰‡å­˜åœ¨ (å¦‚æœæ˜¯é é¸è¼‰å…¥ï¼Œå¯èƒ½é‚„æ²’æ¸²æŸ“ï¼Œé€™è£¡è£œæ•‘ä¸€ä¸‹)
        let card = document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`);
        if (!card) { renderSingleMovieCard(movie); card = document.querySelector(`.movie-card[data-movie-id="${movie.id}"]`); }
        
        if(card) {
            card.classList.add('selected');
            card.classList.remove('hidden-movie'); // ç¢ºä¿é é¸çš„é›»å½±æ˜¯é¡¯ç¤ºçš„
        }

        currentSelections.movie = movie;
        resetSelection(3);
        
        // å¦‚æœæ˜¯å‰›é€²ä¾†é‚„æ²’é¸å½±åŸï¼Œå°±åªåœåœ¨é¸ä¸­é›»å½±ï¼Œä¸è¼‰å…¥å ´æ¬¡
        if (!currentSelections.cinema) return;

        const myShowtimes = cinemaRawShowtimes.filter(s => s.movieId === movie.id);
        
        if (myShowtimes.length === 0) {
            showtimeSelection.innerHTML = '<div style="text-align:center; padding:2rem;">æŸ¥ç„¡å ´æ¬¡</div>';
            showtimeSelectionSection.classList.remove('hidden');
            return;
        }

        currentMovieShowtimesGrouped = {};
        myShowtimes.forEach(s => {
            if (!currentMovieShowtimesGrouped[s.date]) currentMovieShowtimesGrouped[s.date] = [];
            currentMovieShowtimesGrouped[s.date].push(s);
        });
        
        allSortedDates = Object.keys(currentMovieShowtimesGrouped).sort();
        currentDateIndex = 0;
        
        showtimeSelection.innerHTML = ''; 
        renderNextDay();
        
        showtimeSelectionSection.classList.remove('hidden');
        updateStepIndicator(3);
        
        // æ³¨æ„ï¼šé€™è£¡ä¸æ¸…é™¤ preSelectedMovieï¼Œå› ç‚ºå¦‚æœä½¿ç”¨è€…åˆ‡æ›å½±åŸï¼Œæˆ‘å€‘é‚„éœ€è¦å®ƒä¾†è‡ªå‹•é¸ä¸­
        // åªæœ‰åœ¨ submit æˆ–é›¢é–‹æ™‚æ‰æ¸…é™¤
    }

    // 4. æ¸²æŸ“æ—¥æœŸå ´æ¬¡
    async function renderNextDay() {
        if (currentDateIndex >= allSortedDates.length) return;

        const date = allSortedDates[currentDateIndex];
        const rawShowtimes = currentMovieShowtimesGrouped[date];
        
        const section = document.createElement('div'); 
        section.className = 'date-section';
        section.innerHTML = `<h4 class="date-header">${date} <span class="text-sm font-normal text-gray-500 ml-2 animate-pulse">(æŸ¥è©¢åº§ä½ä¸­...)</span></h4>`;
        const grid = document.createElement('div'); 
        grid.className = 'showtime-grid';
        section.appendChild(grid);
        
        showtimeSelection.appendChild(section);

        const isGroupTicket = currentSelections.ticketType === 'group';
        const GROUP_MIN_SEATS = 10;

        try {
            const showtimesWithSeats = await Promise.all(rawShowtimes.map(async (s) => {
                let availableSeats = 0;
                try {
                    const seatsRes = await fetch(`${API_BASE_URL}/booking/seats?showingId=${s.id}`);
                    const seats = await seatsRes.json();
                    availableSeats = seats.filter(seat => seat.status === 1).length;
                } catch { availableSeats = 0; }
                return { ...s, availableSeats };
            }));

            showtimesWithSeats.forEach(s => {
                const available = s.availableSeats;
                const isTooFew = isGroupTicket && available < GROUP_MIN_SEATS;
                const isFull = available <= 0;

                const card = document.createElement('div');
                card.className = `showtime-card ${isFull || isTooFew ? 'disabled-group' : ''}`;
                card.dataset.id = s.id;

                let seatsStatusHTML = '';
                if (isTooFew) seatsStatusHTML = `<div class="showtime-row text-xs text-vieshow-red font-bold">å‰©é¤˜åº§ä½ä¸è¶³ (éœ€ ${GROUP_MIN_SEATS} å¼µ)</div>`;
                else if (isFull) seatsStatusHTML = `<div class="showtime-row text-xs text-gray-500 font-bold">å·²å”®å®Œ</div>`;
                else if (available <= 10) seatsStatusHTML = `<div class="showtime-row text-xs text-red-500 font-bold">âš ï¸ åƒ…å‰© ${available} å¼µ</div>`;
                else seatsStatusHTML = `<div class="showtime-row text-xs text-green-500 font-bold">å‰©é¤˜ ${available} å¸­</div>`;

                card.innerHTML = `
                    <div class="showtime-time">${s.time}</div>
                    <div class="showtime-details">
                        <div class="showtime-row"><span>å½±å»³:</span><span class="font-medium">${s.theater}</span></div>
                        <div class="showtime-row"><span>ç‰ˆæœ¬:</span><span class="font-medium">${s.format}</span></div>
                        ${seatsStatusHTML}
                    </div>`;

                if (!isFull && !isTooFew) {
                    card.onclick = () => selectShowtime(s);
                } else if (isTooFew) {
                     card.onclick = () => alert(`é¸æ“‡åœ˜é«”ç¥¨æ™‚ï¼Œæ­¤å ´æ¬¡å‰©é¤˜åº§ä½ (${available} å¼µ) ä¸è¶³ ${GROUP_MIN_SEATS} å¼µã€‚`);
                }
                grid.appendChild(card);
            });

            const loadingSpan = section.querySelector('.date-header span');
            if(loadingSpan) loadingSpan.remove();

        } catch (e) {
            console.error(e);
            section.querySelector('.date-header span').textContent = "(åº§ä½è¼‰å…¥å¤±æ•—)";
        }

        currentDateIndex++;
        renderLoadMoreButton();
    }

    function renderLoadMoreButton() {
        loadMoreContainer.innerHTML = ''; 
        if (currentDateIndex < allSortedDates.length) {
            const nextDate = allSortedDates[currentDateIndex];
            const btn = document.createElement('button');
            btn.className = 'load-more-btn';
            btn.textContent = `é¡¯ç¤ºä¸‹ä¸€å¤© (${nextDate}) â–¼`;
            btn.type = 'button'; 
            btn.onclick = () => {
                btn.textContent = "è¼‰å…¥ä¸­...";
                btn.disabled = true;
                renderNextDay(); 
            };
            loadMoreContainer.appendChild(btn);
        }
    }

    // --- è¼”åŠ©å‡½å¼ ---
    function selectShowtime(showtime) {
        document.querySelectorAll('.showtime-card').forEach(c => c.classList.remove('selected'));
        const card = document.querySelector(`.showtime-card[data-id="${showtime.id}"]`);
        if(card) card.classList.add('selected');
        currentSelections.showtime = showtime;
        nextButton.disabled = false;
    }

    function updateStepIndicator(step) {
        document.querySelectorAll('.step-circle').forEach((c, i) => {
            c.className = `step-circle ${i < step ? 'step-completed' : (i === step ? 'step-active' : 'step-pending')}`;
        });
    }

    function setupTicketTypeSelection() {
        document.querySelectorAll('.ticket-type-card').forEach(card => {
            card.onclick = function() {
                document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                currentSelections.ticketType = this.dataset.type;
                document.getElementById('groupTicketInfo').classList.toggle('hidden', currentSelections.ticketType !== 'group');
                nextButton.textContent = currentSelections.ticketType === 'group' ? 'ä¸‹ä¸€æ­¥: å¡«å¯«åœ˜é«”è³‡è¨Š' : 'ä¸‹ä¸€æ­¥: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»';
                resetSelection(1);
                document.getElementById('cinemaSelectionSection').classList.remove('hidden');
                updateStepIndicator(1);
            };
        });
    }

    function resetSelection(step) {
        if (step <= 1) { currentSelections.cinema = null; cinemaSelect.selectedIndex = 0; movieSelectionSection.classList.add('hidden'); }
        if (step <= 2) { 
            // åªæœ‰åœ¨çœŸçš„è¦åˆ‡æ›é›»å½±æ™‚æ‰éš±è—ï¼Œå¦‚æœæ˜¯åˆ‡æ›å½±åŸä½†ä¿ç•™é›»å½±å‰‡ä¸éš±è—
            // é€™è£¡ç°¡å–®è™•ç†ï¼šåˆ‡æ›å½±åŸæ™‚æœƒé‡ç½®é›»å½±é¸æ“‡
            currentSelections.movie = null; 
            showtimeSelectionSection.classList.add('hidden'); 
            showtimeSelection.innerHTML = ''; 
            loadMoreContainer.innerHTML = ''; 
        }
        if (step <= 3) { currentSelections.showtime = null; nextButton.disabled = true; }
    }

    form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!currentSelections.ticketType || !currentSelections.cinema || !currentSelections.movie || !currentSelections.showtime) {
                alert('è«‹å®Œæˆæ‰€æœ‰é¸æ“‡'); return;
            }
            sessionStorage.setItem('returnFromStep2Data', JSON.stringify({
                ticketType: currentSelections.ticketType,
                cinemaId: currentSelections.cinema.id
            }));
            const availableSeats = currentSelections.showtime.availableSeats || 0;
            if (currentSelections.ticketType === 'general' && availableSeats < 1) {
                return alert('è©²å ´æ¬¡å·²ç„¡åº§ä½ï¼Œè«‹é‡æ–°é¸æ“‡å ´æ¬¡');
            }
            localStorage.setItem('currentBooking', JSON.stringify({
                ticketType: currentSelections.ticketType,
                cinema: currentSelections.cinema,
                movie: {
                    id: currentSelections.movie.id,
                    title: currentSelections.movie.name, 
                    ...currentSelections.movie 
                },
                showtime: {
                    id: currentSelections.showtime.id,
                    date: currentSelections.showtime.date,
                    time: currentSelections.showtime.time,
                    theater: currentSelections.showtime.theater,
                    type: currentSelections.showtime.format,
                    availableSeats: availableSeats, 
                    ...currentSelections.showtime
                }
            }));
            
            // çœŸæ­£æäº¤å¾Œæ‰æ¸…é™¤é é¸
            sessionStorage.removeItem('preSelectedMovie');
            window.location.href = currentSelections.ticketType === 'group' ? 'booking_flow_group.html' : 'booking_flow_2.html';
    });

    document.addEventListener('DOMContentLoaded', initPage);

    // Alert
    function customAlert(message, callback) { 
        const existingModal = document.getElementById('custom-alert-modal');
        if (existingModal) existingModal.remove();
        const handleConfirm = () => {
            document.getElementById('custom-alert-modal').remove();
            if (callback && typeof callback === 'function') { callback(); }
        };
        window.customAlertConfirm = handleConfirm;
        const modalHtml = `
            <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                    <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
                    </div>
                    <p class="text-gray-700 mb-5">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.alert = customAlert;
    </script>

</body>

</html>

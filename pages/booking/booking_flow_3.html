<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 3: é¸æ“‡åº§ä½ - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../js/chatbot.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-dark': '#1a1a1a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }

        // è‡ªå®šç¾© Alert
        function customAlert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();
            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') { callback(); }
            };
            window.customAlertConfirm = handleConfirm;
            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alert = customAlert;
    </script>

    <style>
        /* åº§ä½æ¨£å¼ */
        .seat { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: all 0.2s ease; font-size: 12px; margin: 2px; }
        .available { background-color: #22c55e; border: 2px solid #16a34a; }
        .available:hover { background-color: #16a34a; transform: scale(1.1); }
        .occupied { background-color: #9ca3af; border: 2px solid #6b7280; cursor: not-allowed; }
        .selected { background-color: #dc2626; border: 2px solid #b91c1c; transform: scale(1.1); box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3); }
        .wheelchair { background-color: #3b82f6; border: 2px solid #1d4ed8; }
        
        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ */
        .step-indicator { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; }
        .step-circle { width: 40px; height: 40px; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; transition: all 200ms ease; }
        .step-line { height: 8px; width: 64px; background: #D1D5DB; transition: background 200ms ease, width 200ms ease; margin: 0 8px; border-radius: 4px; }
        .step-active { background: #e50914; }
        .step-completed { background: #f7a83d; }
        .step-pending { background: #D1D5DB; }
        
        /* Loading Overlay */
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 10; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #666; font-size: 1.2rem; }
    </style>
</head>
<body class="antialiased bg-gray-100 font-sans min-h-screen flex flex-col">

<header class="bg-gray-800 text-white shadow-md">
    <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
        <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
        <div id="headerNavRight" class="space-x-4"></div>
    </nav>
</header>

<main class="container mx-auto px-4 py-8 flex-grow max-w-6xl relative">
    
    <div class="step-indicator">
        <div class="step-circle step-completed">1</div>
        <div class="step-line step-completed"></div>
        <div class="step-circle step-completed">2</div>
        <div class="step-line step-active"></div>
        <div class="step-circle step-active">3</div>
        <div class="step-line step-pending"></div>
        <div class="step-circle step-pending">4</div>
        <div class="step-line step-pending"></div>
        <div class="step-circle step-pending">5</div>
    </div>

    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-4 border-vieshow-red relative min-h-[500px]">
        <div id="seatLoading" class="loading-overlay">æ­£åœ¨é€£ç·šè³‡æ–™åº«è®€å–åº§ä½...</div>

        <div class="mb-8 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>
            <p class="text-xl font-semibold text-vieshow-red">é¸æ“‡åº§ä½</p>
            <p class="text-sm text-gray-500 mt-1">è«‹åœ¨ä¸‹æ–¹å½±å»³åœ°åœ–ä¸­é¸æ“‡æ‚¨å–œæ­¡çš„åº§ä½ã€‚</p>
        </div>

        <div class="bg-vieshow-gold/10 p-4 rounded-lg mb-6 border-l-4 border-vieshow-gold">
            <h2 class="font-bold text-lg mb-2 text-gray-800 flex items-center">
                <svg class="w-5 h-5 mr-2 text-vieshow-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                å ´æ¬¡ç¢ºèª
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div><span class="font-semibold">å½±åŸï¼š</span><span id="cinemaName">è¼‰å…¥ä¸­...</span></div>
                <div><span class="font-semibold">é›»å½±ï¼š</span><span id="movieTitle">è¼‰å…¥ä¸­...</span></div>
                <div><span class="font-semibold">å ´æ¬¡ï¼š</span><span id="showtimeDetails">è¼‰å…¥ä¸­...</span></div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-2 md:mb-0">
                è«‹é¸æ“‡åº§ä½ <span class="text-vieshow-red">ï¼ˆéœ€é¸ <span id="requiredTickets">0</span> å¼µï¼‰</span>
            </h3>
            <div class="flex space-x-4 text-sm text-gray-700">
                <div class="flex items-center"><div class="w-4 h-4 bg-green-500 mr-2 rounded border border-green-600"></div><span>å¯é¸</span></div>
                <div class="flex items-center"><div class="w-4 h-4 bg-gray-400 mr-2 rounded border border-gray-500"></div><span>å·²å”®</span></div>
                <div class="flex items-center"><div class="w-4 h-4 bg-red-600 mr-2 rounded border border-red-700"></div><span>å·²é¸</span></div>
            </div>
        </div>

        <div class="bg-gray-100 p-6 rounded-xl border border-gray-300 mb-6 overflow-x-auto">
            <div class="bg-vieshow-dark text-white text-center py-3 mb-6 rounded-lg font-bold text-lg shadow-lg w-full min-w-[300px]">
                ğŸ¬ å½±å»³è¢å¹• ğŸ¬
            </div>
            <div id="seatMap" class="flex flex-col space-y-2 items-center min-w-[300px]"></div>
        </div>

        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                å·²é¸åº§ä½ï¼š
            </h4>
            <p id="selectedSeatsDisplay" class="text-xl text-green-800 font-bold">å°šæœªé¸æ“‡åº§ä½</p>
        </div>

        <div id="errorMessage" class="font-bold text-center text-red-600 mb-4"></div>

        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
            <h3 class="text-xl font-semibold border-b-2 border-vieshow-red pb-2 mb-4">è¨‚å–®æ‘˜è¦</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">ğŸ“Š ç¥¨å‹™è³‡è¨Š</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>æ‡‰é¸å¼µæ•¸ï¼š</span><span class="font-bold text-vieshow-red" id="totalTicketsRequired">0</span></div>
                        <div class="flex justify-between"><span>å·²é¸åº§ä½ï¼š</span><span class="font-bold text-vieshow-red" id="selectedSeatsSummary">ç„¡</span></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">ğŸ« ç¥¨ç¨®æ˜ç´°</h4>
                    <div class="space-y-1 text-sm">
                        <p id="ticketsSummary">è¼‰å…¥ä¸­...</p>
                        <p id="foodSummary" class="mt-2">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
            <div class="border-t mt-4 pt-4">
                <div class="flex justify-between items-center text-lg font-bold">
                    <span>ç¸½è¨ˆé‡‘é¡ï¼š</span>
                    <span id="totalPriceDisplay" class="text-vieshow-red text-xl">$0 TWD</span>
                </div>
            </div>
        </div>

        <form id="bookingFlow3Form" class="space-y-4">
            <input type="hidden" name="selected_seats" id="submitSeats" value="">
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <a id="prevLink" href="booking_flow_2.html" class="flex-1 text-center bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg text-base">è¿”å›ä¸Šä¸€æ­¥</a>
                <button type="submit" class="next-step-button flex-1 bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ä¸‹ä¸€æ­¥: è¨‚å–®ç¢ºèª
                </button>
            </div>
        </form>
    </div>
</main>

<footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
    <p>&copy; 2025 Vieshow Ticketing System</p>
</footer>

<script>
    const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
    const LOGIN_PAGE_URL = '../auth/login.html';
    const MEMBER_HOME_URL = '../member/member_home.html';
    const INDEX_PAGE_URL = '../../index.html';

    let currentBooking = {};
    let totalTickets = 0;
    let selectedSeats = [];

    // --- DOM Elements ---
    const cinemaNameDisplay = document.getElementById("cinemaName");
    const movieTitleDisplay = document.getElementById("movieTitle");
    const showtimeDetailDisplay = document.getElementById("showtimeDetails");
    const requiredTicketsSpan = document.getElementById("requiredTickets");
    const totalTicketsRequiredSpan = document.getElementById("totalTicketsRequired");
    const selectedSeatsDisplay = document.getElementById("selectedSeatsDisplay");
    const selectedSeatsSummary = document.getElementById("selectedSeatsSummary");
    const ticketsSummary = document.getElementById("ticketsSummary");
    const foodSummary = document.getElementById("foodSummary");
    const totalPriceDisplay = document.getElementById("totalPriceDisplay");
    const nextButton = document.querySelector("button[type='submit']");
    const errorMessage = document.getElementById("errorMessage");

    // --- ç™»å…¥æª¢æŸ¥ ---
    function renderUI() {
        const token = localStorage.getItem('auth_token');
        const navRight = document.getElementById('headerNavRight');
        if (token) {
            navRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold ml-4">æœƒå“¡ä¸­å¿ƒ</a>`;
            document.getElementById('signOutLink')?.addEventListener('click', (e) => {
                e.preventDefault(); 
                localStorage.removeItem('auth_token'); 
                // â˜…â˜…â˜… åœ¨ç™»å‡ºæ™‚å‘¼å« Chatbot çš„é‡ç½®å‡½å¼ â˜…â˜…â˜…
                if (window.resetChatSession) window.resetChatSession(); 
                alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
            });
        } else {
            navRight.innerHTML = `<a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold">ç™»å…¥</a>`;
        }
    }

    function checkLoginStatus() {
        if (!localStorage.getItem('auth_token')) {
            alert('è«‹å…ˆç™»å…¥', () => window.location.href = LOGIN_PAGE_URL);
            return false;
        }
        return true;
    }

    // --- è³‡æ–™è¼‰å…¥ ---
    function loadBookingData() {
        const stored = localStorage.getItem("currentBooking");
        if (!stored) {
            alert('ç„¡è¨‚ç¥¨è³‡æ–™ï¼Œè«‹é‡æ–°é¸æ“‡', () => window.location.href = 'booking_flow_1.html');
            return;
        }
        currentBooking = JSON.parse(stored);
        totalTickets = Number(currentBooking.totalTicketQty) || 0;

        // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
        cinemaNameDisplay.textContent = currentBooking.cinema?.name || "æœªé¸æ“‡";
        movieTitleDisplay.textContent = currentBooking.movie?.title || "æœªé¸æ“‡";
        if (currentBooking.showtime) {
            const st = currentBooking.showtime;
            showtimeDetailDisplay.textContent = `${st.date} ${st.time} ${st.theater} (${st.type})`;
        }

        requiredTicketsSpan.textContent = totalTickets;
        totalTicketsRequiredSpan.textContent = totalTickets;

        // é¡¯ç¤ºæ‘˜è¦
        const tickets = currentBooking.tickets || {};
        ticketsSummary.textContent = Object.values(tickets).map(t => `${t.name} x ${t.qty}`).join(" + ") || "ç„¡ç¥¨ç¨®é¸æ“‡";
        
        const combos = currentBooking.combos || {};
        const comboEntries = Object.values(combos).filter(c => c.qty > 0);
        foodSummary.textContent = comboEntries.length ? comboEntries.map(c => `${c.name} x ${c.qty}`).join(" + ") : "ç„¡é¤é»åŠ è³¼";

        totalPriceDisplay.textContent = `$${(currentBooking.totalPrice || 0).toLocaleString()} TWD`;

        // ã€é—œéµã€‘å¾å¾Œç«¯å–å¾—åº§ä½ç‹€æ…‹ (ä½¿ç”¨ showing.id)
        if (currentBooking.showtime && currentBooking.showtime.id) {
            fetchSeatStatus(currentBooking.showtime.id);
        } else {
            alert('å ´æ¬¡è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡', () => window.location.href = 'booking_flow_1.html');
        }
    }

    // ã€æ–°å¢ã€‘å‘¼å«å¾Œç«¯ API å–å¾—çœŸå¯¦åº§ä½ç‹€æ…‹
    async function fetchSeatStatus(showingId) {
        try {
            console.log("Fetching seats for:", showingId);
            const res = await fetch(`${API_BASE_URL}/booking/seats?showingId=${showingId}`);
            if (!res.ok) throw new Error("API Error");
            const seatData = await res.json();
            
            renderSeatMap(seatData); // ä½¿ç”¨å¾Œç«¯å›å‚³çš„è³‡æ–™æ¸²æŸ“
            document.getElementById('seatLoading').style.display = 'none';
        } catch (e) {
            console.error("åº§ä½è¼‰å…¥å¤±æ•—", e);
            document.getElementById('seatMap').innerHTML = '<p class="text-red-500">ç„¡æ³•è®€å–åº§ä½è¡¨ (å¯èƒ½ä¼ºæœå™¨å¿™ç¢Œä¸­)</p>';
            document.getElementById('seatLoading').style.display = 'none';
        }
    }

    // æ¸²æŸ“åº§ä½åœ– (ä½¿ç”¨å¾Œç«¯è³‡æ–™)
    function renderSeatMap(seatList) {
        const seatMap = document.getElementById("seatMap");
        seatMap.innerHTML = "";
        
        // å°‡ä¸€ç¶­é™£åˆ—è½‰æ›ç‚ºäºŒç¶­çµæ§‹ (A1, A2... åˆ†çµ„)
        const rows = {};
        seatList.forEach(s => {
            const rowLabel = s.seatNumber.charAt(0);
            if (!rows[rowLabel]) rows[rowLabel] = [];
            rows[rowLabel].push(s);
        });

        // ä¾åºæ¸²æŸ“æ¯ä¸€æ’
        Object.keys(rows).sort().forEach(rowLabel => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "flex space-x-2 items-center";

            const label = document.createElement("span");
            label.textContent = rowLabel;
            label.className = "font-bold w-6 text-center text-gray-700";
            rowDiv.appendChild(label);

            // å°æ¯æ’çš„åº§ä½é€²è¡Œæ’åº (1, 2, 3...)
            rows[rowLabel].sort((a, b) => {
                const numA = parseInt(a.seatNumber.substring(1));
                const numB = parseInt(b.seatNumber.substring(1));
                return numA - numB;
            });

            rows[rowLabel].forEach(s => {
                const seatDiv = document.createElement("div");
                seatDiv.textContent = s.seatNumber.substring(1); // é¡¯ç¤ºè™Ÿç¢¼
                seatDiv.classList.add("seat");

                if (s.status === 0) { // 0 = ä½”ç”¨
                    seatDiv.classList.add("occupied");
                    seatDiv.title = "å·²å”®å‡º";
                } else { // 1 = ç©ºä½
                    seatDiv.classList.add("available");
                    seatDiv.title = "å¯é¸";
                    seatDiv.onclick = () => toggleSeat(s.seatNumber, seatDiv);
                }
                rowDiv.appendChild(seatDiv);
            });
            seatMap.appendChild(rowDiv);
        });
    }

    function toggleSeat(seatId, element) {
        if (element.classList.contains("occupied")) return;

        if (element.classList.contains("selected")) {
            element.classList.remove("selected");
            element.classList.add("available");
            selectedSeats = selectedSeats.filter(s => s !== seatId);
        } else {
            if (selectedSeats.length >= totalTickets) {
                errorMessage.textContent = `æœ€å¤šåªèƒ½é¸æ“‡ ${totalTickets} å€‹åº§ä½`;
                setTimeout(() => errorMessage.textContent = "", 2000);
                return;
            }
            element.classList.remove("available");
            element.classList.add("selected");
            selectedSeats.push(seatId);
        }
        updateSelectedDisplay();
    }

    function updateSelectedDisplay() {
        selectedSeatsDisplay.textContent = selectedSeats.length ? selectedSeats.join("ã€") : "å°šæœªé¸æ“‡åº§ä½";
        document.getElementById("selectedSeatsSummary").textContent = selectedSeats.length ? selectedSeats.join("ã€") : "ç„¡";

        nextButton.disabled = selectedSeats.length !== totalTickets;
        
        if (selectedSeats.length === totalTickets) {
            errorMessage.textContent = "âœ“ åº§ä½é¸æ“‡å®Œæˆï¼";
            errorMessage.className = "font-bold text-center text-green-600 mb-4";
        } else {
            errorMessage.textContent = "";
        }
    }
    document.getElementById("prevLink").addEventListener("click", function(e) {
        e.preventDefault();
        
        // ç¢ºä¿ currentBooking å·²è¢«è¼‰å…¥ (é€šå¸¸åœ¨ loadBookingData ä¸­å®Œæˆ)
        if (Object.keys(currentBooking).length === 0) {
            window.location.href = 'booking_flow_2.html';
            return;
        }
    
        // å„²å­˜ç•¶å‰ç‹€æ…‹ï¼Œä»¥ä¾¿ Step 2 è¼‰å…¥
        localStorage.setItem("currentBooking", JSON.stringify(currentBooking));
    
        // åœ˜é«”ç¥¨ç›´æ¥è¿”å›åœ˜é«”ç¥¨é é¢ï¼Œä¸€èˆ¬ç¥¨è¿”å›ç¥¨ç¨®é¸æ“‡é 
        if (currentBooking.ticketType === 'group') {
            window.location.href = 'booking_flow_group.html'; // å‡è¨­åœ˜é«”ç¥¨æœ‰å°ˆé–€çš„ Step 2
        } else {
            window.location.href = 'booking_flow_2.html';
        }
    });
    document.getElementById("bookingFlow3Form").addEventListener("submit", function(e){
    e.preventDefault();

    if (selectedSeats.length !== totalTickets) {
        errorMessage.textContent = "è«‹å…ˆé¸æ»¿åº§ä½æ•¸é‡";
        errorMessage.className = "font-bold text-center text-red-600 mb-4";
        return;
    }

    // ğŸ¯ æ›´æ–°è¨‚ç¥¨è³‡æ–™ï¼šå°‡åº§ä½è³‡è¨Šå¯«å…¥ currentBooking
    currentBooking.selectedSeats = selectedSeats;
    currentBooking.seatCount = selectedSeats.length;

    // å„²å­˜åˆ° localStorage
    localStorage.setItem("currentBooking", JSON.stringify(currentBooking));

    // æ­£å¸¸æµç¨‹ï¼šå‰å¾€ Step4
    window.location.href = "booking_flow_4.html";
});

    window.onload = function() {
        renderUI();
        if (checkLoginStatus()) {
            loadBookingData();
        }
    };
</script>
</body>
</html>




<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 3: é¸æ“‡åº§ä½ - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Tailwind é…ç½®ï¼Œç¢ºä¿é¡è‰²å’Œå­—é«”èˆ‡å°ˆæ¡ˆä¸€è‡´
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-dark': '#1a1a1a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        .seat {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: all 0.2s ease;
            font-size: 12px;
        }
        .available { 
            background-color: #22c55e;
            border: 2px solid #16a34a;
        }
        .available:hover { 
            background-color: #16a34a;
            transform: scale(1.1);
        }
        .occupied { 
            background-color: #9ca3af; 
            border: 2px solid #6b7280;
            cursor: not-allowed;
        }
        .selected { 
            background-color: #dc2626; 
            border: 2px solid #b91c1c;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }
        .wheelchair { 
            background-color: #3b82f6;
            border: 2px solid #1d4ed8;
        }
        .wheelchair:hover {
            background-color: #1d4ed8;
            transform: scale(1.1);
        }
        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ (å·²è½‰æ› Tailwind å¯«æ³•) */
        .step-indicator { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; }
        .step-circle { width: 40px; height: 40px; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; transition: all 200ms ease; }
        .step-line { height: 8px; width: 64px; background: #D1D5DB; transition: background 200ms ease, width 200ms ease; margin: 0 8px; border-radius: 4px; }
        .step-active { background: #e50914; }
        .step-completed { background: #f7a83d; }
        .step-pending { background: #D1D5DB; }
    </style>
</head>
<body class="antialiased bg-gray-100 font-sans min-h-screen flex flex-col">

<header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
            </div>
        </nav>
</header>
<div id="loginOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
        <h2 class="text-2xl font-bold mb-4 text-gray-900 flex items-center justify-center">
            <svg class="w-6 h-6 mr-2 text-vieshow-red" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨
        </h2>
        <p class="text-gray-600 mb-6">
            è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€ç™»å…¥é é¢ï¼Œä»¥ä¾¿ç¹¼çºŒæ‚¨çš„è¨‚ç¥¨æµç¨‹ã€‚
        </p>
        <a href="javascript:void(0)" id="loginRedirectButton" 
            class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
            å‰å¾€ç™»å…¥
        </a>
    </div>
</div>

<main class="container mx-auto px-4 py-8 flex-grow max-w-6xl">
    
    <div class="step-indicator">
        <div class="step-circle step-completed">1</div>
        <div class="step-line step-completed"></div>
        <div class="step-circle step-completed">2</div>
        <div class="step-line step-active"></div>
        <div class="step-circle step-active">3</div>
        <div class="step-line step-pending"></div>
        <div class="step-circle step-pending">4</div>
        <div class="step-line step-pending"></div>
        <div class="step-circle step-pending">5</div>
    </div>

    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-4 border-vieshow-red">
        
        <div class="mb-8 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>
            <p class="text-xl font-semibold text-vieshow-red">é¸æ“‡åº§ä½</p>
            <p class="text-sm text-gray-500 mt-1">è«‹åœ¨ä¸‹æ–¹å½±å»³åœ°åœ–ä¸­é¸æ“‡æ‚¨å–œæ­¡çš„åº§ä½ã€‚</p>
        </div>

        <div class="bg-vieshow-gold/10 p-4 rounded-lg mb-6 border-l-4 border-vieshow-gold">
            <h2 class="font-bold text-lg mb-2 text-gray-800 flex items-center">
                <svg class="w-5 h-5 mr-2 text-vieshow-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                å ´æ¬¡ç¢ºèª
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div><span class="font-semibold">å½±åŸï¼š</span><span id="cinemaName">è¼‰å…¥ä¸­...</span></div>
                <div><span class="font-semibold">é›»å½±ï¼š</span><span id="movieTitle">è¼‰å…¥ä¸­...</span></div>
                <div><span class="font-semibold">å ´æ¬¡ï¼š</span><span id="showtimeDetails">è¼‰å…¥ä¸­...</span></div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-2 md:mb-0">
                è«‹é¸æ“‡åº§ä½ <span class="text-vieshow-red">ï¼ˆéœ€é¸ <span id="requiredTickets">0</span> å¼µï¼‰</span>
            </h3>
            <div class="flex space-x-4 text-sm text-gray-700">
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-green-500 mr-2 rounded border border-green-600"></div>
                    <span>å¯é¸</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-gray-400 mr-2 rounded border border-gray-500"></div>
                    <span>å·²å”®</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-red-600 mr-2 rounded border border-red-700"></div>
                    <span>å·²é¸</span>
                </div>
                <div class="flex items-center">
                    <div class="w-4 h-4 bg-blue-500 mr-2 rounded border border-blue-600"></div>
                    <span>æ„›å¿ƒåº§</span>
                </div>
            </div>
        </div>

        <div class="bg-gray-100 p-6 rounded-xl border border-gray-300 mb-6">
            <div class="bg-vieshow-dark text-white text-center py-3 mb-6 rounded-lg font-bold text-lg shadow-lg">
                ğŸ¬ å½±å»³è¢å¹• ğŸ¬
            </div>
            <div id="seatMap" class="flex flex-col space-y-3 items-center"></div>
        </div>

        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                å·²é¸åº§ä½ï¼š
            </h4>
            <p id="selectedSeatsDisplay" class="text-xl text-green-800 font-bold">å°šæœªé¸æ“‡åº§ä½</p>
        </div>

        <div id="errorMessage" class="font-bold text-center text-red-600 mb-4"></div>

        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
            <h3 class="text-xl font-semibold border-b-2 border-vieshow-red pb-2 mb-4">
                è¨‚å–®æ‘˜è¦
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">ğŸ“Š ç¥¨å‹™è³‡è¨Š</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>æ‡‰é¸å¼µæ•¸ï¼š</span>
                            <span class="font-bold text-vieshow-red" id="totalTicketsRequired">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å·²é¸åº§ä½ï¼š</span>
                            <span class="font-bold text-vieshow-red" id="selectedSeatsSummary">ç„¡</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-700 mb-2">ğŸ« ç¥¨ç¨®æ˜ç´°</h4>
                    <div class="space-y-1 text-sm">
                        <p id="ticketsSummary">è¼‰å…¥ä¸­...</p>
                        <p id="foodSummary" class="mt-2">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
            
            <div class="border-t mt-4 pt-4">
                <div class="flex justify-between items-center text-lg font-bold">
                    <span>ç¸½è¨ˆé‡‘é¡ï¼š</span>
                    <span id="totalPriceDisplay" class="text-vieshow-red text-xl">$0 TWD</span>
                </div>
            </div>
        </div>

        <form id="bookingFlow3Form" class="space-y-4">
            <input type="hidden" name="selected_seats" id="submitSeats" value="">

            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <a id="prevLink" href="booking_flow_2.html" class="flex-1 text-center bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg text-base transform hover:scale-[1.02] active:scale-[0.98]">
                    <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg> 
                    è¿”å›ä¸Šä¸€æ­¥
                </a>
                <button type="submit" class="next-step-button flex-1 bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98]" disabled>
                    ä¸‹ä¸€æ­¥: è¨‚å–®ç¢ºèª
                </button>
            </div>
        </form>
    </div>
</main>

<script>
    // ----------------------------------------------------
    // å°è¦½åˆ—èˆ‡ç™»å…¥/ç™»å‡ºé‚è¼¯ (ä¸è®Š)
    // ----------------------------------------------------
    const INDEX_PAGE_URL = '../../index.html'; 
    const LOGIN_PAGE_URL = '../auth/login.html';
    const MEMBER_HOME_URL = '../member/member_home.html';

    function customAlert(message, callback) { 
        const existingModal = document.getElementById('custom-alert-modal');
        if (existingModal) existingModal.remove();
        const handleConfirm = () => {
            document.getElementById('custom-alert-modal').remove();
            if (callback && typeof callback === 'function') {
                callback(); 
            }
        };
        window.customAlertConfirm = handleConfirm;
        const modalHtml = `
            <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                    <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        ç³»çµ±æç¤º
                    </div>
                    <p class="text-gray-700 mb-5">${message}</p>
                    <div class="flex justify-end">
                        <button onclick="window.customAlertConfirm()" 
                                class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                            ç¢ºèª
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    window.alert = customAlert;

    function renderLoggedOutState() {
        const headerNavRight = document.getElementById('headerNavRight');
        if (!headerNavRight) return;
        const currentUrl = encodeURIComponent(window.location.href);
        const loginRedirectUrl = `${LOGIN_PAGE_URL}?redirect=${currentUrl}`;
        headerNavRight.innerHTML = `
            <a href="${loginRedirectUrl}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
            <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
        `;
    }

    function renderLoggedInState() {
        const headerNavRight = document.getElementById('headerNavRight');
        if (!headerNavRight) return;
        headerNavRight.innerHTML = `
            <a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
            <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
        `;
        document.getElementById('signOutLink')?.addEventListener('click', handleSignOut);
    }

    function handleSignOut(e) {
        e.preventDefault();
        localStorage.removeItem('auth_token');
        localStorage.removeItem('isLoggedIn');
        alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡å°å‘é¦–é ...', () => {
            setTimeout(() => {
                window.location.href = INDEX_PAGE_URL;
            }, 2000);
        }); 
        renderUI();
    }

    function renderUI() {
        const token = localStorage.getItem('auth_token');
        if (token) {
            renderLoggedInState(); 
        } else {
            renderLoggedOutState();
        }
    }

    function setupLoginRedirectLink() {
        const loginButton = document.getElementById('loginRedirectButton');
        if (loginButton) {
            const pathname = window.location.pathname;
            let relativeToRootPath = (pathname.startsWith('/') ? pathname.substring(1) : pathname) + window.location.search; 
            const encodedPath = encodeURIComponent(relativeToRootPath);
            const LOGIN_PAGE_URL_FIXED = '../auth/login.html';
            loginButton.href = `${LOGIN_PAGE_URL_FIXED}?redirect=${encodedPath}`;
        }
    }

    function checkLoginStatus() {
        const loginOverlay = document.getElementById('loginOverlay');
        // ä¿®æ­£ï¼šä¸»å…§å®¹æ‡‰é‡å° main tag
        const mainContent = document.querySelector('main');
        const token = localStorage.getItem('auth_token');
        if (!token) {
            if (loginOverlay) loginOverlay.classList.remove('hidden');
            if (mainContent) mainContent.classList.add('hidden');
            return false;
        }
        if (loginOverlay) loginOverlay.classList.add('hidden');
        if (mainContent) mainContent.classList.remove('hidden');
        return true;
    }
    
    // ----------------------------------------------------
    // åº§ä½é¸æ“‡æµç¨‹é‚è¼¯
    // ----------------------------------------------------

    let currentBooking = {};
    let totalTickets = 0;
    let selectedSeats = [];

    const cinemaNameDisplay = document.getElementById("cinemaName");
    const movieTitleDisplay = document.getElementById("movieTitle");
    const showtimeDetailDisplay = document.getElementById("showtimeDetails");
    const requiredTicketsSpan = document.getElementById("requiredTickets");
    const totalTicketsRequiredSpan = document.getElementById("totalTicketsRequired");
    const selectedSeatsDisplay = document.getElementById("selectedSeatsDisplay");
    const selectedSeatsSummary = document.getElementById("selectedSeatsSummary");
    const ticketsSummary = document.getElementById("ticketsSummary");
    const foodSummary = document.getElementById("foodSummary");
    const totalPriceDisplay = document.getElementById("totalPriceDisplay");
    const submitSeatsInput = document.getElementById("submitSeats");
    const nextButton = document.querySelector("button[type='submit']");
    const errorMessage = document.getElementById("errorMessage");

    // æ›´çœŸå¯¦çš„åº§ä½è³‡æ–™ï¼ˆA=å¯é¸ / O=å·²å”® / W=è¼ªæ¤…å¸­ï¼‰
    const seatData = [
        ["A","A","A","O","A","A","A","A","A","A","A","A"],
        ["O","A","A","A","A","A","O","A","A","A","A","A"],
        ["A","A","A","A","A","A","A","O","A","A","A","A"],
        ["A","A","O","A","A","A","A","A","A","A","A","A"],
        ["A","A","A","A","A","A","A","A","A","A","A","A"],
        ["A","A","A","A","A","A","A","A","A","A","A","A"],
        ["A","A","A","A","A","A","A","A","A","A","A","A"],
        ["W","W","A","A","A","A","A","A","A","A","W","W"],
    ];
    const rows = ["A","B","C","D","E","F","G","H"];

    function loadBookingData() {
        const stored = localStorage.getItem("currentBooking");
        
        // å˜—è©¦è®€å–ç·¨è¼¯æµç¨‹çš„æš«å­˜è³‡æ–™
        const pendingSeatsRaw = localStorage.getItem('editingPendingSeats');
        let pendingSeats = null;

        if (pendingSeatsRaw) {
            try {
                pendingSeats = JSON.parse(pendingSeatsRaw);
                if (pendingSeats && pendingSeats.newOrder) {
                    currentBooking = pendingSeats.newOrder;
                    totalTickets = Number(pendingSeats.desiredTicketCount) || Number(currentBooking.totalTicketQty) || 0;
                    currentBooking.totalTicketQty = totalTickets;
                }
            } catch (e) {
                console.error("è§£æ editingPendingSeats å¤±æ•—", e);
                currentBooking = stored ? JSON.parse(stored) : { tickets: {}, combos: {} };
            }
        } else if (stored) {
            currentBooking = JSON.parse(stored);
            totalTickets = Number(currentBooking.totalTicketQty) || 0;
            
            // ğŸš¨ **é—œéµä¿®æ­£ï¼šæª¢æŸ¥ä¸¦è½‰æ›è³‡æ–™æ ¼å¼**
            // å¦‚æœè³‡æ–™æ˜¯å¾ showtimes_result.html ä¾†çš„æ‰å¹³æ ¼å¼
            if (currentBooking.cinemaName && !currentBooking.cinema) {
                console.log("ğŸ“¦ æª¢æ¸¬åˆ°æ‰å¹³æ ¼å¼è³‡æ–™ï¼Œé€²è¡Œè½‰æ›...");
                
                // å˜—è©¦å¾ showtimeDetail è§£ææ—¥æœŸå’Œæ™‚é–“
                let date = "", time = "", theater = "", type = "";
                
                if (currentBooking.showtimeDetail) {
                    // æ ¼å¼ï¼š "2025-11-30 13:30 Aå»³ (IMAX 2D)"
                    const parts = currentBooking.showtimeDetail.split(" ");
                    if (parts.length >= 4) {
                        date = parts[0];
                        time = parts[1];
                        theater = parts[2];
                        // æå–æ‹¬è™Ÿå…§çš„æ ¼å¼
                        const formatMatch = currentBooking.showtimeDetail.match(/\((.*)\)/);
                        type = formatMatch ? formatMatch[1] : currentBooking.format || "";
                    } else if (parts.length >= 2) {
                        // ç°¡åŒ–æ ¼å¼è™•ç†
                        date = parts[0];
                        time = parts[1];
                        theater = currentBooking.theater || "";
                        type = currentBooking.format || "";
                    }
                }
                
                // è½‰æ›ç‚ºå·¢ç‹€æ ¼å¼
                currentBooking = {
                    ...currentBooking,
                    cinema: { 
                        name: currentBooking.cinemaName,
                        id: currentBooking.cinemaId || currentBooking.cinemaName
                    },
                    movie: { 
                        title: currentBooking.movieTitle,
                        id: currentBooking.movieId || currentBooking.movieTitle
                    },
                    showtime: {
                        date: date || currentBooking.date || "",
                        time: time || currentBooking.time || "",
                        theater: currentBooking.theater || theater,
                        type: currentBooking.format || type,
                        id: currentBooking.showtimeId || ""
                    }
                };
                
                console.log("ğŸ“¦ è½‰æ›å¾Œçš„è³‡æ–™:", currentBooking);
                
                // å„²å­˜å› localStorage ä»¥ä¿æŒä¸€è‡´æ€§
                localStorage.setItem("currentBooking", JSON.stringify(currentBooking));
            }
            
        } else {
            // å¦‚æœæ²’æœ‰ä»»ä½•è³‡æ–™ï¼Œå°å‘ç¬¬ä¸€æ­¥
            window.location.href = "booking_flow_1.html";
            return;
        }

        // ç¢ºèª totalTickets è‡³å°‘ç‚º 1
        if (totalTickets <= 0) {
            alert('è¨‚ç¥¨æ•¸é‡ç„¡æ•ˆï¼Œè«‹é‡æ–°é¸æ“‡ç¥¨ç¨®ã€‚');
            window.location.href = "booking_flow_2.html";
            return;
        }

        // **1. å ´æ¬¡ç¢ºèª (çµ±ä¸€ä½¿ç”¨å·¢ç‹€çµæ§‹)**
        cinemaNameDisplay.textContent = currentBooking.cinema?.name || currentBooking.cinemaName || "æœªé¸æ“‡";
        movieTitleDisplay.textContent = currentBooking.movie?.title || currentBooking.movieTitle || "æœªé¸æ“‡";
        
        if (currentBooking.showtime) {
            const showtime = currentBooking.showtime;
            showtimeDetailDisplay.textContent = `${showtime.date} ${showtime.time} ${showtime.theater} (${showtime.type})`;
        } else if (currentBooking.showtimeDetail) {
            showtimeDetailDisplay.textContent = currentBooking.showtimeDetail;
        } else {
            showtimeDetailDisplay.textContent = "æœªé¸æ“‡";
        }

        requiredTicketsSpan.textContent = totalTickets;
        totalTicketsRequiredSpan.textContent = totalTickets;
        
        // **ä¿®æ­£ï¼šã€Œä¸Šä¸€æ­¥ã€é€£çµ**
        const prevLink = document.getElementById('prevLink');
        if (prevLink) {
            if (currentBooking.isGroupBooking) {
                prevLink.href = 'booking_flow_group.html';
            } else {
                prevLink.href = 'booking_flow_2.html';
            }
        }

        // **4. è¨‚å–®æ‘˜è¦ (ç¥¨ç¨®æ˜ç´°)**
        const tickets = currentBooking.tickets || {};
        const ticketEntries = Object.values(tickets);
        ticketsSummary.textContent = ticketEntries.length
            ? ticketEntries.map(t => `${t.name} x ${t.qty}`).join(" + ")
            : "ç„¡ç¥¨ç¨®é¸æ“‡";

        // **4. è¨‚å–®æ‘˜è¦ (é¤é»æ˜ç´°)**
        const combos = currentBooking.combos || {};
        const comboEntries = Object.values(combos);
        foodSummary.textContent = comboEntries.length && comboEntries.some(c => c.qty > 0)
            ? comboEntries.filter(c => c.qty > 0).map(c => `${c.name} x ${c.qty}`).join(" + ")
            : "ç„¡é¤é»åŠ è³¼";

        // **4. è¨‚å–®æ‘˜è¦ (ç¸½é‡‘é¡)**
        const totalPrice = currentBooking.totalPrice || 0;
        totalPriceDisplay.textContent = `$${totalPrice.toLocaleString('en-US')} TWD`;

        // 2. æ¸²æŸ“åº§ä½åœ°åœ–
        renderSeatMap();
    }


    function renderSeatMap() {
        const seatMap = document.getElementById("seatMap");
        seatMap.innerHTML = "";

        seatData.forEach((row, rIndex) => {
            const rowDiv = document.createElement("div");
            rowDiv.className = "flex space-x-2 items-center";

            const label = document.createElement("span");
            label.textContent = rows[rIndex];
            label.className = "font-bold w-6 text-center text-gray-700";
            rowDiv.appendChild(label);

            row.forEach((seat, cIndex) => {
                const seatId = `${rows[rIndex]}${cIndex+1}`;
                const seatDiv = document.createElement("div");
                seatDiv.textContent = cIndex + 1;
                seatDiv.classList.add("seat");

                if (seat === "O") {
                    seatDiv.classList.add("occupied");
                    seatDiv.title = "åº§ä½å·²å”®å‡º";
                    seatDiv.tabIndex = -1;
                    seatDiv.setAttribute('aria-disabled', 'true');
                    seatDiv.setAttribute('role', 'img');
                    seatDiv.dataset.type = 'O';
                } else if (seat === "W") {
                    seatDiv.classList.add("wheelchair");
                    seatDiv.title = "æ„›å¿ƒåº§ä½ï¼ˆè¼ªæ¤…å¸­ï¼‰";
                    seatDiv.tabIndex = 0;
                    seatDiv.setAttribute('role', 'button');
                    seatDiv.setAttribute('aria-pressed', 'false');
                    seatDiv.dataset.type = 'W';
                    seatDiv.addEventListener("click", () => toggleSeat(seatId, seatDiv));
                    seatDiv.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleSeat(seatId, seatDiv);
                        }
                    });
                } else {
                    seatDiv.classList.add("available");
                    seatDiv.title = "å¯é¸åº§ä½";
                    seatDiv.tabIndex = 0;
                    seatDiv.setAttribute('role', 'button');
                    seatDiv.setAttribute('aria-pressed', 'false');
                    seatDiv.dataset.type = 'A';
                    seatDiv.addEventListener("click", () => toggleSeat(seatId, seatDiv));
                    seatDiv.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleSeat(seatId, seatDiv);
                        }
                    });
                }

                rowDiv.appendChild(seatDiv);
            });

            seatMap.appendChild(rowDiv);
        });
    }

    function toggleSeat(seatId, element) {
        if (element.classList.contains("occupied")) return;

        if (element.classList.contains("selected")) {
            // å–æ¶ˆé¸æ“‡
            element.classList.remove("selected");
            // æ ¹æ“šåŸå§‹é¡å‹é‚„åŸç‹€æ…‹ (A / W)
            const originalType = element.dataset.type;
            if (originalType === 'W') {
                element.classList.add('wheelchair');
            } else if (originalType === 'A') {
                element.classList.add('available');
            }
            selectedSeats = selectedSeats.filter(s => s !== seatId);
        } else {
            // é¸æ“‡åº§ä½
            if (selectedSeats.length >= totalTickets) {
                errorMessage.textContent = `æœ€å¤šåªèƒ½é¸æ“‡ ${totalTickets} å€‹åº§ä½`;
                setTimeout(() => {
                    errorMessage.textContent = "";
                }, 3000);
                return;
            }
            element.classList.remove("available", "wheelchair");
            element.classList.add("selected");
            selectedSeats.push(seatId);
        }

        errorMessage.textContent = "";
        // æ›´æ–°ç„¡éšœç¤™ç‹€æ…‹
        element.setAttribute('aria-pressed', element.classList.contains('selected') ? 'true' : 'false');
        // 3. æ›´æ–°å·²é¸åº§ä½é¡¯ç¤º
        updateSelectedDisplay();
    }

    function updateSelectedDisplay() {
        if (selectedSeats.length === 0) {
            selectedSeatsDisplay.textContent = "å°šæœªé¸æ“‡åº§ä½";
            selectedSeatsSummary.textContent = "ç„¡";
        } else {
            selectedSeatsDisplay.textContent = selectedSeats.join("ã€");
            selectedSeatsSummary.textContent = selectedSeats.join("ã€");
        }

        submitSeatsInput.value = selectedSeats.join(",");

        // å•Ÿç”¨/ç¦ç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
        // å¦‚æœ totalTickets <= 0ï¼Œä¿æŒä¸‹ä¸€æ­¥ç¦ç”¨
        nextButton.disabled = (totalTickets <= 0) || (selectedSeats.length !== totalTickets);
        
        // é¡¯ç¤ºé¸æ“‡é€²åº¦
        if (selectedSeats.length > 0 && selectedSeats.length < totalTickets) {
            errorMessage.textContent = `é‚„éœ€é¸æ“‡ ${totalTickets - selectedSeats.length} å€‹åº§ä½`;
            errorMessage.className = "font-bold text-center text-blue-600 mb-4";
        } else if (selectedSeats.length === totalTickets) {
            errorMessage.textContent = "âœ“ åº§ä½é¸æ“‡å®Œæˆï¼";
            errorMessage.className = "font-bold text-center text-green-600 mb-4";
        } else {
            errorMessage.textContent = "";
        }
    }

    // æäº¤è¡¨å–® - **è³‡æ–™æµçš„æ ¸å¿ƒå„²å­˜èˆ‡è·³è½‰**
    document.getElementById("bookingFlow3Form").addEventListener("submit", function(e){
        e.preventDefault();

        if (selectedSeats.length !== totalTickets) {
            errorMessage.textContent = "è«‹å…ˆé¸æ»¿åº§ä½æ•¸é‡";
            errorMessage.className = "font-bold text-center text-red-600 mb-4";
            return;
        }

        // ğŸ¯ æ›´æ–°è¨‚ç¥¨è³‡æ–™ï¼šå°‡åº§ä½è³‡è¨Šå¯«å…¥ currentBooking
        currentBooking.selectedSeats = selectedSeats;
        currentBooking.seatCount = selectedSeats.length;

        // å„²å­˜åˆ° localStorage
        localStorage.setItem("currentBooking", JSON.stringify(currentBooking));

        console.log("ğŸ¯ Step3 å·²å„²å­˜åº§ä½é¸æ“‡ï¼š", currentBooking);

        // æª¢æŸ¥æ˜¯å¦ç‚ºç·¨è¼¯æµç¨‹ (ä¿ç•™é‚è¼¯ï¼Œç¢ºä¿ç³»çµ±å¥å£¯æ€§)
        // åªæœ‰åœ¨æ˜ç¢ºæ˜¯ç·¨è¼¯æµç¨‹æ™‚æ‰è·³è½‰åˆ° booking_edit_payment.html
        const pendingSeatsRaw2 = localStorage.getItem('editingPendingSeats');
        const editingOrderRaw = localStorage.getItem('editingOrder');

        // æ¢ä»¶1: å…©è€…éƒ½å¿…é ˆå­˜åœ¨æ‰èªç‚ºæ˜¯ç·¨è¼¯æµç¨‹
        // æ¢ä»¶2: æª¢æŸ¥æ˜¯å¦æœ‰ orderIdï¼ˆç·¨è¼¯æµç¨‹å¿…é ˆæœ‰ï¼‰
        if (pendingSeatsRaw2 && editingOrderRaw) {
            try {
                const pendingSeatsObj = JSON.parse(pendingSeatsRaw2);
                const editingOrder = JSON.parse(editingOrderRaw);
                
                // ç¢ºä¿æœ‰æœ‰æ•ˆçš„ orderId æ‰èªç‚ºæ˜¯ç·¨è¼¯æµç¨‹
                if (pendingSeatsObj.orderId && editingOrder.orderId) {
                    console.log("ğŸ”§ æª¢æ¸¬åˆ°æœ‰æ•ˆçš„ç·¨è¼¯æµç¨‹ï¼Œè½‰å‘ç·¨è¼¯ä»˜æ¬¾é é¢");
                    
                    const previousTotal = Number(pendingSeatsObj.previousTotal || 0);
                    const newTotal = Number(currentBooking.totalPrice || 0);
                    const due = newTotal - previousTotal;

                    const pending = {
                        orderId: pendingSeatsObj.orderId,
                        previousTotal: previousTotal,
                        newOrder: currentBooking, 
                        dueAmount: due
                    };
                    
                    localStorage.setItem('pendingModification', JSON.stringify(pending));
                    localStorage.removeItem('editingPendingSeats');
                    
                    window.location.href = 'booking_flow_4.html';
                    return;
                } else {
                    console.log("âš ï¸ ç·¨è¼¯æµç¨‹è³‡æ–™ä¸å®Œæ•´ï¼Œè½‰ç‚ºæ­£å¸¸æµç¨‹");
                    // æ¸…é™¤ä¸å®Œæ•´çš„ç·¨è¼¯è³‡æ–™
                    localStorage.removeItem('editingPendingSeats');
                    localStorage.removeItem('editingOrder');
                }
            } catch (err) {
                console.error('è§£æç·¨è¼¯æµç¨‹è³‡æ–™å¤±æ•—ï¼Œè½‰ç‚ºæ­£å¸¸æµç¨‹', err);
                // æ¸…é™¤éŒ¯èª¤çš„ç·¨è¼¯è³‡æ–™
                localStorage.removeItem('editingPendingSeats');
                localStorage.removeItem('editingOrder');
            }
        } else {
            // æ­£å¸¸æµç¨‹ï¼Œç¢ºä¿æ²’æœ‰æ®˜ç•™çš„ç·¨è¼¯è³‡æ–™
            if (pendingSeatsRaw2) localStorage.removeItem('editingPendingSeats');
            if (editingOrderRaw) localStorage.removeItem('editingOrder');
        }

                // æ­£å¸¸æµç¨‹ï¼šå‰å¾€ Step4
                window.location.href = "booking_flow_4.html";
            });

    window.onload = function() {
        renderUI(); // æ¸²æŸ“å°èˆªåˆ—
        setupLoginRedirectLink(); // è¨­å®šç™»å…¥é€£çµ
        if (checkLoginStatus()) { // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼Œè‹¥å·²ç™»å…¥å‰‡åŸ·è¡Œ loadBookingData
            loadBookingData();
        }
    };
</script>

<footer class="bg-vieshow-dark text-white text-center py-4 mt-8 shadow-inner">
    <p>&copy; 2025 Vieshow Ticketing System</p>
</footer>

</body>
</html>

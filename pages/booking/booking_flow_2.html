<script>
    const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
    const INDEX_PAGE_URL = '../../index.html';
    const LOGIN_PAGE_URL = '../auth/login.html';
    const MEMBER_HOME_URL = '../member/member_home.html';

    // --- å…¨åŸŸè®Šæ•¸ ---
    let ticketList = []; 
    let comboList = [];  
    const MAX_TICKETS = 9; // ç¸½ç¥¨æ•¸ä¸Šé™
    
    let currentSelections = { tickets: {}, combos: {} };
    let currentBookingData = null;

    // ... (ä¿ç•™ checkLoginStatus, renderUI, customAlert å‡½å¼ï¼Œå®ƒå€‘æ˜¯è·¨æª”æ¡ˆä¸€è‡´çš„) ...

    function checkLoginStatus() {
        const token = localStorage.getItem('auth_token');
        if (!token) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨', () => {
                window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`;
            });
            return false;
        }
        return true;
    }

    // --- è³‡æ–™è¼‰å…¥èˆ‡ç‹€æ…‹é‚„åŸ ---
    function loadBookingData() {
        const data = localStorage.getItem('currentBooking');
        if (data) {
            try {
                currentBookingData = JSON.parse(data);
                
                // 1. æª¢æŸ¥ç¥¨å‹™é¡å‹æ˜¯å¦æ”¹è®Š (ä¾‹å¦‚å¾ Step 3 è¿”å›ï¼Œä½†ç¥¨æ•¸è¶…é 9)
                const isGroup = currentBookingData.ticketType === 'group' || (currentBookingData.totalTicketQty > MAX_TICKETS);
                
                // ã€é—œéµä¿®æ­£ã€‘å¼·åˆ¶è¨­å®š ticketTypeï¼Œä»¥é˜²å¾ Step 3 è¿”å›æ™‚ï¼Œé‚è¼¯è®Šå‹•
                if (isGroup && currentBookingData.ticketType !== 'group') {
                    currentBookingData.ticketType = 'group';
                    // å¦‚æœæ˜¯å¾ä¸€èˆ¬ç¥¨è·³åˆ°åœ˜é«”ç¥¨ (ä¾‹å¦‚ç”¨æˆ¶åœ¨ Step 2 ç‹‚é»åˆ° 10 å¼µ)
                    // é€™è£¡å¯ä»¥é¸æ“‡å¼·åˆ¶å°å‘åœ˜é«”è¨‚ç¥¨å°ˆç”¨é é¢ï¼Œä½†æ ¹æ“šæ‚¨çš„æµç¨‹ï¼Œæˆ‘å€‘å…ˆä¿ç•™åœ¨ Step 2 è™•ç†
                }

                document.getElementById('cinemaNameDisplay').textContent = `å½±åŸ: ${currentBookingData.cinema.name}`;
                document.getElementById('movieTitleDisplay').textContent = `é›»å½±: ${currentBookingData.movie.title}`;
                const st = currentBookingData.showtime;
                document.getElementById('showtimeDetailDisplay').textContent = `å ´æ¬¡: ${st.date} ${st.time} ${st.theater} (${st.type})`;
                
            } catch (e) {
                console.error('è³‡æ–™è§£æå¤±æ•—', e);
                window.location.href = 'booking_flow_1.html';
            }
        } else {
            alert('ç„¡è¨‚ç¥¨è³‡æ–™ï¼Œè«‹é‡æ–°é¸æ“‡', () => window.location.href = 'booking_flow_1.html');
        }
    }

    // --- API å‘¼å« ---
    // (fetchTicketTypes å’Œ fetchMeals å‡½å¼ä¿æŒä¸è®Šï¼Œä½†æ–°å¢ restoreSelections å‘¼å«)

    async function fetchTicketTypes() {
        try {
            await new Promise(r => setTimeout(r, 300));
            ticketList = [
                { id: '801', name: 'å…¨ç¥¨', price: 300, limit: MAX_TICKETS, description: 'ä¸€èˆ¬æˆäººç¥¨' },
                { id: '802', name: 'å­¸ç”Ÿç¥¨', price: 250, limit: MAX_TICKETS, description: 'æ†‘æœ‰æ•ˆå­¸ç”Ÿè­‰å…¥å ´' },
                { id: '803', name: 'æ„›å¿ƒæ•¬è€ç¥¨', price: 220, limit: MAX_TICKETS, description: '65æ­²ä»¥ä¸Šé•·è€…æˆ–èº«å¿ƒéšœç¤™è€…' },
                { id: '806', name: 'å¥—ç¥¨', price: 450, limit: MAX_TICKETS, description: 'å«é›»å½±ç¥¨+é¤é»å„ªæƒ ' }
            ];
            renderTicketOptions();
            document.getElementById('ticketLoading').style.display = 'none';
            
            // ã€ä¿®æ­£é»ã€‘åœ¨é€™è£¡å‘¼å«é‚„åŸé¸å–ç‹€æ…‹
            restoreSelections();

        } catch (e) {
            console.error("è¼‰å…¥ç¥¨ç¨®å¤±æ•—", e);
            document.getElementById('ticketContainer').innerHTML = '<p class="text-red-500">è¼‰å…¥å¤±æ•—</p>';
        }
    }

    async function fetchMeals() {
        // ... (ä¿æŒä¸è®Š)
        try {
            const res = await fetch(`${API_BASE_URL}/info/meals`);
            if (!res.ok) throw new Error("API Error");
            const rawMeals = await res.json();
            comboList = rawMeals.map(m => ({
                id: m.id, name: m.name, price: m.price, description: m.info, icon: 'ğŸ¿' 
            }));
            renderComboOptions();
            document.getElementById('comboLoading').style.display = 'none';
        } catch (e) {
            console.error("è¼‰å…¥é¤é»å¤±æ•—", e);
            document.getElementById('comboContainer').innerHTML = '<p class="text-gray-500">æš«ç„¡é¤é»è³‡è¨Š</p>';
            document.getElementById('comboLoading').style.display = 'none';
        }
    }


    // ã€æ–°å¢ã€‘é‚„åŸå·²é¸çš„ç¥¨ç¨®æ•¸é‡
    function restoreSelections() {
        // æª¢æŸ¥æ˜¯å¦æœ‰èˆŠçš„ç¥¨æ•¸ç´€éŒ„
        if (currentBookingData.tickets && Array.isArray(currentBookingData.tickets)) {
            currentBookingData.tickets.forEach(t => {
                const inputEl = document.getElementById(`ticket-${t.id}`);
                if (inputEl && t.qty > 0) {
                    inputEl.value = t.qty;
                    currentSelections.tickets[t.id] = t.qty;
                }
            });
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰èˆŠçš„é¤é»ç´€éŒ„
        if (currentBookingData.combos && Array.isArray(currentBookingData.combos)) {
            currentBookingData.combos.forEach(c => {
                const inputEl = document.getElementById(`combo-${c.id}`);
                if (inputEl && c.qty > 0) {
                    inputEl.value = c.qty;
                    currentSelections.combos[c.id] = c.qty;
                }
            });
        }
        updateTotal(); // æ›´æ–°ç¸½åƒ¹å’ŒæŒ‰éˆ•ç‹€æ…‹
    }


    // ... (handleQuantityChange, renderTicketOptions, renderComboOptions, updateTotal ä¿æŒä¸è®Š) ...

    function renderTicketOptions() {
        const container = document.getElementById('ticketContainer');
        container.innerHTML = ticketList.map(ticket => `
            <div class="selection-card flex justify-between items-center mb-4">
                <div class="flex-1">
                    <div class="text-lg font-semibold text-gray-900 flex items-center">
                        <span class="mr-2 text-xl">ğŸ«</span> ${ticket.name}
                    </div>
                    <p class="text-sm text-gray-500 mt-1">${ticket.description}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="price-tag">TWD ${ticket.price}</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2 ml-4">
                    <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                    </button>
                    <input type="number" id="ticket-${ticket.id}" class="quantity-input" value="0" min="0" max="${MAX_TICKETS}" readonly>
                    <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>
            </div>
        `).join('');
        ticketList.forEach(t => currentSelections.tickets[t.id] = 0);
    }

    function renderComboOptions() {
        const container = document.getElementById('comboContainer');
        container.innerHTML = comboList.map(combo => `
            <div class="selection-card flex justify-between items-center mb-4">
                <div class="flex-1">
                    <div class="text-lg font-semibold text-gray-900 flex items-center">
                        <span class="mr-2 text-xl">${combo.icon}</span> ${combo.name}
                    </div>
                    <p class="text-sm text-gray-500 mt-1">${combo.description}</p>
                    <span class="price-tag mt-1">TWD ${combo.price}</span>
                </div>
                <div class="flex items-center space-x-2 ml-4">
                    <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                    </button>
                    <input type="number" id="combo-${combo.id}" class="quantity-input" value="0" min="0" max="99" readonly>
                    <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>
            </div>
        `).join('');
        comboList.forEach(c => currentSelections.combos[c.id] = 0);
    }
    
    function handleQuantityChange(e) {
        const btn = e.target.closest('button');
        if (!btn) return;

        const id = btn.dataset.id;
        const type = btn.dataset.type;
        const isPlus = btn.classList.contains('btn-plus');
        const input = document.getElementById(`${type}-${id}`);
        let val = parseInt(input.value);

        let totalTickets = Object.values(currentSelections.tickets).reduce((a, b) => a + b, 0);

        if (type === 'ticket') {
            const item = ticketList.find(t => t.id == id);
            if (isPlus) {
                if (totalTickets >= MAX_TICKETS) return alert(`ç¸½ç¥¨æ•¸ä¸Šé™ ${MAX_TICKETS} å¼µ!`);
                val++;
            } else {
                if (val > 0) val--;
            }
            currentSelections.tickets[id] = val;
        } else {
            if (isPlus) val++; else if (val > 0) val--;
            currentSelections.combos[id] = val;
        }

        input.value = val;
        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        let ticketsCount = 0;
        ticketList.forEach(t => {
            const qty = currentSelections.tickets[t.id] || 0;
            total += qty * t.price;
            ticketsCount += qty;
        });
        comboList.forEach(c => {
            const qty = currentSelections.combos[c.id] || 0;
            total += Math.round(qty * c.price * 0.8);
        });

        document.getElementById('totalPrice').textContent = `$${total.toLocaleString()} TWD`;
        document.getElementById('nextStepButton').disabled = ticketsCount === 0;
    }


    // ã€ä¿®æ­£é»ã€‘è¿”å› Flow 1 æ™‚ï¼Œå°‡ç•¶å‰é¸æ“‡çš„ç¥¨ç¨®/å½±åŸå‚³å›å»
    function handleBackToFlow1() {
        if (currentBookingData?.cinema?.id && currentBookingData.ticketType) {
            sessionStorage.setItem('returnFromStep2Data', JSON.stringify({
                ticketType: currentBookingData.ticketType,
                cinemaId: currentBookingData.cinema.id
            }));
        }
        window.location.href = 'booking_flow_1.html';
    }


    document.getElementById('bookingFlow2Form').addEventListener('submit', (e) => {
        e.preventDefault();
        const totalTickets = Object.values(currentSelections.tickets).reduce((a, b) => a + b, 0);
        if (totalTickets === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å¼µç¥¨');
        if (totalTickets > MAX_TICKETS) return alert(`ç¸½ç¥¨æ•¸è¶…éä¸Šé™ ${MAX_TICKETS} å¼µ!`);

        const tickets = [];
        ticketList.forEach(t => {
            if (currentSelections.tickets[t.id] > 0) {
                tickets.push({ id: t.id, name: t.name, price: t.price, qty: currentSelections.tickets[t.id] });
            }
        });

        const combos = [];
        comboList.forEach(c => {
            if (currentSelections.combos[c.id] > 0) {
                combos.push({ id: c.id, name: c.name, price: c.price, qty: currentSelections.combos[c.id] });
            }
        });

        const newData = {
            ...currentBookingData,
            tickets: tickets,
            combos: combos,
            totalPrice: parseInt(document.getElementById('totalPrice').textContent.replace(/\D/g, '')),
            totalTicketQty: totalTickets
        };
        localStorage.setItem('currentBooking', JSON.stringify(newData));
        
        sessionStorage.removeItem('returnFromStep2Data');

        // æ ¹æ“š totalTicketQty å’Œ ticketType æ±ºå®šè·³è½‰ç›®æ¨™
        if (newData.totalTicketQty > MAX_TICKETS || newData.ticketType === 'group') {
             // é›–ç„¶ Step 1 å·²ç¶“æ“‹äº† >9 çš„ç¥¨æ•¸ï¼Œä½†åœ˜é«”ç¥¨é‚„æ˜¯æ‡‰è·³åˆ°åœ˜é«”ç¥¨é é¢
             window.location.href = 'booking_flow_group.html';
        } else {
             window.location.href = 'booking_flow_3.html';
        }
    });

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        renderUI();
        
        if (!checkLoginStatus()) return; 

        loadBookingData();
        
        document.querySelector('.container a[href="javascript:void(0)"]').onclick = handleBackToFlow1;
        document.getElementById('ticketSelectionSection').addEventListener('click', handleQuantityChange);
        document.getElementById('comboSelectionSection').addEventListener('click', handleQuantityChange);

        fetchTicketTypes();
        fetchMeals();
    });
</script>
    
<footer class="bg-vieshow-dark text-white text-center py-4 mt-8 shadow-inner">
    <p>&copy; 2025 Vieshow Ticketing System</p>
</footer>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 2: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é» - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-dark': '#1a1a1a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    
    <style>
        /* (CSS ä¿æŒä¸è®Šï¼Œç›´æ¥æ²¿ç”¨) */
        :root { --vieshow-red: #e50914; --vieshow-gold: #f7a83d; --gray-300: #D1D5DB; --gray-200: #E5E7EB; }
        .next-step-button { width: 100%; background: var(--vieshow-red); color: #fff; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.75rem; transition: all 200ms ease; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-size: 1.125rem; display: inline-block; text-align: center; border: none; cursor: pointer; }
        .next-step-button:hover:not(:disabled) { transform: scale(1.02); background: #c40b10; }
        .next-step-button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .selection-card { border: 1px solid var(--gray-200); padding: 1rem; border-radius: 1rem; background: #fff; box-shadow: 0 6px 18px rgba(13, 14, 15, 0.04); transition: box-shadow 200ms ease; }
        .selection-card:hover { box-shadow: 0 10px 24px rgba(13,14,15,0.06); }
        .price-tag { font-size: 1.125rem; font-weight: 700; color: var(--vieshow-red); }
        .quantity-input { width: 64px; text-align: center; border: 1px solid var(--gray-300); border-radius: 0.5rem; padding: 0.375rem; }
        .quantity-input:focus { outline: none; box-shadow: 0 0 0 4px rgba(247,168,61,0.12); border-color: var(--vieshow-gold); }
        .step-indicator { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; }
        .step-circle { width: 40px; height: 40px; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; transition: all 200ms ease; }
        .step-line { height: 6px; width: 64px; background: var(--gray-300); transition: background 200ms ease; margin: 0 8px; border-radius: 4px; }
        .step-active { background: var(--vieshow-red); }
        .step-completed { background: var(--vieshow-gold); }
        .step-pending { background: var(--gray-300); }
        
        /* è¼‰å…¥ä¸­é®ç½© */
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 10; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #666; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4"></div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow max-w-4xl relative">
        <div class="step-indicator">
            <div class="step-circle step-completed">1</div>
            <div class="step-line step-active"></div>
            <div class="step-circle step-active">2</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">3</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">4</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">5</div>
        </div>
        
        <div id="bookingCard" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-4 border-vieshow-red relative min-h-[400px]">
            
            <div class="mb-8 pb-4 border-b border-gray-200">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>
                <p class="text-xl font-semibold text-vieshow-red"> é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»</p>
                <p class="text-sm text-gray-500 mt-1">è«‹é¸æ“‡æ‚¨éœ€è¦çš„ç¥¨ç¨®æ•¸é‡èˆ‡åŠ è³¼é¤é»ã€‚</p>
            </div>

            <div id="summarySection" class="p-4 rounded-xl bg-vieshow-gold/10 border-l-4 border-vieshow-gold text-sm text-gray-700 mb-6 shadow-inner">
                <h2 class="font-bold text-lg mb-2 text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-vieshow-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    å ´æ¬¡ç¢ºèª
                </h2>
                <div id="cinemaNameDisplay">å½±åŸ: è¼‰å…¥ä¸­...</div>
                <div id="movieTitleDisplay">é›»å½±: è¼‰å…¥ä¸­...</div>
                <div id="showtimeDetailDisplay" class="font-mono mt-1 text-gray-900 font-semibold">å ´æ¬¡: è¼‰å…¥ä¸­...</div>
            </div>

            <form id="bookingFlow2Form" action="#" method="POST" class="space-y-8">
                
                <div id="ticketSelectionSection" class="space-y-4 relative">
                    <div id="ticketLoading" class="loading-overlay">è¼‰å…¥ç¥¨ç¨®ä¸­...</div>
                    <label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="mr-2">ğŸ«</span> é¸æ“‡ç¥¨ç¨®æ•¸é‡ <span class="text-base font-normal text-red-500 ml-2">(ç¸½ç¥¨æ•¸æœ€å¤š 8 å¼µ)</span>
                    </label>
                    <div id="ticketContainer"></div>
                </div>
                
                <div id="comboSelectionSection" class="space-y-4 relative">
                    <div id="comboLoading" class="loading-overlay">è¼‰å…¥é¤é»ä¸­...</div>
                    <label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="mr-2">ğŸ¿</span> é¤é»åŠ è³¼ (å¯é¸) <span class="text-base font-normal text-green-600 ml-2">(å¥—é¤äº« 8 æŠ˜å„ªæƒ ï¼)</span>
                    </label>
                    <div id="comboContainer"></div>
                </div>
                
                <div class="bg-white pt-6 border-t border-gray-200 sticky bottom-0 z-10">
                    <div class="bg-vieshow-dark text-white p-4 rounded-xl shadow-2xl font-extrabold text-center text-lg mb-4">
                        ç¸½è¨ˆé‡‘é¡: <span id="totalPrice">$0 TWD</span>
                    </div>

                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <a href="booking_flow_1.html" class="flex-1 text-center bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg text-base">
                            é‡æ–°é¸æ“‡å ´æ¬¡ 
                        </a>
                        <button type="submit" id="nextStepButton" class="next-step-button flex-1" disabled>
                            ä¸‹ä¸€æ­¥: é¸æ“‡åº§ä½ 
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const INDEX_PAGE_URL = '../../index.html';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const MEMBER_HOME_URL = '../member/member_home.html';

        // --- å…¨åŸŸè®Šæ•¸ ---
        let ticketList = []; // å¾ API ç²å–çš„ç¥¨ç¨®
        let comboList = [];  // å¾ API ç²å–çš„é¤é»
        const MAX_TICKETS = 8;
        
        let currentSelections = { tickets: {}, combos: {} };
        let currentBookingData = null;

        // --- ç™»å…¥æª¢æŸ¥èˆ‡å°è¦½åˆ— ---
        function renderUI() {
            const token = localStorage.getItem('auth_token');
            const navRight = document.getElementById('headerNavRight');
            if (token) {
                navRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold ml-4">æœƒå“¡ä¸­å¿ƒ</a>`;
                document.getElementById('signOutLink').addEventListener('click', (e) => {
                    e.preventDefault(); localStorage.removeItem('auth_token'); alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
                });
            } else {
                navRight.innerHTML = `<a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold">ç™»å…¥</a>`;
            }
        }

        function checkLoginStatus() {
            if (!localStorage.getItem('auth_token')) {
                alert('è«‹å…ˆç™»å…¥', () => window.location.href = LOGIN_PAGE_URL);
                return false;
            }
            return true;
        }

        // --- è³‡æ–™è¼‰å…¥ ---
        function loadBookingData() {
            const data = localStorage.getItem('currentBooking');
            if (data) {
                try {
                    currentBookingData = JSON.parse(data);
                    // é¡¯ç¤ºå ´æ¬¡æ‘˜è¦
                    document.getElementById('cinemaNameDisplay').textContent = `å½±åŸ: ${currentBookingData.cinema.name}`;
                    document.getElementById('movieTitleDisplay').textContent = `é›»å½±: ${currentBookingData.movie.title}`;
                    const st = currentBookingData.showtime;
                    document.getElementById('showtimeDetailDisplay').textContent = `å ´æ¬¡: ${st.date} ${st.time} ${st.theater} (${st.type})`;
                } catch (e) {
                    console.error('è³‡æ–™è§£æå¤±æ•—', e);
                    window.location.href = 'booking_flow_1.html';
                }
            } else {
                alert('ç„¡è¨‚ç¥¨è³‡æ–™ï¼Œè«‹é‡æ–°é¸æ“‡', () => window.location.href = 'booking_flow_1.html');
            }
        }

        // ã€é—œéµã€‘å¾å¾Œç«¯å–å¾—ç¥¨ç¨®
        async function fetchTicketTypes() {
            try {
                // é€™è£¡æ¨¡æ“¬å¾å¾Œç«¯å–å¾—ç¥¨ç¨®ï¼Œå¯¦éš›ä¸Šæ‡‰è©²è¦æœ‰ /api/info/tickets API
                // æš«æ™‚ä½¿ç”¨å¯«æ­»è³‡æ–™ï¼Œä½†æ¶æ§‹å·²æ”¹ç‚ºéåŒæ­¥ï¼Œæœªä¾†æ¥ API åªè¦æ”¹ fetch URL å³å¯
                // const res = await fetch(`${API_BASE_URL}/info/tickets`);
                // ticketList = await res.json();
                
                // æ¨¡æ“¬ API å›å‚³
                await new Promise(r => setTimeout(r, 300));
                ticketList = [
                    { id: '801', name: 'å…¨ç¥¨', price: 300, limit: 8, description: 'ä¸€èˆ¬æˆäººç¥¨' },
                    { id: '802', name: 'å­¸ç”Ÿç¥¨', price: 250, limit: 4, description: 'æ†‘æœ‰æ•ˆå­¸ç”Ÿè­‰å…¥å ´' },
                    { id: '803', name: 'æ„›å¿ƒæ•¬è€ç¥¨', price: 220, limit: 2, description: '65æ­²ä»¥ä¸Šé•·è€…æˆ–èº«å¿ƒéšœç¤™è€…' },
                    { id: '806', name: 'å¥—ç¥¨', price: 450, limit: 4, description: 'å«é›»å½±ç¥¨+é¤é»å„ªæƒ ' }
                ];
                
                renderTicketOptions();
                document.getElementById('ticketLoading').style.display = 'none';
            } catch (e) {
                console.error("è¼‰å…¥ç¥¨ç¨®å¤±æ•—", e);
                document.getElementById('ticketContainer').innerHTML = '<p class="text-red-500">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // ã€é—œéµã€‘å¾å¾Œç«¯å–å¾—é¤é»
        async function fetchMeals() {
            try {
                const res = await fetch(`${API_BASE_URL}/info/meals`);
                if (!res.ok) throw new Error("API Error");
                const rawMeals = await res.json();
                
                // è½‰æ›æ ¼å¼ä»¥ç¬¦åˆå‰ç«¯é‚è¼¯
                comboList = rawMeals.map(m => ({
                    id: m.id,
                    name: m.name,
                    price: m.price,
                    description: m.info,
                    icon: 'ğŸ¿' // å¾Œç«¯è‹¥ç„¡ iconï¼Œå‰ç«¯çµ±ä¸€çµ¦é è¨­
                }));

                renderComboOptions();
                document.getElementById('comboLoading').style.display = 'none';
            } catch (e) {
                console.error("è¼‰å…¥é¤é»å¤±æ•—", e);
                document.getElementById('comboContainer').innerHTML = '<p class="text-gray-500">æš«ç„¡é¤é»è³‡è¨Š</p>';
                document.getElementById('comboLoading').style.display = 'none';
            }
        }

        // --- æ¸²æŸ“ UI ---
        function renderTicketOptions() {
            const container = document.getElementById('ticketContainer');
            container.innerHTML = ticketList.map(ticket => `
                <div class="selection-card flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <div class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="mr-2 text-xl">ğŸ«</span> ${ticket.name}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${ticket.description}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="price-tag">TWD ${ticket.price}</span>
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">ä¸Šé™: ${ticket.limit} å¼µ</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        <input type="number" id="ticket-${ticket.id}" class="quantity-input" value="0" min="0" max="${ticket.limit}" readonly>
                        <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // åˆå§‹åŒ–è¨ˆæ•¸
            ticketList.forEach(t => currentSelections.tickets[t.id] = 0);
        }

        function renderComboOptions() {
            const container = document.getElementById('comboContainer');
            container.innerHTML = comboList.map(combo => `
                <div class="selection-card flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <div class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="mr-2 text-xl">${combo.icon}</span> ${combo.name}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${combo.description}</p>
                        <span class="price-tag mt-1">TWD ${combo.price}</span>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        <input type="number" id="combo-${combo.id}" class="quantity-input" value="0" min="0" max="99" readonly>
                        <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // åˆå§‹åŒ–è¨ˆæ•¸
            comboList.forEach(c => currentSelections.combos[c.id] = 0);
        }

        // --- æ•¸é‡å¢æ¸›èˆ‡è¨ˆç®— ---
        function handleQuantityChange(e) {
            const btn = e.target.closest('button');
            if (!btn) return;

            const id = btn.dataset.id;
            const type = btn.dataset.type;
            const isPlus = btn.classList.contains('btn-plus');
            const input = document.getElementById(`${type}-${id}`);
            let val = parseInt(input.value);

            // è¨ˆç®—ç›®å‰ç¸½ç¥¨æ•¸
            let totalTickets = Object.values(currentSelections.tickets).reduce((a, b) => a + b, 0);

            if (type === 'ticket') {
                const item = ticketList.find(t => t.id == id);
                if (isPlus) {
                    if (val >= item.limit) return alert(`å–®ç¨®ç¥¨é™è³¼ ${item.limit} å¼µ`);
                    if (totalTickets >= MAX_TICKETS) return alert(`ç¸½ç¥¨æ•¸ä¸Šé™ ${MAX_TICKETS} å¼µ`);
                    val++;
                } else {
                    if (val > 0) val--;
                }
                currentSelections.tickets[id] = val;
            } else {
                if (isPlus) val++; else if (val > 0) val--;
                currentSelections.combos[id] = val;
            }

            input.value = val;
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            let ticketsCount = 0;

            // ç¥¨åƒ¹
            ticketList.forEach(t => {
                const qty = currentSelections.tickets[t.id] || 0;
                total += qty * t.price;
                ticketsCount += qty;
            });

            // é¤é» (8æŠ˜)
            comboList.forEach(c => {
                const qty = currentSelections.combos[c.id] || 0;
                total += Math.round(qty * c.price * 0.8);
            });

            document.getElementById('totalPrice').textContent = `$${total.toLocaleString()} TWD`;
            document.getElementById('nextStepButton').disabled = ticketsCount === 0;
        }

        // --- æäº¤ ---
        document.getElementById('bookingFlow2Form').addEventListener('submit', (e) => {
            e.preventDefault();
            const totalTickets = Object.values(currentSelections.tickets).reduce((a, b) => a + b, 0);
            if (totalTickets === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€å¼µç¥¨');

            // æ•´ç†è³‡æ–™
            const tickets = [];
            ticketList.forEach(t => {
                if (currentSelections.tickets[t.id] > 0) {
                    tickets.push({ ...t, qty: currentSelections.tickets[t.id] });
                }
            });

            const combos = [];
            comboList.forEach(c => {
                if (currentSelections.combos[c.id] > 0) {
                    combos.push({ ...c, qty: currentSelections.combos[c.id] });
                }
            });

            // æ›´æ–° localStorage
            const newData = {
                ...currentBookingData,
                tickets: tickets,
                combos: combos,
                totalPrice: parseInt(document.getElementById('totalPrice').textContent.replace(/\D/g, '')),
                totalTicketQty: totalTickets
            };
            localStorage.setItem('currentBooking', JSON.stringify(newData));
            
            // è·³è½‰
            window.location.href = 'booking_flow_3.html';
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkLoginStatus()) return;
            renderUI();
            loadBookingData();
            
            // ç¶å®šäº‹ä»¶å§”æ´¾
            document.getElementById('ticketSelectionSection').addEventListener('click', handleQuantityChange);
            document.getElementById('comboSelectionSection').addEventListener('click', handleQuantityChange);

            // ä¸¦è¡Œè¼‰å…¥è³‡æ–™
            fetchTicketTypes();
            fetchMeals();
        });

        // Custom Alert
        function alert(msg, cb) {
            const d = document.createElement('div');
            d.innerHTML = `<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded-lg shadow-xl"><p class="mb-4 font-bold text-gray-800">${msg}</p><button class="bg-vieshow-red text-white px-4 py-2 rounded" onclick="this.closest('.fixed').remove(); if(${cb}) ${cb}()">ç¢ºå®š</button></div></div>`;
            document.body.appendChild(d.firstChild);
        }
    </script>
    
    <footer class="bg-vieshow-dark text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>
</body>
</html>

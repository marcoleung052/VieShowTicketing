<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚ç¥¨æ­¥é©Ÿ 2: é¸æ“‡ç¥¨ç¨®èˆ‡é¤é» - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Tailwind é…ç½®ï¼Œç¢ºä¿é¡è‰²å’Œå­—é«”èˆ‡å°ˆæ¡ˆä¸€è‡´
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-dark': '#1a1a1a',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    
    <style>
        /* Converted Tailwind utility rules to plain CSS for browser use */
        :root {
            --vieshow-red: #e50914;
            --vieshow-gold: #f7a83d;
            --vieshow-dark: #1a1a1a;
            --gray-300: #D1D5DB;
            --gray-200: #E5E7EB;
            --gray-100: #F3F4F6;
            --gray-500: #6B7280;
        }

        .select-styled {
            width: 100%;
            padding: 0.75rem;
            background: #ffffff;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            font-size: 1rem;
        }
        .select-styled:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(247,168,61,0.12);
            border-color: var(--vieshow-gold);
        }

        .next-step-button {
            width: 100%;
            background: var(--vieshow-red);
            color: #fff;
            font-weight: 700;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            transition: all 200ms ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            font-size: 1.125rem;
            display: inline-block;
            text-align: center;
            border: none;
            cursor: pointer;
        }
        .next-step-button:hover { transform: scale(1.02); background: #c40b10; }
        .next-step-button:active { transform: scale(0.98); }
        .next-step-button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

        .selection-card {
            border: 1px solid var(--gray-200);
            padding: 1rem;
            border-radius: 1rem;
            background: #fff;
            box-shadow: 0 6px 18px rgba(13, 14, 15, 0.04);
            transition: box-shadow 200ms ease, transform 200ms ease;
        }
        .selection-card:hover { box-shadow: 0 10px 24px rgba(13,14,15,0.06); }
        .selection-card.selected { border-color: var(--vieshow-red); box-shadow: 0 0 0 4px rgba(229,9,20,0.08); }

        .price-tag { font-size: 1.125rem; font-weight: 700; color: var(--vieshow-red); }

        .quantity-input {
            width: 64px;
            text-align: center;
            border: 1px solid var(--gray-300);
            border-radius: 0.5rem;
            padding: 0.375rem;
        }
        .quantity-input:focus { outline: none; box-shadow: 0 0 0 4px rgba(247,168,61,0.12); border-color: var(--vieshow-gold); }

        .step-indicator { display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; }
        .step-circle { width: 40px; height: 40px; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; transition: all 200ms ease; }
        .step-line { height: 6px; width: 64px; background: var(--gray-300); transition: background 200ms ease, width 200ms ease; margin: 0 8px; border-radius: 4px; }
        .step-active { background: var(--vieshow-red); }
        .step-completed { background: var(--vieshow-gold); }
        .step-pending { background: var(--gray-300); }

        @media (max-width: 640px) {
            .step-line { width: 32px; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
            </div>
        </nav>
    </header>

    <div id="loginOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 flex items-center justify-center">
                <svg class="w-6 h-6 mr-2 text-vieshow-red" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨
            </h2>
            <p class="text-gray-600 mb-6">
                è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€ç™»å…¥é é¢ï¼Œä»¥ä¾¿ç¹¼çºŒæ‚¨çš„è¨‚ç¥¨æµç¨‹ã€‚
            </p>
            <a href="javascript:void(0)" id="loginRedirectButton" 
                class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                å‰å¾€ç™»å…¥
            </a>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8 flex-grow max-w-4xl">
        
        <div class="step-indicator">
            <div class="step-circle step-completed">1</div>
            <div class="step-line step-active"></div>
            <div class="step-circle step-active">2</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">3</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">4</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">5</div>
        </div>
        
        <div id="bookingCard" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-4 border-vieshow-red">
            
            <div class="mb-8 pb-4 border-b border-gray-200">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸŸï¸ è¨‚ç¥¨æµç¨‹</h1>
                <p class="text-xl font-semibold text-vieshow-red"> é¸æ“‡ç¥¨ç¨®èˆ‡é¤é»</p>
                <p class="text-sm text-gray-500 mt-1">è«‹é¸æ“‡æ‚¨éœ€è¦çš„ç¥¨ç¨®æ•¸é‡èˆ‡åŠ è³¼é¤é»ã€‚</p>
            </div>

            <div id="summarySection" class="p-4 rounded-xl bg-vieshow-gold/10 border-l-4 border-vieshow-gold text-sm text-gray-700 mb-6 shadow-inner">
                <h2 class="font-bold text-lg mb-2 text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-vieshow-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    å ´æ¬¡ç¢ºèª
                </h2>
                <div id="cinemaNameDisplay">å½±åŸ: è¼‰å…¥ä¸­...</div>
                <div id="movieTitleDisplay">é›»å½±: è¼‰å…¥ä¸­...</div>
                <div id="showtimeDetailDisplay" class="font-mono mt-1 text-gray-900 font-semibold">å ´æ¬¡: è¼‰å…¥ä¸­...</div>
                <div id="loadError" class="text-red-600 font-semibold hidden mt-2">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹å›ä¸Šä¸€æ­¥ã€‚</div>
            </div>

            <form id="bookingFlow2Form" action="#" method="POST" class="space-y-8">
                
                <div id="ticketSelectionSection" class="space-y-4">
                    <label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="mr-2">ğŸ«</span> é¸æ“‡ç¥¨ç¨®æ•¸é‡ <span class="text-base font-normal text-red-500 ml-2">(ç¸½ç¥¨æ•¸æœ€å¤š 8 å¼µ)</span>
                    </label>
                    </div>
                
                <div id="comboSelectionSection" class="space-y-4">
                    <label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="mr-2">ğŸ¿</span> é¤é»åŠ è³¼ (å¯é¸) <span class="text-base font-normal text-green-600 ml-2">(å¥—é¤äº« 8 æŠ˜å„ªæƒ ï¼)</span>
                    </label>
                    </div>
                
                <div class="bg-white pt-6 border-t border-gray-200">
                    <div class="bg-vieshow-dark text-white p-4 rounded-xl shadow-2xl font-extrabold text-center text-lg mb-4">
                        ç¸½è¨ˆé‡‘é¡: <span id="totalPrice">$0 TWD</span>
                    </div>

                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <a href="booking_flow_1.html" class="flex-1 text-center bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg text-base transform hover:scale-[1.02] active:scale-[0.98]">
                            <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> 
                            é‡æ–°é¸æ“‡å ´æ¬¡ 
                        </a>
                        <button type="submit" id="nextStepButton" class="next-step-button flex-1" disabled>
                            ä¸‹ä¸€æ­¥: é¸æ“‡åº§ä½ 
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </main>

    <script>
        // å¾é¦–é è¤‡è£½çš„å°è¦½åˆ—ç›¸é—œå¸¸æ•¸ (è·¯å¾‘ä¿®æ­£ç‚º '../../')
        const INDEX_PAGE_URL = '../../index.html'; // **[æ–°å¢]** è£œä¸Šé¦–é  URL
        const LOGIN_PAGE_URL = '../auth/login.html';
        const MEMBER_HOME_URL = '../member/member_home.html';

           // --- ç™»å…¥/ç™»å‡º/å°è¦½åˆ—é‚è¼¯ ---
        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            const currentUrl = encodeURIComponent(window.location.href);
            const loginRedirectUrl = `${LOGIN_PAGE_URL}?redirect=${currentUrl}`;
            headerNavRight.innerHTML = `
                <a href="${loginRedirectUrl}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
        }

        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            headerNavRight.innerHTML = `
                <a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
            document.getElementById('signOutLink')?.addEventListener('click', handleSignOut);
        }

        function handleSignOut(e) {
            e.preventDefault();
            localStorage.removeItem('auth_token');
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentBooking'); // æ¸…é™¤æœªå®Œæˆçš„è¨‚å–®
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡å°å‘é¦–é ...', () => {
                setTimeout(() => {
                    window.location.href = INDEX_PAGE_URL;
                }, 2000);
            }); 
            renderUI();
        }

        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                renderLoggedInState(); 
            } else {
                renderLoggedOutState();
            }
        }

        function checkLoginStatus() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨', () => {
                    const currentPage = window.location.pathname + window.location.search;
                    window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(currentPage)}`;
                });
                return false;
            }
            return true;
        }


        // 3. çµ±ä¸€çš„è‡ªå®šç¾© Alert å‡½æ•¸
        // ----------------------------------------------------

        /**
         * è‡ªå®šç¾© Modal è­¦å‘Šæ¡†ï¼Œä¸¦æ¥å—ä¸€å€‹é»æ“Šç¢ºèªå¾ŒåŸ·è¡Œçš„ callback å‡½æ•¸ã€‚
         * @param {string} message - é¡¯ç¤ºçš„è¨Šæ¯ã€‚
         * @param {function} [callback] - ç”¨æˆ¶é»æ“Šã€Œç¢ºèªã€å¾Œè¦åŸ·è¡Œçš„å‡½æ•¸ (å¯é¸)ã€‚
         */
        function customAlert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            // è™•ç†é»æ“Šã€Œç¢ºèªã€çš„é‚è¼¯
            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                // åªæœ‰åœ¨ç”¨æˆ¶é»æ“Šç¢ºèªå¾Œï¼Œæ‰åŸ·è¡Œå‚³å…¥çš„ callback å‡½æ•¸
                if (callback && typeof callback === 'function') {
                    callback(); 
                }
            };

            // å°‡ handleConfirm å‡½æ•¸è¨»å†Šåˆ°å…¨åŸŸï¼Œç¢ºä¿ HTML onclick å¯ä»¥æ‰¾åˆ°å®ƒ
            window.customAlertConfirm = handleConfirm;


            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" 
                                    class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // è¦†å¯«ç€è¦½å™¨å…§å»ºçš„ alertï¼Œçµ±ä¸€ä½¿ç”¨ customAlert
        window.alert = customAlert;

        // å°è¦½åˆ—é‚è¼¯çµæŸ

    function setupLoginRedirectLink() {
        const loginButton = document.getElementById('loginRedirectButton');
        
        if (loginButton) {
            // 1. ç²å–ç›¸å°æ–¼å°ˆæ¡ˆæ ¹ç›®éŒ„çš„è·¯å¾‘ (ä¾‹å¦‚ï¼šbooking/booking_flow.html?...)
            const currentFullUrl = window.location.href;
            
            const pathname = window.location.pathname;
            let relativeToRootPath = (pathname.startsWith('/') ? pathname.substring(1) : pathname) + window.location.search; 
            const encodedPath = encodeURIComponent(currentFullUrl);

            const LOGIN_PAGE_URL_FIXED = '../auth/login.html'; 
            
            // 3. è³¦å€¼çµ¦æŒ‰éˆ•çš„ href
            loginButton.href = `${LOGIN_PAGE_URL_FIXED}?redirect=${encodedPath}`;
        }
    }

    // æ­¥é©Ÿ 0: æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    const loginOverlay = document.getElementById('loginOverlay');
    const mainContent = document.querySelector('main'); 


    function checkLoginStatus() {
        // æ¨¡æ“¬ç™»å…¥ç‹€æ…‹ï¼šæª¢æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰ 'auth_token' è³‡æ–™
        const token = localStorage.getItem('auth_token');
        if (!token) {
            alert('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨', () => {
                const currentFullUrl = window.location.href;
                window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(currentFullUrl)}`;
            });
            // æœªç™»å…¥è™•ç†ï¼šé¡¯ç¤ºåœ–å±¤ï¼Œéš±è—ä¸»è¦å…§å®¹
            if (loginOverlay) {
                loginOverlay.classList.remove('hidden');
            }
            if (mainContent) {
                // é¿å…ä½¿ç”¨è€…çœ‹åˆ°è¢«é®è“‹çš„å…§å®¹
                mainContent.classList.add('hidden'); 
            }
            
            // é˜»æ­¢å¾ŒçºŒçš„è¨‚ç¥¨åˆå§‹åŒ–æµç¨‹
            return false;
        }

        // å·²ç™»å…¥è™•ç†ï¼šç¢ºä¿åœ–å±¤éš±è—ï¼Œä¸»è¦å…§å®¹é¡¯ç¤º
        if (loginOverlay) {
            loginOverlay.classList.add('hidden');
        }
        if (mainContent) {
            mainContent.classList.remove('hidden');
        }
        
        return true;
    }
        // Mock Data for Step 2
        const MOCK_TICKETS = [
            // å–®ä¸€ç¥¨ç¨®é™åˆ¶ï¼šå…¨ç¥¨ 8 å¼µï¼Œå­¸ç”Ÿç¥¨ 4 å¼µï¼Œæ„›å¿ƒç¥¨ 2 å¼µï¼Œå…’ç«¥ç¥¨ 4 å¼µ (çš†ç¬¦åˆ "æ¯å€‹ç¥¨ç¨®æœ€å¤šåªèƒ½é¸å…«å¼µ" çš„è¦æ±‚)
            { id: 'full', name: 'å…¨ç¥¨', price: 320, limit: 8, description: 'ä¸€èˆ¬æˆäººç¥¨', icon: 'ğŸ‘¤' },
            { id: 'student', name: 'å­¸ç”Ÿç¥¨', price: 280, limit: 4, description: 'æ†‘æœ‰æ•ˆå­¸ç”Ÿè­‰å…¥å ´', icon: 'ğŸ“' },
            { id: 'elder', name: 'æ„›å¿ƒæ•¬è€ç¥¨', price: 160, limit: 2, description: '65æ­²ä»¥ä¸Šé•·è€…æˆ–èº«å¿ƒéšœç¤™è€…', icon: 'ğŸ‘µ' },
            { id: 'child', name: 'å…’ç«¥ç¥¨', price: 240, limit: 4, description: '12æ­²ä»¥ä¸‹å…’ç«¥', icon: 'ğŸ‘¶' }
        ];

        const MOCK_COMBOS = [
            { id: 'combo_a', name: 'ç¶“å…¸çˆ†ç±³èŠ±å¥—é¤', price: 150, description: 'Mçˆ†ç±³èŠ± + ä¸­å¯æ¨‚ x1', icon: 'ğŸ¿' },
            { id: 'combo_b', name: 'é›™äººè±ªè¯å¥—é¤', price: 300, description: 'Lçˆ†ç±³èŠ± + å¤§å¯æ¨‚ x2 + ç†±ç‹— x1', icon: 'ğŸ‰' },
            { id: 'combo_c', name: 'å–®äººé£²å“åŠ è³¼', price: 80, description: 'å¤§æ¯å¯æ¨‚ x1', icon: 'ğŸ¥¤' },
            { id: 'combo_d', name: 'ç”œå¿ƒçµ„åˆ', price: 200, description: 'çˆ†ç±³èŠ±(ç”œ) + å‰æ‹¿æ£’ x2', icon: 'ğŸ¬' }
        ];
        
        // æœ€å¤§ç¸½ç¥¨æ•¸é™åˆ¶ (æ‰€æœ‰ç¥¨ç¨®ç›¸åŠ ä¸å¾—å¤§æ–¼ 8)
        const MAX_TICKETS = 8;
        
        // å–å¾— DOM å…ƒç´ 
        const cinemaNameDisplay = document.getElementById('cinemaNameDisplay');
        const movieTitleDisplay = document.getElementById('movieTitleDisplay');
        const showtimeDetailDisplay = document.getElementById('showtimeDetailDisplay');
        const loadError = document.getElementById('loadError');
        const ticketSelectionSection = document.getElementById('ticketSelectionSection');
        const comboSelectionSection = document.getElementById('comboSelectionSection');
        const totalPriceDisplay = document.getElementById('totalPrice');
        const nextStepButton = document.getElementById('nextStepButton');
        const form = document.getElementById('bookingFlow2Form');

        // å„²å­˜ç•¶å‰é¸æ“‡çš„æ•¸é‡
        let currentSelections = {
            tickets: {}, // { full: 0, student: 0, ... }
            combos: {}   // { combo_a: 0, combo_b: 0, ... }
        };

        let currentBookingData = null; // å„²å­˜æ­¥é©Ÿ 1 çš„è³‡æ–™

        // 1. è¼‰å…¥æ­¥é©Ÿ 1 çš„è³‡æ–™ä¸¦é¡¯ç¤º
        function loadBookingData() {
            const data = localStorage.getItem('currentBooking');
            if (data) {
                try {
                    currentBookingData = JSON.parse(data);
                    
                    // æª¢æŸ¥æ˜¯å¦æ˜¯å¾ showtimes_result.html ä¾†çš„è³‡æ–™æ ¼å¼
                    if (currentBookingData.cinemaName) {
                        // æ ¼å¼ 1: ä¾†è‡ª showtimes_result.html çš„æ ¼å¼
                        cinemaNameDisplay.textContent = `å½±åŸ: ${currentBookingData.cinemaName}`;
                        movieTitleDisplay.textContent = `é›»å½±: ${currentBookingData.movieTitle}`;
                        showtimeDetailDisplay.textContent = `å ´æ¬¡: ${currentBookingData.showtimeDetail}`;
                        
                        // è½‰æ›ç‚ºå…§éƒ¨ä¸€è‡´çš„æ ¼å¼
                        currentBookingData = {
                            cinema: { name: currentBookingData.cinemaName },
                            movie: { title: currentBookingData.movieTitle },
                            showtime: {
                                date: currentBookingData.showtimeDetail?.split(' ')[0] || '',
                                time: currentBookingData.showtimeDetail?.split(' ')[1] || '',
                                theater: currentBookingData.theater || '',
                                type: currentBookingData.format || ''
                            }
                        };
                    } else {
                        // æ ¼å¼ 2: ä¾†è‡ª booking_flow_1.html çš„åŸå§‹æ ¼å¼
                        cinemaNameDisplay.textContent = `å½±åŸ: ${currentBookingData.cinema?.name || currentBookingData.cinemaName || 'æœªé¸æ“‡'}`;
                        movieTitleDisplay.textContent = `é›»å½±: ${currentBookingData.movie?.title || currentBookingData.movieTitle || 'æœªé¸æ“‡'}`;
                        
                        if (currentBookingData.showtime) {
                            const showtime = currentBookingData.showtime;
                            showtimeDetailDisplay.textContent = `å ´æ¬¡: ${showtime.date} ${showtime.time} ${showtime.theater} (${showtime.type})`;
                        } else {
                            showtimeDetailDisplay.textContent = `å ´æ¬¡: ${currentBookingData.showtimeDetail || 'æœªé¸æ“‡'}`;
                        }
                    }
                } catch (e) {
                    console.error('è§£ææ­¥é©Ÿ 1 è³‡æ–™å¤±æ•—:', e);
                    loadError.classList.remove('hidden');
                }
            } else {
                console.warn('æ‰¾ä¸åˆ°è¨‚ç¥¨è³‡æ–™ã€‚ä½¿ç”¨é è¨­å€¼ã€‚');
                cinemaNameDisplay.textContent = `å½±åŸ: å¨ç§€å½±åŸ (æ¨¡æ“¬)`;
                movieTitleDisplay.textContent = `é›»å½±: æ²™ä¸˜ï¼šç¬¬äºŒéƒ¨`;
                showtimeDetailDisplay.textContent = `å ´æ¬¡: 2025/11/17 (ä¸€) 19:30 - æ•¸ä½ 3 å»³`;
                currentBookingData = {
                    cinema: { name: 'å¨ç§€å½±åŸ (æ¨¡æ“¬)' },
                    movie: { title: 'æ²™ä¸˜ï¼šç¬¬äºŒéƒ¨' },
                    showtime: { 
                        date: '2025/11/17 (ä¸€)', 
                        time: '19:30', 
                        theater: 'æ•¸ä½ 3 å»³',
                        type: 'æ•¸ä½ç‰ˆ'
                    }
                };
            }
        }

        // 2. æ¸²æŸ“ç¥¨ç¨®é¸æ“‡ UI
        function renderTicketOptions() {
            // æ¸…ç©ºä¸¦é‡æ–°åŠ å…¥æ¨™é¡Œ
            let html = `<label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <span class="mr-2">ğŸ«</span> é¸æ“‡ç¥¨ç¨®æ•¸é‡ <span class="text-base font-normal text-red-500 ml-2">(ç¸½ç¥¨æ•¸æœ€å¤š ${MAX_TICKETS} å¼µ)</span>
            </label>`;
            
            html += MOCK_TICKETS.map(ticket => `
                <div class="selection-card flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <div class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="mr-2 text-xl">${ticket.icon}</span>
                            ${ticket.name}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${ticket.description}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="price-tag">TWD ${ticket.price.toLocaleString('en-US')}</span>
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">å–®ç¨®ä¸Šé™: ${ticket.limit} å¼µ</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        <input type="number" id="ticket-${ticket.id}" name="ticket-${ticket.id}" 
                               class="quantity-input" value="0" min="0" max="${ticket.limit}" readonly 
                               data-id="${ticket.id}" data-type="ticket">
                        <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            ticketSelectionSection.innerHTML = html;

            // åˆå§‹åŒ– currentSelections.tickets
            MOCK_TICKETS.forEach(t => currentSelections.tickets[t.id] = 0);

            // å¦‚æœä¾†è‡ªç·¨è¼¯æµç¨‹ï¼Œå˜—è©¦å¾ currentBookingData é å¡«æ•¸é‡
            if (currentBookingData && currentBookingData.tickets) {
                // currentBookingData.tickets å¯èƒ½æ˜¯ object keyed by ticket id, æˆ– array with name/quantity
                MOCK_TICKETS.forEach(t => {
                    let qty = 0;
                    // case: object keyed by id
                    if (typeof currentBookingData.tickets === 'object' && !Array.isArray(currentBookingData.tickets)) {
                        const entry = currentBookingData.tickets[t.id] || currentBookingData.tickets[t.name] || currentBookingData.tickets[t.type];
                        if (entry) qty = entry.qty || entry.quantity || entry.qty || 0;
                    }
                    // case: array of { name, quantity }
                    if (Array.isArray(currentBookingData.tickets)) {
                        const found = currentBookingData.tickets.find(tt => (tt.type && tt.type === t.name) || (tt.name && tt.name === t.name));
                        if (found) qty = found.quantity || found.qty || found.qty || 0;
                    }
                    if (qty > 0) {
                        const el = document.getElementById(`ticket-${t.id}`);
                        if (el) el.value = qty;
                        currentSelections.tickets[t.id] = Number(qty);
                    }
                });
            }

            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            ticketSelectionSection.addEventListener('click', handleQuantityChange);
        }

        // 3. æ¸²æŸ“é¤é»é¸æ“‡ UI
        function renderComboOptions() {
            // æ¸…ç©ºä¸¦é‡æ–°åŠ å…¥æ¨™é¡Œ
            let html = `<label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <span class="mr-2">ğŸ¿</span> é¤é»åŠ è³¼ (å¯é¸) <span class="text-base font-normal text-green-600 ml-2">(å¥—é¤äº« 8 æŠ˜å„ªæƒ ï¼)</span>
            </label>`;

            html += MOCK_COMBOS.map(combo => `
                <div class="selection-card flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <div class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="mr-2 text-xl">${combo.icon}</span>
                            ${combo.name}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${combo.description}</p>
                        <span class="price-tag mt-1">TWD ${combo.price.toLocaleString('en-US')}</span>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        <input type="number" id="combo-${combo.id}" name="combo-${combo.id}" 
                               class="quantity-input" value="0" min="0" max="99" readonly
                               data-id="${combo.id}" data-type="combo">
                        <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            comboSelectionSection.innerHTML = html;

            // åˆå§‹åŒ– currentSelections.combos
            MOCK_COMBOS.forEach(c => currentSelections.combos[c.id] = 0);

            // å¦‚æœä¾†è‡ªç·¨è¼¯æµç¨‹ï¼Œå˜—è©¦å¾ currentBookingData é å¡«é¤é»æ•¸é‡
            if (currentBookingData && currentBookingData.combos) {
                // currentBookingData.combos å¯èƒ½æ˜¯ object keyed by combo id or keyed by name, æˆ– array
                MOCK_COMBOS.forEach(c => {
                    let qty = 0;
                    // object keyed by id
                    if (typeof currentBookingData.combos === 'object' && !Array.isArray(currentBookingData.combos)) {
                        const entry = currentBookingData.combos[c.id] || currentBookingData.combos[c.name];
                        if (entry) qty = entry.qty || entry.quantity || 0;
                    }
                    // array case: compare by name
                    if (Array.isArray(currentBookingData.combos)) {
                        const found = currentBookingData.combos.find(cc => cc.name === c.name);
                        if (found) qty = found.quantity || found.qty || 0;
                    }
                    if (qty > 0) {
                        const el = document.getElementById(`combo-${c.id}`);
                        if (el) el.value = qty;
                        currentSelections.combos[c.id] = Number(qty);
                    }
                });
            }

            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            comboSelectionSection.addEventListener('click', handleQuantityChange);
        }
        
        // 4. è™•ç†æ•¸é‡å¢æ¸›é‚è¼¯ (å·²ç¢ºä¿æŒ‰ä¸‹æŒ‰éˆ•æ™‚æ•¸é‡é™åˆ¶ç”Ÿæ•ˆ)
        function handleQuantityChange(event) {
            const target = event.target.closest('button');
            if (!target) return;
            
            const itemId = target.getAttribute('data-id');
            const itemType = target.getAttribute('data-type');
            const inputElement = document.getElementById(`${itemType}-${itemId}`);
            
            if (!inputElement) return;

            let currentValue = parseInt(inputElement.value);
            let newValue = currentValue;
            
            const isPlus = target.classList.contains('btn-plus');

            if (itemType === 'ticket') {
                const ticketInfo = MOCK_TICKETS.find(t => t.id === itemId);
                
                // è¨ˆç®—ç›®å‰æ‰€æœ‰ç¥¨ç¨®çš„ç¸½å’Œ (ä¸åŒ…æ‹¬ç•¶å‰æ­£åœ¨æ“ä½œçš„ç¥¨ç¨®)
                let ticketTotal = Object.values(currentSelections.tickets).reduce((sum, count) => sum + count, 0);
                // æ’é™¤ç•¶å‰ç¥¨ç¨®çš„è¨ˆæ•¸ï¼Œå› ç‚ºæˆ‘å€‘æ¥ä¸‹ä¾†æœƒæ›´æ–°å®ƒ
                ticketTotal -= currentValue;

                if (isPlus) {
                    // æª¢æŸ¥ 1: å–®ä¸€ç¥¨ç¨®ä¸Šé™ (ä¾‹å¦‚ï¼šå­¸ç”Ÿç¥¨æœ€å¤š 4 å¼µ)
                    if (currentValue >= ticketInfo.limit) {
                        showToast(`å–®ä¸€ç¥¨ç¨®æœ€å¤šåªèƒ½è³¼è²· ${ticketInfo.limit} å¼µ`, 'warning');
                        return;
                    } 
                    // æª¢æŸ¥ 2: ç¸½ç¥¨æ•¸ä¸Šé™ (æ‰€æœ‰ç¥¨ç¨®ç›¸åŠ ä¸å¾—å¤§æ–¼ 8)
                    if ((ticketTotal + 1) > MAX_TICKETS) {
                         showToast(`ç¸½ç¥¨æ•¸å·²é”ä¸Šé™ ${MAX_TICKETS} å¼µ!`, 'warning');
                         return;
                    } 
                    newValue++;
                } else {
                    if (currentValue > 0) newValue--;
                }
                
                currentSelections.tickets[itemId] = newValue;

            } else if (itemType === 'combo') {
                // é¤é»æ•¸é‡æ§åˆ¶ (ç„¡ç¸½ä¸Šé™ï¼Œä½†ä¸èƒ½å°æ–¼ 0)
                if (isPlus) {
                    newValue++;
                } else {
                    if (currentValue > 0) newValue--;
                }
                currentSelections.combos[itemId] = newValue;
            }

            inputElement.value = newValue;
            updateTotal();
            checkFormValidity();
        }

        // 5. è¨ˆç®—ä¸¦æ›´æ–°ç¸½é‡‘é¡ (**åŒ…å«é¤é» 8 æŠ˜å„ªæƒ **)
        function updateTotal() {
            let total = 0;
            let ticketCount = 0;
            const COMBO_DISCOUNT_RATE = 0.8; // 8æŠ˜

            // è¨ˆç®—ç¥¨åƒ¹ç¸½å’Œ
            MOCK_TICKETS.forEach(ticket => {
                const count = currentSelections.tickets[ticket.id] || 0;
                total += count * ticket.price;
                ticketCount += count;
            });

            // è¨ˆç®—é¤é»ç¸½å’Œ (æ‡‰ç”¨ 8æŠ˜)
            MOCK_COMBOS.forEach(combo => {
                const count = currentSelections.combos[combo.id] || 0;
                const originalComboPrice = count * combo.price;
                
                // æ‡‰ç”¨ 80% æŠ˜æ‰£ (8æŠ˜)
                const discountedPrice = originalComboPrice * COMBO_DISCOUNT_RATE;

                total += discountedPrice;
            });
            
            // å°‡ç¸½åƒ¹å››æ¨äº”å…¥åˆ°æ•´æ•¸ï¼Œå› ç‚ºåƒ¹æ ¼é€šå¸¸æ˜¯æ•´æ•¸
            total = Math.round(total);

            totalPriceDisplay.textContent = `$${total.toLocaleString('en-US')} TWD`;
            return ticketCount;
        }

        // 6. æª¢æŸ¥è¡¨å–®æœ‰æ•ˆæ€§ (è‡³å°‘é¸æ“‡ä¸€å¼µç¥¨)
        function checkFormValidity() {
            const totalTickets = updateTotal();
            if (totalTickets > 0) {
                nextStepButton.disabled = false;
            } else {
                nextStepButton.disabled = true;
            }
        }

        // 7. é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message, type = 'info') {
            // ç§»é™¤ç¾æœ‰çš„æç¤º
            const existingToast = document.getElementById('custom-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.id = 'custom-toast';
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white font-medium z-50 transform transition-transform duration-300 ${
                type === 'warning' ? 'bg-orange-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // 3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 8. ç›£è½å™¨ï¼šè¡¨å–®æäº¤ (ä¸‹ä¸€æ­¥) (*** ä¿®æ­£é‚è¼¯ï¼šåŠ å…¥æœ€çµ‚çš„æ•¸é‡é™åˆ¶æª¢æŸ¥ ***)
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const totalTickets = Object.values(currentSelections.tickets).reduce((s, c) => s + c, 0);

            // ã€ä¿®æ­£ 1: æœ€çµ‚æª¢æŸ¥ - ç¸½ç¥¨æ•¸ä¸å¾—å¤§æ–¼ MAX_TICKETS (8 å¼µ)ã€‘
            if (totalTickets === 0) {
                showToast("è«‹è‡³å°‘é¸æ“‡ä¸€å¼µç¥¨ï¼", "warning");
                return;
            }
            if (totalTickets > MAX_TICKETS) {
                // ä½¿ç”¨ alert ç¢ºä¿ä½¿ç”¨è€…çœ‹åˆ°éŒ¯èª¤è¨Šæ¯
                alert(`ç¸½ç¥¨æ•¸ (${totalTickets} å¼µ) è¶…éä¸Šé™ ${MAX_TICKETS} å¼µï¼Œè«‹ä¿®æ­£ï¼`);
                return;
            }

            // ã€ä¿®æ­£ 2: æœ€çµ‚æª¢æŸ¥ - æª¢æŸ¥å–®ä¸€ç¥¨ç¨®æ•¸é‡æ˜¯å¦è¶…éå…¶é™åˆ¶ã€‘
            let isValid = true;
            let overLimitTicketName = '';
            
            for (const t of MOCK_TICKETS) {
                const qty = currentSelections.tickets[t.id] || 0;
                // ä¿®æ­£ï¼šæª¢æŸ¥æ˜¯å¦è¶…éè©²ç¥¨ç¨®çš„å–®ä¸€ä¸Šé™
                if (qty > t.limit) { 
                    isValid = false;
                    overLimitTicketName = `${t.name} (ä¸Šé™: ${t.limit} å¼µ)`;
                    break; 
                }
            }

            if (!isValid) {
                // ä½¿ç”¨ alert ç¢ºä¿ä½¿ç”¨è€…çœ‹åˆ°éŒ¯èª¤è¨Šæ¯
                alert(`ç¥¨ç¨®é¸æ“‡æ•¸é‡éŒ¯èª¤ï¼š${overLimitTicketName}ï¼Œè«‹ä¿®æ­£ï¼`);
                return;
            }
            
            const COMBO_DISCOUNT_RATE = 0.8; // 8æŠ˜ (**é¤é» 8 æŠ˜é‚è¼¯ç¢ºèªç„¡èª¤**)

            // æ•´ç†ç¥¨ç¨®
            const ticketData = {};
            let ticketPriceTotal = 0;

            MOCK_TICKETS.forEach(t => {
                const qty = currentSelections.tickets[t.id];
                if (qty > 0) {
                    ticketData[t.id] = {
                        name: t.name,
                        price: t.price,
                        qty: qty,
                        subtotal: qty * t.price, // ã€æ–°å¢/ç¢ºèªã€‘ç¥¨ç¨®å°è¨ˆ
                        icon: t.icon
                    };
                    ticketPriceTotal += qty * t.price;
                }
            });

            // æ•´ç†é¤é» (è¨ˆç®—åŸå§‹åƒ¹æ ¼èˆ‡æŠ˜æ‰£å¾Œåƒ¹æ ¼)
            const comboData = {};
            let comboPriceOriginalTotal = 0; // ç´€éŒ„é¤é»åŸå§‹ç¸½åƒ¹ (ä¸æ‰“æŠ˜)
            let comboPriceDiscountedTotal = 0; // ç´€éŒ„é¤é»æŠ˜æ‰£å¾Œç¸½åƒ¹ (æ‰“ 8 æŠ˜)

            MOCK_COMBOS.forEach(c => {
                const qty = currentSelections.combos[c.id];
                if (qty > 0) {
                    const originalSubtotal = qty * c.price;
                    // æ‡‰ç”¨ 80% æŠ˜æ‰£ (8æŠ˜)
                    const discountedSubtotal = originalSubtotal * COMBO_DISCOUNT_RATE;

                    comboData[c.id] = {
                        name: c.name,
                        price: c.price, // å„²å­˜å–®åƒ¹
                        qty: qty,
                        originalSubtotal: originalSubtotal, // å„²å­˜åŸå§‹å°è¨ˆ
                        discountedSubtotal: discountedSubtotal, // å„²å­˜æŠ˜æ‰£å¾Œå°è¨ˆ
                        icon: c.icon
                    };
                    comboPriceOriginalTotal += originalSubtotal;
                    comboPriceDiscountedTotal += discountedSubtotal;
                }
            });

            // æœ€çµ‚ç¸½åƒ¹ = ç¥¨åƒ¹ç¸½å’Œ + æŠ˜æ‰£å¾Œçš„é¤é»ç¸½å’Œ (ä¸¦å››æ¨äº”å…¥åˆ°æ•´æ•¸)
            const finalPrice = Math.round(ticketPriceTotal + comboPriceDiscountedTotal);

            // è®€å–ç¾æœ‰ Step1 è³‡æ–™
            const base = currentBookingData || {};

            // å„²å­˜ Step2 è³‡æ–™ï¼ˆå…¨çµ±ä¸€æ ¼å¼ï¼‰
            const step2Data = {
                ...base,

                tickets: ticketData,
                combos: comboData,

                isGroupBooking: false,   // æ˜ç¢ºæ¨™è¨˜é€™ä¸æ˜¯åœ˜é«”ç¥¨
                groupInfo: null,         // ä¸€èˆ¬è¨‚ç¥¨ä¸éœ€è¦åœ˜é«”è³‡è¨Š

                totalTicketQty: totalTickets,
                totalTicketPrice: ticketPriceTotal,
                
                // å„²å­˜é¤é»æŠ˜æ‰£ç´°ç¯€
                comboOriginalPrice: comboPriceOriginalTotal, // é¤é»åŸå§‹ç¸½åƒ¹
                comboDiscountedPrice: Math.round(comboPriceDiscountedTotal), // é¤é»æŠ˜æ‰£å¾Œç¸½åƒ¹
                totalPrice: finalPrice, // æœ€çµ‚ç¸½åƒ¹ (åŒ…å«é¤é» 8 æŠ˜)
                
                // ã€è³‡æ–™çµæ§‹ä¸€è‡´æ€§ä¿®æ­£ã€‘ç‚ºå¾ŒçºŒæ­¥é©Ÿé ç•™æ¬„ä½ (æ­¥é©Ÿ 3: é¸ä½, æ­¥é©Ÿ 4/5: ä»˜æ¬¾/å‚™è¨»)
                selectedSeats: null, 
                paymentMethod: null, 
                remarks: '' 
            };

            localStorage.setItem('currentBooking', JSON.stringify(step2Data));

            console.log("ğŸ« Step2 å·²å„²å­˜ï¼š", step2Data);

            // --- ç·¨è¼¯æµç¨‹åˆ¤æ–· (ç¶­æŒåŸé‚è¼¯ï¼Œä½†ä½¿ç”¨ä¿®æ­£å¾Œçš„ finalPrice) ---
            const editingRaw = localStorage.getItem('editingOrder');
            if (editingRaw) {
                try {
                    const editing = JSON.parse(editingRaw);
                    const originalTotal = Number(editing.originalTotal || 0);
                    const newTotal = Number(finalPrice || 0);

                    if (newTotal > originalTotal) {
                        const originalTicketQty = Number(editing.originalTicketQty || 0);
                        const newTicketQty = Number(totalTickets || 0);

                        if (newTicketQty > originalTicketQty) {
                            const pendingSeats = {
                                orderId: editing.orderId,
                                previousTotal: originalTotal,
                                newOrder: step2Data,
                                desiredTicketCount: newTicketQty
                            };
                            localStorage.setItem('editingPendingSeats', JSON.stringify(pendingSeats));
                            window.location.href = "booking_flow_3.html";
                            return;
                        }

                        const pending = {
                            orderId: editing.orderId,
                            previousTotal: originalTotal,
                            newOrder: step2Data,
                            dueAmount: newTotal - originalTotal
                        };
                        localStorage.setItem('pendingModification', JSON.stringify(pending));
                        window.location.href = "booking_edit_payment.html";
                        return;
                    } else {
                        const ok = confirm('æœ¬æ¬¡è®Šæ›´å¾Œç¸½é¡è¼ƒåŸæœ¬è¨‚å–®å°‘/ç›¸ç­‰ï¼Œç³»çµ±ä¸æœƒé€€è²»ã€‚ç¢ºå®šè¦å„²å­˜è®Šæ›´å—ï¼Ÿ');
                        if (!ok) return;

                        try {
                            const storedRaw = localStorage.getItem('bookingHistory') || '[]';
                            const arr = JSON.parse(storedRaw);
                            const idx = arr.findIndex(o => String(o.id) === String(editing.orderId));

                            const ticketsArray = Object.keys(step2Data.tickets || {}).map(k => {
                                const t = step2Data.tickets[k];
                                return { type: t.name, quantity: Number(t.qty || 0), price: Number(t.price || 0) };
                            }).filter(x=>x.quantity>0);

                            const combosArray = Object.keys(step2Data.combos || {}).map(k => {
                                const c = step2Data.combos[k];
                                return { 
                                    name: c.name, 
                                    quantity: Number(c.qty || 0), 
                                    price: Number(c.price || 0), // é€™è£¡å­˜çš„æ˜¯åŸå§‹å–®åƒ¹
                                    subtotal: Number(c.discountedSubtotal || 0) // é€™è£¡å­˜æŠ˜æ‰£å¾Œå°è¨ˆ
                                };
                            }).filter(x=>x.quantity>0);

                            const updatedOrder = Object.assign({}, arr[idx] || {}, {
                                id: arr[idx]?.id || editing.orderId || step2Data.id,
                                movie: arr[idx]?.movie || step2Data.movie || {},
                                cinema: arr[idx]?.cinema || step2Data.cinema || (step2Data.cinema?.name || ''),
                                showtime: arr[idx]?.showtime || step2Data.showtime || step2Data.showtimeDetail || '',
                                tickets: ticketsArray,
                                combos: combosArray,
                                total: newTotal,
                                totalTicketQty: step2Data.totalTicketQty,
                                totalTicketPrice: step2Data.totalTicketPrice,
                                totalComboPrice: newTotal - step2Data.totalTicketPrice, // ç”¨ç¸½åƒ¹æ¸›å»ç¥¨åƒ¹å¾—åˆ°å¯¦éš›æ”¯ä»˜çš„é¤é»æŠ˜æ‰£åƒ¹
                                modified_at: new Date().toISOString()
                            });

                            if (idx >= 0) arr[idx] = updatedOrder; else arr.push(updatedOrder);
                            localStorage.setItem('bookingHistory', JSON.stringify(arr));
                            localStorage.removeItem('editingOrder');
                            localStorage.removeItem('currentBooking');
                            showToast('å·²å„²å­˜è®Šæ›´ï¼ˆè«‹æ³¨æ„ç³»çµ±ä¸æœƒé€€è²»ï¼‰', 'info');
                            window.location.href = 'booking_history.html';
                            return;
                        } catch (e) {
                            console.error('å„²å­˜ç·¨è¼¯çµæœå¤±æ•—', e);
                            showToast('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'warning');
                            return;
                        }
                    }
                } catch (e) {
                    console.error('è§£æ editingOrder å¤±æ•—', e);
                }
            }
            // éç·¨è¼¯æµç¨‹ï¼šè·³è½‰åˆ°æ­¥é©Ÿ 3
            window.location.href = "booking_flow_3.html";
        });

        // é é¢è¼‰å…¥æ™‚ï¼ŒåŸ·è¡Œåˆå§‹åŒ–
        window.onload = function() {
            renderUI(); // ç¢ºä¿ç™»å…¥/ç™»å‡ºé€£çµæ­£ç¢º
            setupLoginRedirectLink(); // ç¢ºä¿ç™»å…¥å°å‘æ­£ç¢º

            if (!checkLoginStatus()) {
                return;
            }

            loadBookingData();
            renderTicketOptions();
            renderComboOptions();
            checkFormValidity(); // åˆå§‹åŒ–æ™‚æª¢æŸ¥æŒ‰éˆ•ç‹€æ…‹
        };
    </script>

    <footer class="bg-vieshow-dark text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>
    
</body>
</html>

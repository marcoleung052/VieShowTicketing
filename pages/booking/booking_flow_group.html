<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ˜é«”è¨‚ç¥¨ - é¸æ“‡äººæ•¸èˆ‡é¤é» - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../js/chatbot.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-dark': '#1a1a1a',
                        'gray-500': '#6b7280',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        };

        // è‡ªå®šç¾© Alert (å¾ flow_1 è¤‡è£½çš„çµ±ä¸€ç‰ˆæœ¬)
        function customAlert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') { callback(); }
            };
            window.customAlertConfirm = handleConfirm;

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alert = customAlert;
    </script>
    
    <style>
        /* (CSS ä¿æŒä¸è®Š) */
        :root { --vieshow-red: #e50914; --vieshow-gold: #f7a83d; --gray-300: #D1D5DB; --gray-200: #E5E7EB; }
        .next-step-button { width: 100%; background: var(--vieshow-red); color: #fff; font-weight: 700; padding: 0.75rem 1rem; border-radius: 0.75rem; transition: all 200ms ease; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-size: 1.125rem; display: inline-block; text-align: center; border: none; cursor: pointer; }
        .next-step-button:hover:not(:disabled) { transform: scale(1.02); background: #c40b10; }
        .next-step-button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
        .selection-card { border: 1px solid var(--gray-200); padding: 1rem; border-radius: 1rem; background: #fff; box-shadow: 0 6px 18px rgba(13, 14, 15, 0.04); transition: box-shadow 200ms ease; }
        .selection-card:hover { box-shadow: 0 10px 24px rgba(13,14,15,0.06); }
        .price-tag { font-size: 1.125rem; font-weight: 700; color: var(--vieshow-red); }
        .quantity-input { width: 64px; text-align: center; border: 1px solid var(--gray-300); border-radius: 0.5rem; padding: 0.375rem; }
        .quantity-input:focus { outline: none; box-shadow: 0 0 0 4px rgba(247,168,61,0.12); border-color: var(--vieshow-gold); }
        
        /* æ­¥é©ŸæŒ‡ç¤ºå™¨ (æ°´å¹³ä½ˆå±€) */
        .step-indicator { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 2rem; 
            /* é—œéµï¼šæ°´å¹³æ’åˆ— */
        }
        .step-circle { 
            width: 40px; 
            height: 40px; 
            border-radius: 9999px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            color: #fff; 
            font-weight: 700; 
            transition: all 200ms ease; 
        }
        .step-line { 
            height: 8px; /* è®Šæ›´ç‚ºæ°´å¹³é€£æ¥ç·šçš„é«˜åº¦ */
            width: 64px; /* æ°´å¹³é€£æ¥ç·šçš„é•·åº¦ */
            background: #D1D5DB; 
            transition: background 200ms ease, width 200ms ease; 
            margin: 0 8px; /* å·¦å³é–“è· */
            border-radius: 4px; 
        }
        .step-active { background: #e50914; }
        .step-completed { background: #f7a83d; }
        .step-pending { background: #D1D5DB; }
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 10; display: flex; justify-content: center; align-items: center; font-weight: bold; color: #666; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4"></div>
        </nav>
    </header>

    <div id="loginOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 flex items-center justify-center">
                <svg class="w-6 h-6 mr-2 text-vieshow-red" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨
            </h2>
            <p class="text-gray-600 mb-6">
                è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€ç™»å…¥é é¢ï¼Œä»¥ä¾¿ç¹¼çºŒæ‚¨çš„è¨‚ç¥¨æµç¨‹ã€‚
            </p>
            <a href="javascript:void(0)" id="loginRedirectButton" 
                class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                å‰å¾€ç™»å…¥
            </a>
        </div>
    </div>


    <main class="container mx-auto px-4 py-8 flex-grow max-w-4xl">
        
        <div class="step-indicator">
            <div class="step-circle step-completed">1</div>
            <div class="step-line step-active"></div>
            <div class="step-circle step-active">2</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">3</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">4</div>
            <div class="step-line step-pending"></div>
            <div class="step-circle step-pending">5</div>
        </div>
        
        <div id="bookingCard" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl border-t-4 border-vieshow-red">
            
            <div class="mb-8 pb-4 border-b border-gray-200">
                <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸŸï¸ åœ˜é«”è¨‚ç¥¨</h1>
                <p class="text-xl font-semibold text-vieshow-red"> é¸æ“‡äººæ•¸èˆ‡é¤é»</p>
                <p class="text-sm text-gray-500 mt-1">è«‹é¸æ“‡æ‚¨çš„åœ˜é«”äººæ•¸ (10-20äºº) èˆ‡åŠ è³¼é¤é»ã€‚</p>
            </div>

            <div id="summarySection" class="p-4 rounded-xl bg-vieshow-gold/10 border-l-4 border-vieshow-gold text-sm text-gray-700 mb-6 shadow-inner">
                <h2 class="font-bold text-lg mb-2 text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-vieshow-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    å ´æ¬¡ç¢ºèª
                </h2>
                <div id="cinemaNameDisplay">å½±åŸ: è¼‰å…¥ä¸­...</div>
                <div id="movieTitleDisplay">é›»å½±: è¼‰å…¥ä¸­...</div>
                <div id="showtimeDetailDisplay" class="font-mono mt-1 text-gray-900 font-semibold">å ´æ¬¡: è¼‰å…¥ä¸­...</div>
                <div id="availableSeatsWarning" class="font-bold mt-2 text-green-600""></div>
                <div id="loadError" class="text-red-600 font-semibold hidden mt-2">è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹å›ä¸Šä¸€æ­¥ã€‚</div>
            </div>

            <form id="groupBookingForm" action="#" method="POST" class="space-y-8">
                
                <div id="ticketSelectionSection" class="space-y-4">
                    </div>
                
                <div id="comboSelectionSection" class="space-y-4 relative">
                    <div id="comboLoading" class="loading-overlay">è¼‰å…¥é¤é»ä¸­...</div>
                    <label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <span class="mr-2">ğŸ¿</span> é¤é»åŠ è³¼ (å¯é¸) <span class="text-base font-normal text-green-600 ml-2">(å¥—é¤äº« 8 æŠ˜å„ªæƒ ï¼)</span>
                    </label>
                    <div id="comboContainer"></div>
                </div>
                
                <div class="bg-white pt-6 border-t border-gray-200">
                    <div class="bg-vieshow-dark text-white p-4 rounded-xl shadow-2xl font-extrabold text-center text-lg mb-4">
                        è³¼è²·æ˜ç´°ç¸½è¨ˆ: <span id="totalPrice">$0 TWD</span>
                    </div>

                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <a href="booking_flow_1.html" class="flex-1 text-center bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg text-base transform hover:scale-[1.02] active:scale-[0.98]">
                            <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> 
                            ä¸Šä¸€æ­¥: é‡æ–°é¸æ“‡å ´æ¬¡ 
                        </a>
                        <button type="submit" id="nextStepButton" class="next-step-button flex-1" disabled>
                            ä¸‹ä¸€æ­¥: ç¢ºèªåº§ä½èˆ‡ä»˜æ¬¾ 
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </main>

    <script>
        // ----------------------------------------------------
        // å°è¦½åˆ—èˆ‡ç™»å…¥/ç™»å‡ºé‚è¼¯ (æ²¿ç”¨ï¼Œç¢ºä¿å³ä¸Šè§’ç™»å‡ºåŠŸèƒ½å¯ç”¨)
        // ----------------------------------------------------
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const INDEX_PAGE_URL = '../../index.html';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const MEMBER_HOME_URL = '../member/member_home.html';

        function customAlert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();
            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') {
                    callback(); 
                }
            };
            window.customAlertConfirm = handleConfirm;
            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" 
                                    class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alert = customAlert;

        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            const currentUrl = encodeURIComponent(window.location.href);
            const loginRedirectUrl = `${LOGIN_PAGE_URL}?redirect=${currentUrl}`;
            headerNavRight.innerHTML = `
                <a href="${loginRedirectUrl}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
        }

        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            headerNavRight.innerHTML = `
                <a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
            document.getElementById('signOutLink')?.addEventListener('click', (e) => {
                e.preventDefault(); 
                localStorage.removeItem('auth_token'); 
                // â˜…â˜…â˜… åœ¨ç™»å‡ºæ™‚å‘¼å« Chatbot çš„é‡ç½®å‡½å¼ â˜…â˜…â˜…
                if (window.resetChatSession) window.resetChatSession(); 
                alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
            });
        }

        function handleSignOut(e) {
            e.preventDefault();
            localStorage.removeItem('auth_token');
            localStorage.removeItem('isLoggedIn');
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡å°å‘é¦–é ...', () => {
                setTimeout(() => {
                    window.location.href = INDEX_PAGE_URL;
                }, 2000);
            }); 
            renderUI();
        }

        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                renderLoggedInState(); 
            } else {
                renderLoggedOutState();
            }
        }

        function setupLoginRedirectLink() {
            const loginButton = document.getElementById('loginRedirectButton');
            if (loginButton) {
                const pathname = window.location.pathname;
                let relativeToRootPath = (pathname.startsWith('/') ? pathname.substring(1) : pathname) + window.location.search; 
                const encodedPath = encodeURIComponent(relativeToRootPath);
                const LOGIN_PAGE_URL_FIXED = '../auth/login.html';
                loginButton.href = `${LOGIN_PAGE_URL_FIXED}?redirect=${encodedPath}`;
            }
        }

        function checkLoginStatus() {
            const loginOverlay = document.getElementById('loginOverlay');
            const mainContent = document.querySelector('main');
            const token = localStorage.getItem('auth_token');
            if (!token) {
                if (loginOverlay) loginOverlay.classList.remove('hidden');
                if (mainContent) mainContent.classList.add('hidden');
                return false;
            }
            if (loginOverlay) loginOverlay.classList.add('hidden');
            if (mainContent) mainContent.classList.remove('hidden');
            return true;
        }
        // ----------------------------------------------------
        // åœ˜é«”ç¥¨å°ˆå±¬é‚è¼¯
        // ----------------------------------------------------

        // åƒ¹æ ¼èˆ‡æ•¸é‡é™åˆ¶å¸¸æ•¸
        const ADULT_BASE_PRICE = 320; // å…¨ç¥¨åŸåƒ¹
        const TICKET_DISCOUNT_RATE = 0.8; // ç¥¨åƒ¹ 8 æŠ˜
        const COMBO_DISCOUNT_RATE = 0.8; // é¤é» 8 æŠ˜
        const MIN_TICKETS = 10;
        const MAX_TICKETS = 20;
        
        // è¨ˆç®—åœ˜é«”ç¥¨åƒ¹ (å…¨ç¥¨ 8 æŠ˜)
        const GROUP_TICKET_PRICE = Math.round(ADULT_BASE_PRICE * TICKET_DISCOUNT_RATE); // TWD 256

        // Mock Ticket Info for Group Booking (åªæœ‰ä¸€ç¨®ç¥¨)
        const MOCK_TICKETS = [
            { 
                id: 'group_full', 
                name: 'åœ˜é«”ç¥¨', 
                price: GROUP_TICKET_PRICE, 
                limit: MAX_TICKETS, 
                min: MIN_TICKETS,
                description: `å…¨ç¥¨åŸåƒ¹ TWD ${ADULT_BASE_PRICE}ï¼Œäº« 8 æŠ˜å„ªæƒ `, 
                icon: 'ğŸ‘¥' 
            }
        ];

        let comboList = []; // [å‹•æ…‹å–å¾—] å„²å­˜å¾ API å–å¾—çš„é¤é»è³‡æ–™
        let availableSeats = 0;

        // å–å¾— DOM å…ƒç´ 
        const cinemaNameDisplay = document.getElementById('cinemaNameDisplay');
        const movieTitleDisplay = document.getElementById('movieTitleDisplay');
        const showtimeDetailDisplay = document.getElementById('showtimeDetailDisplay');
        const loadError = document.getElementById('loadError');
        const ticketSelectionSection = document.getElementById('ticketSelectionSection');
        const comboSelectionSection = document.getElementById('comboSelectionSection');
        const totalPriceDisplay = document.getElementById('totalPrice');
        const nextStepButton = document.getElementById('nextStepButton');
        const form = document.getElementById('groupBookingForm');

        // å„²å­˜ç•¶å‰é¸æ“‡çš„æ•¸é‡
        let currentSelections = {
            tickets: { 'group_full': MIN_TICKETS }, // åœ˜é«”ç¥¨é è¨­ç‚º MIN_TICKETS (10)
            combos: {}   // { combo_a: 0, combo_b: 0, ... }
        };

        let currentBookingData = null; // å„²å­˜æ­¥é©Ÿ 1 çš„è³‡æ–™

        // 1. è¼‰å…¥æ­¥é©Ÿ 1 çš„è³‡æ–™ä¸¦é¡¯ç¤º (å ´æ¬¡ç¢ºèª)
        async function loadBookingData() {
            const data = localStorage.getItem('currentBooking');
            if (data) {
                try {
                    currentBookingData = JSON.parse(data);
                    
                    document.getElementById('cinemaNameDisplay').textContent = `å½±åŸ: ${currentBookingData.cinema.name}`;
                    document.getElementById('movieTitleDisplay').textContent = `é›»å½±: ${currentBookingData.movie.title}`;
                    const st = currentBookingData.showtime;
                    document.getElementById('showtimeDetailDisplay').textContent = `å ´æ¬¡: ${st.date} ${st.time} ${st.theater} (${st.type})`;
                    
                    if (currentBookingData.showtime.availableSeats !== undefined) {
                        availableSeats = currentBookingData.showtime.availableSeats;
                        updateSeatWarning();
                    } else {
                        await fetchAvailableSeats(currentBookingData.showtime.id);
                    }

                } catch (e) {
                    console.error('è³‡æ–™è§£æå¤±æ•—', e);
                    window.location.href = 'booking_flow_1.html';
                }
            } else {
                alert('ç„¡è¨‚ç¥¨è³‡æ–™ï¼Œè«‹é‡æ–°é¸æ“‡', () => window.location.href = 'booking_flow_1.html');
            }
        }
        
        async function fetchAvailableSeats(showingId) {
            try {
                const warningEl = document.getElementById('availableSeatsWarning');
                warningEl.textContent = "æ­£åœ¨ç¢ºèªå‰©é¤˜åº§ä½...";
                warningEl.className = "font-bold text-gray-500 mt-2 animate-pulse";

                const res = await fetch(`${API_BASE_URL}/booking/seats?showingId=${showingId}`);
                if (!res.ok) throw new Error("API Error");
                
                const seats = await res.json();
                availableSeats = seats.filter(s => s.status === 1).length;
                
                currentBookingData.showtime.availableSeats = availableSeats;
                localStorage.setItem('currentBooking', JSON.stringify(currentBookingData));
                
                updateSeatWarning();
                if(ticketList.length > 0) renderTicketOptions();

            } catch (e) {
                console.error("ç„¡æ³•å–å¾—åº§ä½è³‡è¨Š", e);
                availableSeats = 0;
                updateSeatWarning();
            }
        }

        function updateSeatWarning() {
            const warningEl = document.getElementById('availableSeatsWarning');
            warningEl.className = "font-bold mt-2"; 
            
            if (availableSeats <= 0) {
                warningEl.textContent = `æ­¤å ´æ¬¡å·²ç„¡åº§ä½ï¼`;
                warningEl.classList.add('text-red-600');
                document.getElementById('nextStepButton').disabled = true;
            } else if (availableSeats <= 10) {
                warningEl.textContent = `æ³¨æ„ï¼šæ­¤å ´æ¬¡åƒ…å‰© ${availableSeats} å€‹åº§ä½ï¼`;
                warningEl.classList.add('text-red-500');
            } else {
                warningEl.textContent = `æ­¤å ´æ¬¡æœ‰ ${availableSeats} å€‹åº§ä½å¯ä¾›é¸æ“‡ã€‚`;
                warningEl.classList.add('text-green-600');
            }
        }
        // 2. æ¸²æŸ“åœ˜é«”ç¥¨ç¨®é¸æ“‡ UI
        async function renderTicketOptions() {
            const ticket = MOCK_TICKETS[0];
            
            // å¦‚æœ local storage ä¸­æœ‰ groupSizeï¼Œå‰‡ä½¿ç”¨å®ƒä½œç‚ºé è¨­å€¼
            let initialQty = MIN_TICKETS;
            if (currentBookingData?.groupInfo?.groupSize) {
                initialQty = currentBookingData.groupInfo.groupSize;
                // æª¢æŸ¥æ˜¯å¦è¶…å‡ºç¯„åœï¼Œè¶…å‡ºå‰‡é‡ç½®ç‚º MIN_TICKETS
                if (initialQty < MIN_TICKETS || initialQty > MAX_TICKETS) {
                    initialQty = MIN_TICKETS;
                }
            }
            currentSelections.tickets[ticket.id] = initialQty;
            const currentMax = availableSeats > 0 ? Math.min(MAX_TICKETS, availableSeats) : MAX_TICKETS;
            let html = `<label class="block text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <span class="mr-2">ğŸ‘¥</span> é¸æ“‡åœ˜é«”äººæ•¸ <span class="text-base font-normal text-red-500 ml-2">(${MIN_TICKETS} åˆ° ${MAX_TICKETS} å¼µ)</span>
            </label>`;
            
            html += `
                <div class="selection-card flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <div class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="mr-2 text-xl">${ticket.icon}</span>
                            ${ticket.name}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${ticket.description}</p>
                        <span class="price-tag mt-1">TWD ${ticket.price.toLocaleString('en-US')} / å¼µ</span>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        <input type="number" id="ticket-${ticket.id}" name="ticket-${ticket.id}" 
                               class="quantity-input" value="${initialQty}" min="${MIN_TICKETS}" max="${MAX_TICKETS}" readonly 
                               data-id="${ticket.id}" data-type="ticket">
                        <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${ticket.id}" data-type="ticket">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                </div>
            `;
            
            ticketSelectionSection.innerHTML = html;
            ticketSelectionSection.addEventListener('click', handleQuantityChange);
        }

        // [æ–°å¢] 3. å¾ API ç²å–é¤é»è³‡æ–™
        async function fetchMeals() {
            try {
                const res = await fetch(`${API_BASE_URL}/info/meals`);
                if (!res.ok) throw new Error("API Error");
                const rawMeals = await res.json();
                // è½‰æ›è³‡æ–™æ ¼å¼ä»¥ç¬¦åˆå‰ç«¯é‚è¼¯
                comboList = rawMeals.map(m => ({
                    id: m.id, 
                    name: m.name, 
                    price: m.price, 
                    description: m.info, 
                    icon: 'ğŸ¿' 
                }));
                
                renderComboOptions();
                document.getElementById('comboLoading').style.display = 'none';

            } catch (e) {
                console.error("è¼‰å…¥é¤é»å¤±æ•—", e);
                document.getElementById('comboContainer').innerHTML = '<p class="text-gray-500">æš«ç„¡é¤é»è³‡è¨Š</p>';
                document.getElementById('comboLoading').style.display = 'none';
            }
        }

        // 3. æ¸²æŸ“é¤é»é¸æ“‡ UI (æ”¹ç”¨ comboList)
        function renderComboOptions() {
            const container = document.getElementById('comboContainer');
            
            // åˆå§‹åŒ–é¸å–®æ•¸é‡ (å¦‚æœæœ‰èˆŠè³‡æ–™ï¼Œå¯åœ¨æ­¤é‚„åŸ)
            comboList.forEach(c => {
                if (currentSelections.combos[c.id] === undefined) {
                    currentSelections.combos[c.id] = 0;
                }
            });

            container.innerHTML = comboList.map(combo => `
                <div class="selection-card flex justify-between items-center mb-4">
                    <div class="flex-1">
                        <div class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="mr-2 text-xl">${combo.icon}</span> ${combo.name}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${combo.description}</p>
                        <span class="price-tag mt-1">TWD ${(combo.price * COMBO_DISCOUNT_RATE).toFixed(0).toLocaleString('en-US')} (åŸåƒ¹ ${combo.price})</span>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button type="button" class="btn-minus bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                        </button>
                        <input type="number" id="combo-${combo.id}" name="combo-${combo.id}" 
                               class="quantity-input" value="0" min="0" max="99" readonly
                               data-id="${combo.id}" data-type="combo">
                        <button type="button" class="btn-plus bg-vieshow-red hover:bg-red-700 text-white p-2 rounded-full transition duration-150 active:scale-95" data-id="${combo.id}" data-type="combo">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>
                </div>
            `).join('');
            
            comboSelectionSection.addEventListener('click', handleQuantityChange);
        }
        
        // 4. è™•ç†æ•¸é‡å¢æ¸›é‚è¼¯
        function handleQuantityChange(event) {
            const target = event.target.closest('button');
            if (!target) return;
            
            const itemId = target.getAttribute('data-id');
            const itemType = target.getAttribute('data-type');
            const inputElement = document.getElementById(`${itemType}-${itemId}`);
            
            if (!inputElement) return;

            let currentValue = parseInt(inputElement.value);
            let newValue = currentValue;
            
            const isPlus = target.classList.contains('btn-plus');

            if (itemType === 'ticket') {
                const currentMax = Math.min(MAX_TICKETS, availableSeats);
                // åœ˜é«”ç¥¨é™åˆ¶: 10-20 å¼µ
                if (isPlus) {
                    if (currentValue < currentMax) {
                        newValue++;
                    } else {
                        if (availableSeats < MAX_TICKETS && currentValue >= availableSeats) {
                            alert(`æ­¤å ´æ¬¡åƒ…å‰© ${availableSeats} å€‹åº§ä½ï¼Œç„¡æ³•å†å¢åŠ `);
                        } else {
                            showToast(`åœ˜é«”ç¥¨äººæ•¸ä¸Šé™ç‚º ${MAX_TICKETS} äºº`, 'warning');
                        }
                        return;
                    }
                } else {
                    if (currentValue > MIN_TICKETS) {
                        newValue--;
                    } else {
                        showToast(`åœ˜é«”ç¥¨äººæ•¸ä¸‹é™ç‚º ${MIN_TICKETS} äºº`, 'warning');
                        return;
                    }
                }
                
                currentSelections.tickets[itemId] = newValue;

            } else if (itemType === 'combo') {
                // é¤é»æ•¸é‡æ§åˆ¶
                if (isPlus) {
                    newValue++;
                } else {
                    if (currentValue > 0) newValue--;
                }
                currentSelections.combos[itemId] = newValue;
            }

            inputElement.value = newValue;
            updateTotal();
            checkFormValidity();
        }

        // 5. è¨ˆç®—ä¸¦æ›´æ–°ç¸½é‡‘é¡ (**åŒ…å«ç¥¨åƒ¹èˆ‡é¤é» 8 æŠ˜å„ªæƒ **) - å¯¦ä½œè³¼è²·æ˜ç´°è¨ˆç®—
        function updateTotal() {
            let total = 0;
            let ticketCount = 0;

            // 1. è¨ˆç®—åœ˜é«”ç¥¨åƒ¹ç¸½å’Œ (å·²æ˜¯ 8 æŠ˜åƒ¹ TWD 256)
            MOCK_TICKETS.forEach(ticket => {
                const count = currentSelections.tickets[ticket.id] || 0;
                total += count * ticket.price; // ticket.price å·²ç¶“æ˜¯ 8 æŠ˜å¾Œçš„åƒ¹æ ¼ (256)
                ticketCount += count;
            });

            // 2. è¨ˆç®—é¤é»ç¸½å’Œ (æ‡‰ç”¨ 8æŠ˜) - [ä¿®æ”¹] æ”¹ç”¨ comboList
            comboList.forEach(combo => {
                const count = currentSelections.combos[combo.id] || 0;
                const originalComboPrice = count * combo.price;
                
                // æ‡‰ç”¨ 8 æŠ˜æŠ˜æ‰£
                const discountedPrice = originalComboPrice * COMBO_DISCOUNT_RATE;

                total += discountedPrice;
            });
            
            // å°‡ç¸½åƒ¹å››æ¨äº”å…¥åˆ°æ•´æ•¸
            total = Math.round(total);

            // æ›´æ–°é¡¯ç¤º
            totalPriceDisplay.textContent = `$${total.toLocaleString('en-US')} TWD`;
            return ticketCount;
        }

        // 6. æª¢æŸ¥è¡¨å–®æœ‰æ•ˆæ€§ (è‡³å°‘é¸æ“‡ MIN_TICKETS å¼µç¥¨)
        function checkFormValidity() {
            const totalTickets = updateTotal();
            // [æ–°å¢] å¦‚æœå‰©é¤˜åº§ä½ä¸è¶³æœ€ä½åœ˜é«”äººæ•¸(10)ï¼Œå¼·åˆ¶é–ä½æŒ‰éˆ•
            if (availableSeats > 0 && availableSeats < MIN_TICKETS) {
                nextStepButton.disabled = true;
                return;
            }
            // åœ˜é«”ç¥¨å¿…é ˆåœ¨ 10-20 ä¹‹é–“
            if (totalTickets >= MIN_TICKETS && totalTickets <= MAX_TICKETS) {
                nextStepButton.disabled = false;
            } else {
                nextStepButton.disabled = true;
            }
        }

        // 7. é¡¯ç¤ºæç¤ºè¨Šæ¯
        function showToast(message, type = 'info') {
            const existingToast = document.getElementById('custom-toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.id = 'custom-toast';
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white font-medium z-50 transform transition-transform duration-300 ${
                type === 'warning' ? 'bg-orange-500' : 'bg-blue-500'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 8. ç›£è½å™¨ï¼šè¡¨å–®æäº¤ (ä¸‹ä¸€æ­¥)
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const totalTickets = currentSelections.tickets['group_full'] || 0;

            // æœ€çµ‚æª¢æŸ¥åœ˜é«”ç¥¨äººæ•¸é™åˆ¶
            if (totalTickets < MIN_TICKETS || totalTickets > MAX_TICKETS) {
                alert(`åœ˜é«”ç¥¨äººæ•¸å¿…é ˆä»‹æ–¼ ${MIN_TICKETS} åˆ° ${MAX_TICKETS} å¼µä¹‹é–“ï¼`);
                return;
            }
            
            const ticket = MOCK_TICKETS[0];
            const ticketPriceTotal = totalTickets * ticket.price; // å·²æ˜¯ 8 æŠ˜åƒ¹

            // æ•´ç†é¤é» (è¨ˆç®—åŸå§‹åƒ¹æ ¼èˆ‡æŠ˜æ‰£å¾Œåƒ¹æ ¼) - [ä¿®æ”¹] æ”¹ç”¨ comboList
            const comboData = {};
            let comboPriceOriginalTotal = 0; 
            let comboPriceDiscountedTotal = 0; 

            comboList.forEach(c => {
                const qty = currentSelections.combos[c.id] || 0;
                if (qty > 0) {
                    const originalSubtotal = qty * c.price;
                    const discountedSubtotal = originalSubtotal * COMBO_DISCOUNT_RATE;

                    comboData[c.id] = {
                        name: c.name,
                        price: c.price, // åŸå§‹å–®åƒ¹
                        qty: qty,
                        originalSubtotal: originalSubtotal,
                        discountedSubtotal: discountedSubtotal,
                        icon: c.icon
                    };
                    comboPriceOriginalTotal += originalSubtotal;
                    comboPriceDiscountedTotal += discountedSubtotal;
                }
            });

            // æœ€çµ‚ç¸½åƒ¹ = ç¥¨åƒ¹ç¸½å’Œ + æŠ˜æ‰£å¾Œçš„é¤é»ç¸½å’Œ
            const finalPrice = Math.round(ticketPriceTotal + comboPriceDiscountedTotal);

            // æ•´ç†åœ˜é«”ç¥¨è³‡æ–™
            const ticketData = {
                [ticket.id]: {
                    name: ticket.name,
                    price: ticket.price, // 8æŠ˜å¾Œçš„å–®åƒ¹ (256)
                    qty: totalTickets,
                    subtotal: ticketPriceTotal,
                    icon: ticket.icon
                }
            };
            
            // è®€å–ç¾æœ‰ Step1 è³‡æ–™ä¸¦è¦†è“‹/æ–°å¢ Step2 åœ˜é«”è³‡æ–™
            const base = currentBookingData || {};

            const step2Data = {
                ...base,
                // åœ˜é«”ç¥¨å°ˆå±¬æ¨™è¨˜
                isGroupBooking: true, 
                // åˆªé™¤èˆŠçš„ contactName/Phone/Noteï¼Œå› ç‚ºæ­¤é é¢å·²ç§»é™¤è¼¸å…¥æ¡†
                groupInfo: {
                    groupSize: totalTickets,
                    contactName: '', 
                    contactPhone: '',
                    note: ''
                }, 

                tickets: ticketData,
                combos: comboData,

                totalTicketQty: totalTickets,
                totalTicketPrice: ticketPriceTotal,
                
                comboOriginalPrice: comboPriceOriginalTotal, 
                comboDiscountedPrice: Math.round(comboPriceDiscountedTotal), 
                totalPrice: finalPrice, // æœ€çµ‚ç¸½åƒ¹ (ç¥¨/é¤é»çš† 8 æŠ˜)

                // ========== [æ–°å¢] è£œé½Šèˆ‡ flow_2 ä¸€è‡´çš„åˆå§‹åŒ–æ¬„ä½ ==========
                selectedSeats: null, 
                paymentMethod: null, 
                remarks: '' 
                // ======================================================
            };
            localStorage.setItem('currentBooking', JSON.stringify(step2Data));

            console.log("ğŸ‘¥ Group Booking Step2 å·²å„²å­˜ï¼š", step2Data);

            // è·³è½‰åˆ°æ­¥é©Ÿ 3
            window.location.href = "booking_flow_3.html";
        });

        // é é¢è¼‰å…¥æ™‚ï¼ŒåŸ·è¡Œåˆå§‹åŒ–
        window.onload = function() {
            renderUI(); // ç¢ºä¿ç™»å…¥/ç™»å‡ºé€£çµæ­£ç¢º
            setupLoginRedirectLink(); // ç¢ºä¿ç™»å…¥å°å‘æ­£ç¢º

            if (!checkLoginStatus()) {
                // å¦‚æœæœªç™»å…¥ï¼Œå¾ŒçºŒæµç¨‹æœƒè¢«é˜»æ­¢
                return;
            }

            (async () => {
                await loadBookingData(); // ç­‰å¾…åº§ä½è³‡è¨Šè¼‰å…¥
                fetchMeals(); 
                checkFormValidity();
            })();
        };
    </script>

    <footer class="bg-vieshow-dark text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>
    
</body>
</html>





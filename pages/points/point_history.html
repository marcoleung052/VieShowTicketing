<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»æ•¸äº¤æ˜“æ­·å²è¨˜éŒ„ - Vieshow Ticketing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-bg': '#fefefe', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4 flex items-center"></div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-10 flex-grow max-w-4xl">
        
        <div class="bg-vieshow-bg p-6 sm:p-8 rounded-xl shadow-2xl border-t-4 border-vieshow-gold">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-extrabold text-gray-800 flex items-center">
                    ğŸ§¾ é»æ•¸äº¤æ˜“æ­·å²è¨˜éŒ„
                </h2>
                <button onclick="forceRefresh()" class="text-sm text-gray-500 hover:text-vieshow-red flex items-center transition">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0020 13a8.001 8.001 0 00-2.008-5.385M4 13c.09.665.23 1.32.418 1.95M12 20v-5h-.582m-15.356-2A8.001 8.001 0 004 11a8.001 8.001 0 002.008 5.385"></path></svg>
                    æ›´æ–°ç´€éŒ„
                </button>
            </div>
            
            <p class="text-center text-gray-500 mb-8">æŸ¥çœ‹æ‚¨ iShow é»æ•¸çš„æ‰€æœ‰è®Šå‹•è¨˜éŒ„ã€‚</p>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                <div class="bg-vieshow-red text-white p-4 rounded-lg shadow-md text-center">
                    <p class="text-sm font-medium opacity-80">ç•¶å‰å¯ç”¨é»æ•¸</p>
                    <p class="text-2xl font-bold mt-1" id="currentPoints">è¼‰å…¥ä¸­...</p>
                </div>
                <a href="../member/topup.html" class="bg-white hover:bg-gray-50 border border-gray-200 p-4 rounded-lg shadow-md text-center transition duration-150 flex flex-col justify-center">
                    <p class="text-vieshow-red font-medium">ğŸ’° é»æ•¸å„²å€¼</p>
                </a>
                <a href="point_exchange.html" class="bg-white hover:bg-gray-50 border border-gray-200 p-4 rounded-lg shadow-md text-center transition duration-150 flex flex-col justify-center">
                    <p class="text-vieshow-red font-medium">ğŸ é»æ•¸å…Œæ›ä¸­å¿ƒ</p>
                </a>
            </div>

            <div class="flex flex-wrap gap-3 mb-6 items-center">
                <label for="filterType" class="text-gray-700 font-medium text-sm">ç¯©é¸é¡å‹:</label>
                <select id="filterType" class="px-3 py-2 border border-gray-300 rounded-lg text-sm shadow-sm focus:ring-vieshow-red focus:border-vieshow-red transition">
                    <option value="all">æ‰€æœ‰è¨˜éŒ„</option>
                    <option value="inflow">é»æ•¸ç²å¾— (æ”¶å…¥)</option>
                    <option value="outflow">é»æ•¸æ”¯å‡º (å…Œæ›)</option>
                </select>
            </div>

            <div class="overflow-x-auto bg-white rounded-lg shadow-lg border border-gray-100">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">äº¤æ˜“æ—¥æœŸ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">é …ç›® / å‚™è¨»</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">é»æ•¸è®Šå‹•</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">å‰©é¤˜é»æ•¸</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200" id="pointHistoryTableBody"></tbody>
                </table>
                <div id="noRecordsMessage" class="hidden text-center p-8 text-gray-500">
                    <p>ğŸ˜® ç›®å‰é‚„æ²’æœ‰ä»»ä½•äº¤æ˜“è¨˜éŒ„ï¼Œå¿«å»å„²å€¼æˆ–å…Œæ›å§ï¼</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const MEMBER_HOME_URL = '../member/member_home.html';
        const INDEX_PAGE_URL = '../../index.html';

        // ------------------------
        // å°è¦½åˆ—èˆ‡ç™»å…¥ç‹€æ…‹
        // ------------------------
        function renderUI() {
            const token = localStorage.getItem('auth_token');
            const headerNavRight = document.getElementById('headerNavRight');
            
            if (token) {
                headerNavRight.innerHTML = `
                    <a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
                    <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
                `;
                document.getElementById('signOutLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user');
                    sessionStorage.removeItem('pointHistoryCache'); // æ¸…é™¤å¿«å–
                    alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
                });
            } else {
                headerNavRight.innerHTML = `
                    <a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                `;
            }
        }

        // ------------------------
        // ä¸»ç¨‹å¼é‚è¼¯
        // ------------------------
        const currentPointsDisplay = document.getElementById('currentPoints');
        const tableBody = document.getElementById('pointHistoryTableBody');
        const filterType = document.getElementById('filterType');
        const noRecordsMessage = document.getElementById('noRecordsMessage');
        
        let pointHistoryData = [];
        let user = null;

        document.addEventListener('DOMContentLoaded', async () => {
            renderUI();
            
            user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('auth_token');

            if (!token || !user) {
                alert('è«‹å…ˆç™»å…¥', () => window.location.href = LOGIN_PAGE_URL);
                return;
            }

            // 1. å–å¾—ç•¶å‰é¤˜é¡ (å„ªå…ˆè®€å– memberDataCache)
            loadCurrentPoints();

            // 2. å–å¾—æ­·å²ç´€éŒ„ (å„ªå…ˆè®€å– pointHistoryCache)
            await fetchPointHistory(user.id);
        });

        function loadCurrentPoints() {
            // å˜—è©¦è®€å–æœƒå“¡è³‡æ–™å¿«å–
            const cachedProfile = sessionStorage.getItem('memberDataCache');
            if (cachedProfile) {
                try {
                    const data = JSON.parse(cachedProfile);
                    currentPointsDisplay.textContent = `${data.points.toLocaleString()}`;
                    return;
                } catch(e) {}
            }

            // å¦‚æœæ²’æœ‰å¿«å–ï¼Œç™¼é€ API
            fetch(`${API_BASE_URL}/member/profile?id=${user.id}`)
                .then(res => res.json())
                .then(data => {
                    currentPointsDisplay.textContent = `${data.points.toLocaleString()}`;
                    // æ›´æ–°å¿«å–
                    sessionStorage.setItem('memberDataCache', JSON.stringify(data));
                })
                .catch(err => console.error(err));
        }

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ”¯æ´å¿«å–çš„æ­·å²ç´€éŒ„è¼‰å…¥
        async function fetchPointHistory(memberId, forceRefresh = false) {
            // 1. æª¢æŸ¥å¿«å–
            if (!forceRefresh) {
                const cachedHistory = sessionStorage.getItem('pointHistoryCache');
                if (cachedHistory) {
                    try {
                        pointHistoryData = JSON.parse(cachedHistory);
                        console.log("âš¡ ä½¿ç”¨å¿«å–æ­·å²ç´€éŒ„");
                        renderTable(pointHistoryData);
                        return;
                    } catch(e) { console.warn("å¿«å–è§£æå¤±æ•—"); }
                }
            }

            // 2. å‘¼å« API
            try {
                console.log("ğŸŒ ç™¼é€ API è«‹æ±‚è¼‰å…¥æ­·å²...");
                const response = await fetch(`${API_BASE_URL}/member/point-history?id=${memberId}`);
                if (!response.ok) throw new Error('Failed to fetch history');
                
                pointHistoryData = await response.json();
                
                // æ›´æ–°å¿«å–
                sessionStorage.setItem('pointHistoryCache', JSON.stringify(pointHistoryData));
                
                renderTable(pointHistoryData);

            } catch (error) {
                console.error('API Error:', error);
                renderTable([]);
            }
        }

        // å¼·åˆ¶é‡æ–°æ•´ç†æŒ‰éˆ•
        window.forceRefresh = function() {
            if(!user) return;
            sessionStorage.removeItem('pointHistoryCache');
            sessionStorage.removeItem('memberDataCache');
            loadCurrentPoints();
            fetchPointHistory(user.id, true);
        }

        function renderTable(records) {
            tableBody.innerHTML = '';
            
            if (records.length === 0) {
                noRecordsMessage.classList.remove('hidden');
                return;
            }
            noRecordsMessage.classList.add('hidden');

            records.forEach(record => {
                const isPositive = record.change >= 0;
                const changeClass = isPositive ? 'text-green-600 font-bold' : 'text-vieshow-red font-bold';
                const changeSign = isPositive ? '+' : '-'; 
                const absChange = Math.abs(record.change).toLocaleString();
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${record.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${record.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                        <span class="${changeClass}">${isPositive ? '+' : '-'} ${absChange}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-700 font-medium">
                        ${record.balance.toLocaleString()}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ç¯©é¸åŠŸèƒ½
        filterType.addEventListener('change', () => {
            const type = filterType.value;
            if (type === 'all') {
                renderTable(pointHistoryData);
            } else {
                const filtered = pointHistoryData.filter(r => r.type === type);
                renderTable(filtered);
            }
        });

        // è‡ªå®šç¾© Alert
        function alert(message, callback) { 
            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl p-6 w-full max-w-sm">
                        <p class="text-gray-700 mb-5 font-bold text-lg text-center">${message}</p>
                        <div class="flex justify-center">
                            <button id="alertConfirm" class="bg-vieshow-red text-white py-2 px-6 rounded-lg font-bold">ç¢ºèª</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('alertConfirm').addEventListener('click', () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback) callback();
            });
        }
        window.alert = alert;
    </script>
    <footer class="bg-gray-800 text-white p-4 mt-auto text-center text-sm">
        <p class="text-gray-400">&copy; 2025 Vieshow Ticketing System.</p>
    </footer>
</body>
</html>

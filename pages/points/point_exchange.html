<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»æ•¸å…Œæ›ä¸­å¿ƒ - Vieshow Ticketing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                        'vieshow-bg': '#fefefe', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4 flex items-center">
                </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-10 flex-grow max-w-4xl">
        
        <div class="bg-vieshow-bg p-6 sm:p-8 rounded-xl shadow-2xl border-t-4 border-vieshow-gold">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-2 flex items-center justify-center">
                ğŸ é»æ•¸å…Œæ›ä¸­å¿ƒ
            </h2>
            <p class="text-center text-gray-500 mb-8">ä½¿ç”¨æ‚¨çš„ iShow é»æ•¸å…Œæ›ç²¾é¸å•†å“åŠå„ªæƒ åˆ¸ã€‚</p>

            <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-50 p-4 rounded-lg border border-gray-200 mb-8 shadow-inner">
                <div class="text-center sm:text-left mb-3 sm:mb-0">
                    <p class="text-lg font-medium text-gray-700">æ‚¨çš„ç•¶å‰å¯ç”¨é»æ•¸:</p>
                    <p class="text-3xl font-extrabold text-vieshow-red mt-1" id="currentPoints">è¼‰å…¥ä¸­...</p>
                </div>
                <a href="point_history.html" class="text-vieshow-red hover:text-vieshow-gold font-semibold transition duration-150 text-sm">
                    æŸ¥çœ‹æˆ‘çš„å…Œæ›è¨˜éŒ„ &rarr;
                </a>
            </div>

            <h3 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">ç²¾é¸å…Œæ›å“é …</h3>
            
            <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <div class="exchange-card bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100" data-id="popcorn" data-cost="500">
                    <div class="p-4 sm:p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">ğŸ¿ ç¶“å…¸å¤§çˆ†ç±³èŠ±å¥—é¤</h4>
                        <p class="text-gray-500 text-sm mb-4">ä¸€ä»½å¤§çˆ†ç±³èŠ±èˆ‡å…©æ¯ä¸­æ¯é£²æ–™ï¼Œè§€å½±å¿…å‚™ï¼</p>
                        <div class="text-center bg-vieshow-red text-white py-2 rounded-lg font-extrabold text-2xl mb-4">
                            500 é»
                        </div>
                        <button class="exchange-button w-full bg-gray-200 text-gray-500 py-2 rounded-lg font-bold cursor-not-allowed" disabled>
                            è¼‰å…¥ä¸­...
                        </button>
                        <p class="text-xs text-center text-gray-400 mt-2">é»æ“Šå…Œæ›å°‡ç”Ÿæˆå…Œæ›æ¢ç¢¼</p>
                    </div>
                </div>

                <div class="exchange-card bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100" data-id="drink" data-cost="200">
                    <div class="p-4 sm:p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">ğŸ¥¤ ä»»é¸ä¸­æ¯é£²æ–™</h4>
                        <p class="text-gray-500 text-sm mb-4">å¯å…Œæ›ä¸€æ¯ä¸­æ¯å¯æ¨‚æˆ–æ°£æ°´ã€‚</p>
                        <div class="text-center bg-vieshow-red text-white py-2 rounded-lg font-extrabold text-2xl mb-4">
                            200 é»
                        </div>
                        <button class="exchange-button w-full bg-gray-200 text-gray-500 py-2 rounded-lg font-bold cursor-not-allowed" disabled>
                            è¼‰å…¥ä¸­...
                        </button>
                        <p class="text-xs text-center text-gray-400 mt-2">é»æ“Šå…Œæ›å°‡ç”Ÿæˆå…Œæ›æ¢ç¢¼</p>
                    </div>
                </div>
                
                <div class="exchange-card bg-white rounded-xl shadow-lg transition duration-300 overflow-hidden border border-gray-100" data-id="coupon" data-cost="1500">
                    <div class="p-4 sm:p-6">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">ğŸ·ï¸ 50å…ƒé›»å½±æŠµç”¨åˆ¸</h4>
                        <p class="text-gray-500 text-sm mb-4">å–®ç­†è³¼ç¥¨æŠ˜æŠµ 50 å…ƒï¼Œä½¿ç”¨æœŸé™ä¸‰å€‹æœˆã€‚</p>
                        <div class="text-center bg-vieshow-red text-white py-2 rounded-lg font-extrabold text-2xl mb-4">
                            1,500 é»
                        </div>
                        <button class="exchange-button w-full bg-gray-200 text-gray-500 py-2 rounded-lg font-bold cursor-not-allowed" disabled>
                            è¼‰å…¥ä¸­...
                        </button>
                        <p class="text-xs text-center text-gray-400 mt-2">éœ€ 1,500 é»</p>
                    </div>
                </div>

            </div>
            
            <div id="exchangeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="closeModal(event)">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
                    <h3 class="text-2xl font-bold text-vieshow-red mb-4">å…Œæ›ç¢ºèª</h3>
                    <p class="text-lg text-gray-700 mb-2">æ‚¨å³å°‡ä½¿ç”¨ <span id="modalCost" class="font-extrabold text-vieshow-red"></span> é»å…Œæ›ï¼š</p>
                    <p id="modalProduct" class="text-xl font-semibold text-gray-900 border-b pb-3 mb-4"></p>
                    
                    <div id="modalMessage" class="hidden p-3 my-4 rounded-lg font-medium text-sm text-center"></div>

                    <p class="text-sm text-gray-500 mb-6">å…Œæ›æˆåŠŸå¾Œï¼Œé»æ•¸å°‡ç«‹å³æ‰£é™¤ï¼Œå…Œæ›ç¢¼å°‡å­˜æ–¼æ‚¨çš„ã€Œæˆ‘çš„å…Œæ›è¨˜éŒ„ã€ã€‚</p>

                    <div class="flex justify-end space-x-3">
                        <button id="cancelButton" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">
                            å–æ¶ˆ
                        </button>
                        <button id="confirmButton" class="px-6 py-2 text-white bg-vieshow-red rounded-lg hover:bg-red-700 transition duration-150 font-bold">
                            ç¢ºèªå…Œæ›
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const MEMBER_HOME_URL = '../member/member_home.html';
        const INDEX_PAGE_URL = '../../index.html';

        let currentPoints = 0;
        let selectedItem = null;
        let user = null;

        const currentPointsDisplay = document.getElementById('currentPoints');
        const exchangeButtons = document.querySelectorAll('.exchange-button');
        const exchangeModal = document.getElementById('exchangeModal');
        const modalProduct = document.getElementById('modalProduct');
        const modalCost = document.getElementById('modalCost');
        const modalMessage = document.getElementById('modalMessage');
        const confirmButton = document.getElementById('confirmButton');
        const cancelButton = document.getElementById('cancelButton');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            renderUI();
            
            user = JSON.parse(localStorage.getItem('user'));
            const token = localStorage.getItem('auth_token');

            if (!token || !user) {
                alert('è«‹å…ˆç™»å…¥ä»¥ä½¿ç”¨é»æ•¸å…Œæ›åŠŸèƒ½', () => {
                    window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`;
                });
                return;
            }

            await fetchUserPoints(user.id);
        });

        // è®€å–é»æ•¸
        async function fetchUserPoints(memberId) {
            try {
                const response = await fetch(`${API_BASE_URL}/member/profile?id=${memberId}`);
                if (!response.ok) throw new Error('ç„¡æ³•å–å¾—æœƒå“¡è³‡æ–™');
                
                const data = await response.json();
                currentPoints = data.points; 
                currentPointsDisplay.textContent = `${currentPoints.toLocaleString()} é»`;
                updateExchangeButtonsState();

            } catch (error) {
                console.error('API Error:', error);
                currentPointsDisplay.textContent = 'è®€å–å¤±æ•—';
            }
        }

        // --- å…Œæ›é‚è¼¯ (æ ¸å¿ƒä¿®æ”¹) ---
        confirmButton.addEventListener('click', async () => {
            if (!selectedItem || confirmButton.disabled) return;

            const { productName, cost } = selectedItem;

            if (currentPoints < cost) {
                showModalMessage('é»æ•¸ä¸è¶³ï¼Œç„¡æ³•å®Œæˆå…Œæ›ã€‚', 'error');
                return;
            }
            
            confirmButton.disabled = true;
            confirmButton.textContent = 'è™•ç†ä¸­...';
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            confirmButton.classList.remove('bg-vieshow-red', 'hover:bg-red-700');

            try {
                // å‘¼å«å¾Œç«¯ API æ‰£é»
                const response = await fetch(`${API_BASE_URL}/member/redeem`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        memberId: user.id,
                        cost: cost,
                        productName: productName // å‚³çµ¦å¾Œç«¯åšç´€éŒ„ç”¨ (é¸ç”¨)
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // æˆåŠŸï¼šæ›´æ–°å‰ç«¯é»æ•¸
                    currentPoints = result.balance; 
                    currentPointsDisplay.textContent = `${currentPoints.toLocaleString()} é»`;

                    showModalMessage(`âœ… æˆåŠŸå…Œæ› ${productName}ï¼å·²æ‰£é™¤ ${cost} é»ã€‚`, 'success');
                    
                    confirmButton.textContent = 'å·²å…Œæ›';
                    confirmButton.disabled = true;
                    confirmButton.classList.remove('bg-gray-400');
                    confirmButton.classList.add('bg-green-600');
                    
                    cancelButton.textContent = 'å®Œæˆ';
                    cancelButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                    cancelButton.classList.add('bg-vieshow-gold', 'hover:bg-yellow-600', 'text-gray-900');
                    
                    cancelButton.removeEventListener('click', closeCancelModal); 
                    cancelButton.addEventListener('click', closeSuccessModal); 

                    updateExchangeButtonsState();
                } else {
                    // å¤±æ•—
                    showModalMessage(`âŒ å…Œæ›å¤±æ•—: ${result.message}`, 'error');
                    resetModalButtons(); // æ¢å¾©æŒ‰éˆ•è®“ç”¨æˆ¶é‡è©¦
                }

            } catch (error) {
                console.error("API Error:", error);
                showModalMessage('âŒ é€£ç·šä¼ºæœå™¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                resetModalButtons();
            }
        });

        // --- UI è¼”åŠ©å‡½å¼ ---
        function showModalMessage(text, type) {
            modalMessage.textContent = text;
            modalMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            if (type === 'success') modalMessage.classList.add('bg-green-100', 'text-green-800');
            else modalMessage.classList.add('bg-red-100', 'text-red-800');
            modalMessage.classList.remove('hidden');
        }

        function resetModalButtons() {
            if (confirmButton.textContent === 'è™•ç†ä¸­...') return; 
            confirmButton.textContent = 'ç¢ºèªå…Œæ›';
            confirmButton.disabled = false;
            confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed', 'bg-green-600');
            confirmButton.classList.add('bg-vieshow-red', 'hover:bg-red-700');
            
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            cancelButton.classList.remove('bg-vieshow-gold', 'hover:bg-yellow-600', 'text-gray-900');
            cancelButton.removeEventListener('click', closeSuccessModal); 
            cancelButton.addEventListener('click', closeCancelModal); 
        }

        function updateExchangeButtonsState() {
            document.querySelectorAll('.exchange-card').forEach(card => {
                const button = card.querySelector('.exchange-button');
                const cost = parseInt(card.dataset.cost);

                if (cost > currentPoints) {
                    card.classList.add('opacity-60');
                    button.disabled = true;
                    button.textContent = 'é»æ•¸ä¸è¶³';
                    button.classList.add('bg-gray-400', 'cursor-not-allowed', 'text-gray-900'); 
                    button.classList.remove('bg-vieshow-gold', 'hover:bg-yellow-600', 'text-white');
                    card.querySelector('.text-xs').textContent = `éœ€ ${cost.toLocaleString()} é»ï¼Œç›®å‰ä¸è¶³`;
                } else {
                    card.classList.remove('opacity-60');
                    button.disabled = false;
                    button.textContent = 'ç«‹å³å…Œæ›';
                    button.classList.remove('bg-gray-200', 'bg-gray-400', 'cursor-not-allowed', 'text-white', 'text-gray-500'); 
                    button.classList.add('bg-vieshow-gold', 'hover:bg-yellow-600', 'text-gray-900');
                    card.querySelector('.text-xs').textContent = 'é»æ“Šå…Œæ›å°‡ç”Ÿæˆå…Œæ›æ¢ç¢¼';
                }
            });
        }

        function openModal(productName, cost, id) {
            selectedItem = { productName, cost, id };
            modalProduct.textContent = productName;
            modalCost.textContent = cost.toLocaleString();
            modalMessage.classList.add('hidden'); 
            resetModalButtons(); 
            exchangeModal.classList.add('flex');
            exchangeModal.classList.remove('hidden');
        }

        function closeCancelModal() {
            exchangeModal.classList.add('hidden');
            exchangeModal.classList.remove('flex');
            selectedItem = null;
            resetModalButtons(); 
        }

        function closeSuccessModal() {
            closeCancelModal();
        }

        function closeModal(event) {
            if (event.target === exchangeModal) closeCancelModal();
        }
        cancelButton.addEventListener('click', closeCancelModal);

        exchangeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const card = button.closest('.exchange-card');
                const cost = parseInt(card.dataset.cost);
                const id = card.dataset.id;
                const productName = card.querySelector('h4').textContent.trim();
                if (cost > currentPoints) return; 
                openModal(productName, cost, id);
            });
        });

        // å°è¦½åˆ—èˆ‡ç™»å…¥ç‹€æ…‹
        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (headerNavRight) headerNavRight.innerHTML = `<a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>`;
        }
        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            headerNavRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
            document.getElementById('signOutLink')?.addEventListener('click', handleSignOut);
        }
        function handleSignOut(e) {
            e.preventDefault();
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡å°å‘é¦–é ...', () => { window.location.href = INDEX_PAGE_URL; }); 
        }
        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) renderLoggedInState(); else renderLoggedOutState();
        }

        function customAlert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();
            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') callback(); 
            };
            window.customAlertConfirm = handleConfirm;
            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alert = customAlert;
    </script>
    <footer class="bg-gray-800 text-white p-4 mt-auto text-center text-sm">
        <p class="text-gray-400">&copy; 2025 Vieshow Ticketing System.</p>
    </footer>
</body>
</html>

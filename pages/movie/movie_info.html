<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">é›»å½±è³‡è¨Š - Vieshow Ticketing</title> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .detail-row {
            display: flex;
            align-items: baseline;
            margin-bottom: 0.75rem; 
        }
        .detail-label {
            font-weight: 600; 
            width: 80px; 
            flex-shrink: 0;
            color: #374151; 
        }
        .detail-content {
            flex-grow: 1;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">
    
    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
            </div>
        </nav>
    </header>

    <div class="container mx-auto px-4 py-8 flex-grow">
        <div id="movieInfoCard" class="bg-white p-6 md:p-10 rounded-xl shadow-lg">
            
            <h2 id="movieTitle" class="text-3xl font-extrabold text-vieshow-red mb-3 border-b-4 border-vieshow-red pb-3 text-center">
                è¼‰å…¥ä¸­...
            </h2>
            
            <div id="averageRatingDisplay" class="text-center mb-8 p-4 bg-red-50 rounded-lg shadow-inner border border-red-200">
                </div>

            <div class="movie-details mb-8 text-gray-700 bg-gray-50 p-6 rounded-xl border border-gray-200">
                <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">åŸºæœ¬è³‡è¨Š</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-3">
                    <div class="detail-row"><span class="detail-label">ä¸Šæ˜ æ™‚é–“:</span><span id="releaseTime" class="detail-content"></span></div>
                    <div class="detail-row"><span class="detail-label">é¡å‹:</span><span id="genre" class="detail-content"></span></div>
                    <div class="detail-row"><span class="detail-label">ç‰‡é•·:</span><span id="duration" class="detail-content"></span></div>
                    <div class="detail-row"><span class="detail-label">å°æ¼”:</span><span id="director" class="detail-content"></span></div>
                    <div class="detail-row"><span class="detail-label">æ¼”å“¡:</span><span id="cast" class="detail-content"></span></div>
                </div>
                
                <h3 class="text-xl font-bold mt-6 mb-2 text-gray-800 border-b pb-2">åŠ‡æƒ…ç°¡ä»‹:</h3>
                <p id="synopsis" class="leading-relaxed whitespace-pre-wrap"></p>
            </div>

            <div id="ratingWrapper" class="mb-8 border border-dashed border-gray-300 p-6 rounded-lg bg-yellow-50 hidden">
                <h4 class="text-xl font-semibold mb-4 text-gray-800">æ‚¨çš„è©•åˆ† (éœ€ç™»å…¥æ‰èƒ½åƒèˆ‡)</h4>
                
                <div id="ratingSection">
                    </div>
            </div>
            
            <div id="bookingButtonWrapper" class="text-center pt-4"> 
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const MEMBER_HOME_URL = '../member/member_home.html';
        const INDEX_PAGE_URL = '../../index.html';

        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            const currentUrl = encodeURIComponent(window.location.href);
            headerNavRight.innerHTML = `<a href="${LOGIN_PAGE_URL}?redirect=${currentUrl}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
        }

        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            headerNavRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
            document.getElementById('signOutLink')?.addEventListener('click', handleSignOut);
        }

        function handleSignOut(e) {
            e.preventDefault();
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡é‡æ–°æ•´ç†é é¢...', () => {
                window.location.reload();
            });
        }

        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) renderLoggedInState(); else renderLoggedOutState();
        }

        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // --- æ¸²æŸ“é›»å½±è³‡è¨Š ---
        function renderMovieInfo(movie) {
            const releaseDate = new Date(movie.releaseTime);
            const today = new Date();
            today.setHours(0,0,0,0);
            const isReleased = releaseDate <= today;

            document.getElementById('pageTitle').textContent = `ã€Š${movie.name}ã€‹é›»å½±è³‡è¨Š`;
            document.getElementById('movieTitle').textContent = `ã€Š${movie.name}ã€‹é›»å½±ä»‹ç´¹`;
            document.getElementById('releaseTime').textContent = movie.releaseTime;
            document.getElementById('director').textContent = movie.director;
            document.getElementById('cast').textContent = movie.cast;
            document.getElementById('genre').textContent = "åŠ‡æƒ…"; 
            document.getElementById('duration').textContent = movie.duration;
            document.getElementById('synopsis').textContent = movie.info || "æš«ç„¡ç°¡ä»‹";

            // æ›´æ–°åˆ†æ•¸é¡¯ç¤ºå€å¡Šçš„ IDï¼Œæ–¹ä¾¿å¾ŒçºŒ JS æ›´æ–°
            const ratingDisplay = document.getElementById('averageRatingDisplay');
            const bookingButtonWrapper = document.getElementById('bookingButtonWrapper'); 

            if (isReleased) {
                ratingDisplay.innerHTML = `
                    <p class="text-xl font-semibold text-gray-800 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-gold mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.045a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.045a1 1 0 00-1.175 0l-2.817 2.045c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.02 8.729c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        å¹³å‡è§€çœ¾è©•åˆ†ï¼š
                        <span id="scoreValue" class="text-vieshow-red text-4xl font-extrabold ml-2">${movie.averageRating ? movie.averageRating.toFixed(1) : '0.0'}</span> / 5.0
                    </p>
                    <p class="text-sm text-gray-500 mt-1 text-center">
                        (å…± <span id="voteCount">${movie.totalVotes}</span> ä½è§€çœ¾è©•åˆ†)
                    </p>
                `;
                
                if (bookingButtonWrapper) {
                    bookingButtonWrapper.innerHTML = `
                        <a href="../booking/booking_flow_1.html?movie_id=${movie.id}" 
                            class="inline-block px-8 py-3 bg-vieshow-red text-white font-bold rounded-full shadow-lg hover:bg-red-700 transition duration-300 transform hover:scale-[1.02]">
                            ğŸŸï¸ å‰å¾€è¨‚ç¥¨
                        </a>`;
                }
            } else {
                ratingDisplay.textContent = "æ­¤é›»å½±å°šæœªä¸Šæ˜ ï¼Œæš«ç„¡è©•åˆ†è³‡æ–™ã€‚";
                if (bookingButtonWrapper) {
                    bookingButtonWrapper.innerHTML = `<button disabled class="inline-block px-8 py-3 bg-gray-400 text-white font-bold rounded-full shadow-lg cursor-not-allowed">ğŸŸï¸ å°šæœªé–‹æ”¾è¨‚ç¥¨</button>`;
                }
            }

            const isLoggedIn = localStorage.getItem('auth_token');
            renderRatingSection(isLoggedIn, movie.id, isReleased);
        }

        // --- æ¸²æŸ“è©•åˆ†è¡¨å–® ---
        function renderRatingSection(isLoggedIn, movieId, isReleased) {
            const ratingWrapper = document.getElementById('ratingWrapper'); 
            const ratingSection = document.getElementById('ratingSection');
            
            if (!isReleased) {
                ratingWrapper.classList.add('hidden');
                return;
            }
            ratingWrapper.classList.remove('hidden');
            
            if (isLoggedIn) {
                ratingSection.innerHTML = `
                    <form id="ratingForm" class="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <select id="userRating" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-vieshow-gold focus:border-vieshow-gold w-full sm:w-auto">
                            <option value="5">â­â­â­â­â­ 5 é¡†æ˜Ÿ (æ¥µä½³)</option>
                            <option value="4">â­â­â­â­ 4 é¡†æ˜Ÿ</option>
                            <option value="3" selected>â­â­â­ 3 é¡†æ˜Ÿ (å°šå¯)</option>
                            <option value="2">â­â­ 2 é¡†æ˜Ÿ</option>
                            <option value="1">â­ 1 é¡†æ˜Ÿ (æ¥µå·®)</option>
                        </select>
                        <button type="submit" id="submitRatingBtn" class="bg-vieshow-gold text-gray-900 font-semibold py-2 px-4 rounded-md shadow-md hover:bg-yellow-500 transition duration-300 w-full sm:w-auto">
                            é€å‡ºè©•åˆ†
                        </button>
                    </form>
                `;
                
                // ç¶å®šæäº¤äº‹ä»¶
                document.getElementById('ratingForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const ratingValue = document.getElementById('userRating').value;
                    const user = JSON.parse(localStorage.getItem('user'));
                    const btn = document.getElementById('submitRatingBtn');
                    
                    btn.disabled = true;
                    btn.textContent = 'æäº¤ä¸­...';

                    try {
                        const response = await fetch(`${API_BASE_URL}/movie/rate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                movieId: movieId,
                                memberId: user.id,
                                rating: ratingValue
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            alert(`ğŸ‰ ${result.message}ï¼æ„Ÿè¬æ‚¨çš„å›é¥‹ã€‚`);
                            // æ›´æ–°ç•«é¢ä¸Šçš„å¹³å‡åˆ†
                            document.getElementById('scoreValue').textContent = result.newAverage.toFixed(1);
                            document.getElementById('voteCount').textContent = result.newTotalVotes;
                        } else {
                            alert(`âŒ è©•åˆ†å¤±æ•—ï¼š${result.message}`);
                        }
                    } catch (err) {
                        console.error(err);
                        alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = 'é€å‡ºè©•åˆ†';
                    }
                });

            } else {
                const currentUrl = encodeURIComponent(window.location.href);
                const loginUrl = `${LOGIN_PAGE_URL}?redirect=${currentUrl}`;
                ratingSection.innerHTML = `
                    <p class="text-gray-600 mb-4 flex items-center">
                        æ‚¨å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥å¾Œæ‰èƒ½ç‚ºé›»å½±è©•åˆ†ã€‚
                    </p>
                    <a href="${loginUrl}" class="bg-vieshow-gold text-gray-900 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-500 transition duration-300 inline-flex items-center space-x-2">
                        <span>ğŸ‘¤ å‰å¾€ç™»å…¥</span>
                    </a>
                `;
            }
        }
        
        // è‡ªå®šç¾© Alert
        function alert(message, callback) {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();
            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') callback(); 
            };
            window.customAlertConfirm = handleConfirm;
            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            renderUI();
            const movieId = getQueryParam('movie_id');
            if (!movieId) {
                document.getElementById('movieInfoCard').innerHTML = '<p class="text-center p-10 text-gray-500">ç„¡æ•ˆçš„é›»å½±é€£çµã€‚</p>';
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/movie/${movieId}`);
                if (!response.ok) throw new Error("é›»å½±ä¸å­˜åœ¨");
                const movieData = await response.json();
                renderMovieInfo(movieData);
            } catch (e) {
                console.error("è¼‰å…¥å¤±æ•—:", e);
                document.getElementById('movieInfoCard').innerHTML = '<p class="text-center p-10 text-red-500">ç„¡æ³•è¼‰å…¥é›»å½±è³‡è¨Šã€‚</p>';
            }
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ´æ¬¡æŸ¥è©¢çµæœ - å¨ç§€å½±åŸ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }

        .showtime-button {
            padding: 0.5rem 1rem;
            background-color: #ffffff;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            font-weight: 600;
            transition: transform 200ms ease-in-out, box-shadow 200ms ease-in-out, background-color 200ms ease-in-out;
        }
        .showtime-button:hover {
            background-color: #e50914;
            color: #fff;
            border-color: #e50914;
            box-shadow: 0 8px 18px rgba(0,0,0,0.12);
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
                </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        
        <div class="bg-white p-8 rounded-xl shadow-xl mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 border-l-4 border-vieshow-gold pl-4">
                ğŸ¥ å¿«æœçµæœ
            </h1>
            <div id="search-criteria" class="text-lg text-gray-600 mb-6 flex flex-wrap gap-4 mt-4">
                </div>
            <a href="../../index.html" class="text-vieshow-red hover:text-red-700 font-semibold transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                è¿”å›é‡æ–°æŸ¥è©¢
            </a>
        </div>

        <div id="showtimes-list" class="space-y-8">
            <p class="text-center text-gray-500 py-10">æ­£åœ¨æœå°‹å ´æ¬¡...</p>
        </div>

    </main>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        // è¨­å®šå¾Œç«¯ API ç¶²å€
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';

        // é é¢è·¯å¾‘è¨­å®š
        const LOGIN_PAGE_URL = '../../pages/auth/login.html';
        const MEMBER_HOME_URL = '../../pages/member/member_home.html';

        // åœ°é»ä»£ç¢¼å°æ‡‰è¡¨ (å°‡é¦–é çš„ value è½‰æ›ç‚ºè³‡æ–™åº«çš„ ID)
        // å‡è¨­è³‡æ–™åº« ID: 01=å°åŒ—ä¿¡ç¾©, 02=å°ä¸­å¤§é ç™¾, 03=é«˜é›„å¤§é ç™¾
        const locationIdMap = {
            'taipei': '01',
            'taichung': '02',
            'kaohsiung': '03'
        };

        // é¡¯ç¤ºåç¨±å°æ‡‰ (ç”¨æ–¼ UI é¡¯ç¤º)
        const locationNameMap = {
            'taipei': 'å°åŒ—ä¿¡ç¾©',
            'taichung': 'å°ä¸­å¤§é ç™¾',
            'kaohsiung': 'é«˜é›„å¤§é ç™¾',
            '01': 'å°åŒ—ä¿¡ç¾©',
            '02': 'å°ä¸­å¤§é ç™¾',
            '03': 'é«˜é›„å¤§é ç™¾'
        };

        // ----------------------------------------------------
        // å°è¦½åˆ—èˆ‡ç™»å…¥ç‹€æ…‹é‚è¼¯
        // ----------------------------------------------------
        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            const currentUrl = encodeURIComponent(window.location.href);
            const loginRedirectUrl = `${LOGIN_PAGE_URL}?redirect=${currentUrl}`;
            headerNavRight.innerHTML = `
                <a href="${loginRedirectUrl}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
        }

        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            headerNavRight.innerHTML = `
                <a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
            document.getElementById('signOutLink')?.addEventListener('click', handleSignOut);
        }

        function handleSignOut(e) {
            e.preventDefault();
            localStorage.removeItem('auth_token');
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡é‡æ–°æ•´ç†é é¢...', () => {
                window.location.reload();
            });
        }

        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                renderLoggedInState();
            } else {
                renderLoggedOutState();
            }
        }

        // ----------------------------------------------------
        // æ ¸å¿ƒé‚è¼¯ï¼šè¼‰å…¥ä¸¦æ¸²æŸ“å ´æ¬¡
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', async () => {
            renderUI();

            const params = new URLSearchParams(window.location.search);
            const locationCode = params.get('location') || '';
            const date = params.get('date') || '';
            const movieId = params.get('movie') || '';

            // è½‰æ›åœ°é»ä»£ç¢¼ç‚ºè³‡æ–™åº« ID
            const dbLocationId = locationIdMap[locationCode] || locationCode;

            // æº–å‚™é¡¯ç¤ºæŸ¥è©¢æ¢ä»¶
            const locationName = locationNameMap[locationCode] || locationCode || 'æ‰€æœ‰å½±åŸ';
            
            try {
                // å»ºæ§‹ API æŸ¥è©¢å­—ä¸²
                const queryStr = new URLSearchParams({
                    location: dbLocationId,
                    movie: movieId,
                    date: date
                }).toString();

                const response = await fetch(`${API_BASE_URL}/movie/showtimes?${queryStr}`);
                
                if (!response.ok) throw new Error('API è«‹æ±‚å¤±æ•—');
                const showtimes = await response.json();

                // æ¸²æŸ“æŸ¥è©¢æ¢ä»¶æ–‡å­—
                renderCriteria(locationName, date, showtimes);

                // æ¸²æŸ“çµæœ
                renderShowtimes(showtimes);

            } catch (e) {
                console.error("æœå°‹å¤±æ•—:", e);
                document.getElementById('showtimes-list').innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-red-500 text-xl font-bold">ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨ ğŸ˜¢</p>
                        <p class="text-gray-500 mt-2">è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šã€‚</p>
                    </div>
                `;
            }
        });

        /**
         * æ¸²æŸ“æŸ¥è©¢æ¢ä»¶
         */
        function renderCriteria(locationName, date, showtimes) {
            const criteriaDiv = document.getElementById('search-criteria');
            let criteriaHtml = '';

            // å½±åŸæ¨™ç±¤
            if (locationName && locationName !== 'æ‰€æœ‰å½±åŸ') {
                criteriaHtml += `<span class="bg-vieshow-red/10 text-vieshow-red font-bold p-2 rounded-lg">å½±åŸ: ${locationName}</span>`;
            }
            
            // æ—¥æœŸæ¨™ç±¤
            if (date) {
                criteriaHtml += `<span class="bg-gray-200 text-gray-800 font-bold p-2 rounded-lg">æ—¥æœŸ: ${date}</span>`;
            }
            
            // é›»å½±æ¨™ç±¤ (å¾çµæœä¸­æŠ“å–ç¬¬ä¸€ç­†çš„é›»å½±åç¨±ï¼Œè‹¥ç„¡çµæœå‰‡ç„¡æ³•é¡¯ç¤ºåç¨±)
            if (showtimes.length > 0) {
                // å¦‚æœæœ‰æŒ‡å®šé›»å½±IDï¼Œå˜—è©¦æŠ“å–åç¨±
                const movieName = showtimes[0].movieName;
                // åªæœ‰ç•¶æœå°‹åƒæ•¸æœ‰æŒ‡å®š movie ID æ™‚æ‰ç‰¹åˆ¥é¡¯ç¤ºé›»å½±æ¨™ç±¤ï¼Œé¿å…é‡è¤‡
                const params = new URLSearchParams(window.location.search);
                if (params.get('movie')) {
                    criteriaHtml += `<span class="bg-vieshow-gold/20 text-gray-800 font-bold p-2 rounded-lg">é›»å½±: ${movieName}</span>`;
                }
            } else {
                if (new URLSearchParams(window.location.search).get('movie')) {
                     criteriaHtml += `<span class="bg-vieshow-gold/20 text-gray-800 font-bold p-2 rounded-lg">æŒ‡å®šé›»å½±</span>`;
                }
            }
            
            if (criteriaHtml === '') {
                criteriaHtml = '<p class="text-gray-700">é¡¯ç¤ºæ‰€æœ‰å ´æ¬¡ã€‚</p>';
            }

            // çµæœæ•¸é‡
            criteriaHtml += `<span class="bg-gray-500/10 text-gray-600 font-bold p-2 rounded-lg">å…±æ‰¾åˆ° ${showtimes.length} ç­†å ´æ¬¡</span>`;
            
            criteriaDiv.innerHTML = criteriaHtml;
        }

        /**
         * æ¸²æŸ“å ´æ¬¡åˆ—è¡¨
         * (ç‚ºäº†æ–¹ä¾¿é¡¯ç¤ºï¼Œæˆ‘å€‘å°‡å ´æ¬¡ä¾ç…§ã€Œé›»å½±ã€å’Œã€Œå½±åŸã€åˆ†çµ„ï¼Œ
         * ä½†å› ç‚ºå¾Œç«¯å›å‚³çš„æ˜¯å¹³é¢é™£åˆ—ï¼Œé€™è£¡æˆ‘å€‘å…ˆåšç°¡å–®çš„éæ­·é¡¯ç¤ºï¼Œ
         * æˆ–è€…å°‡åŒä¸€é›»å½±åŒä¸€å½±åŸçš„å ´æ¬¡åˆä½µé¡¯ç¤º)
         */
        function renderShowtimes(showtimes) {
            const container = document.getElementById('showtimes-list');
            
            if (showtimes.length === 0) {
                 container.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <p class="text-2xl text-gray-700 font-semibold mb-2">ğŸ˜¢ æŠ±æ­‰ï¼Œæ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å ´æ¬¡ã€‚</p>
                        <p class="text-gray-500">è«‹å˜—è©¦æ›´æ”¹æ‚¨çš„ç¯©é¸æ¢ä»¶æˆ–é¸æ“‡å…¶ä»–æ—¥æœŸã€‚</p>
                    </div>
                 `;
                 return;
            }

            // ç‚ºäº†ç¾è§€ï¼Œæˆ‘å€‘å°‡å ´æ¬¡è³‡æ–™ä¾ç…§ [é›»å½± + å½±åŸ + ç‰ˆæœ¬ + æ—¥æœŸ] é€²è¡Œåˆ†çµ„
            // é€™æ¨£åŒä¸€éƒ¨é›»å½±çš„å¤šå€‹æ™‚é–“é»å¯ä»¥é¡¯ç¤ºåœ¨ä¸€èµ·
            const grouped = {};
            
            showtimes.forEach(s => {
                // å»ºç«‹åˆ†çµ„ Key
                const key = `${s.movieId}-${s.cinemaId}-${s.date}-${s.format}-${s.theater}`;
                
                if (!grouped[key]) {
                    grouped[key] = {
                        ...s,
                        times: [] // ç”¨ä¾†å­˜å¤šå€‹æ™‚é–“ (é€™è£¡å­˜ç‰©ä»¶ {time: '...', id: '...'}) ä»¥ä¾¿å€åˆ†ä¸åŒå ´æ¬¡ID
                    };
                }
                grouped[key].times.push({ time: s.time, id: s.id });
            });

            // å°‡åˆ†çµ„å¾Œçš„ç‰©ä»¶è½‰å›é™£åˆ—
            const groupedShowtimes = Object.values(grouped);

            const html = groupedShowtimes.map(group => {
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-2 border-vieshow-red/50">
                        <div class="md:flex md:justify-between md:items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-extrabold text-gray-900 hover:text-vieshow-red transition duration-300">
                                    <a href="pages/movie/movie_info.html?movie_id=${group.movieId}">${group.movieName}</a>
                                </h2>
                                <p class="text-sm text-gray-500 mt-1">
                                    å½±åŸï¼š<span class="font-semibold text-gray-700">${group.cinemaName}</span> | 
                                    æ—¥æœŸï¼š<span class="font-semibold text-gray-700">${group.date}</span> | 
                                    ç‰‡é•·: ${group.duration || 120} åˆ†é˜
                                </p>
                                <p class="text-sm text-gray-500 mt-1">
                                    ç‰ˆæœ¬ï¼š<span class="font-semibold text-vieshow-red">${group.format}</span> | 
                                    å»³åˆ¥ï¼š<span class="font-semibold text-vieshow-red">${group.theater}</span>
                                </p>
                            </div>
                        </div>

                        <div class="mt-4 border-t pt-4 border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">å ´æ¬¡æ™‚é–“ï¼š</h3>
                            <div class="flex flex-wrap gap-3">
                                ${group.times.map(t => `
                                    <button onclick="selectShowtime('${t.id}', '${group.movieName}', '${t.time}', '${group.cinemaId}', '${group.date}', '${group.theater}', '${group.format}', '${group.movieId}')" 
                                            class="showtime-button">
                                        ${t.time}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        /**
         * é¸å®šå ´æ¬¡ä¸¦è·³è½‰ (è·³é booking_flow_1)
         */
        function selectShowtime(showingId, movieName, time, cinemaId, date, theater, format, movieId) {
            
            // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            if (!localStorage.getItem('auth_token')) {
                alert('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œè¨‚ç¥¨', () => {
                    const currentUrl = encodeURIComponent(window.location.href);
                    window.location.href = `${LOGIN_PAGE_URL}?redirect=${currentUrl}`;
                });
                return;
            }

            const cinemaName = locationNameMap[cinemaId] || 'æŒ‡å®šå½±åŸ';
            
            // å»ºæ§‹ç¬¦åˆ booking_flow_2.html é æœŸçš„è³‡æ–™çµæ§‹
            // æ³¨æ„ï¼šbooking_flow_2.html é æœŸçš„æ˜¯ currentBooking ç‰©ä»¶
            const bookingData = {
                cinema: {
                    id: cinemaId,
                    name: cinemaName
                },
                movie: {
                    id: movieId,
                    title: movieName
                },
                showtime: {
                    id: showingId, // é€™æ˜¯å¾Œç«¯è³‡æ–™åº«çš„ showingID
                    date: date,
                    time: time,
                    theater: theater,
                    type: format
                },
                // é è¨­å€¼
                ticketType: 'general', 
                tickets: {},
                combos: {},
                totalPrice: 0,
                totalTicketQty: 0
            };
            
            // å„²å­˜è‡³ localStorage
            localStorage.setItem('currentBooking', JSON.stringify(bookingData));
            
            console.log('å·²é¸æ“‡å ´æ¬¡ï¼Œè·³è½‰è‡³ Step 2:', bookingData);
            
            // è·³è½‰åˆ°é¸ä½é é¢ (Booking Flow 2)
            window.location.href = '../booking/booking_flow_2.html';
        }
        
        // è‡ªå®šç¾© Alert
        function alert(message, callback) {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') {
                    callback(); 
                }
            };
            
            window.customAlertConfirm = handleConfirm;

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" 
                                    class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // è¦†å¯«åŸç”Ÿ alert
        window.alert = alert;

    </script>
</body>
</html>



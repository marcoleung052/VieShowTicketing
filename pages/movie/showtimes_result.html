<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ´æ¬¡æŸ¥è©¢çµæœ - å¨ç§€å½±åŸ</title>
    <script src="../../js/chatbot.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }

        .showtime-button {
            padding: 0.5rem 1rem;
            background-color: #ffffff;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 200ms ease-in-out;
        }
        .showtime-button:hover {
            background-color: #e50914;
            color: #fff;
            border-color: #e50914;
            box-shadow: 0 4px 12px rgba(229, 9, 20, 0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4"></div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        
        <div class="bg-white p-8 rounded-xl shadow-xl mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 border-l-4 border-vieshow-gold pl-4">
                ğŸ¥ å¿«æœçµæœ
            </h1>
            <div id="search-criteria" class="text-lg text-gray-600 mb-6 flex flex-wrap gap-4 mt-4 items-center">
                </div>
            <a href="../../index.html" class="text-vieshow-red hover:text-red-700 font-semibold transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                è¿”å›é‡æ–°æŸ¥è©¢
            </a>
        </div>

        <div id="showtimes-list" class="space-y-8">
            <p class="text-center text-gray-500 py-10">æ­£åœ¨æœå°‹å ´æ¬¡...</p>
        </div>

    </main>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const LOGIN_PAGE_URL = '../../pages/auth/login.html';
        const MEMBER_HOME_URL = '../../pages/member/member_home.html';

        // åœ°é»åç¨±å°æ‡‰è¡¨ (ID -> ä¸­æ–‡åï¼Œåƒ…ä½œå¾Œå‚™ç”¨)
        const locationMap = {
            '01': 'å°åŒ—ä¿¡ç¾©å¨ç§€å½±åŸ', '02': 'å°åŒ—äº¬ç«™å¨ç§€å½±åŸ', '03': 'æ¿æ©‹å¤§é ç™¾å¨ç§€å½±åŸ',
            '04': 'æ–°ç«¹å·¨åŸå¨ç§€å½±åŸ', '05': 'å°ä¸­å¤§é ç™¾å¨ç§€å½±åŸ', '06': 'å°ä¸­TIGER CITYå¨ç§€å½±åŸ',
            '07': 'å°å—å—ç´¡å¨ç§€å½±åŸ', '08': 'é«˜é›„å¤§é ç™¾å¨ç§€å½±åŸ'
        };

        // --- UI ç‹€æ…‹ ---
        function renderUI() {
            const token = localStorage.getItem('auth_token');
            const headerNavRight = document.getElementById('headerNavRight');
            if (token) {
                headerNavRight.innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold ml-4">æœƒå“¡ä¸­å¿ƒ</a>`;
                document.getElementById('signOutLink')?.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    localStorage.removeItem('auth_token'); 
                    // â˜…â˜…â˜… åœ¨ç™»å‡ºæ™‚å‘¼å« Chatbot çš„é‡ç½®å‡½å¼ â˜…â˜…â˜…
                    if (window.resetChatSession) window.resetChatSession(); 
                    alert('å·²ç™»å‡º', () => window.location.href = INDEX_PAGE_URL);
                });            
            } else {
                const url = encodeURIComponent(window.location.href);
                headerNavRight.innerHTML = `<a href="${LOGIN_PAGE_URL}?redirect=${url}" class="hover:text-vieshow-gold">ç™»å…¥</a>`;
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---

        async function initPage() {
            renderUI();
            
            const params = new URLSearchParams(window.location.search);
            const locationId = params.get('location');
            const movieId = params.get('movie');
            const date = params.get('date');

            // 1. å…ˆæ¸²æŸ“åŸºæœ¬çš„æœå°‹æ¢ä»¶
            renderSearchCriteria(locationId, null, date); 

            // 2. è¼‰å…¥è³‡æ–™
            await loadShowtimes(locationId, movieId, date);
        }

        async function loadShowtimes(locationId, movieId, date) {
            const container = document.getElementById('showtimes-list');
            container.innerHTML = '<div class="text-center py-10"><div class="animate-spin h-8 w-8 border-4 border-vieshow-red border-t-transparent rounded-full mx-auto mb-2"></div><p class="text-gray-500">æ­£åœ¨æœå°‹å ´æ¬¡...</p></div>';

            try {
                const queryParams = new URLSearchParams();
                if (locationId) queryParams.append('location', locationId);
                if (movieId) queryParams.append('movie', movieId);
                if (date) queryParams.append('date', date); 

                const res = await fetch(`${API_BASE_URL}/movie/showtimes?${queryParams.toString()}`);
                if (!res.ok) throw new Error("API Error");
                
                const showtimes = await res.json();
                
                // --- æ™ºæ…§æ›´æ–°æ¨™é¡Œ ---
                let movieName = null;
                if (showtimes.length > 0 && movieId) {
                    movieName = showtimes[0].movieName;
                } else if (movieId) {
                    try {
                        const mRes = await fetch(`${API_BASE_URL}/movie/${movieId}`);
                        if (mRes.ok) {
                            const mData = await mRes.json();
                            movieName = mData.name;
                        }
                    } catch(e) {}
                }

                renderSearchCriteria(locationId, movieName, date);
                
                const filteredShowtimes = date ? showtimes.filter(s => s.date === date.replace(/-/g, '/')) : showtimes;
                renderShowtimesList(filteredShowtimes);

            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-center text-red-500 py-10">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
            }
        }

        function renderSearchCriteria(locId, movieName, dateStr) {
            const criteriaDiv = document.getElementById('search-criteria');
            let html = '';
            
            if (locId) {
                const name = locationMap[locId] || `å½±åŸ(${locId})`;
                html += `<span class="bg-gray-100 text-gray-700 font-bold px-3 py-1 rounded-full text-sm border border-gray-200">ğŸ“ ${name}</span>`;
            }
            if (movieName) {
                html += `<span class="bg-red-50 text-vieshow-red font-bold px-3 py-1 rounded-full text-sm border border-red-100">ğŸ¬ ${movieName}</span>`;
            }
            if (dateStr) {
                html += `<span class="bg-yellow-50 text-yellow-700 font-bold px-3 py-1 rounded-full text-sm border border-yellow-200">ğŸ“… ${dateStr}</span>`;
            }
            if (!html) html = '<span class="text-gray-500">é¡¯ç¤ºæ‰€æœ‰å ´æ¬¡</span>';
            criteriaDiv.innerHTML = html;
        }

        function renderShowtimesList(showtimes) {
            const container = document.getElementById('showtimes-list');
            
            // 1. å–å¾—ç¾åœ¨æ™‚é–“ (ç‚ºäº†ç²¾ç¢ºæ¯”å°)
            const now = new Date();

            // åˆ†çµ„é‚è¼¯
            const grouped = {};
            showtimes.forEach(s => {
                // æ™‚é–“éæ¿¾
                const showtimeDateStr = s.date.replace(/\//g, '-') + 'T' + s.time + ':00'; 
                const showtimeDate = new Date(showtimeDateStr);
                
                if (showtimeDate < now) { return; }

                const key = `${s.movieId}-${s.cinemaId}-${s.date}-${s.format}-${s.theater}`;
                if (!grouped[key]) {
                    grouped[key] = { ...s, times: [] };
                }
                grouped[key].times.push({ time: s.time, id: s.id });
            });

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-xl text-gray-600 mb-2 font-bold">ğŸ˜¢ æŸ¥ç„¡å ´æ¬¡</p>
                        <p class="text-sm text-gray-500">å¯èƒ½ä»Šæ—¥å ´æ¬¡å·²æ’­æ˜ å®Œç•¢ï¼Œè«‹å˜—è©¦é¸æ“‡å…¶ä»–æ—¥æœŸã€‚</p>
                    </div>`;
                return;
            }

            const html = Object.values(grouped).map(group => `
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-vieshow-red hover:shadow-lg transition duration-300">
                    <div class="flex flex-col md:flex-row justify-between mb-4 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="text-2xl font-extrabold text-gray-900 mb-2">
                                <a href="../movie/movie_info.html?movie_id=${group.movieId}" class="hover:text-vieshow-red transition">${group.movieName}</a>
                            </h3>
                            <div class="text-gray-600 text-sm space-y-1">
                                <p class="flex items-center"><span class="bg-gray-200 text-xs px-2 py-0.5 rounded mr-2 text-gray-700 font-bold">å½±åŸ</span> ${group.cinemaName}</p>
                                <p class="flex items-center"><span class="bg-gray-200 text-xs px-2 py-0.5 rounded mr-2 text-gray-700 font-bold">å»³åˆ¥</span> ${group.theater}</p>
                                <p class="flex items-center"><span class="bg-vieshow-red/10 text-vieshow-red text-xs px-2 py-0.5 rounded mr-2 font-bold">ç‰ˆæœ¬</span> ${group.format}</p>
                            </div>
                        </div>
                        <div class="mt-4 md:mt-0 text-right">
                            <span class="inline-block text-lg font-bold text-gray-800 bg-yellow-100 px-4 py-2 rounded-lg border border-yellow-200">
                                ğŸ“… ${group.date}
                            </span>
                        </div>
                    </div>
                    
                    <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase tracking-wider">é¸æ“‡å ´æ¬¡æ™‚é–“</h4>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                        ${group.times.map(t => `
                            <button onclick="goToBooking('${t.id}', '${group.movieName}', '${t.time}', '${group.cinemaId}', '${group.date}', '${group.theater}', '${group.format}', '${group.movieId}', '${group.cinemaName}')" 
                                    class="showtime-button py-2 rounded-lg font-bold text-lg hover:bg-vieshow-red hover:text-white hover:border-vieshow-red transition shadow-sm border border-gray-300 text-gray-700">
                                ${t.time}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // ã€ä¿®æ­£ã€‘å¢åŠ  passedCinemaName åƒæ•¸
        function goToBooking(showingId, movieName, time, cinemaId, date, theater, format, movieId, passedCinemaName) {
            
            // å„ªå…ˆä½¿ç”¨å¾Œç«¯å›å‚³çš„åç¨±ï¼Œå¦‚æœæ²’æœ‰å‰‡æŸ¥è¡¨ï¼Œå†æ²’æœ‰å‰‡é¡¯ç¤ºé è¨­
            const cinemaName = passedCinemaName || locationMap[cinemaId] || 'æŒ‡å®šå½±åŸ';

            const bookingData = {
                cinema: { id: cinemaId, name: cinemaName }, 
                movie: { id: movieId, title: movieName },
                showtime: { id: showingId, date, time, theater, type: format },
                ticketType: 'general', tickets: {}, combos: {}, totalPrice: 0, totalTicketQty: 0
            };
            
            localStorage.setItem('currentBooking', JSON.stringify(bookingData));
            sessionStorage.removeItem('returnFromStep2Data');

            if (!localStorage.getItem('auth_token')) {
                return alert('è«‹å…ˆç™»å…¥', () => {
                    const targetUrl = '../booking/booking_flow_2.html';
                    const redirectUrl = encodeURIComponent(targetUrl);
                    window.location.href = `${LOGIN_PAGE_URL}?redirect=${redirectUrl}`;
                });
            }
            
            window.location.href = '../../pages/booking/booking_flow_2.html';
        }

        function customAlert(message, callback) { 
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();
            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') { callback(); }
            };
            window.customAlertConfirm = handleConfirm;
            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">ç¢ºèª</button>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        window.alert = customAlert;

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>






<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ´æ¬¡æŸ¥è©¢çµæœ - å¨ç§€å½±åŸ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // ç¢ºä¿ Tailwind é…ç½®èˆ‡ index.html ä¸€è‡´
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // å¨ç§€ä¸»é¡Œè‰²ï¼šç´…è‰²å’Œé‡‘è‰²
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        /* ä½¿ç”¨ Inter å’Œ Noto Sans TC ç¢ºä¿ä¸­è‹±æ–‡å­—é«”é¡¯ç¤ºæ­£å¸¸ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }

        /* å ´æ¬¡æ™‚é–“æŒ‰éˆ•æ¨£å¼ (å¾ Tailwind å¯«æ³•è½‰æ›) */
        .showtime-button {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            background-color: #ffffff;
            color: #1f2937; /* gray-800 */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 9999px; /* rounded-full */
            font-weight: 600; /* font-semibold */
            transition: transform 200ms ease-in-out, box-shadow 200ms ease-in-out, background-color 200ms ease-in-out;
        }
        .showtime-button:hover {
            background-color: #e50914; /* vieshow-red */
            color: #fff;
            border-color: #e50914;
            box-shadow: 0 8px 18px rgba(0,0,0,0.12);
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
                </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        
        <div class="bg-white p-8 rounded-xl shadow-xl mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 border-l-4 border-vieshow-gold pl-4">
                ğŸ¥ å¿«æœçµæœ
            </h1>
            <div id="search-criteria" class="text-lg text-gray-600 mb-6 flex flex-wrap gap-4 mt-4">
                </div>
            <a href="../../index.html" class="text-vieshow-red hover:text-red-700 font-semibold transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                è¿”å›é‡æ–°æŸ¥è©¢
            </a>
        </div>

        <div id="showtimes-list" class="space-y-8">
            </div>

    </main>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        // åœ°é»ä»£ç¢¼å°æ‡‰åç¨±
        const locationMap = {
            'taipei': 'å°åŒ—ä¿¡ç¾©',
            'taichung': 'å°ä¸­å¤§é ç™¾',
            'kaohsiung': 'é«˜é›„å¤§é ç™¾'
        };
        
        // æ¨¡æ“¬é›»å½±å ´æ¬¡è³‡æ–™ (ç¾åœ¨åŒ…å«åœ°é»å’Œæ—¥æœŸï¼Œä»¥ä¾¿ç¯©é¸)
        const mockShowtimes = [
            // å°åŒ—ä¿¡ç¾© - 2025-11-30
            { loc: 'taipei', date: '2025-11-30', id: 'G001', name: "æ˜Ÿéš›ç‰¹æ”»éšŠï¼šç„¡é™æˆ°çˆ­",theater: 'Aå»³', format: "IMAX 2D", rating: "ä¿è­·ç´š", times: ["10:00", "13:30", "17:00", "20:30"], duration: 150 },
            { loc: 'taipei', date: '2025-11-30', id: 'D002', name: "å¤¢æƒ³å•Ÿå‹•ï¼šäººå·¥æ™ºæ…§æ™‚ä»£",theater: 'Bå»³', format: "æ•¸ä½ 2D", rating: "æ™®éç´š", times: ["11:00", "14:45", "18:30"], duration: 120 },
            
            // å°åŒ—ä¿¡ç¾© - 2025-12-01
            { loc: 'taipei', date: '2025-12-01', id: 'H003', name: "æ¥µé€Ÿç‹‚é£†ï¼šåˆå¤œå°æ±º",theater: 'Cå»³', format: "æ•¸ä½ 4DX", rating: "é™åˆ¶ç´š", times: ["12:15", "15:45", "19:15", "22:45"], duration: 135 },
            { loc: 'taipei', date: '2025-12-01', id: 'C004', name: "è²“å’ªåµæ¢èˆ‡å¤±è¹¤çš„é‘½çŸ³",theater: 'Då»³', format: "æ•¸ä½ 3D", rating: "æ™®éç´š", times: ["09:30", "13:00", "16:30"], duration: 95 },
            // å°ä¸­å¤§é ç™¾ - 2025-11-30
            { loc: 'taichung', date: '2025-11-30', id: 'G001', name: "æ˜Ÿéš›ç‰¹æ”»éšŠï¼šç„¡é™æˆ°çˆ­",theater: 'Eå»³', format: "IMAX 2D", rating: "ä¿è­·ç´š", times: ["09:45", "12:15", "15:30", "19:00"], duration: 150 },
            { loc: 'taichung', date: '2025-11-30', id: 'F005', name: "å¤±è½çš„å¤æ–‡æ˜",theater: 'Få»³', format: "æ•¸ä½ 2D", rating: "ä¿è­·ç´š", times: ["10:45", "14:15", "17:45"], duration: 140 },
            
            // é«˜é›„å¤§é ç™¾ - 2025-11-30
            { loc: 'kaohsiung', date: '2025-11-30', id: 'J006', name: "å»šç¥çˆ­éœ¸æˆ°",theater: 'Gå»³', format: "æ•¸ä½ 2D", rating: "æ™®éç´š", times: ["10:30", "13:00", "16:45"], duration: 110 },
        ];

        
        // å°è¦½åˆ—ç›¸é—œå¸¸æ•¸
        const INDEX_PAGE_URL = '../../index.html';
        const LOGIN_PAGE_URL = '../../pages/auth/login.html';
        const MEMBER_HOME_URL = '../../pages/member/member_home.html';

        /**
         * æ¸²æŸ“æœªç™»å…¥ç‹€æ…‹çš„å°è¦½åˆ—ã€‚
         */
        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;
            
            // ç²å–ç•¶å‰é é¢çš„å®Œæ•´ URLï¼Œä¸¦é€²è¡Œ URL ç·¨ç¢¼
            const currentUrl = encodeURIComponent(window.location.href);

            // æ§‹é€ å¸¶æœ‰å›èª¿ç¶²å€çš„ç™»å…¥é€£çµ
            const loginRedirectUrl = `${LOGIN_PAGE_URL}?redirect=${currentUrl}`;
            
            // æ¸²æŸ“å°è¦½åˆ—ï¼šç™»å…¥ + æœƒå“¡ä¸­å¿ƒ
            headerNavRight.innerHTML = `
                <a href="${loginRedirectUrl}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
        }

        /**
         * æ¸²æŸ“å·²ç™»å…¥ç‹€æ…‹çš„å°è¦½åˆ—ã€‚
         */
        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            if (!headerNavRight) return;

            // æ¸²æŸ“å°è¦½åˆ—ï¼šç™»å‡º + æœƒå“¡ä¸­å¿ƒ
            headerNavRight.innerHTML = `
                <a href="#" id="signOutLink" class="hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;
            
            // ç¶å®šç™»å‡ºäº‹ä»¶
            document.getElementById('signOutLink')?.addEventListener('click', handleSignOut);
        }

        /**
         * è™•ç†ç™»å‡ºé‚è¼¯ã€‚
         */
        function handleSignOut(e) {
            e.preventDefault();

            // 1. æ¸…é™¤ç™»å…¥ç‹€æ…‹çš„é—œéµæ­¥é©Ÿ
            localStorage.removeItem('auth_token');

            // 2. é¡¯ç¤ºç™»å‡ºè¨Šæ¯ (ä½¿ç”¨è‡ªå®šç¾© alert)
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡é‡æ–°æ•´ç†é é¢...', () => {
                // 3. å»¶é²å°å‘ç•¶å‰é é¢
                setTimeout(() => {
                    // é‡æ–°è¼‰å…¥ç•¶å‰é é¢ï¼Œè®“ UI å›åˆ°æœªç™»å…¥ç‹€æ…‹
                    window.location.href = window.location.href; 
                }, 2000);
            });
            
            // 4. é‡æ–°æ¸²æŸ“å°è¦½åˆ—è‡³æœªç™»å…¥ç‹€æ…‹ (å¿…é ˆåœ¨è·³è½‰å‰åŸ·è¡Œ)
            renderUI();
        }

        /**
         * æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦æ¸²æŸ“ UI
         */
        function renderUI() {
            // æ¨¡æ“¬ï¼šå¦‚æœ localStorage ä¸­æœ‰ 'auth_token' å‰‡è¦–ç‚ºå·²ç™»å…¥
            const token = localStorage.getItem('auth_token');
            if (token) {
                renderLoggedInState(); 
            } else {
                renderLoggedOutState();
            }
        }
        // å°è¦½åˆ—é‚è¼¯çµæŸ


        document.addEventListener('DOMContentLoaded', () => {
            // å„ªå…ˆæ¸²æŸ“å°è¦½åˆ—
            renderUI();

            const params = new URLSearchParams(window.location.search);
            const locationCode = params.get('location');
            const date = params.get('date');
            const movieId = params.get('movie'); // ç²å–é›»å½± ID

            // æ ¹æ“šåƒæ•¸ç¯©é¸å ´æ¬¡
            const filteredShowtimes = mockShowtimes.filter(showtime => {
                let match = true;
                
                // 1. ç¯©é¸å½±åŸ (å¦‚æœ locationCode éç©º)
                if (locationCode && locationCode !== '') {
                    match = match && (showtime.loc === locationCode);
                }
                
                // 2. ç¯©é¸æ—¥æœŸ (å¦‚æœ date éç©º)
                if (date && date !== '') {
                    match = match && (showtime.date === date);
                }
                
                // 3. ç¯©é¸é›»å½± (å¦‚æœ movieId éç©º)
                if (movieId && movieId !== '') {
                    match = match && (showtime.id === movieId);
                }

                return match;
            });

            // æ¸²æŸ“æŸ¥è©¢æ¢ä»¶
            renderCriteria(locationCode, date, movieId, filteredShowtimes.length);

            // æ¸²æŸ“ç¯©é¸å¾Œçš„å ´æ¬¡
            renderShowtimes(filteredShowtimes);
        });

        /**
         * æ¸²æŸ“æŸ¥è©¢æ¢ä»¶å’Œçµæœæ•¸é‡
         */
        function renderCriteria(locationCode, date, movieId, count) {
            const criteriaDiv = document.getElementById('search-criteria');
            let criteriaHtml = '';

            if (locationCode) {
                const locationName = locationMap[locationCode] || 'æœªçŸ¥å½±åŸ';
                criteriaHtml += `<span class="bg-vieshow-red/10 text-vieshow-red font-bold p-2 rounded-lg">å½±åŸ: ${locationName}</span>`;
            }
            if (date) {
                criteriaHtml += `<span class="bg-gray-200 text-gray-800 font-bold p-2 rounded-lg">æ—¥æœŸ: ${date}</span>`;
            }
            if (movieId) {
                // é€™è£¡éœ€è¦ä¸€å€‹è¼”åŠ©å‡½æ•¸ä¾†ç²å–é›»å½±åç¨±
                const movieName = mockShowtimes.find(m => m.id === movieId)?.name || 'æœªçŸ¥é›»å½±';
                criteriaHtml += `<span class="bg-vieshow-gold/20 text-gray-800 font-bold p-2 rounded-lg">é›»å½±: ${movieName}</span>`;
            }
            
            if (criteriaHtml === '') {
                criteriaHtml = '<p class="text-gray-700">æœªé¸æ“‡ä»»ä½•ç¯©é¸æ¢ä»¶ï¼Œé¡¯ç¤ºæ‰€æœ‰å ´æ¬¡ã€‚</p>';
            }

            // é¡¯ç¤ºçµæœæ•¸é‡
            criteriaHtml += `<span class="bg-gray-500/10 text-gray-600 font-bold p-2 rounded-lg">å…±æ‰¾åˆ° ${count} ç­†ç¬¦åˆçš„å ´æ¬¡</span>`;
            
            criteriaDiv.innerHTML = criteriaHtml;
        }


        /**
         * æ¸²æŸ“é›»å½±å ´æ¬¡åˆ—è¡¨
         * @param {Array<object>} showtimes - ç¯©é¸å¾Œçš„å ´æ¬¡è³‡æ–™é™£åˆ—
         */
        function renderShowtimes(showtimes) {
            const container = document.getElementById('showtimes-list');
            if (!container) return;

            if (showtimes.length === 0) {
                 container.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                        <p class="text-2xl text-gray-700 font-semibold mb-2">ğŸ˜¢ æŠ±æ­‰ï¼Œæ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å ´æ¬¡ã€‚</p>
                        <p class="text-gray-500">è«‹å˜—è©¦æ›´æ”¹æ‚¨çš„ç¯©é¸æ¢ä»¶ã€‚</p>
                    </div>
                 `;
                 return;
            }

            const html = showtimes.map(movie => {
                const locationName = locationMap[movie.loc] || 'æœªçŸ¥å½±åŸ';
                
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-2 border-vieshow-red/50">
                        <div class="md:flex md:justify-between md:items-start mb-4">
                            <div>
                                <h2 class="text-2xl font-extrabold text-gray-900 hover:text-vieshow-red transition duration-300">
                                    <a href="../movie/movie_info.html?movie_id=${movie.id}">${movie.name}</a>
                                </h2>
                                <p class="text-sm text-gray-500 mt-1">
                                    å½±åŸï¼š<span class="font-semibold text-gray-700">${locationName}</span> |
                                    æ—¥æœŸï¼š<span class="font-semibold text-gray-700">${movie.date}</span> |
                                    ç‰‡é•·: ${movie.duration} åˆ†é˜
                                </p>
                                <p class="text-sm text-gray-500 mt-1">
                                    ç‰ˆæœ¬ï¼š<span class="font-semibold text-vieshow-red">${movie.format}</span> |
                                    å»³åˆ¥ï¼š<span class="font-semibold text-vieshow-red">${movie.theater}</span> |
                                    åˆ†ç´šï¼š<span class="font-semibold text-vieshow-red">${movie.rating}</span>
                                </p>
                            </div>
                        </div>

                        <div class="mt-4 border-t pt-4 border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-700 mb-3">å ´æ¬¡æ™‚é–“ï¼š</h3>
                            <div class="flex flex-wrap gap-3">
                                ${movie.times.map(time => `
                                    <button onclick="selectShowtime('${movie.id}', '${movie.name}', '${time}', '${movie.loc}', '${movie.date}', '${movie.theater}', '${movie.format}')" 
                                            class="showtime-button">
                                        ${time}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        /**
         * é¸å®šå ´æ¬¡ä¸¦è·³è½‰åˆ°é¸ç¥¨èˆ‡é¤é»é é¢ (è·³é booking_flow_1.html)
         *
         * @param {string} movieId
         * @param {string} movieName
         * @param {string} time - è©²å ´æ¬¡çš„æ™‚é–“ (e.g., '13:30')
         * @param {string} locationCode - å½±åŸä»£ç¢¼ (e.g., 'taipei')
         * @param {string} date - è©²å ´æ¬¡çš„æ—¥æœŸ (e.g., '2025-11-30')
         * @param {string} theater - å»³åˆ¥ (e.g., 'Aå»³')
         * @param {string} format - ç‰ˆæœ¬æ ¼å¼ (e.g., 'IMAX 2D')
         */
        function selectShowtime(movieId, movieName, time, locationCode, date, theater , format) {
            
            // ç”±æ–¼è·³é Step 1ï¼Œæˆ‘å€‘éœ€è¦æ§‹é€  Step 1 æ‰€éœ€çš„æ‰€æœ‰è³‡æ–™
            const locationName = locationMap[locationCode] || 'æœªçŸ¥å½±åŸ';
            
            // æ¨¡æ“¬ showtime ID
            const showtimeId = `${locationCode}-${movieId}-${date}-${time.replace(':', '')}`;
            
            const bookingData = {
                // å„²å­˜ ID
                cinemaId: locationCode, // ä½¿ç”¨ locationCode ä½œç‚º cinemaId
                movieId: movieId,
                showtimeId: showtimeId,

                // å„²å­˜é¡¯ç¤ºåç¨±
                cinemaName: locationName,
                movieTitle: movieName,
                
                // *** é—œéµä¿®æ”¹ï¼šç¢ºä¿ showtimeDetail åŒ…å«æ—¥æœŸã€æ™‚é–“ã€å»³åˆ¥å’Œæ ¼å¼ï¼Œä»¥ä¾› Step 2 é¡¯ç¤ºæ‘˜è¦ ***
                showtimeDetail: `${date} ${time} ${theater} (${format})`, 
                
                theater: theater,
                format: format,
            };
            
            // å„²å­˜ä½¿ç”¨è€…é¸æ“‡çš„è³‡è¨Šï¼Œä»¥ä¾¿åœ¨æ­¥é©Ÿ 2/7 ä¸­ä½¿ç”¨
            // ğŸš¨ é€™æ˜¯è·³è½‰çš„é—œéµæ­¥é©Ÿ
            localStorage.setItem('currentBooking', JSON.stringify(bookingData));
            
            console.log('å¿«æœå·²å„²å­˜è¨‚ç¥¨è³‡æ–™ä¸¦è·³è½‰:', bookingData);
            
            // å°èˆªåˆ° booking_flow_2.html (è·¯å¾‘ä¿®æ­£ç‚º ../booking/booking_flow_2.html)
            window.location.href = '../booking/booking_flow_2.html';
        }
        
        /**
         * æ¨¡æ“¬ alert() å‡½æ•¸ï¼Œç¾åœ¨æ¥å—ä¸€å€‹å¯é¸çš„å›å‘¼å‡½æ•¸ (callback)ã€‚
         * ç•¶ç”¨æˆ¶é»æ“Šã€Œç¢ºèªã€æ™‚ï¼ŒæœƒåŸ·è¡Œé€™å€‹å›å‘¼å‡½æ•¸ã€‚
         */
        function alert(message, callback) {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            // è™•ç†é»æ“Šã€Œç¢ºèªã€çš„é‚è¼¯
            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') {
                    // åªæœ‰åœ¨ç”¨æˆ¶é»æ“Šç¢ºèªå¾Œï¼Œæ‰åŸ·è¡Œå‚³å…¥çš„ callback å‡½æ•¸ (ä¾‹å¦‚ç™»å‡ºå¾Œçš„è·³è½‰)
                    callback(); 
                }
            };
            
            // å°‡ handleConfirm å‡½æ•¸è¨»å†Šåˆ°å…¨åŸŸï¼Œä»¥ä¾¿åœ¨ HTML onclick ä¸­ä½¿ç”¨
            window.customAlertConfirm = handleConfirm;

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" 
                                    class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // å°‡è‡ªå®šç¾© alert è³¦å€¼çµ¦ window.alertï¼Œè¦†å¯«åŸç”Ÿ alertã€‚
        window.alert = alert;
    </script>
</body>
</html>
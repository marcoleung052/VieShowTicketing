<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ´æ¬¡æŸ¥è©¢çµæœ - å¨ç§€å½±åŸ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }

        .showtime-button {
            padding: 0.5rem 1rem;
            background-color: #ffffff;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            font-weight: 600;
            transition: transform 200ms ease-in-out, box-shadow 200ms ease-in-out, background-color 200ms ease-in-out;
        }
        .showtime-button:hover {
            background-color: #e50914;
            color: #fff;
            border-color: #e50914;
            box-shadow: 0 8px 18px rgba(0,0,0,0.12);
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="../../index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
                </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">
        
        <div class="bg-white p-8 rounded-xl shadow-xl mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 border-l-4 border-vieshow-gold pl-4">
                ğŸ¥ å¿«æœçµæœ
            </h1>
            <div id="search-criteria" class="text-lg text-gray-600 mb-6 flex flex-wrap gap-4 mt-4">
                </div>
            <a href="../../index.html" class="text-vieshow-red hover:text-red-700 font-semibold transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                è¿”å›é‡æ–°æŸ¥è©¢
            </a>
        </div>

        <div id="showtimes-list" class="space-y-8">
            <p class="text-center text-gray-500 py-10">æ­£åœ¨æœå°‹å ´æ¬¡...</p>
        </div>

    </main>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const INDEX_PAGE_URL = '../../index.html';
        const LOGIN_PAGE_URL = '../auth/login.html';
        const MEMBER_HOME_URL = '../member/member_home.html';

        // ... (ä¿ç•™ UI ç‹€æ…‹æ§åˆ¶ renderUI, checkLoginStatus ç­‰å‡½å¼) ...
        function renderLoggedOutState() { document.getElementById('headerNavRight').innerHTML = `<a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold">ç™»å…¥</a>`; }
        function renderLoggedInState() { document.getElementById('headerNavRight').innerHTML = `<a href="#" id="signOutLink" class="hover:text-vieshow-gold">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold ml-4">æœƒå“¡ä¸­å¿ƒ</a>`; document.getElementById('signOutLink').addEventListener('click', (e) => { e.preventDefault(); localStorage.removeItem('auth_token'); window.location.reload(); }); }
        function renderUI() { localStorage.getItem('auth_token') ? renderLoggedInState() : renderLoggedOutState(); }
        function customAlert(msg, cb) { const d=document.createElement('div'); d.innerHTML=`<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white p-6 rounded shadow"><p class="mb-4 font-bold text-gray-800">${msg}</p><button class="bg-red-600 text-white px-4 py-2 rounded" onclick="this.closest('.fixed').remove();if(${cb})${cb}()">OK</button></div></div>`; document.body.appendChild(d.firstChild); }
        window.alert = customAlert;

        // --- æ ¸å¿ƒé‚è¼¯ ---

        async function initPage() {
            renderUI();
            
            // 1. è®€å– URL åƒæ•¸
            const params = new URLSearchParams(window.location.search);
            const locationId = params.get('location');
            const movieId = params.get('movie');
            const date = params.get('date'); // ã€ä¿®æ­£ã€‘è®€å–æ—¥æœŸåƒæ•¸

            // é¡¯ç¤ºæœå°‹æ¢ä»¶ (UI)
            renderSearchCriteria(locationId, movieId, date);

            // 2. å‘¼å« API è¼‰å…¥è³‡æ–™
            await loadShowtimes(locationId, movieId, date);
        }

        async function loadShowtimes(locationId, movieId, date) {
            const container = document.getElementById('showtimes-list');
            container.innerHTML = '<p class="text-center text-gray-500 py-10">æ­£åœ¨è¼‰å…¥å ´æ¬¡...</p>';

            try {
                // å»ºæ§‹ API æŸ¥è©¢åƒæ•¸
                const queryParams = new URLSearchParams();
                if (locationId) queryParams.append('location', locationId);
                if (movieId) queryParams.append('movie', movieId);
                
                // ã€ä¿®æ­£ã€‘å¦‚æœä½¿ç”¨è€…æœ‰é¸æ—¥æœŸï¼Œå‚³çµ¦å¾Œç«¯é€²è¡Œéæ¿¾
                // æ³¨æ„ï¼šå¾Œç«¯ API å¿…é ˆæ”¯æ´ date åƒæ•¸ï¼Œå¦å‰‡å¾Œç«¯æœƒå›å‚³æ‰€æœ‰æ—¥æœŸ
                // å¦‚æœå¾Œç«¯é‚„æ²’æ”¯æ´ï¼Œå‰ç«¯éœ€è¦è‡ªå·± filterï¼Œä½†æœ€å¥½æ˜¯å¾Œç«¯åš
                if (date) queryParams.append('date', date); 

                const res = await fetch(`${API_BASE_URL}/movie/showtimes?${queryParams.toString()}`);
                if (!res.ok) throw new Error("API Error");
                
                const showtimes = await res.json();
                
                // å¦‚æœå‰ç«¯éœ€è¦å†æ¬¡éæ¿¾æ—¥æœŸ (é˜²å‘†ï¼Œç¢ºä¿åªé¡¯ç¤ºé¸å®šæ—¥æœŸçš„)
                const filteredShowtimes = date ? showtimes.filter(s => s.date === date.replace(/-/g, '/')) : showtimes;
                // æ³¨æ„ï¼šå‰ç«¯æ—¥æœŸæ ¼å¼é€šå¸¸æ˜¯ YYYY-MM-DDï¼Œå¾Œç«¯å›å‚³å¯èƒ½æ˜¯ YYYY/MM/DDï¼Œéœ€è½‰æ›æ¯”å°
                
                renderShowtimesList(filteredShowtimes);

            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-center text-red-500 py-10">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
            }
        }

        function renderSearchCriteria(locId, movId, dateStr) {
            const criteriaDiv = document.getElementById('search-criteria');
            let html = '';
            
            // é€™è£¡å¯ä»¥å‘¼å« API å–å¾—åç¨±ï¼Œæˆ–è€…ç°¡å–®é¡¯ç¤º
            if (locId) html += `<span class="bg-gray-200 px-3 py-1 rounded-full text-sm">å½±åŸ ID: ${locId}</span>`;
            if (movId) html += `<span class="bg-gray-200 px-3 py-1 rounded-full text-sm">é›»å½± ID: ${movId}</span>`;
            if (dateStr) html += `<span class="bg-vieshow-red text-white px-3 py-1 rounded-full text-sm">ğŸ“… æ—¥æœŸ: ${dateStr}</span>`;
            
            if (!html) html = '<span class="text-gray-500">é¡¯ç¤ºæ‰€æœ‰å ´æ¬¡</span>';
            criteriaDiv.innerHTML = html;
        }

        function renderShowtimesList(showtimes) {
            const container = document.getElementById('showtimes-list');
            
            if (showtimes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 bg-gray-50 rounded-lg">
                        <p class="text-xl text-gray-600 mb-2">æŸ¥ç„¡å ´æ¬¡ ğŸ˜¢</p>
                        <p class="text-sm text-gray-400">è«‹å˜—è©¦æ›´æ”¹æœå°‹æ¢ä»¶</p>
                    </div>`;
                return;
            }

            // åˆ†çµ„é‚è¼¯ (åŒ Booking Flow 1)
            const grouped = {};
            showtimes.forEach(s => {
                const key = `${s.movieId}-${s.cinemaId}-${s.date}-${s.format}-${s.theater}`;
                if (!grouped[key]) {
                    grouped[key] = { ...s, times: [] };
                }
                grouped[key].times.push({ time: s.time, id: s.id });
            });

            const html = Object.values(grouped).map(group => `
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-vieshow-gold hover:shadow-lg transition">
                    <div class="flex flex-col md:flex-row justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${group.movieName}</h3>
                            <p class="text-gray-600 text-sm flex items-center">
                                <span class="bg-gray-100 px-2 py-0.5 rounded mr-2 text-gray-500">${group.cinemaName}</span>
                                <span class="bg-gray-100 px-2 py-0.5 rounded mr-2 text-gray-500">${group.theater}</span>
                                <span class="text-vieshow-red font-bold">${group.format}</span>
                            </p>
                        </div>
                        <div class="mt-2 md:mt-0 text-right">
                            <span class="text-lg font-bold text-gray-800 bg-yellow-100 px-3 py-1 rounded-lg">
                                ${group.date}
                            </span>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                        ${group.times.map(t => `
                            <button onclick="goToBooking('${t.id}', '${group.movieName}', '${t.time}', '${group.cinemaId}', '${group.date}', '${group.theater}', '${group.format}', '${group.movieId}')" 
                                    class="border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-vieshow-red hover:text-white hover:border-vieshow-red transition font-medium text-center">
                                ${t.time}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // è·³è½‰è¨‚ç¥¨ (èˆ‡ booking_flow_1 å…±ç”¨é‚è¼¯)
        function goToBooking(showingId, movieName, time, cinemaId, date, theater, format, movieId) {
             if (!localStorage.getItem('auth_token')) {
                return alert('è«‹å…ˆç™»å…¥', () => {
                    window.location.href = `${LOGIN_PAGE_URL}?redirect=${encodeURIComponent(window.location.href)}`;
                });
            }

            const bookingData = {
                cinema: { id: cinemaId, name: 'é¸å®šå½±åŸ' }, // é€™è£¡å¯èƒ½éœ€è¦è£œå…¨åç¨±
                movie: { id: movieId, title: movieName },
                showtime: { id: showingId, date, time, theater, type: format },
                ticketType: 'general', tickets: {}, combos: {}, totalPrice: 0, totalTicketQty: 0
            };
            
            localStorage.setItem('currentBooking', JSON.stringify(bookingData));
            window.location.href = '../booking/booking_flow_2.html';
        }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>




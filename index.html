<script>
        // 1. è¨­å®šå¾Œç«¯ API ç¶²å€ (è«‹ç¢ºèªé€™æ˜¯æ‚¨çš„æ­£ç¢ºç¶²å€)
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';

        const LOGIN_PAGE_URL = './pages/auth/login.html';
        const MEMBER_HOME_URL = './pages/member/member_home.html';
        const REGISTER_PAGE_URL = './pages/auth/register.html';

        /**
         * æ¸²æŸ“æœªç™»å…¥ç‹€æ…‹
         */
        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            const heroSection = document.getElementById('heroSection');

            headerNavRight.innerHTML = `
                <a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;

            heroSection.innerHTML = `
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">
                    ğŸ¬ Vieshow ç·šä¸Šè¨‚ç¥¨ç³»çµ±
                </h1>
                <p class="text-lg text-gray-600 mb-6">æ­¡è¿ï¼æœ€æ–°çš„ç†±é–€é›»å½±æ­£åœ¨ç†±æ˜ ä¸­ï¼Œç«‹å³è¨‚ç¥¨äº«å„ªæƒ ã€‚</p>
                
                <a href="${REGISTER_PAGE_URL}" 
                    class="inline-flex items-center justify-center bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-xl transform hover:scale-105 hover:shadow-vieshow-red/50">
                    <span class="mr-2">ğŸ‘¤</span> è¨»å†Š
                </a>
            `;
        }

        /**
         * æ¸²æŸ“å·²ç™»å…¥ç‹€æ…‹
         */
        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            const heroSection = document.getElementById('heroSection');
            
            headerNavRight.innerHTML = `
                <a href="javascript:void(0)" id="signOutLink" class="text-white hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
                <a href="${MEMBER_HOME_URL}" class="text-white hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;

            heroSection.innerHTML = `
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">
                    ğŸ¬ Vieshow ç·šä¸Šè¨‚ç¥¨ç³»çµ±
                </h1>
                <p class="text-lg text-gray-600 mb-6">æ‚¨å·²ç™»å…¥ï¼æœ€æ–°çš„ç†±é–€é›»å½±æ­£åœ¨ç†±æ˜ ä¸­ï¼Œç«‹å³è¨‚ç¥¨äº«å„ªæƒ ã€‚</p>
            `;
            
            const signOutLinkElement = document.getElementById('signOutLink');
            if (signOutLinkElement) {
                signOutLinkElement.addEventListener('click', handleSignOut);
            }
        }

        /**
         * ç™»å‡ºé‚è¼¯
         */
        function handleSignOut(e) {
            e.preventDefault();
            localStorage.removeItem('auth_token');
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡é‡æ–°æ•´ç†é é¢...', () => {
                window.location.reload(); // é‡æ–°æ•´ç†é é¢
            }); 
        }

        /**
         * æª¢æŸ¥ UI ç‹€æ…‹
         */
        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                renderLoggedInState();
            } else {
                renderLoggedOutState();
            }
        }
        
        /**
         * å¡«å……ä¸‹æ‹‰é¸å–®
         */
        function populateMovieSelect(movies) {
            const select = document.getElementById('movie-select');
            if (!select) return;

            // æ¸…ç©ºèˆŠé¸é … (ä¿ç•™ç¬¬ä¸€å€‹é è¨­é¸é …)
            select.innerHTML = '<option value="">è«‹é¸æ“‡é›»å½± (é¸å¡«)</option>';

            const options = movies.map(movie => 
                `<option value="${movie.id}">${movie.name}</option>`
            ).join('');
            
            select.innerHTML += options;
        }

        /**
         * æ¸²æŸ“é›»å½±åˆ—è¡¨
         */
        function renderMovieList(movies, containerId, showRatingAndBooking) {
            const container = document.getElementById('nowPlayingContainer'); // é è¨­å®¹å™¨ï¼Œå¦‚æœ ID å‚³å…¥å‰‡ä½¿ç”¨å‚³å…¥çš„
            const targetContainer = document.getElementById(containerId) || container;
            if (!targetContainer) return;

            // å¦‚æœæ²’æœ‰é›»å½±è³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
            if (!movies || movies.length === 0) {
                targetContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">ç›®å‰æ²’æœ‰ç›¸é—œé›»å½±è³‡æ–™ã€‚</p>';
                return;
            }

            const html = movies.map(movie => {
                // è™•ç†æµ·å ±è·¯å¾‘ï¼šè‹¥å¾Œç«¯å›å‚³ç©ºå­—ä¸²ï¼Œå‰‡ä½¿ç”¨é è¨­åœ–
                const posterSrc = movie.posterUrl ? movie.posterUrl : 'https://placehold.co/400x600/9ca3af/ffffff?text=No+Poster';

                const ratingHtml = showRatingAndBooking ? `
                    <span class="flex items-center font-semibold text-vieshow-gold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.045a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.045a1 1 0 00-1.175 0l-2.817 2.045c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.02 8.729c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        ${movie.rating ? movie.rating.toFixed(1) : '0.0'}
                    </span>
                ` : `<span class="text-sm font-semibold text-gray-500">å°šç„¡è©•åˆ†</span>`;

                const bookingHtml = showRatingAndBooking ? `
                    <div class="mt-3">
                        <button onclick="event.preventDefault(); window.location.href='pages/booking/booking_flow_1.html?movie_id=${movie.id}'" 
                                class="w-full bg-vieshow-red text-white font-bold py-2 rounded-lg hover:bg-red-700 transition duration-300 text-sm">
                            ç«‹å³è¨‚ç¥¨
                        </button>
                    </div>
                ` : ``;

                // è™•ç†ä¸Šæ˜ æ—¥æœŸé¡¯ç¤º (åªå–æ—¥æœŸéƒ¨åˆ†)
                const displayDate = movie.releaseDate ? movie.releaseDate.split(' ')[0] : 'è¿‘æ—¥ä¸Šæ˜ ';

                return `
                    <div class="movie-poster-card block rounded-lg shadow-lg hover:shadow-2xl">
                        <a href="pages/movie/movie_info.html?movie_id=${movie.id}">
                            <div class="poster-container rounded-t-lg">
                                <img src="${posterSrc}" 
                                            alt="${movie.name} æµ·å ±" 
                                            onerror="this.onerror=null; this.src='https://placehold.co/400x600/9ca3af/ffffff?text=No+Poster';"
                                            class="rounded-t-lg">
                            </div>
                            
                            <div class="p-3">
                                <h3 class="text-lg font-bold text-gray-900 truncate mb-1" title="${movie.name}">
                                    ${movie.name}
                                </h3>
                                
                                <div class="flex justify-between items-center text-sm text-gray-500">
                                    ${ratingHtml}
                                    <span class="text-xs ${showRatingAndBooking ? '' : 'ml-auto font-bold text-gray-800'}">
                                        ${displayDate} ä¸Šæ˜ 
                                    </span>
                                </div>
                            </div>
                        </a>
                        ${bookingHtml}
                    </div>
                `;
            }).join('');

            targetContainer.innerHTML = html;
        }

        /**
         * è¼‰å…¥ä¸¦æ¸²æŸ“å½±åŸè³‡è¨Š
         */
        async function loadCinemas() {
            const container = document.getElementById('cinemaInfo');
            if (!container) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/info/cinemas`);
                const cinemas = await response.json();

                if (cinemas.length === 0) {
                    container.innerHTML = '<p class="text-center col-span-3 text-gray-500">æš«ç„¡å½±åŸè³‡è¨Š</p>';
                    return;
                }

                container.innerHTML = cinemas.map(cinema => `
                    <div class="content-card">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">${cinema.name}</h4>
                        <p class="text-gray-600 mb-2">
                            åœ°å€ï¼š${cinema.address}
                        </p>
                        <p class="text-gray-600 font-semibold">
                            å°ˆç·šï¼š<span class="text-vieshow-red">${cinema.phone}</span>
                        </p>
                    </div>
                `).join('');

            } catch (error) {
                console.error("è¼‰å…¥å½±åŸå¤±æ•—:", error);
                container.innerHTML = '<p class="text-center col-span-3 text-red-500">è¼‰å…¥å½±åŸè³‡è¨Šå¤±æ•—</p>';
            }
        }

        /**
         * è¼‰å…¥ä¸¦æ¸²æŸ“é¤é»è³‡è¨Š
         */
        async function loadMeals() {
            const container = document.getElementById('foodInfo');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE_URL}/info/meals`);
                const meals = await response.json();

                if (meals.length === 0) {
                    container.innerHTML = '<p class="text-center col-span-3 text-gray-500">æš«ç„¡é¤é»è³‡è¨Š</p>';
                    return;
                }

                container.innerHTML = meals.map(meal => `
                    <div class="food-card">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xl font-extrabold text-vieshow-red truncate pr-2" title="${meal.name}">${meal.name}</h4>
                            <span class="text-2xl font-extrabold text-gray-800 shrink-0">TWD ${meal.price}</span>
                        </div>
                        <p class="text-gray-700 text-sm ml-1 line-clamp-2" title="${meal.info}">
                            ${meal.info}
                        </p>
                    </div>
                `).join('');

            } catch (error) {
                console.error("è¼‰å…¥é¤é»å¤±æ•—:", error);
                container.innerHTML = '<p class="text-center col-span-3 text-red-500">è¼‰å…¥é¤é»è³‡è¨Šå¤±æ•—</p>';
            }
        }

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ async/await å‘¼å«å¾Œç«¯ API ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. æ¸²æŸ“åŸºæœ¬ UI
            renderUI();
            
            // 2. é¡¯ç¤ºè¼‰å…¥ä¸­ç‹€æ…‹
            document.getElementById('nowPlayingContainer').innerHTML = '<p class="col-span-full text-center py-10">è¼‰å…¥ä¸­...</p>';
            document.getElementById('comingSoonContainer').innerHTML = '<p class="col-span-full text-center py-10">è¼‰å…¥ä¸­...</p>';

            try {
                // 3. å¾å¾Œç«¯ç²å–ã€Œç†±æ˜ ä¸­ã€é›»å½±
                const resNow = await fetch(`${API_BASE_URL}/movie/now-playing`);
                if (!resNow.ok) throw new Error('ç„¡æ³•è¼‰å…¥ç†±æ˜ é›»å½±');
                const nowPlayingMovies = await resNow.json();
                
                // æ¸²æŸ“ç†±æ˜ é›»å½±
                renderMovieList(nowPlayingMovies, 'nowPlayingContainer', true);
                
                // å¡«å……æœå°‹ä¸‹æ‹‰é¸å–®
                populateMovieSelect(nowPlayingMovies);

                // 4. å¾å¾Œç«¯ç²å–ã€Œå³å°‡ä¸Šæ˜ ã€é›»å½±
                const resSoon = await fetch(`${API_BASE_URL}/movie/coming-soon`);
                if (!resSoon.ok) throw new Error('ç„¡æ³•è¼‰å…¥å³å°‡ä¸Šæ˜ é›»å½±');
                const comingSoonMovies = await resSoon.json();
                
                // æ¸²æŸ“å³å°‡ä¸Šæ˜ é›»å½±
                renderMovieList(comingSoonMovies, 'comingSoonContainer', false);

            } catch (error) {
                console.error("API è¼‰å…¥å¤±æ•—:", error);
                document.getElementById('nowPlayingContainer').innerHTML = '<p class="col-span-full text-center text-red-500">ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
                document.getElementById('comingSoonContainer').innerHTML = '';
            }

            // 5. è¼‰å…¥å½±åŸèˆ‡é¤é»
            loadCinemas();
            loadMeals();
        });

        // è‡ªå®šç¾© Alert
        function alert(message, callback) {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') {
                    callback(); 
                }
            };
            
            window.customAlertConfirm = handleConfirm;

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" 
                                    class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
    </script>

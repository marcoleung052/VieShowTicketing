<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¨ç§€å½±åŸç·šä¸Šè¨‚ç¥¨ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        /* è¼‰å…¥ç•«é¢æ¨£å¼ */
        #globalLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e50914;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .fade-out {
            opacity: 0;
            visibility: hidden; /* ç¢ºä¿éš±è—å¾Œä¸æ“‹ä½é»æ“Š */
        }

        /* æ¨£å¼ä¿æŒä¸è®Š */
        .movie-poster-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
            overflow: hidden;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.08);
            border: 1px solid #f3f4f6;
        }
        .movie-poster-card:hover {
            transform: translateY(-5px);
        }
        .poster-container {
            aspect-ratio: 2 / 3; 
            overflow: hidden;
        }
        .poster-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        .movie-poster-card:hover img {
            transform: scale(1.05);
        }
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            background-clip: padding-box;
        }
        @media (min-width: 640px) {
            .search-input.sm-auto { width: auto; }
        }
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(229,9,20,0.06);
            border-color: #e50914;
        }
        .content-card {
            transition: transform 0.2s;
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.06);
            border-top: 4px solid rgba(247,168,61,0.15);
        }
        .content-card:hover {
            transform: translateY(-3px);
            border-top-color: #e50914;
            box-shadow: 0 16px 32px rgba(0,0,0,0.08);
        }
        .food-card {
            background-color: #ffffff;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.06);
            border-bottom: 4px solid #e50914;
            transition: box-shadow 0.3s, transform 0.15s;
        }
        .food-card:hover { box-shadow: 0 10px 24px rgba(0,0,0,0.08); }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col overflow-hidden">

    <div id="globalLoader">
        <div class="loader-spinner"></div>
        <p class="text-gray-600 font-bold text-lg animate-pulse" id="loadingText">æ­£åœ¨åˆå§‹åŒ–å½±åŸ...</p>
    </div>

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="./index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">

        <div id="heroSection" class="text-center mb-12 bg-white p-8 rounded-xl shadow-xl">
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-10 border-t-4 border-vieshow-gold">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">âœ¨ å¿«æœ</h3>
            <form id="showtime-search-form" action="pages/movie/showtimes_result.html" method="GET" 
                    class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                
                <select name="location" id="location-select" class="search-input bg-white">
                    <option value="">è«‹é¸æ“‡å½±åŸ (é¸å¡«)</option>
                </select>
                
                <input type="date" name="date" id="date-input" class="search-input" value="">
                
                <select name="movie" id="movie-select" class="search-input bg-white">
                    <option value="">è«‹é¸æ“‡é›»å½± (é¸å¡«)</option>
                </select>

                <button type="submit" 
                        class="w-full md:w-auto bg-gray-800 hover:bg-vieshow-red text-white font-semibold py-3 px-6 rounded-xl transition duration-300 shadow-md">
                    æŸ¥è©¢å ´æ¬¡
                </button>
            </form>
        </div>
        
        <div class="mb-12">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-red pl-4">
                ğŸ”¥ ç†±å”®ä¸­
            </h3>
            <div id="nowPlayingContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                </div>
        </div>

        <div class="mb-12">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-gold pl-4">
                ğŸ“… å³å°‡ä¸Šæ˜ 
            </h3>
            <div id="comingSoonContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                </div>
        </div>
        
        <div class="mb-12">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-gold pl-4">
                ğŸ“ å½±åŸè³‡è¨Š
            </h3>
            <div id="cinemaInfo" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                </div>
        </div>

        <div class="mb-8">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-red pl-4">
                ğŸ¿ é¤é»è³‡è¨Š
            </h3>
            <div id="foodInfo" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';
        const LOGIN_PAGE_URL = './pages/auth/login.html';
        const MEMBER_HOME_URL = './pages/member/member_home.html';
        const REGISTER_PAGE_URL = './pages/auth/register.html';

        // ------------------------
        // UI ç‹€æ…‹æ§åˆ¶
        // ------------------------
        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            const heroSection = document.getElementById('heroSection');
            headerNavRight.innerHTML = `<a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a> <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
            heroSection.innerHTML = `
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">ğŸ¬ Vieshow ç·šä¸Šè¨‚ç¥¨ç³»çµ±</h1>
                <p class="text-lg text-gray-600 mb-6">æ­¡è¿ï¼æœ€æ–°çš„ç†±é–€é›»å½±æ­£åœ¨ç†±æ˜ ä¸­ï¼Œç«‹å³è¨‚ç¥¨äº«å„ªæƒ ã€‚</p>
                <a href="${REGISTER_PAGE_URL}" class="inline-flex items-center justify-center bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-xl transform hover:scale-105 hover:shadow-vieshow-red/50"><span class="mr-2">ğŸ‘¤</span> è¨»å†Š</a>`;
        }

        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            const heroSection = document.getElementById('heroSection');
            headerNavRight.innerHTML = `<a href="javascript:void(0)" id="signOutLink" class="text-white hover:text-vieshow-gold transition duration-300">ç™»å‡º</a> <a href="${MEMBER_HOME_URL}" class="text-white hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>`;
            heroSection.innerHTML = `
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">ğŸ¬ Vieshow ç·šä¸Šè¨‚ç¥¨ç³»çµ±</h1>
                <p class="text-lg text-gray-600 mb-6">æ‚¨å·²ç™»å…¥ï¼æœ€æ–°çš„ç†±é–€é›»å½±æ­£åœ¨ç†±æ˜ ä¸­ï¼Œç«‹å³è¨‚ç¥¨äº«å„ªæƒ ã€‚</p>`;
            document.getElementById('signOutLink').addEventListener('click', (e) => {
                e.preventDefault(); localStorage.removeItem('auth_token'); window.location.reload();
            });
        }

        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) renderLoggedInState(); else renderLoggedOutState();
        }

        // ------------------------
        // æ ¸å¿ƒè¼‰å…¥é‚è¼¯ (å„ªåŒ–ç‰ˆ)
        // ------------------------
        
        async function fetchAndCacheMovieDetails(movies) {
            console.log("ğŸš€ èƒŒæ™¯é–‹å§‹é è¼‰é›»å½±è©³æƒ…...");
            // ä½¿ç”¨ Promise.allSettled é¿å…ä¸€å€‹å¤±æ•—å¡ä½å…¨éƒ¨ï¼Œä¸”ä¸ä½¿ç”¨ await é˜»æ“‹ä¸»ç·šç¨‹ (åœ¨ loadAllData å¤–éƒ¨å‘¼å«)
            const promises = movies.map(async (movie) => {
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰å¿«å–ï¼Œé¿å…é‡è¤‡è«‹æ±‚
                if (sessionStorage.getItem(`movie_cache_${movie.id}`)) return;
                
                try {
                    const res = await fetch(`${API_BASE_URL}/movie/${movie.id}`);
                    if (res.ok) {
                        const detail = await res.json();
                        sessionStorage.setItem(`movie_cache_${movie.id}`, JSON.stringify(detail));
                    }
                } catch (e) {
                    console.warn(`é è¼‰é›»å½± ${movie.id} å¤±æ•—`);
                }
            });
            
            await Promise.allSettled(promises);
            console.log("âœ… èƒŒæ™¯é è¼‰å®Œæˆï¼");
        }

        async function loadAllData() {
            const loadingText = document.getElementById('loadingText');
            
            try {
                // 1. å–å¾—ã€Œå¿…è¦ã€çš„åˆ—è¡¨è³‡æ–™
                loadingText.textContent = "æ­£åœ¨è¼‰å…¥å½±åŸèˆ‡é›»å½±åˆ—è¡¨...";
                
                const pCinemas = fetch(`${API_BASE_URL}/info/cinemas`).then(res => res.json());
                const pMeals = fetch(`${API_BASE_URL}/info/meals`).then(res => res.json());
                const pNow = fetch(`${API_BASE_URL}/movie/now-playing`).then(res => res.json());
                const pSoon = fetch(`${API_BASE_URL}/movie/coming-soon`).then(res => res.json());

                // ç­‰å¾…é€™ 4 å€‹ API å›ä¾† (é€šå¸¸å¾ˆå¿«ï¼Œå› ç‚ºè³‡æ–™é‡å°)
                const [cinemas, meals, nowPlaying, comingSoon] = await Promise.all([pCinemas, pMeals, pNow, pSoon]);

                // 2. æ¸²æŸ“é é¢
                renderCinemas(cinemas);
                renderMeals(meals);
                renderMovieList(nowPlaying, 'nowPlayingContainer', true);
                renderMovieList(comingSoon, 'comingSoonContainer', false);
                populateMovieSelect(nowPlaying);
                populateCinemaSelect(cinemas);

                // 3. ã€é—œéµä¿®æ”¹ã€‘ç«‹åˆ»éš±è—è¼‰å…¥ç•«é¢ï¼ä¸ç­‰å¾…è©³ç´°è³‡æ–™ï¼
                hideLoader();

                // 4. ã€èƒŒæ™¯åŸ·è¡Œã€‘å·å·å»æŠ“è©³ç´°è³‡æ–™
                const allMovies = [...nowPlaying, ...comingSoon];
                // æ³¨æ„ï¼šé€™è£¡ä¸åŠ  awaitï¼Œè®“å®ƒåœ¨èƒŒæ™¯è·‘
                fetchAndCacheMovieDetails(allMovies);

            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±æ•—:", error);
                // å°±ç®—å¤±æ•—ä¹Ÿè¦æŠŠè¼‰å…¥ç•«é¢é—œæ‰ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                hideLoader();
                alert("é€£ç·šä¼ºæœå™¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
            }
        }

        function hideLoader() {
            const loader = document.getElementById('globalLoader');
            loader.classList.add('fade-out');
            document.body.classList.remove('overflow-hidden'); 
            setTimeout(() => loader.remove(), 500);
        }

        // --- æ¸²æŸ“è¼”åŠ©å‡½å¼ ---
        function renderMovieList(movies, containerId, showRatingAndBooking) {
            const container = document.getElementById(containerId);
            if (!movies || movies.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500">ç„¡è³‡æ–™</p>'; return;
            }
            container.innerHTML = movies.map(movie => {
                const poster = movie.posterUrl || 'https://placehold.co/400x600/9ca3af/ffffff?text=No+Poster';
                const ratingHtml = showRatingAndBooking ? 
                    `<span class="flex items-center font-semibold text-vieshow-gold">â˜… ${movie.rating ? movie.rating.toFixed(1) : '0.0'}</span>` : 
                    `<span class="text-sm font-semibold text-gray-500">å°šç„¡è©•åˆ†</span>`;
                const bookingHtml = showRatingAndBooking ? 
                    `<div class="mt-3"><button onclick="event.preventDefault(); window.location.href='pages/booking/booking_flow_1.html?movie_id=${movie.id}'" class="w-full bg-vieshow-red text-white font-bold py-2 rounded-lg hover:bg-red-700 text-sm">ç«‹å³è¨‚ç¥¨</button></div>` : ``;

                return `
                    <div class="movie-poster-card block rounded-lg shadow-lg hover:shadow-2xl">
                        <a href="pages/movie/movie_info.html?movie_id=${movie.id}">
                            <div class="poster-container rounded-t-lg"><img src="${poster}" class="rounded-t-lg"></div>
                            <div class="p-3">
                                <h3 class="text-lg font-bold text-gray-900 truncate mb-1">${movie.name}</h3>
                                <div class="flex justify-between items-center text-sm text-gray-500">${ratingHtml} <span class="text-xs">${movie.releaseDate.split(' ')[0]}</span></div>
                            </div>
                        </a>
                        ${bookingHtml}
                    </div>`;
            }).join('');
        }

        function renderCinemas(cinemas) {
            const container = document.getElementById('cinemaInfo');
            if (cinemas.length === 0) { container.innerHTML = '<p class="text-center col-span-3 text-gray-500">ç„¡å½±åŸè³‡æ–™</p>'; return; }
            container.innerHTML = cinemas.map(c => `
                <div class="content-card">
                    <h4 class="text-xl font-bold text-gray-800 mb-2">${c.name}</h4>
                    <p class="text-gray-600 mb-2">åœ°å€ï¼š${c.address}</p>
                    <p class="text-gray-600 font-semibold">å°ˆç·šï¼š<span class="text-vieshow-red">${c.phone}</span></p>
                </div>`).join('');
        }

        function renderMeals(meals) {
            const container = document.getElementById('foodInfo');
            if (meals.length === 0) { container.innerHTML = '<p class="text-center col-span-3 text-gray-500">ç„¡é¤é»è³‡æ–™</p>'; return; }
            container.innerHTML = meals.map(m => `
                <div class="food-card">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-xl font-extrabold text-vieshow-red truncate pr-2">${m.name}</h4>
                        <span class="text-2xl font-extrabold text-gray-800 shrink-0">TWD ${m.price}</span>
                    </div>
                    <p class="text-gray-700 text-sm ml-1 line-clamp-2">${m.info}</p>
                </div>`).join('');
        }

        function populateMovieSelect(movies) {
            const select = document.getElementById('movie-select');
            select.innerHTML = '<option value="">è«‹é¸æ“‡é›»å½± (é¸å¡«)</option>' + movies.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        function populateCinemaSelect(cinemas) {
            const select = document.getElementById('location-select');
            select.innerHTML = '<option value="">è«‹é¸æ“‡å½±åŸ (é¸å¡«)</option>' + cinemas.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
            const dateInput = document.getElementById('date-input');
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            dateInput.value = today;

            loadAllData();
        });

        // è‡ªå®šç¾© Alert
        function alert(message, callback) {
            const existing = document.getElementById('custom-alert'); if(existing) existing.remove();
            const html = `<div id="custom-alert" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm"><p class="text-gray-700 font-bold mb-4">${message}</p><div class="flex justify-end"><button id="alertOK" class="bg-vieshow-red text-white py-2 px-4 rounded font-bold">ç¢ºèª</button></div></div></div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            document.getElementById('alertOK').onclick = () => { document.getElementById('custom-alert').remove(); if(callback) callback(); };
        }
    </script>
</body>
</html>

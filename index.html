<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¨ç§€å½±åŸç·šä¸Šè¨‚ç¥¨ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        // Tailwind é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'vieshow-red': '#e50914',
                        'vieshow-gold': '#f7a83d',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        .movie-poster-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
            overflow: hidden;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.08);
            border: 1px solid #f3f4f6;
        }
        .movie-poster-card:hover {
            transform: translateY(-5px);
        }
        .poster-container {
            aspect-ratio: 2 / 3; 
            overflow: hidden;
        }
        .poster-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        .movie-poster-card:hover img {
            transform: scale(1.05);
        }
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            background-clip: padding-box;
        }
        @media (min-width: 640px) {
            .search-input.sm-auto { width: auto; }
        }
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(229,9,20,0.06);
            border-color: #e50914;
        }
        .content-card {
            transition: transform 0.2s;
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.06);
            border-top: 4px solid rgba(247,168,61,0.15);
        }
        .content-card:hover {
            transform: translateY(-3px);
            border-top-color: #e50914;
            box-shadow: 0 16px 32px rgba(0,0,0,0.08);
        }
        .food-card {
            background-color: #ffffff;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 6px 12px rgba(0,0,0,0.06);
            border-bottom: 4px solid #e50914;
            transition: box-shadow 0.3s, transform 0.15s;
        }
        .food-card:hover { box-shadow: 0 10px 24px rgba(0,0,0,0.08); }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="./index.html" class="text-xl font-bold hover:text-vieshow-red transition duration-300">Vieshow å½±åŸ</a>
            <div id="headerNavRight" class="space-x-4">
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 flex-grow">

        <div id="heroSection" class="text-center mb-12 bg-white p-8 rounded-xl shadow-xl">
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-10 border-t-4 border-vieshow-gold">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">âœ¨ å¿«æœ</h3>
            <form id="showtime-search-form" action="pages/movie/showtimes_result.html" method="GET" 
                    class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                
                <select name="location" id="location-select" class="search-input bg-white">
                    <option value="">è«‹é¸æ“‡å½±åŸ (é¸å¡«)</option>
                    </select>
                
                <input type="date" name="date" class="search-input" value="">
                
                <select name="movie" id="movie-select" class="search-input bg-white">
                    <option value="">è«‹é¸æ“‡é›»å½± (é¸å¡«)</option>
                </select>

                <button type="submit" 
                        class="w-full md:w-auto bg-gray-800 hover:bg-vieshow-red text-white font-semibold py-3 px-6 rounded-xl transition duration-300 shadow-md">
                    æŸ¥è©¢å ´æ¬¡
                </button>
            </form>
        </div>
        
        <div class="mb-12">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-red pl-4">
                ğŸ”¥ ç†±å”®ä¸­
            </h3>
            <div id="nowPlayingContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <p class="col-span-full text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div class="mb-12">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-gold pl-4">
                ğŸ“… å³å°‡ä¸Šæ˜ 
            </h3>
            <div id="comingSoonContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <p class="col-span-full text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
        
        <div class="mb-12">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-gold pl-4">
                ğŸ“ å½±åŸè³‡è¨Š
            </h3>
            <div id="cinemaInfo" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <p class="col-span-full text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-3xl font-extrabold text-gray-900 mb-6 border-l-4 border-vieshow-red pl-4">
                ğŸ¿ é¤é»è³‡è¨Š
            </h3>
            <div id="foodInfo" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <p class="col-span-full text-center text-gray-500 py-8">è¼‰å…¥ä¸­...</p>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-white text-center py-4 mt-8 shadow-inner">
        <p>&copy; 2025 Vieshow Ticketing System</p>
    </footer>

    <script>
        const API_BASE_URL = 'https://marcoleung052-vieshow-backend.hf.space/api';

        const LOGIN_PAGE_URL = './pages/auth/login.html';
        const MEMBER_HOME_URL = './pages/member/member_home.html';
        const REGISTER_PAGE_URL = './pages/auth/register.html';

        // ------------------------
        // UI ç‹€æ…‹æ§åˆ¶
        // ------------------------
        function renderLoggedOutState() {
            const headerNavRight = document.getElementById('headerNavRight');
            const heroSection = document.getElementById('heroSection');

            headerNavRight.innerHTML = `
                <a href="${LOGIN_PAGE_URL}" class="hover:text-vieshow-gold transition duration-300">ç™»å…¥</a>
                <a href="${MEMBER_HOME_URL}" class="hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;

            heroSection.innerHTML = `
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">
                    ğŸ¬ Vieshow ç·šä¸Šè¨‚ç¥¨ç³»çµ±
                </h1>
                <p class="text-lg text-gray-600 mb-6">æ­¡è¿ï¼æœ€æ–°çš„ç†±é–€é›»å½±æ­£åœ¨ç†±æ˜ ä¸­ï¼Œç«‹å³è¨‚ç¥¨äº«å„ªæƒ ã€‚</p>
                <a href="${REGISTER_PAGE_URL}" 
                    class="inline-flex items-center justify-center bg-vieshow-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-xl transform hover:scale-105 hover:shadow-vieshow-red/50">
                    <span class="mr-2">ğŸ‘¤</span> è¨»å†Š
                </a>
            `;
        }

        function renderLoggedInState() {
            const headerNavRight = document.getElementById('headerNavRight');
            const heroSection = document.getElementById('heroSection');
            
            headerNavRight.innerHTML = `
                <a href="javascript:void(0)" id="signOutLink" class="text-white hover:text-vieshow-gold transition duration-300">ç™»å‡º</a>
                <a href="${MEMBER_HOME_URL}" class="text-white hover:text-vieshow-gold transition duration-300">æœƒå“¡ä¸­å¿ƒ</a>
            `;

            heroSection.innerHTML = `
                <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-2">
                    ğŸ¬ Vieshow ç·šä¸Šè¨‚ç¥¨ç³»çµ±
                </h1>
                <p class="text-lg text-gray-600 mb-6">æ‚¨å·²ç™»å…¥ï¼æœ€æ–°çš„ç†±é–€é›»å½±æ­£åœ¨ç†±æ˜ ä¸­ï¼Œç«‹å³è¨‚ç¥¨äº«å„ªæƒ ã€‚</p>
            `;
            
            const signOutLinkElement = document.getElementById('signOutLink');
            if (signOutLinkElement) {
                signOutLinkElement.addEventListener('click', handleSignOut);
            }
        }

        function handleSignOut(e) {
            e.preventDefault();
            localStorage.removeItem('auth_token');
            alert('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚å³å°‡é‡æ–°æ•´ç†é é¢...', () => {
                window.location.reload(); 
            }); 
        }

        function renderUI() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                renderLoggedInState();
            } else {
                renderLoggedOutState();
            }
        }
        
        // ------------------------
        // è³‡æ–™è¼‰å…¥é‚è¼¯
        // ------------------------

        // è¼‰å…¥é›»å½±é¸å–®
        function populateMovieSelect(movies) {
            const select = document.getElementById('movie-select');
            if (!select) return;

            select.innerHTML = '<option value="">è«‹é¸æ“‡é›»å½± (é¸å¡«)</option>';
            const options = movies.map(movie => 
                `<option value="${movie.id}">${movie.name}</option>`
            ).join('');
            select.innerHTML += options;
        }

        // ã€æ–°å¢ã€‘è¼‰å…¥å½±åŸé¸å–®
        async function loadCinemasForSelect() {
            const select = document.getElementById('location-select');
            if (!select) return;

            try {
                const response = await fetch(`${API_BASE_URL}/info/cinemas`);
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥å½±åŸè³‡æ–™');
                const cinemas = await response.json();

                select.innerHTML = '<option value="">è«‹é¸æ“‡å½±åŸ (é¸å¡«)</option>';
                const options = cinemas.map(cinema => 
                    `<option value="${cinema.id}">${cinema.name}</option>`
                ).join('');
                select.innerHTML += options;

            } catch (error) {
                console.error("è¼‰å…¥å½±åŸé¸å–®å¤±æ•—:", error);
                // å¤±æ•—æ™‚ä¿ç•™é è¨­é¸é …
            }
        }

        // æ¸²æŸ“é›»å½±åˆ—è¡¨
        function renderMovieList(movies, containerId, showRatingAndBooking) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!movies || movies.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500">ç›®å‰æ²’æœ‰ç›¸é—œé›»å½±è³‡æ–™ã€‚</p>';
                return;
            }

            const html = movies.map(movie => {
                const posterSrc = movie.posterUrl ? movie.posterUrl : 'https://placehold.co/400x600/9ca3af/ffffff?text=No+Poster';

                const ratingHtml = showRatingAndBooking ? `
                    <span class="flex items-center font-semibold text-vieshow-gold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.045a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.045a1 1 0 00-1.175 0l-2.817 2.045c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.02 8.729c-.783-.57-.381-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        ${movie.rating ? movie.rating.toFixed(1) : '0.0'}
                    </span>
                ` : `<span class="text-sm font-semibold text-gray-500">å°šç„¡è©•åˆ†</span>`;

                const bookingHtml = showRatingAndBooking ? `
                    <div class="mt-3">
                        <button onclick="event.preventDefault(); window.location.href='pages/booking/booking_flow_1.html?movie_id=${movie.id}'" 
                                class="w-full bg-vieshow-red text-white font-bold py-2 rounded-lg hover:bg-red-700 transition duration-300 text-sm">
                            ç«‹å³è¨‚ç¥¨
                        </button>
                    </div>
                ` : ``;

                const displayDate = movie.releaseDate ? movie.releaseDate.split(' ')[0] : 'è¿‘æ—¥ä¸Šæ˜ ';

                return `
                    <div class="movie-poster-card block rounded-lg shadow-lg hover:shadow-2xl">
                        <a href="pages/movie/movie_info.html?movie_id=${movie.id}">
                            <div class="poster-container rounded-t-lg">
                                <img src="${posterSrc}" alt="${movie.name} æµ·å ±" 
                                     onerror="this.onerror=null; this.src='https://placehold.co/400x600/9ca3af/ffffff?text=No+Poster';"
                                     class="rounded-t-lg">
                            </div>
                            <div class="p-3">
                                <h3 class="text-lg font-bold text-gray-900 truncate mb-1" title="${movie.name}">
                                    ${movie.name}
                                </h3>
                                <div class="flex justify-between items-center text-sm text-gray-500">
                                    ${ratingHtml}
                                    <span class="text-xs ${showRatingAndBooking ? '' : 'ml-auto font-bold text-gray-800'}">
                                        ${displayDate} ä¸Šæ˜ 
                                    </span>
                                </div>
                            </div>
                        </a>
                        ${bookingHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // è¼‰å…¥å½±åŸå€å¡Š (ä¸‹æ–¹åˆ—è¡¨)
        async function loadCinemas() {
            const container = document.getElementById('cinemaInfo');
            if (!container) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/info/cinemas`);
                if (!response.ok) throw new Error('API å›æ‡‰éŒ¯èª¤');
                const cinemas = await response.json();

                if (cinemas.length === 0) {
                    container.innerHTML = '<p class="text-center col-span-3 text-gray-500">æš«ç„¡å½±åŸè³‡è¨Š</p>';
                    return;
                }

                container.innerHTML = cinemas.map(cinema => `
                    <div class="content-card">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">${cinema.name}</h4>
                        <p class="text-gray-600 mb-2">
                            åœ°å€ï¼š${cinema.address}
                        </p>
                        <p class="text-gray-600 font-semibold">
                            å°ˆç·šï¼š<span class="text-vieshow-red">${cinema.phone}</span>
                        </p>
                    </div>
                `).join('');

            } catch (error) {
                console.error("è¼‰å…¥å½±åŸå¤±æ•—:", error);
                container.innerHTML = '<p class="text-center col-span-3 text-red-500">è¼‰å…¥å½±åŸè³‡è¨Šå¤±æ•—</p>';
            }
        }

        // è¼‰å…¥é¤é»
        async function loadMeals() {
            const container = document.getElementById('foodInfo');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE_URL}/info/meals`);
                if (!response.ok) throw new Error('API å›æ‡‰éŒ¯èª¤');
                const meals = await response.json();

                if (meals.length === 0) {
                    container.innerHTML = '<p class="text-center col-span-3 text-gray-500">æš«ç„¡é¤é»è³‡è¨Š</p>';
                    return;
                }

                container.innerHTML = meals.map(meal => `
                    <div class="food-card">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xl font-extrabold text-vieshow-red truncate pr-2" title="${meal.name}">${meal.name}</h4>
                            <span class="text-2xl font-extrabold text-gray-800 shrink-0">TWD ${meal.price}</span>
                        </div>
                        <p class="text-gray-700 text-sm ml-1 line-clamp-2" title="${meal.info}">
                            ${meal.info}
                        </p>
                    </div>
                `).join('');

            } catch (error) {
                console.error("è¼‰å…¥é¤é»å¤±æ•—:", error);
                container.innerHTML = '<p class="text-center col-span-3 text-red-500">è¼‰å…¥é¤é»è³‡è¨Šå¤±æ•—</p>';
            }
        }

        // --- ä¸»ç¨‹å¼é€²å…¥é» ---
        document.addEventListener('DOMContentLoaded', async () => {
            renderUI();

            // 1. è¼‰å…¥é›»å½±
            try {
                const resNow = await fetch(`${API_BASE_URL}/movie/now-playing`);
                if (!resNow.ok) throw new Error('ç„¡æ³•è¼‰å…¥ç†±æ˜ é›»å½±');
                const nowPlayingMovies = await resNow.json();
                renderMovieList(nowPlayingMovies, 'nowPlayingContainer', true);
                
                // å¡«å……é›»å½±ä¸‹æ‹‰é¸å–®
                populateMovieSelect(nowPlayingMovies);

                const resSoon = await fetch(`${API_BASE_URL}/movie/coming-soon`);
                if (!resSoon.ok) throw new Error('ç„¡æ³•è¼‰å…¥å³å°‡ä¸Šæ˜ é›»å½±');
                const comingSoonMovies = await resSoon.json();
                renderMovieList(comingSoonMovies, 'comingSoonContainer', false);
            } catch (e) {
                console.error("API è¼‰å…¥å¤±æ•—:", e);
                document.getElementById('nowPlayingContainer').innerHTML = '<p class="col-span-full text-center text-red-500">ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨</p>';
            }

            // 2. è¼‰å…¥å½±åŸ (ä¸‹æ–¹å€å¡Š)
            loadCinemas();
            
            // 3. è¼‰å…¥å¿«æœå½±åŸé¸å–® (ä¸Šæ–¹é¸å–®)
            loadCinemasForSelect();

            // 4. è¼‰å…¥é¤é»
            loadMeals();
        });

        // è‡ªå®šç¾© Alert
        function alert(message, callback) {
            const existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const handleConfirm = () => {
                document.getElementById('custom-alert-modal').remove();
                if (callback && typeof callback === 'function') {
                    callback(); 
                }
            };
            
            window.customAlertConfirm = handleConfirm;

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform scale-100 transition-all duration-300">
                        <div class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-vieshow-red mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            ç³»çµ±æç¤º
                        </div>
                        <p class="text-gray-700 mb-5">${message}</p>
                        <div class="flex justify-end">
                            <button onclick="window.customAlertConfirm()" 
                                    class="bg-vieshow-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-vieshow-red focus:ring-offset-2">
                                ç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
    </script>
</body>
</html>
